{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"AI FP&amp;A Monthly Close Automation","text":""},{"location":"#welcome","title":"Welcome","text":"<p>Welcome to the AI FP&amp;A Monthly Close Automation System user manual. This comprehensive guide will help you understand, deploy, and operate an AI-powered financial consolidation system for Nuvini Group Limited's portfolio companies.</p>"},{"location":"#what-is-ai-fpa","title":"What is AI FP&amp;A?","text":"<p>The AI FP&amp;A system automates the monthly financial close process across multiple portfolio companies, consolidating financial data from diverse ERP systems into standardized IFRS and US GAAP compliant reports.</p>"},{"location":"#key-capabilities","title":"Key Capabilities","text":"<ul> <li>Automated Data Extraction from 4+ Brazilian ERP systems (TOTVS, ContaAzul, Omie, Bling)</li> <li>Multi-Currency Consolidation with IFRS 21 compliant FX translation</li> <li>Intercompany Elimination with intelligent matching and FX tolerance</li> <li>IFRS/US GAAP Reconciliation for dual reporting standards</li> <li>Human Oversight with confidence scoring and risk-based review</li> <li>Complete Audit Trail with 7-year retention for compliance</li> </ul>"},{"location":"#portfolio-coverage","title":"Portfolio Coverage","text":"<p>Currently supports 7 portfolio companies:</p> Company ERP System Currency ARR Effecti TOTVS Protheus BRL $8.5M Mercos ContaAzul BRL $7.2M Datahub Omie BRL $6.8M OnClick TOTVS Protheus BRL $6.1M Ip\u00ea Digital Bling BRL $5.4M Munddi ContaAzul BRL $4.8M Leadlovers Bling BRL $4.8M <p>Total ARR: $43.6M | Total Employees: 665</p>"},{"location":"#system-architecture","title":"System Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    AI FP&amp;A SYSTEM                            \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u2502\n\u2502  \u2502 ERP Systems  \u2502  \u2502 Consolidation\u2502  \u2502   Reports    \u2502      \u2502\n\u2502  \u2502 (4 Adapters) \u2502\u2192 \u2502   Engine     \u2502\u2192 \u2502 (IFRS/GAAP)  \u2502      \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2502\n\u2502         \u2193                 \u2193                   \u2193             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u2502\n\u2502  \u2502         PostgreSQL Database (25 tables)          \u2502      \u2502\n\u2502  \u2502         - Multi-tenant RLS                       \u2502      \u2502\n\u2502  \u2502         - 7-year audit trail                     \u2502      \u2502\n\u2502  \u2502         - 80+ optimized indexes                  \u2502      \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510      \u2502\n\u2502  \u2502         Security &amp; Compliance Layer              \u2502      \u2502\n\u2502  \u2502         - AES-256 encryption                     \u2502      \u2502\n\u2502  \u2502         - RBAC (11 roles)                        \u2502      \u2502\n\u2502  \u2502         - Human oversight                        \u2502      \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"#quick-start","title":"Quick Start","text":"<p>New User?</p> <p>Start with the Quick Start Guide for a hands-on introduction.</p> <ol> <li>System Requirements - Verify prerequisites</li> <li>Installation - Set up the system</li> <li>Quick Start - Run your first consolidation</li> <li>Monthly Close Process - Understand the workflow</li> </ol>"},{"location":"#key-features","title":"Key Features","text":""},{"location":"#intelligent-automation","title":"\ud83e\udd16 Intelligent Automation","text":"<ul> <li>99.9% accuracy target with comprehensive validation</li> <li>Confidence scoring (Green/Yellow/Red) for all AI-generated entries</li> <li>Risk-based sampling - 5% review for green, 100% for yellow/red</li> <li>Automatic retry logic with circuit breakers</li> </ul>"},{"location":"#multi-entity-support","title":"\ud83c\udf0d Multi-Entity Support","text":"<ul> <li>7 portfolio companies with ability to scale to 66+</li> <li>Multi-currency consolidation (BRL \u2192 USD presentation)</li> <li>Intercompany elimination with FX-aware matching</li> <li>Purchase Price Allocation (goodwill, amortization, impairment)</li> </ul>"},{"location":"#enterprise-security","title":"\ud83d\udd12 Enterprise Security","text":"<ul> <li>AES-256-GCM field-level encryption</li> <li>Row-Level Security (RLS) for multi-tenant isolation</li> <li>11 RBAC roles with 25+ granular permissions</li> <li>Complete audit trail with immutable S3 Object Lock storage</li> </ul>"},{"location":"#regulatory-compliance","title":"\ud83d\udcca Regulatory Compliance","text":"<ul> <li>\u2705 IFRS 10, IFRS 3, IFRS 21 - Consolidation, business combinations, FX</li> <li>\u2705 US GAAP ASC 810/805/830 - Consolidation, business combinations, FX</li> <li>\u2705 SOC 2 Type II - Access controls, encryption, audit logging</li> <li>\u2705 ISO 27001 - Information security management</li> </ul>"},{"location":"#documentation-structure","title":"Documentation Structure","text":"<p>This manual is organized into the following sections:</p>"},{"location":"#getting-started","title":"Getting Started","text":"<p>System overview, installation, and initial setup</p>"},{"location":"#user-guide","title":"User Guide","text":"<p>Day-to-day operations and workflows</p>"},{"location":"#technical-reference","title":"Technical Reference","text":"<p>Detailed technical documentation for developers</p>"},{"location":"#deployment","title":"Deployment","text":"<p>Production deployment guides and best practices</p>"},{"location":"#appendix","title":"Appendix","text":"<p>Glossary, FAQ, compliance information, and changelog</p>"},{"location":"#support","title":"Support","text":"<ul> <li>GitHub Issues: https://github.com/escotilha/nuvini-ai-fpa/issues</li> <li>Email: Pierre Schurmann (pschumacher@nuvini.ai)</li> <li>Documentation: This manual and <code>/docs</code> folder in the repository</li> </ul>"},{"location":"#version-information","title":"Version Information","text":"<ul> <li>Version: 1.0.0</li> <li>Release Date: February 7, 2026</li> <li>Last Updated: February 7, 2026</li> <li>Python Version: 3.13+</li> <li>PostgreSQL Version: 15+</li> </ul> <p>Next: System Overview \u2192</p>"},{"location":"appendix/glossary/","title":"Glossary","text":"<p>ARR - Annual Recurring Revenue CoA - Chart of Accounts CTA - Cumulative Translation Adjustment ERP - Enterprise Resource Planning FX - Foreign Exchange IFRS - International Financial Reporting Standards PPA - Purchase Price Allocation RBAC - Role-Based Access Control RLS - Row-Level Security</p>"},{"location":"deployment/aws-setup/","title":"AWS Infrastructure Setup","text":"<p>This guide covers setting up the AWS infrastructure required for the AI FP&amp;A system.</p>"},{"location":"deployment/aws-setup/#overview","title":"Overview","text":"<p>The AI FP&amp;A system uses the following AWS services:</p> <ul> <li>RDS PostgreSQL - Primary database</li> <li>Secrets Manager - ERP credentials storage</li> <li>S3 - Audit trail storage with Object Lock (WORM)</li> <li>KMS - Encryption key management</li> <li>CloudWatch - Logging and monitoring</li> </ul>"},{"location":"deployment/aws-setup/#prerequisites","title":"Prerequisites","text":"<ul> <li>AWS Account with admin access</li> <li>AWS CLI installed and configured</li> <li>Terraform (optional, for infrastructure as code)</li> </ul>"},{"location":"deployment/aws-setup/#step-1-postgresql-rds-setup","title":"Step 1: PostgreSQL RDS Setup","text":""},{"location":"deployment/aws-setup/#create-rds-instance","title":"Create RDS Instance","text":"<pre><code>aws rds create-db-instance \\\n    --db-instance-identifier nuvini-fpa-prod \\\n    --db-instance-class db.t3.large \\\n    --engine postgres \\\n    --engine-version 15.4 \\\n    --master-username fpa_admin \\\n    --master-user-password &lt;SECURE_PASSWORD&gt; \\\n    --allocated-storage 100 \\\n    --storage-type gp3 \\\n    --storage-encrypted \\\n    --kms-key-id &lt;KMS_KEY_ARN&gt; \\\n    --backup-retention-period 7 \\\n    --preferred-backup-window \"03:00-04:00\" \\\n    --preferred-maintenance-window \"sun:04:00-sun:05:00\" \\\n    --multi-az \\\n    --publicly-accessible false \\\n    --vpc-security-group-ids &lt;SECURITY_GROUP_ID&gt; \\\n    --db-subnet-group-name &lt;SUBNET_GROUP_NAME&gt; \\\n    --enable-iam-database-authentication \\\n    --tags Key=Project,Value=AI-FPA Key=Environment,Value=Production\n</code></pre>"},{"location":"deployment/aws-setup/#configure-postgresql-parameters","title":"Configure PostgreSQL Parameters","text":"<p>Create parameter group:</p> <pre><code>aws rds create-db-parameter-group \\\n    --db-parameter-group-name fpa-postgres15 \\\n    --db-parameter-group-family postgres15 \\\n    --description \"AI FP&amp;A PostgreSQL 15 parameters\"\n\n# Set parameters\naws rds modify-db-parameter-group \\\n    --db-parameter-group-name fpa-postgres15 \\\n    --parameters \\\n        \"ParameterName=shared_buffers,ParameterValue=8GB,ApplyMethod=pending-reboot\" \\\n        \"ParameterName=work_mem,ParameterValue=256MB,ApplyMethod=immediate\" \\\n        \"ParameterName=maintenance_work_mem,ParameterValue=2GB,ApplyMethod=immediate\" \\\n        \"ParameterName=effective_cache_size,ParameterValue=24GB,ApplyMethod=immediate\" \\\n        \"ParameterName=random_page_cost,ParameterValue=1.1,ApplyMethod=immediate\"\n</code></pre>"},{"location":"deployment/aws-setup/#enable-ssltls","title":"Enable SSL/TLS","text":"<pre><code># Download RDS certificate\nwget https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem\n\n# Configure connection string\nDATABASE_URL=\"postgresql://fpa_admin:&lt;PASSWORD&gt;@nuvini-fpa-prod.xxxx.us-east-1.rds.amazonaws.com:5432/fpa_db?sslmode=require&amp;sslrootcert=global-bundle.pem\"\n</code></pre>"},{"location":"deployment/aws-setup/#step-2-secrets-manager-setup","title":"Step 2: Secrets Manager Setup","text":""},{"location":"deployment/aws-setup/#create-secrets-for-erp-credentials","title":"Create Secrets for ERP Credentials","text":"<pre><code># TOTVS Protheus (Effecti)\naws secretsmanager create-secret \\\n    --name fpa/erp/effecti/totvs \\\n    --description \"Effecti TOTVS Protheus credentials\" \\\n    --secret-string '{\n        \"client_id\": \"effecti_oauth_client\",\n        \"client_secret\": \"XXXX\",\n        \"tenant_id\": \"effecti_tenant\",\n        \"api_endpoint\": \"https://api.totvs.com.br/protheus\"\n    }' \\\n    --tags Key=Project,Value=AI-FPA Key=Company,Value=Effecti\n\n# ContaAzul (Mercos)\naws secretsmanager create-secret \\\n    --name fpa/erp/mercos/contaazul \\\n    --description \"Mercos ContaAzul credentials\" \\\n    --secret-string '{\n        \"api_key\": \"XXXX\",\n        \"api_endpoint\": \"https://api.contaazul.com/v1\"\n    }' \\\n    --tags Key=Project,Value=AI-FPA Key=Company,Value=Mercos\n\n# Repeat for all 7 companies...\n</code></pre>"},{"location":"deployment/aws-setup/#grant-access-to-secrets","title":"Grant Access to Secrets","text":"<pre><code># Create IAM policy\naws iam create-policy \\\n    --policy-name FPA-SecretsAccess \\\n    --policy-document '{\n        \"Version\": \"2012-10-17\",\n        \"Statement\": [{\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"secretsmanager:GetSecretValue\",\n                \"secretsmanager:DescribeSecret\"\n            ],\n            \"Resource\": \"arn:aws:secretsmanager:*:*:secret:fpa/erp/*\"\n        }]\n    }'\n\n# Attach to application role\naws iam attach-role-policy \\\n    --role-name FPA-Application-Role \\\n    --policy-arn &lt;POLICY_ARN&gt;\n</code></pre>"},{"location":"deployment/aws-setup/#step-3-s3-audit-trail-setup","title":"Step 3: S3 Audit Trail Setup","text":""},{"location":"deployment/aws-setup/#create-s3-bucket-with-object-lock","title":"Create S3 Bucket with Object Lock","text":"<pre><code># Create bucket with versioning and Object Lock\naws s3api create-bucket \\\n    --bucket nuvini-fpa-audit-logs \\\n    --region us-east-1 \\\n    --object-lock-enabled-for-bucket\n\n# Enable versioning (required for Object Lock)\naws s3api put-bucket-versioning \\\n    --bucket nuvini-fpa-audit-logs \\\n    --versioning-configuration Status=Enabled\n\n# Set Object Lock configuration (7-year retention)\naws s3api put-object-lock-configuration \\\n    --bucket nuvini-fpa-audit-logs \\\n    --object-lock-configuration '{\n        \"ObjectLockEnabled\": \"Enabled\",\n        \"Rule\": {\n            \"DefaultRetention\": {\n                \"Mode\": \"GOVERNANCE\",\n                \"Years\": 7\n            }\n        }\n    }'\n\n# Enable encryption with KMS\naws s3api put-bucket-encryption \\\n    --bucket nuvini-fpa-audit-logs \\\n    --server-side-encryption-configuration '{\n        \"Rules\": [{\n            \"ApplyServerSideEncryptionByDefault\": {\n                \"SSEAlgorithm\": \"aws:kms\",\n                \"KMSMasterKeyID\": \"&lt;KMS_KEY_ARN&gt;\"\n            },\n            \"BucketKeyEnabled\": true\n        }]\n    }'\n\n# Block public access\naws s3api put-public-access-block \\\n    --bucket nuvini-fpa-audit-logs \\\n    --public-access-block-configuration \\\n        \"BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true\"\n</code></pre>"},{"location":"deployment/aws-setup/#configure-lifecycle-policy","title":"Configure Lifecycle Policy","text":"<pre><code>aws s3api put-bucket-lifecycle-configuration \\\n    --bucket nuvini-fpa-audit-logs \\\n    --lifecycle-configuration '{\n        \"Rules\": [{\n            \"Id\": \"TransitionToIA\",\n            \"Status\": \"Enabled\",\n            \"Transitions\": [{\n                \"Days\": 90,\n                \"StorageClass\": \"STANDARD_IA\"\n            }],\n            \"NoncurrentVersionTransitions\": [{\n                \"NoncurrentDays\": 30,\n                \"StorageClass\": \"STANDARD_IA\"\n            }]\n        }]\n    }'\n</code></pre>"},{"location":"deployment/aws-setup/#step-4-kms-key-setup","title":"Step 4: KMS Key Setup","text":""},{"location":"deployment/aws-setup/#create-master-encryption-key","title":"Create Master Encryption Key","text":"<pre><code>aws kms create-key \\\n    --description \"AI FP&amp;A master encryption key\" \\\n    --key-usage ENCRYPT_DECRYPT \\\n    --origin AWS_KMS \\\n    --multi-region false \\\n    --tags TagKey=Project,TagValue=AI-FPA\n\n# Create alias\naws kms create-alias \\\n    --alias-name alias/fpa-master-key \\\n    --target-key-id &lt;KEY_ID&gt;\n\n# Set key policy\naws kms put-key-policy \\\n    --key-id &lt;KEY_ID&gt; \\\n    --policy-name default \\\n    --policy '{\n        \"Version\": \"2012-10-17\",\n        \"Statement\": [{\n            \"Sid\": \"Enable IAM User Permissions\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"AWS\": \"arn:aws:iam::&lt;ACCOUNT_ID&gt;:root\"},\n            \"Action\": \"kms:*\",\n            \"Resource\": \"*\"\n        }, {\n            \"Sid\": \"Allow FPA Application\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"AWS\": \"arn:aws:iam::&lt;ACCOUNT_ID&gt;:role/FPA-Application-Role\"},\n            \"Action\": [\n                \"kms:Decrypt\",\n                \"kms:DescribeKey\",\n                \"kms:GenerateDataKey\"\n            ],\n            \"Resource\": \"*\"\n        }]\n    }'\n</code></pre>"},{"location":"deployment/aws-setup/#step-5-cloudwatch-setup","title":"Step 5: CloudWatch Setup","text":""},{"location":"deployment/aws-setup/#create-log-groups","title":"Create Log Groups","text":"<pre><code># Application logs\naws logs create-log-group \\\n    --log-group-name /fpa/application\n\n# ERP connector logs\naws logs create-log-group \\\n    --log-group-name /fpa/erp-connectors\n\n# Consolidation logs\naws logs create-log-group \\\n    --log-group-name /fpa/consolidation\n\n# Security audit logs\naws logs create-log-group \\\n    --log-group-name /fpa/security\n\n# Set retention (7 years for compliance)\nfor group in /fpa/application /fpa/erp-connectors /fpa/consolidation /fpa/security; do\n    aws logs put-retention-policy \\\n        --log-group-name $group \\\n        --retention-in-days 2555  # 7 years\ndone\n</code></pre>"},{"location":"deployment/aws-setup/#create-cloudwatch-alarms","title":"Create CloudWatch Alarms","text":"<pre><code># Database connection failures\naws cloudwatch put-metric-alarm \\\n    --alarm-name fpa-database-connection-failures \\\n    --alarm-description \"Alert on database connection failures\" \\\n    --metric-name DatabaseConnections \\\n    --namespace AWS/RDS \\\n    --statistic Sum \\\n    --period 300 \\\n    --evaluation-periods 2 \\\n    --threshold 10 \\\n    --comparison-operator GreaterThanThreshold \\\n    --dimensions Name=DBInstanceIdentifier,Value=nuvini-fpa-prod\n\n# Consolidation errors\naws cloudwatch put-metric-alarm \\\n    --alarm-name fpa-consolidation-errors \\\n    --alarm-description \"Alert on consolidation validation errors\" \\\n    --metric-name ConsolidationErrors \\\n    --namespace FPA/Consolidation \\\n    --statistic Sum \\\n    --period 3600 \\\n    --evaluation-periods 1 \\\n    --threshold 5 \\\n    --comparison-operator GreaterThanThreshold\n</code></pre>"},{"location":"deployment/aws-setup/#step-6-iam-roles-and-policies","title":"Step 6: IAM Roles and Policies","text":""},{"location":"deployment/aws-setup/#create-application-role","title":"Create Application Role","text":"<pre><code># Create role\naws iam create-role \\\n    --role-name FPA-Application-Role \\\n    --assume-role-policy-document '{\n        \"Version\": \"2012-10-17\",\n        \"Statement\": [{\n            \"Effect\": \"Allow\",\n            \"Principal\": {\"Service\": \"ec2.amazonaws.com\"},\n            \"Action\": \"sts:AssumeRole\"\n        }]\n    }'\n\n# Attach managed policies\naws iam attach-role-policy \\\n    --role-name FPA-Application-Role \\\n    --policy-arn arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy\n\n# Create custom policy\naws iam create-policy \\\n    --policy-name FPA-Application-Policy \\\n    --policy-document '{\n        \"Version\": \"2012-10-17\",\n        \"Statement\": [{\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"s3:PutObject\",\n                \"s3:PutObjectRetention\",\n                \"s3:GetObject\"\n            ],\n            \"Resource\": \"arn:aws:s3:::nuvini-fpa-audit-logs/*\"\n        }, {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"kms:Decrypt\",\n                \"kms:GenerateDataKey\"\n            ],\n            \"Resource\": \"&lt;KMS_KEY_ARN&gt;\"\n        }, {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"logs:CreateLogStream\",\n                \"logs:PutLogEvents\"\n            ],\n            \"Resource\": \"arn:aws:logs:*:*:log-group:/fpa/*\"\n        }]\n    }'\n</code></pre>"},{"location":"deployment/aws-setup/#step-7-verification","title":"Step 7: Verification","text":""},{"location":"deployment/aws-setup/#test-database-connection","title":"Test Database Connection","text":"<pre><code>psql \"$DATABASE_URL\" -c \"SELECT version();\"\n</code></pre>"},{"location":"deployment/aws-setup/#test-secrets-access","title":"Test Secrets Access","text":"<pre><code>import boto3\nimport json\n\nclient = boto3.client('secretsmanager', region_name='us-east-1')\nresponse = client.get_secret_value(SecretId='fpa/erp/effecti/totvs')\ncredentials = json.loads(response['SecretString'])\nprint(f\"Retrieved credentials for: {credentials.get('api_endpoint')}\")\n</code></pre>"},{"location":"deployment/aws-setup/#test-s3-audit-log-write","title":"Test S3 Audit Log Write","text":"<pre><code>import boto3\n\ns3 = boto3.client('s3')\ns3.put_object(\n    Bucket='nuvini-fpa-audit-logs',\n    Key='test/audit.log',\n    Body=b'Test audit entry',\n    ServerSideEncryption='aws:kms',\n    ObjectLockMode='GOVERNANCE',\n    ObjectLockRetainUntilDate=datetime.now() + timedelta(days=2555)\n)\n</code></pre>"},{"location":"deployment/aws-setup/#cost-estimate","title":"Cost Estimate","text":"Service Configuration Monthly Cost RDS PostgreSQL db.t3.large, 100GB gp3, Multi-AZ ~$280 S3 100GB STANDARD, 1TB IA ~$45 Secrets Manager 7 secrets ~$3 KMS 1 key, 10K requests/month ~$2 CloudWatch 50GB logs, 10 alarms ~$30 Total ~$360/month"},{"location":"deployment/aws-setup/#security-best-practices","title":"Security Best Practices","text":"<ol> <li>Enable MFA on all admin accounts</li> <li>Use IAM roles instead of access keys</li> <li>Enable CloudTrail for API audit logging</li> <li>Regular backups with automated restore testing</li> <li>Encrypt everything - RDS, S3, EBS volumes</li> <li>Least privilege - minimal permissions per role</li> <li>VPC isolation - private subnets for RDS</li> <li>Security groups - whitelist only required IPs</li> </ol>"},{"location":"deployment/aws-setup/#next-steps","title":"Next Steps","text":"<ul> <li>Environment Configuration</li> <li>PostgreSQL Setup</li> <li>Monitoring Configuration</li> </ul>"},{"location":"deployment/backup-recovery/","title":"Backup &amp; Recovery","text":""},{"location":"deployment/backup-recovery/#automated-backups","title":"Automated Backups","text":"<ul> <li>RDS Backups: Daily automated snapshots, 7-day retention</li> <li>S3 Audit Logs: Immutable with 7-year retention</li> <li>Configuration: Version controlled in Git</li> </ul>"},{"location":"deployment/backup-recovery/#recovery-procedures","title":"Recovery Procedures","text":""},{"location":"deployment/backup-recovery/#database-recovery","title":"Database Recovery","text":"<pre><code># Restore from snapshot\naws rds restore-db-instance-from-db-snapshot \\\n    --db-instance-identifier fpa-restored \\\n    --db-snapshot-identifier &lt;snapshot-id&gt;\n</code></pre>"},{"location":"deployment/backup-recovery/#disaster-recovery","title":"Disaster Recovery","text":"<p>RPO: 24 hours | RTO: 4 hours</p>"},{"location":"deployment/environment/","title":"Environment Configuration","text":""},{"location":"deployment/environment/#environment-variables","title":"Environment Variables","text":"<p>Create <code>.env</code> file:</p> <p>```bash</p>"},{"location":"deployment/environment/#database","title":"Database","text":"<p>DATABASE_URL=postgresql://user:pass@host:5432/fpa_db DATABASE_POOL_SIZE=20</p>"},{"location":"deployment/environment/#aws","title":"AWS","text":"<p>AWS_REGION=us-east-1 S3_AUDIT_BUCKET=nuvini-fpa-audit-logs AWS_KMS_KEY_ID=alias/fpa-master-key</p>"},{"location":"deployment/environment/#claude-api","title":"Claude API","text":"<p>ANTHROPIC_API_KEY=sk-ant-xxxxx</p>"},{"location":"deployment/environment/#rediscelery","title":"Redis/Celery","text":"<p>REDIS_URL=redis://localhost:6379/0</p>"},{"location":"deployment/environment/#security","title":"Security","text":"<p>ENCRYPTION_KEY_ID=alias/fpa-master-key JWT_SECRET_KEY="},{"location":"deployment/environment/#environment","title":"Environment","text":"<p>ENVIRONMENT=production DEBUG=false</p>"},{"location":"deployment/monitoring/","title":"Monitoring &amp; Observability","text":""},{"location":"deployment/monitoring/#cloudwatch-metrics","title":"CloudWatch Metrics","text":"<p>Key metrics to monitor: - Database connection pool usage - Consolidation accuracy scores - ERP connector success rates - Human review queue depth</p>"},{"location":"deployment/monitoring/#alerts","title":"Alerts","text":"<p>Critical alerts: - Consolidation validation failures - Database connection errors - ERP connector timeouts - Security policy violations</p>"},{"location":"deployment/postgresql/","title":"PostgreSQL Database Setup","text":""},{"location":"deployment/postgresql/#initialize-database","title":"Initialize Database","text":"<pre><code>createdb fpa_db\npsql fpa_db -f database/migrations/001_initial_schema.sql\npsql fpa_db -f database/migrations/002_rls_policies.sql\npsql fpa_db -f database/migrations/003_indexes.sql\npsql fpa_db -f database/seeds/001_portfolio_entities.sql\npsql fpa_db -f database/seeds/002_standard_coa.sql\n</code></pre>"},{"location":"deployment/postgresql/#performance-tuning","title":"Performance Tuning","text":"<p>See database/README.md for complete tuning guide.</p> <p>Key settings: - shared_buffers = 8GB - work_mem = 256MB - effective_cache_size = 24GB</p>"},{"location":"getting-started/architecture/","title":"System Architecture","text":"<p>This document provides a detailed technical overview of the AI FP&amp;A Monthly Close Automation system architecture.</p>"},{"location":"getting-started/architecture/#table-of-contents","title":"Table of Contents","text":"<ol> <li>High-Level Architecture</li> <li>Component Architecture</li> <li>Data Flow</li> <li>Technology Stack</li> <li>Security Architecture</li> <li>Scalability &amp; Performance</li> <li>Deployment Architecture</li> </ol>"},{"location":"getting-started/architecture/#high-level-architecture","title":"High-Level Architecture","text":"<p>The system follows a layered microservices architecture with clear separation of concerns:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         PRESENTATION LAYER                           \u2502\n\u2502                                                                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502\n\u2502  \u2502   Excel      \u2502  \u2502  PowerPoint  \u2502  \u2502     PDF      \u2502              \u2502\n\u2502  \u2502   Reports    \u2502  \u2502   Reports    \u2502  \u2502   Reports    \u2502              \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2191\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         API &amp; ORCHESTRATION LAYER                    \u2502\n\u2502                                                                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502            FastAPI REST API                           \u2502           \u2502\n\u2502  \u2502  /health, /consolidate, /reports, /entities, etc.    \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                              \u2193                                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502         Monthly Close Orchestrator                    \u2502           \u2502\n\u2502  \u2502  Workflow: Extract \u2192 Consolidate \u2192 Validate \u2192 Report \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         BUSINESS LOGIC LAYER                         \u2502\n\u2502                                                                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502\n\u2502  \u2502  Connectors   \u2502  \u2502 Consolidation\u2502  \u2502  Analysis   \u2502              \u2502\n\u2502  \u2502               \u2502  \u2502   Engine     \u2502  \u2502   Engine    \u2502              \u2502\n\u2502  \u2502  - TOTVS      \u2502  \u2502              \u2502  \u2502             \u2502              \u2502\n\u2502  \u2502  - ContaAzul  \u2502  \u2502  - FX Conv.  \u2502  \u2502  - Variance \u2502              \u2502\n\u2502  \u2502  - Omie       \u2502  \u2502  - IC Elim.  \u2502  \u2502  - KPIs     \u2502              \u2502\n\u2502  \u2502  - Bling      \u2502  \u2502  - PPA       \u2502  \u2502  - AI/Claude\u2502              \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         DATA LAYER                                   \u2502\n\u2502                                                                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502           PostgreSQL 15+ Database                     \u2502           \u2502\n\u2502  \u2502                                                        \u2502           \u2502\n\u2502  \u2502  - Trial Balances (Partitioned by Year)              \u2502           \u2502\n\u2502  \u2502  - Consolidated Financials                           \u2502           \u2502\n\u2502  \u2502  - Chart of Accounts                                 \u2502           \u2502\n\u2502  \u2502  - Audit Trail (7-Year Retention)                    \u2502           \u2502\n\u2502  \u2502  - Row-Level Security (Multi-Tenant)                 \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                                                                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502           Redis 7+ (Task Queue &amp; Cache)               \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         EXTERNAL SERVICES                            \u2502\n\u2502                                                                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502  ERP APIs  \u2502  \u2502  FX Rates  \u2502  \u2502 Claude AI  \u2502  \u2502    AWS     \u2502   \u2502\n\u2502  \u2502  (4 types) \u2502  \u2502  BCB/ECB   \u2502  \u2502 Anthropic  \u2502  \u2502  Services  \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/architecture/#key-architectural-principles","title":"Key Architectural Principles","text":"<ol> <li>Separation of Concerns: Each layer has a single, well-defined responsibility</li> <li>Loose Coupling: Components communicate through well-defined interfaces</li> <li>High Cohesion: Related functionality grouped together</li> <li>Scalability: Horizontal scaling at each layer</li> <li>Observability: Comprehensive logging, monitoring, and tracing</li> <li>Security: Defense-in-depth with multiple security layers</li> </ol>"},{"location":"getting-started/architecture/#component-architecture","title":"Component Architecture","text":""},{"location":"getting-started/architecture/#1-data-ingestion-layer-connectors","title":"1. Data Ingestion Layer (Connectors)","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              ERP Connector Framework                     \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502         ERPConnector (Abstract Base)            \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  + connect()                                    \u2502    \u2502\n\u2502  \u2502  + disconnect()                                 \u2502    \u2502\n\u2502  \u2502  + get_trial_balance()                          \u2502    \u2502\n\u2502  \u2502  + get_subledger_details()                      \u2502    \u2502\n\u2502  \u2502  + get_companies()                              \u2502    \u2502\n\u2502  \u2502  + health_check()                               \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502             \u2191          \u2191          \u2191          \u2191           \u2502\n\u2502             \u2502          \u2502          \u2502          \u2502           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502\n\u2502  \u2502  TOTVS   \u2502  \u2502ContaAzul \u2502  \u2502   Omie   \u2502  \u2502  Bling   \u2502\u2502\n\u2502  \u2502Connector \u2502  \u2502Connector \u2502  \u2502Connector \u2502  \u2502Connector \u2502\u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502\n\u2502                                                          \u2502\n\u2502  Shared Components:                                     \u2502\n\u2502  - AuthHandler (OAuth2, API Key, Bearer Token)         \u2502\n\u2502  - RetryManager (Exponential Backoff)                  \u2502\n\u2502  - RateLimiter (Token Bucket Algorithm)                \u2502\n\u2502  - CircuitBreaker (Prevent Cascading Failures)         \u2502\n\u2502  - DataValidator (Schema Validation, Normalization)    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/architecture/#key-features","title":"Key Features","text":"<ul> <li>Authentication: Multi-protocol support (OAuth 2.0, API Key, Bearer Token)</li> <li>Resilience: Automatic retry with exponential backoff, circuit breaker</li> <li>Rate Limiting: Per-provider token bucket rate limiting</li> <li>Validation: Comprehensive data validation and normalization</li> <li>Observability: Structured logging, health checks, metrics</li> </ul>"},{"location":"getting-started/architecture/#data-flow","title":"Data Flow","text":"<pre><code>ERP API \u2192 HTTP Client \u2192 Auth Handler \u2192 Rate Limiter \u2192\nCircuit Breaker \u2192 Response Parser \u2192 Data Validator \u2192\nNormalized Data \u2192 Database\n</code></pre>"},{"location":"getting-started/architecture/#2-consolidation-engine","title":"2. Consolidation Engine","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Consolidation Engine                        \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502           ConsolidationEngine                   \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  + register_entity()                            \u2502    \u2502\n\u2502  \u2502  + load_trial_balance()                         \u2502    \u2502\n\u2502  \u2502  + consolidate()                                \u2502    \u2502\n\u2502  \u2502  + get_audit_trail()                            \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502             \u2502          \u2502          \u2502          \u2502           \u2502\n\u2502             \u2193          \u2193          \u2193          \u2193           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502\n\u2502  \u2502    FX    \u2502  \u2502   IC     \u2502  \u2502   PPA    \u2502  \u2502   GAAP   \u2502\u2502\n\u2502  \u2502Converter \u2502  \u2502Eliminator\u2502  \u2502 Manager  \u2502  \u2502   Recon  \u2502\u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502\n\u2502                                                          \u2502\n\u2502  Components:                                            \u2502\n\u2502  - FXRateManager: Load and manage FX rates             \u2502\n\u2502  - FXConverter: Apply rates to accounts                \u2502\n\u2502  - IntercompanyMatcher: Identify IC pairs              \u2502\n\u2502  - EliminationGenerator: Create elimination entries    \u2502\n\u2502  - PPAScheduler: Track goodwill &amp; amortization         \u2502\n\u2502  - GAAPrec: IFRS to US GAAP adjustments                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/architecture/#consolidation-process","title":"Consolidation Process","text":"<pre><code>Step 1: FX Conversion\n  Input:  Trial Balances (BRL)\n  Output: Translated Balances (USD)\n\n  Algorithm:\n  - Load FX rates (closing, average, historical)\n  - Apply closing rate to BS accounts\n  - Apply average rate to P&amp;L accounts\n  - Calculate Cumulative Translation Adjustment (CTA)\n\nStep 2: Intercompany Elimination\n  Input:  Translated Balances (USD)\n  Output: Elimination Entries\n\n  Algorithm:\n  - Identify IC relationships (entity pairs)\n  - Match AR/AP pairs (by reference, amount \u00b11%)\n  - Match Revenue/Expense pairs (by entity relationship)\n  - Generate elimination journal entries\n  - Calculate FX gains/losses on IC balances\n\nStep 3: PPA Amortization\n  Input:  Active PPA Schedules\n  Output: Amortization Entries\n\n  Algorithm:\n  - Retrieve PPA schedules for all entities\n  - Calculate monthly amortization (straight-line)\n  - Generate journal entries\n  - Update goodwill carrying amount\n\nStep 4: Aggregation\n  Input:  Translated Balances, Eliminations, PPA Entries\n  Output: Consolidated Balances\n\n  Algorithm:\n  - Sum all entries by standard account\n  - Apply elimination entries\n  - Apply PPA entries\n  - Calculate totals by account type\n\nStep 5: Validation\n  Input:  Consolidated Balances\n  Output: Validation Report, Accuracy Score\n\n  Checks:\n  - Balance Sheet Balance (Assets = Liabilities + Equity)\n  - Debit/Credit Balance\n  - Net Income Reconciliation\n  - FX Rate Consistency\n  - Reasonableness Checks\n</code></pre>"},{"location":"getting-started/architecture/#3-analysis-engine","title":"3. Analysis Engine","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Analysis Engine                             \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502         VarianceAnalyzer                        \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  + analyze_budget_vs_actual()                   \u2502    \u2502\n\u2502  \u2502  + analyze_month_over_month()                   \u2502    \u2502\n\u2502  \u2502  + identify_anomalies()                         \u2502    \u2502\n\u2502  \u2502  + generate_commentary()                        \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                          \u2502                               \u2502\n\u2502                          \u2193                               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502         Claude AI Integration                   \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  Prompt Engineering:                            \u2502    \u2502\n\u2502  \u2502  \"Analyze variance in account X:                \u2502    \u2502\n\u2502  \u2502   - Current: $Y                                 \u2502    \u2502\n\u2502  \u2502   - Budget: $Z                                  \u2502    \u2502\n\u2502  \u2502   - Variance: $(Y-Z) / Z% increase             \u2502    \u2502\n\u2502  \u2502   - Historical trend: [data]                    \u2502    \u2502\n\u2502  \u2502   Explain why this variance occurred.\"          \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                          \u2502                               \u2502\n\u2502                          \u2193                               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502         KPI Calculator                          \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  SaaS Metrics:                                  \u2502    \u2502\n\u2502  \u2502  - ARR, MRR, NRR                                \u2502    \u2502\n\u2502  \u2502  - Logo Churn, Revenue Churn                    \u2502    \u2502\n\u2502  \u2502  - ARPU, LTV/CAC                                \u2502    \u2502\n\u2502  \u2502  - Rule of 40                                   \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/architecture/#ai-variance-analysis-flow","title":"AI Variance Analysis Flow","text":"<pre><code>1. Detect Material Variances\n   - Budget vs Actual &gt; $10K or 10%\n   - Month-over-Month &gt; $5K or 5%\n\n2. Gather Context\n   - Account name and type\n   - Current vs prior period/budget\n   - Historical trend (12 months)\n   - Related accounts (e.g., Revenue + COGS)\n\n3. Generate Prompt for Claude\n   Template:\n   \"\"\"\n   You are a financial analyst reviewing monthly close results.\n\n   Account: {account_name}\n   Current Period: ${current:,.2f}\n   Prior Period: ${prior:,.2f}\n   Variance: ${variance:,.2f} ({variance_pct}%)\n   Trend: {trend_description}\n\n   Explain the variance in 2-3 sentences suitable for\n   CFO review. Focus on likely business drivers.\n   \"\"\"\n\n4. Call Claude API\n   Model: claude-sonnet-4-5\n   Temperature: 0.3 (consistent, factual)\n   Max Tokens: 300\n\n5. Format Response\n   - Remove markdown\n   - Capitalize properly\n   - Add to variance analysis report\n\n6. Confidence Scoring\n   Factors:\n   - Data completeness (100%)\n   - Variance explainability (AI confidence)\n   - Pattern consistency (historical)\n\n   Score: 0-100%\n   - Green (95-100%): Auto-approve\n   - Yellow (80-94%): Review recommended\n   - Red (&lt;80%): Manual validation required\n</code></pre>"},{"location":"getting-started/architecture/#4-reporting-layer","title":"4. Reporting Layer","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Report Generation                           \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502       ExcelReportGenerator                      \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  Sheets:                                        \u2502    \u2502\n\u2502  \u2502  - Summary (Key metrics, KPIs)                  \u2502    \u2502\n\u2502  \u2502  - Balance Sheet (Assets, Liabilities, Equity)  \u2502    \u2502\n\u2502  \u2502  - P&amp;L Statement (Revenue, Expenses, Net Inc.)  \u2502    \u2502\n\u2502  \u2502  - Trial Balance (Account detail)               \u2502    \u2502\n\u2502  \u2502  - FX Rates (Exchange rates used)               \u2502    \u2502\n\u2502  \u2502  - Audit Log (Consolidation steps)              \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  Library: OpenPyXL                              \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502       PowerPointGenerator                       \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  Slides:                                        \u2502    \u2502\n\u2502  \u2502  - Executive Summary (Key highlights)           \u2502    \u2502\n\u2502  \u2502  - Financial Performance (Charts)               \u2502    \u2502\n\u2502  \u2502  - Variance Analysis (Waterfall charts)         \u2502    \u2502\n\u2502  \u2502  - KPI Trends (Time series)                     \u2502    \u2502\n\u2502  \u2502  - Per-Company Highlights                       \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  Library: python-pptx                           \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502       PDFExporter                               \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  - Board Package (All financials)               \u2502    \u2502\n\u2502  \u2502  - Executive Summary (1-pager)                  \u2502    \u2502\n\u2502  \u2502  - Audit Trail (Complete log)                   \u2502    \u2502\n\u2502  \u2502                                                  \u2502    \u2502\n\u2502  \u2502  Library: ReportLab / WeasyPrint                \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/architecture/#5-orchestration-layer","title":"5. Orchestration Layer","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502           Monthly Close Orchestrator                     \u2502\n\u2502                                                          \u2502\n\u2502  State Machine:                                         \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  Extract   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  Consolidate     \u2502\n\u2502  \u2502  IDLE    \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192  \u2502EXTRACTING\u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192        \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                   \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  Validate  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  Report       \u2502\n\u2502  \u2502CONSOLIDATING\u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192  \u2502VALIDATING\u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192      \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2502\n\u2502                                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  Distribute  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u2502\n\u2502  \u2502REPORTING \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192    \u2502COMPLETED \u2502                \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2502\n\u2502                                 \u2502                        \u2502\n\u2502                                 \u2502 Error                  \u2502\n\u2502                                 \u2193                        \u2502\n\u2502                            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u2502\n\u2502                            \u2502  FAILED  \u2502                \u2502\n\u2502                            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2502\n\u2502                                                          \u2502\n\u2502  Celery Tasks:                                          \u2502\n\u2502  - extract_trial_balances_task()                        \u2502\n\u2502  - consolidate_financials_task()                        \u2502\n\u2502  - validate_results_task()                              \u2502\n\u2502  - generate_reports_task()                              \u2502\n\u2502  - distribute_reports_task()                            \u2502\n\u2502                                                          \u2502\n\u2502  Error Handling:                                        \u2502\n\u2502  - Retry failed tasks (max 3 attempts)                  \u2502\n\u2502  - Send alerts to Slack/Email                           \u2502\n\u2502  - Log detailed error trace                             \u2502\n\u2502  - Allow manual resume from checkpoint                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/architecture/#data-flow_1","title":"Data Flow","text":""},{"location":"getting-started/architecture/#end-to-end-monthly-close-flow","title":"End-to-End Monthly Close Flow","text":"<pre><code>1. TRIGGER (1st of month, 6 AM UTC)\n   \u2502\n   \u251c\u2500\u2192 Lambda/EventBridge scheduled event\n   \u2502   POST /api/v1/consolidation/run\n   \u2502\n2. EXTRACT (5-10 minutes)\n   \u2502\n   \u251c\u2500\u2192 For each entity (parallel):\n   \u2502   \u2502\n   \u2502   \u251c\u2500\u2192 Create ERP connector\n   \u2502   \u251c\u2500\u2192 Authenticate\n   \u2502   \u251c\u2500\u2192 Extract trial balance\n   \u2502   \u251c\u2500\u2192 Validate data\n   \u2502   \u2514\u2500\u2192 Store in database\n   \u2502\n   \u2514\u2500\u2192 Wait for all entities\n   \u2502\n3. MAP (2-3 minutes)\n   \u2502\n   \u251c\u2500\u2192 Load entity Chart of Accounts\n   \u251c\u2500\u2192 Map to Standard CoA\n   \u2514\u2500\u2192 Store mappings\n   \u2502\n4. CONSOLIDATE (3-5 minutes)\n   \u2502\n   \u251c\u2500\u2192 Load FX rates (BCB API)\n   \u251c\u2500\u2192 Apply FX conversion\n   \u251c\u2500\u2192 Identify intercompany transactions\n   \u251c\u2500\u2192 Generate elimination entries\n   \u251c\u2500\u2192 Apply PPA amortization\n   \u251c\u2500\u2192 Aggregate to consolidated balances\n   \u2514\u2500\u2192 Store consolidated result\n   \u2502\n5. VALIDATE (1-2 minutes)\n   \u2502\n   \u251c\u2500\u2192 Balance sheet balance check\n   \u251c\u2500\u2192 Debit/credit balance check\n   \u251c\u2500\u2192 Net income reconciliation\n   \u251c\u2500\u2192 Reasonableness checks\n   \u251c\u2500\u2192 Calculate accuracy score\n   \u2514\u2500\u2192 Store validation report\n   \u2502\n6. ANALYZE (3-5 minutes)\n   \u2502\n   \u251c\u2500\u2192 Calculate budget vs actual variances\n   \u251c\u2500\u2192 Identify material variances\n   \u251c\u2500\u2192 Call Claude API for explanations\n   \u251c\u2500\u2192 Calculate SaaS KPIs\n   \u2514\u2500\u2192 Store analysis results\n   \u2502\n7. REPORT (5-7 minutes)\n   \u2502\n   \u251c\u2500\u2192 Generate Excel (consolidated financials)\n   \u251c\u2500\u2192 Generate PowerPoint (executive summary)\n   \u251c\u2500\u2192 Generate PDF (board package)\n   \u251c\u2500\u2192 Upload to S3\n   \u2514\u2500\u2192 Store report metadata\n   \u2502\n8. DISTRIBUTE (2-3 minutes)\n   \u2502\n   \u251c\u2500\u2192 Send email notifications\n   \u251c\u2500\u2192 Post to Slack channel\n   \u2514\u2500\u2192 Update dashboard\n   \u2502\n9. COMPLETE\n   \u2502\n   \u2514\u2500\u2192 Total time: 20-35 minutes (target: &lt;2 hours)\n</code></pre>"},{"location":"getting-started/architecture/#database-schema-relationships","title":"Database Schema Relationships","text":"<pre><code>portfolio_entities\n  \u2502\n  \u251c\u2500\u2192 entity_chart_of_accounts\n  \u2502     \u2502\n  \u2502     \u2514\u2500\u2192 standard_chart_of_accounts\n  \u2502\n  \u251c\u2500\u2192 trial_balances (partitioned by year)\n  \u2502\n  \u251c\u2500\u2192 consolidated_balances\n  \u2502\n  \u251c\u2500\u2192 intercompany_balances\n  \u2502\n  \u251c\u2500\u2192 journal_entries\n  \u2502     \u2502\n  \u2502     \u2514\u2500\u2192 journal_entry_lines\n  \u2502\n  \u2514\u2500\u2192 etl_batches\n        \u2502\n        \u2514\u2500\u2192 validation_results\n\nusers\n  \u2502\n  \u2514\u2500\u2192 user_entity_access\n        \u2502\n        \u2514\u2500\u2192 portfolio_entities\n\nfx_rates (daily)\nfx_rates_monthly (average)\n\nagent_actions (partitioned by year)\ncredential_access_log\nperiod_locks\n</code></pre>"},{"location":"getting-started/architecture/#technology-stack","title":"Technology Stack","text":""},{"location":"getting-started/architecture/#backend","title":"Backend","text":"Component Technology Version Purpose Language Python 3.13+ Core application Web Framework FastAPI 0.110+ REST API ORM SQLAlchemy 2.0+ Database access DB Driver asyncpg 0.29+ Async PostgreSQL Task Queue Celery 5.3+ Background tasks HTTP Client httpx 0.27+ Async HTTP Data Validation Pydantic 2.6+ Schema validation"},{"location":"getting-started/architecture/#database-cache","title":"Database &amp; Cache","text":"Component Technology Version Purpose Primary DB PostgreSQL 15+ Transactional data Cache Redis 7.0+ Task queue, caching Extensions uuid-ossp, btree_gist, pg_trgm - UUID, indexing, search"},{"location":"getting-started/architecture/#external-services","title":"External Services","text":"Service Provider Purpose AI Model Claude Sonnet 4.5 / Opus 4.6 Variance analysis, commentary ERP APIs TOTVS, ContaAzul, Omie, Bling Trial balance extraction FX Rates BCB (Brazil), ECB (Europe) Exchange rates Cloud AWS (RDS, ECS, S3, Lambda) Infrastructure"},{"location":"getting-started/architecture/#libraries-tools","title":"Libraries &amp; Tools","text":"Library Purpose openpyxl Excel file generation python-pptx PowerPoint generation reportlab PDF generation pandas Data manipulation pytest Testing framework black Code formatting mypy Type checking"},{"location":"getting-started/architecture/#security-architecture","title":"Security Architecture","text":""},{"location":"getting-started/architecture/#multi-layer-security","title":"Multi-Layer Security","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Layer 1: Network Security                               \u2502\n\u2502                                                          \u2502\n\u2502 - VPC with private subnets                              \u2502\n\u2502 - Security groups (least privilege)                     \u2502\n\u2502 - NACLs                                                  \u2502\n\u2502 - TLS 1.3 for all connections                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Layer 2: Authentication &amp; Authorization                 \u2502\n\u2502                                                          \u2502\n\u2502 - JWT tokens for API authentication                     \u2502\n\u2502 - Row-Level Security in PostgreSQL                      \u2502\n\u2502 - RBAC (admin, manager, analyst, read-only)             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Layer 3: Data Protection                                \u2502\n\u2502                                                          \u2502\n\u2502 - Encryption at rest (AES-256)                          \u2502\n\u2502 - Encryption in transit (TLS 1.3)                       \u2502\n\u2502 - AWS Secrets Manager for credentials                   \u2502\n\u2502 - No secrets in code or logs                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Layer 4: Audit &amp; Compliance                             \u2502\n\u2502                                                          \u2502\n\u2502 - Immutable audit logs (7-year retention)               \u2502\n\u2502 - Credential access logging                             \u2502\n\u2502 - Agent action tracking                                 \u2502\n\u2502 - S3 Object Lock for archival                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/architecture/#row-level-security-rls","title":"Row-Level Security (RLS)","text":"<p>PostgreSQL RLS ensures users only access authorized data:</p> <pre><code>-- RLS Policy for trial_balances\nCREATE POLICY trial_balances_rls ON trial_balances\nUSING (\n  entity_id IN (\n    SELECT entity_id\n    FROM user_entity_access\n    WHERE user_id = current_user_id()\n      AND can_read = true\n  )\n);\n\n-- Enable RLS\nALTER TABLE trial_balances ENABLE ROW LEVEL SECURITY;\n</code></pre> <p>Users can only query entities they have explicit access to, enforced at the database level.</p>"},{"location":"getting-started/architecture/#scalability-performance","title":"Scalability &amp; Performance","text":""},{"location":"getting-started/architecture/#current-capacity-7-entities","title":"Current Capacity (7 Entities)","text":"Metric Value Consolidation Time &lt;5 seconds Database Size ~2 GB (current year) Query Response Time &lt;100ms (p95) API Throughput 1000 requests/min Concurrent Users 50"},{"location":"getting-started/architecture/#target-capacity-66-entities","title":"Target Capacity (66 Entities)","text":"Metric Value Consolidation Time &lt;60 seconds Database Size ~20 GB (7 years) Query Response Time &lt;200ms (p95) API Throughput 5000 requests/min Concurrent Users 200"},{"location":"getting-started/architecture/#scaling-strategies","title":"Scaling Strategies","text":""},{"location":"getting-started/architecture/#vertical-scaling-to-66-entities","title":"Vertical Scaling (to 66 entities)","text":"<ul> <li>Database: db.r6g.2xlarge (8 vCPU, 64 GB RAM)</li> <li>Application: ECS Fargate (8 vCPU, 16 GB RAM)</li> <li>Redis: cache.r6g.large (2 vCPU, 13 GB RAM)</li> </ul>"},{"location":"getting-started/architecture/#horizontal-scaling-beyond-100-entities","title":"Horizontal Scaling (beyond 100 entities)","text":"<ul> <li>Database: Citus extension (distributed PostgreSQL)</li> <li>Application: Auto-scaling ECS tasks (2-10 instances)</li> <li>Cache: Redis cluster mode (3-5 nodes)</li> <li>Task Queue: Celery workers (5-20 workers)</li> </ul>"},{"location":"getting-started/architecture/#performance-optimizations","title":"Performance Optimizations","text":"<ol> <li>Database Partitioning: Range partitioning by year (trial_balances, agent_actions)</li> <li>Covering Indexes: 80+ optimized indexes for common queries</li> <li>Connection Pooling: SQLAlchemy pool (10-20 connections)</li> <li>Query Optimization: Parallel query execution, index-only scans</li> <li>Caching: Redis caching for FX rates, CoA mappings</li> <li>Async I/O: httpx for ERP API calls (concurrent extraction)</li> </ol>"},{"location":"getting-started/architecture/#deployment-architecture","title":"Deployment Architecture","text":""},{"location":"getting-started/architecture/#aws-production-architecture","title":"AWS Production Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Internet                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502\n                        \u2193\n            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n            \u2502   Route 53 (DNS)      \u2502\n            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502\n                        \u2193\n            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n            \u2502   ALB (Load Balancer) \u2502\n            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                        \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                                \u2502\n        \u2193                                \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  ECS Task 1  \u2502                \u2502  ECS Task 2  \u2502\n\u2502  (FastAPI)   \u2502                \u2502  (FastAPI)   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502                                \u2502\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502           \u2502           \u2502\n        \u2193           \u2193           \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   RDS    \u2502  \u2502ElastiCache\u2502 \u2502    S3    \u2502\n\u2502PostgreSQL\u2502  \u2502  Redis   \u2502  \u2502 Reports  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n        \u2502           \u2502           \u2502\n        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                    \u2502\n        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n        \u2502                        \u2502\n        \u2193                        \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  CloudWatch  \u2502        \u2502    Lambda    \u2502\n\u2502  Monitoring  \u2502        \u2502   Triggers   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/architecture/#environment-configuration","title":"Environment Configuration","text":"Environment Purpose Infrastructure Development Local dev Docker Compose Staging Pre-prod testing AWS ECS (1 task) Production Live system AWS ECS (2+ tasks)"},{"location":"getting-started/architecture/#summary","title":"Summary","text":"<p>The AI FP&amp;A system architecture is designed for:</p> <ul> <li>\u2705 Scalability: Handle 7-66+ entities without redesign</li> <li>\u2705 Reliability: 99%+ uptime, automatic retry, circuit breakers</li> <li>\u2705 Security: Multi-layer security, RLS, encryption, audit logs</li> <li>\u2705 Performance: &lt;2 hour monthly close, &lt;100ms query response</li> <li>\u2705 Maintainability: Clear separation of concerns, comprehensive testing</li> <li>\u2705 Observability: Structured logging, monitoring, tracing</li> </ul> <p>Next Steps: Review Quick Start to see the architecture in action.</p>"},{"location":"getting-started/installation/","title":"Installation Guide","text":"<p>This guide walks through installing the AI FP&amp;A Monthly Close Automation system on your local machine or server.</p>"},{"location":"getting-started/installation/#prerequisites","title":"Prerequisites","text":"<p>Before starting, ensure you have completed the System Requirements checklist:</p> <ul> <li>\u2705 Python 3.13+ installed</li> <li>\u2705 PostgreSQL 15+ installed and running</li> <li>\u2705 Redis 7.0+ installed and running</li> <li>\u2705 API credentials for all ERP systems</li> <li>\u2705 Anthropic API key</li> </ul>"},{"location":"getting-started/installation/#installation-methods","title":"Installation Methods","text":"<p>Choose the installation method that best fits your needs:</p> <ul> <li>Local Development - For development and testing</li> <li>Production Deployment - For production on AWS</li> </ul>"},{"location":"getting-started/installation/#local-development-installation","title":"Local Development Installation","text":""},{"location":"getting-started/installation/#step-1-clone-the-repository","title":"Step 1: Clone the Repository","text":"<pre><code># Clone the repository\ngit clone https://github.com/nuvini/ai-fpna.git\ncd ai-fpna\n\n# Verify you're in the correct directory\npwd\n# Expected output: /path/to/ai-fpna\n</code></pre>"},{"location":"getting-started/installation/#step-2-create-python-virtual-environment","title":"Step 2: Create Python Virtual Environment","text":"<p>Using <code>venv</code> (built-in):</p> <pre><code># Create virtual environment\npython3 -m venv .venv\n\n# Activate virtual environment\n# On Linux/macOS:\nsource .venv/bin/activate\n\n# On Windows:\n.venv\\Scripts\\activate\n\n# Verify activation\nwhich python\n# Expected output: /path/to/ai-fpna/.venv/bin/python\n</code></pre> <p>Using <code>uv</code> (recommended, faster):</p> <pre><code># Install uv if not already installed\npip install uv\n\n# Create virtual environment with uv\nuv venv\n\n# Activate virtual environment\nsource .venv/bin/activate  # Linux/macOS\n.venv\\Scripts\\activate     # Windows\n</code></pre>"},{"location":"getting-started/installation/#step-3-install-python-dependencies","title":"Step 3: Install Python Dependencies","text":"<pre><code># Upgrade pip\npip install --upgrade pip\n\n# Install dependencies\npip install -r requirements.txt\n\n# Verify installation\npip list | grep fastapi\n# Expected output: fastapi 0.110.x or later\n</code></pre> <p>Expected installation time: 2-5 minutes (depending on network speed)</p>"},{"location":"getting-started/installation/#step-4-set-up-postgresql-database","title":"Step 4: Set Up PostgreSQL Database","text":""},{"location":"getting-started/installation/#create-database","title":"Create Database","text":"<pre><code># Connect to PostgreSQL as superuser\npsql -U postgres\n\n# Create database\nCREATE DATABASE ai_fpna_db;\n\n# Create application user\nCREATE USER fpna_app WITH PASSWORD 'your_secure_password_here';\n\n# Grant privileges\nGRANT ALL PRIVILEGES ON DATABASE ai_fpna_db TO fpna_app;\n\n# Exit psql\n\\q\n</code></pre>"},{"location":"getting-started/installation/#run-database-migrations","title":"Run Database Migrations","text":"<pre><code># Navigate to database directory\ncd database\n\n# Run migration scripts in order\npsql -U fpna_app -d ai_fpna_db -f migrations/001_initial_schema.sql\npsql -U fpna_app -d ai_fpna_db -f migrations/002_rls_policies.sql\npsql -U fpna_app -d ai_fpna_db -f migrations/003_indexes.sql\n\n# Verify tables were created\npsql -U fpna_app -d ai_fpna_db -c \"\\dt\"\n# Expected output: List of tables (portfolio_entities, trial_balances, etc.)\n\n# Return to project root\ncd ..\n</code></pre>"},{"location":"getting-started/installation/#load-seed-data","title":"Load Seed Data","text":"<pre><code># Load portfolio entities\npsql -U fpna_app -d ai_fpna_db -f database/seeds/001_portfolio_entities.sql\n\n# Load standard chart of accounts\npsql -U fpna_app -d ai_fpna_db -f database/seeds/002_standard_coa.sql\n\n# Verify seed data\npsql -U fpna_app -d ai_fpna_db -c \"SELECT entity_code, entity_name FROM portfolio_entities;\"\n# Expected output: 7 portfolio companies\n</code></pre>"},{"location":"getting-started/installation/#step-5-configure-redis","title":"Step 5: Configure Redis","text":""},{"location":"getting-started/installation/#start-redis-server","title":"Start Redis Server","text":"<pre><code># On Linux/macOS with Homebrew\nbrew services start redis\n\n# On Linux with systemd\nsudo systemctl start redis\n\n# On Windows (WSL2)\nsudo service redis-server start\n\n# Verify Redis is running\nredis-cli ping\n# Expected output: PONG\n</code></pre>"},{"location":"getting-started/installation/#test-redis-connection","title":"Test Redis Connection","text":"<pre><code># Connect to Redis\nredis-cli\n\n# Set test key\nSET test_key \"Hello FP&amp;A\"\n\n# Get test key\nGET test_key\n# Expected output: \"Hello FP&amp;A\"\n\n# Delete test key\nDEL test_key\n\n# Exit Redis CLI\nEXIT\n</code></pre>"},{"location":"getting-started/installation/#step-6-configure-environment-variables","title":"Step 6: Configure Environment Variables","text":"<p>Create a <code>.env</code> file in the project root:</p> <pre><code># Copy example environment file\ncp .env.example .env\n\n# Edit with your favorite editor\nnano .env  # or vim, code, etc.\n</code></pre> <p>Required environment variables:</p> <pre><code># Database Configuration\nDATABASE_URL=postgresql://fpna_app:your_secure_password_here@localhost:5432/ai_fpna_db\nDATABASE_POOL_SIZE=10\nDATABASE_MAX_OVERFLOW=20\n\n# Redis Configuration\nREDIS_URL=redis://localhost:6379/0\n\n# Anthropic API\nANTHROPIC_API_KEY=sk-ant-your-api-key-here\n\n# ERP Credentials - TOTVS Protheus\nTOTVS_CLIENT_ID=your_totvs_client_id\nTOTVS_CLIENT_SECRET=your_totvs_client_secret\nTOTVS_TENANT=your_tenant_id\nTOTVS_BASE_URL=https://api.totvs.com.br\n\n# ERP Credentials - ContaAzul\nCONTAAZUL_CLIENT_ID=your_contaazul_client_id\nCONTAAZUL_CLIENT_SECRET=your_contaazul_client_secret\nCONTAAZUL_BASE_URL=https://api.contaazul.com\n\n# ERP Credentials - Omie\nOMIE_APP_KEY=your_omie_app_key\nOMIE_APP_SECRET=your_omie_app_secret\nOMIE_BASE_URL=https://app.omie.com.br/api/v1\n\n# ERP Credentials - Bling\nBLING_API_KEY=your_bling_api_key\nBLING_BASE_URL=https://api.bling.com.br/Api/v3\n\n# Application Settings\nENVIRONMENT=development\nLOG_LEVEL=INFO\nSECRET_KEY=your-secret-key-change-in-production\nALLOWED_HOSTS=localhost,127.0.0.1\n\n# Email Configuration (optional)\nSMTP_HOST=smtp.gmail.com\nSMTP_PORT=587\nSMTP_USER=your_email@example.com\nSMTP_PASSWORD=your_email_password\n</code></pre> <p>Security Note: Never commit <code>.env</code> to version control. The <code>.gitignore</code> file already excludes it.</p>"},{"location":"getting-started/installation/#step-7-verify-installation","title":"Step 7: Verify Installation","text":"<p>Run the verification script:</p> <pre><code># Make verification script executable\nchmod +x scripts/verify_installation.sh\n\n# Run verification\n./scripts/verify_installation.sh\n</code></pre> <p>Expected output:</p> <pre><code>\u2713 Python version: 3.13.2\n\u2713 PostgreSQL connection: OK\n\u2713 Redis connection: OK\n\u2713 Database tables: 24 tables found\n\u2713 Seed data: 7 entities, 150 standard accounts\n\u2713 Environment variables: All required variables set\n\u2713 ERP connections: 4/4 accessible\n\u2713 Anthropic API: OK\n\nInstallation verification: PASSED\n</code></pre>"},{"location":"getting-started/installation/#step-8-run-tests","title":"Step 8: Run Tests","text":"<pre><code># Run all tests\npytest\n\n# Run with coverage report\npytest --cov=src --cov-report=html\n\n# Open coverage report\nopen htmlcov/index.html  # macOS\nxdg-open htmlcov/index.html  # Linux\n</code></pre> <p>Expected output:</p> <pre><code>============================= test session starts ==============================\ncollected 127 items\n\ntests/test_connectors.py ...................... [ 17%]\ntests/test_consolidation.py ...................... [ 33%]\ntests/test_fx_converter.py ............ [ 42%]\ntests/test_validation.py ................ [ 54%]\ntests/integration/test_full_close.py .................... [ 70%]\n...\n\n============================= 127 passed in 45.2s ==============================\n</code></pre>"},{"location":"getting-started/installation/#step-9-start-application","title":"Step 9: Start Application","text":""},{"location":"getting-started/installation/#start-celery-worker-terminal-1","title":"Start Celery Worker (Terminal 1)","text":"<pre><code># Activate virtual environment\nsource .venv/bin/activate\n\n# Start Celery worker\ncelery -A src.orchestration.celery_app worker --loglevel=info\n</code></pre> <p>Expected output:</p> <pre><code>[2026-02-07 10:00:00,000: INFO/MainProcess] Connected to redis://localhost:6379/0\n[2026-02-07 10:00:00,050: INFO/MainProcess] celery@hostname ready.\n</code></pre>"},{"location":"getting-started/installation/#start-fastapi-application-terminal-2","title":"Start FastAPI Application (Terminal 2)","text":"<pre><code># Activate virtual environment\nsource .venv/bin/activate\n\n# Start FastAPI development server\nuvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000\n</code></pre> <p>Expected output:</p> <pre><code>INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)\nINFO:     Started reloader process [12345] using WatchFiles\nINFO:     Started server process [12346]\nINFO:     Waiting for application startup.\nINFO:     Application startup complete.\n</code></pre>"},{"location":"getting-started/installation/#verify-api-is-running","title":"Verify API is Running","text":"<p>Open a web browser and navigate to:</p> <ul> <li>API Documentation: http://localhost:8000/docs</li> <li>Health Check: http://localhost:8000/health</li> </ul> <p>Expected health check response:</p> <pre><code>{\n  \"status\": \"healthy\",\n  \"database\": \"connected\",\n  \"redis\": \"connected\",\n  \"version\": \"1.0.0\"\n}\n</code></pre>"},{"location":"getting-started/installation/#production-deployment","title":"Production Deployment","text":"<p>For production deployment on AWS, follow these steps:</p>"},{"location":"getting-started/installation/#step-1-aws-infrastructure-setup","title":"Step 1: AWS Infrastructure Setup","text":""},{"location":"getting-started/installation/#create-rds-postgresql-instance","title":"Create RDS PostgreSQL Instance","text":"<pre><code># Using AWS CLI\naws rds create-db-instance \\\n  --db-instance-identifier fpna-postgres \\\n  --db-instance-class db.r6g.xlarge \\\n  --engine postgres \\\n  --engine-version 15.5 \\\n  --master-username fpna_admin \\\n  --master-user-password \"your_secure_password\" \\\n  --allocated-storage 100 \\\n  --storage-type gp3 \\\n  --storage-encrypted \\\n  --backup-retention-period 7 \\\n  --multi-az \\\n  --vpc-security-group-ids sg-xxxxxxxxx \\\n  --db-subnet-group-name fpna-db-subnet-group\n</code></pre>"},{"location":"getting-started/installation/#create-elasticache-redis","title":"Create ElastiCache Redis","text":"<pre><code># Using AWS CLI\naws elasticache create-cache-cluster \\\n  --cache-cluster-id fpna-redis \\\n  --cache-node-type cache.t3.medium \\\n  --engine redis \\\n  --engine-version 7.0 \\\n  --num-cache-nodes 1 \\\n  --security-group-ids sg-xxxxxxxxx \\\n  --cache-subnet-group-name fpna-redis-subnet-group\n</code></pre>"},{"location":"getting-started/installation/#create-s3-buckets","title":"Create S3 Buckets","text":"<pre><code># Create bucket for reports\naws s3 mb s3://fpna-reports-prod --region us-east-1\n\n# Create bucket for archival\naws s3 mb s3://fpna-archive-prod --region us-east-1\n\n# Enable versioning on reports bucket\naws s3api put-bucket-versioning \\\n  --bucket fpna-reports-prod \\\n  --versioning-configuration Status=Enabled\n</code></pre>"},{"location":"getting-started/installation/#step-2-store-secrets-in-aws-secrets-manager","title":"Step 2: Store Secrets in AWS Secrets Manager","text":"<pre><code># Store database credentials\naws secretsmanager create-secret \\\n  --name fpna/prod/database \\\n  --secret-string '{\n    \"username\": \"fpna_admin\",\n    \"password\": \"your_secure_password\",\n    \"host\": \"fpna-postgres.xxxxxxxx.us-east-1.rds.amazonaws.com\",\n    \"port\": \"5432\",\n    \"database\": \"ai_fpna_db\"\n  }'\n\n# Store Anthropic API key\naws secretsmanager create-secret \\\n  --name fpna/prod/anthropic \\\n  --secret-string '{\"api_key\": \"sk-ant-your-api-key-here\"}'\n\n# Store ERP credentials\naws secretsmanager create-secret \\\n  --name fpna/prod/erp-credentials \\\n  --secret-string '{\n    \"totvs\": {\n      \"client_id\": \"...\",\n      \"client_secret\": \"...\"\n    },\n    \"contaazul\": {\n      \"client_id\": \"...\",\n      \"client_secret\": \"...\"\n    },\n    \"omie\": {\n      \"app_key\": \"...\",\n      \"app_secret\": \"...\"\n    },\n    \"bling\": {\n      \"api_key\": \"...\"\n    }\n  }'\n</code></pre>"},{"location":"getting-started/installation/#step-3-build-and-push-docker-image","title":"Step 3: Build and Push Docker Image","text":"<pre><code># Build Docker image\ndocker build -t fpna-app:latest .\n\n# Tag for ECR\ndocker tag fpna-app:latest 123456789012.dkr.ecr.us-east-1.amazonaws.com/fpna-app:latest\n\n# Login to ECR\naws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.us-east-1.amazonaws.com\n\n# Push image\ndocker push 123456789012.dkr.ecr.us-east-1.amazonaws.com/fpna-app:latest\n</code></pre>"},{"location":"getting-started/installation/#step-4-deploy-to-ecs","title":"Step 4: Deploy to ECS","text":"<pre><code># Create ECS cluster\naws ecs create-cluster --cluster-name fpna-prod-cluster\n\n# Register task definition\naws ecs register-task-definition --cli-input-json file://ecs/task-definition.json\n\n# Create ECS service\naws ecs create-service \\\n  --cluster fpna-prod-cluster \\\n  --service-name fpna-app \\\n  --task-definition fpna-app:1 \\\n  --desired-count 2 \\\n  --launch-type FARGATE \\\n  --network-configuration \"awsvpcConfiguration={subnets=[subnet-xxx,subnet-yyy],securityGroups=[sg-zzz],assignPublicIp=ENABLED}\" \\\n  --load-balancers \"targetGroupArn=arn:aws:elasticloadbalancing:us-east-1:123456789012:targetgroup/fpna-tg/xxx,containerName=fpna-app,containerPort=8000\"\n</code></pre>"},{"location":"getting-started/installation/#step-5-run-database-migrations","title":"Step 5: Run Database Migrations","text":"<pre><code># Connect to RDS instance\npsql -h fpna-postgres.xxxxxxxx.us-east-1.rds.amazonaws.com -U fpna_admin -d ai_fpna_db\n\n# Run migrations\n\\i migrations/001_initial_schema.sql\n\\i migrations/002_rls_policies.sql\n\\i migrations/003_indexes.sql\n\n# Load seed data\n\\i seeds/001_portfolio_entities.sql\n\\i seeds/002_standard_coa.sql\n\n# Exit psql\n\\q\n</code></pre>"},{"location":"getting-started/installation/#step-6-verify-production-deployment","title":"Step 6: Verify Production Deployment","text":"<pre><code># Check ECS service status\naws ecs describe-services --cluster fpna-prod-cluster --services fpna-app\n\n# Check health endpoint\ncurl https://api.fpna.nuvini.ai/health\n\n# Check CloudWatch logs\naws logs tail /ecs/fpna-app --follow\n</code></pre>"},{"location":"getting-started/installation/#post-installation-configuration","title":"Post-Installation Configuration","text":""},{"location":"getting-started/installation/#configure-scheduled-jobs","title":"Configure Scheduled Jobs","text":""},{"location":"getting-started/installation/#monthly-close-trigger","title":"Monthly Close Trigger","text":"<pre><code># Create Lambda function for monthly trigger\naws lambda create-function \\\n  --function-name fpna-monthly-trigger \\\n  --runtime python3.13 \\\n  --handler lambda_function.lambda_handler \\\n  --role arn:aws:iam::123456789012:role/fpna-lambda-role \\\n  --code S3Bucket=fpna-deployments,S3Key=monthly-trigger.zip\n\n# Create EventBridge rule (trigger on 1st of each month at 6 AM UTC)\naws events put-rule \\\n  --name fpna-monthly-close \\\n  --schedule-expression \"cron(0 6 1 * ? *)\" \\\n  --state ENABLED\n\n# Add Lambda target to rule\naws events put-targets \\\n  --rule fpna-monthly-close \\\n  --targets \"Id\"=\"1\",\"Arn\"=\"arn:aws:lambda:us-east-1:123456789012:function:fpna-monthly-trigger\"\n</code></pre>"},{"location":"getting-started/installation/#configure-monitoring","title":"Configure Monitoring","text":""},{"location":"getting-started/installation/#cloudwatch-alarms","title":"CloudWatch Alarms","text":"<pre><code># Database connection errors\naws cloudwatch put-metric-alarm \\\n  --alarm-name fpna-db-connection-errors \\\n  --alarm-description \"Alert when DB connection errors exceed threshold\" \\\n  --metric-name DatabaseConnectionErrors \\\n  --namespace FPNA \\\n  --statistic Sum \\\n  --period 300 \\\n  --threshold 5 \\\n  --comparison-operator GreaterThanThreshold \\\n  --evaluation-periods 1 \\\n  --alarm-actions arn:aws:sns:us-east-1:123456789012:fpna-alerts\n\n# Consolidation failures\naws cloudwatch put-metric-alarm \\\n  --alarm-name fpna-consolidation-failures \\\n  --alarm-description \"Alert when consolidation fails\" \\\n  --metric-name ConsolidationErrors \\\n  --namespace FPNA \\\n  --statistic Sum \\\n  --period 300 \\\n  --threshold 1 \\\n  --comparison-operator GreaterThanThreshold \\\n  --evaluation-periods 1 \\\n  --alarm-actions arn:aws:sns:us-east-1:123456789012:fpna-alerts\n</code></pre>"},{"location":"getting-started/installation/#create-admin-user","title":"Create Admin User","text":"<pre><code># Connect to database\npsql -h localhost -U fpna_app -d ai_fpna_db\n\n# Create admin user\nINSERT INTO users (user_id, email, full_name, role, is_active)\nVALUES (\n  gen_random_uuid(),\n  'admin@nuvini.ai',\n  'FP&amp;A Administrator',\n  'admin',\n  true\n);\n\n# Grant access to all entities\nINSERT INTO user_entity_access (user_id, entity_id, can_read, can_write, can_approve)\nSELECT\n  (SELECT user_id FROM users WHERE email = 'admin@nuvini.ai'),\n  entity_id,\n  true,\n  true,\n  true\nFROM portfolio_entities;\n\n# Exit psql\n\\q\n</code></pre>"},{"location":"getting-started/installation/#troubleshooting","title":"Troubleshooting","text":""},{"location":"getting-started/installation/#database-connection-issues","title":"Database Connection Issues","text":"<p>Problem: Cannot connect to PostgreSQL</p> <pre><code># Check if PostgreSQL is running\npg_isready -h localhost -p 5432\n\n# Check PostgreSQL logs\ntail -f /usr/local/var/log/postgres.log  # macOS\nsudo tail -f /var/log/postgresql/postgresql-15-main.log  # Linux\n\n# Test connection with psql\npsql -U fpna_app -d ai_fpna_db -h localhost\n</code></pre>"},{"location":"getting-started/installation/#redis-connection-issues","title":"Redis Connection Issues","text":"<p>Problem: Cannot connect to Redis</p> <pre><code># Check if Redis is running\nredis-cli ping\n\n# Check Redis logs\ntail -f /usr/local/var/log/redis.log  # macOS\nsudo tail -f /var/log/redis/redis-server.log  # Linux\n\n# Restart Redis\nbrew services restart redis  # macOS\nsudo systemctl restart redis  # Linux\n</code></pre>"},{"location":"getting-started/installation/#import-errors","title":"Import Errors","text":"<p>Problem: <code>ModuleNotFoundError</code> when running the application</p> <pre><code># Verify virtual environment is activated\nwhich python\n# Should show: /path/to/.venv/bin/python\n\n# Reinstall dependencies\npip install --force-reinstall -r requirements.txt\n\n# Check installed packages\npip list\n</code></pre>"},{"location":"getting-started/installation/#migration-errors","title":"Migration Errors","text":"<p>Problem: Database migration fails</p> <pre><code># Check PostgreSQL version\npsql --version\n\n# Verify database exists\npsql -U postgres -l | grep ai_fpna_db\n\n# Check for existing tables\npsql -U fpna_app -d ai_fpna_db -c \"\\dt\"\n\n# Drop and recreate database (CAUTION: destroys data)\ndropdb ai_fpna_db\ncreatedb ai_fpna_db\n</code></pre>"},{"location":"getting-started/installation/#permission-denied-errors","title":"Permission Denied Errors","text":"<p>Problem: Permission denied when running scripts</p> <pre><code># Make scripts executable\nchmod +x scripts/*.sh\n\n# Check file ownership\nls -la scripts/\n\n# Fix ownership if needed\nsudo chown $(whoami) scripts/*.sh\n</code></pre>"},{"location":"getting-started/installation/#next-steps","title":"Next Steps","text":"<p>After successful installation:</p> <ol> <li>Quick Start - Run your first consolidation</li> <li>User Guide - Learn how to use the system</li> <li>API Documentation - Integrate with other systems</li> </ol>"},{"location":"getting-started/installation/#support","title":"Support","text":"<p>For installation issues:</p> <ul> <li>Documentation: Review this guide and Requirements</li> <li>GitHub Issues: File a bug report</li> <li>Email: support@nuvini.ai</li> </ul>"},{"location":"getting-started/overview/","title":"System Overview","text":""},{"location":"getting-started/overview/#introduction","title":"Introduction","text":"<p>The AI FP&amp;A Monthly Close Automation system is an enterprise-grade platform designed to automate the monthly financial close process for Nuvini Group's portfolio of companies. Built on cutting-edge AI technology, the system reduces monthly close time from 40 hours to under 2 hours while maintaining 99%+ accuracy.</p>"},{"location":"getting-started/overview/#what-problem-does-it-solve","title":"What Problem Does It Solve?","text":"<p>Traditional financial consolidation for multi-entity groups is:</p> <ul> <li>Time-consuming: 40+ hours of manual work per month</li> <li>Error-prone: Manual data entry and calculations introduce errors</li> <li>Not scalable: Each new acquisition requires additional headcount</li> <li>Delayed insights: Financial reports arrive weeks after month-end</li> </ul> <p>The AI FP&amp;A system automates this entire process, enabling:</p> <ul> <li>96% reduction in close time: From 40 hours to 1.5 hours</li> <li>99%+ accuracy: Consistent, reliable financial statements</li> <li>Infinite scalability: Add new entities with zero marginal cost</li> <li>Real-time insights: Financial results available hours after month-end</li> </ul>"},{"location":"getting-started/overview/#portfolio-companies","title":"Portfolio Companies","text":"<p>The system currently manages financial consolidation for 7 portfolio companies:</p> Company Industry ERP System Location Effecti SaaS TOTVS Protheus Brazil Mercos B2B Platform ContaAzul Brazil Datahub Data Services Omie Brazil OnClick Digital Marketing TOTVS Protheus Brazil Ip\u00ea Digital E-commerce Bling Brazil Munddi Logistics Tech ContaAzul Brazil Leadlovers Marketing Automation Bling Brazil <p>The architecture supports scaling to 66+ entities without performance degradation.</p>"},{"location":"getting-started/overview/#key-capabilities","title":"Key Capabilities","text":""},{"location":"getting-started/overview/#1-multi-erp-data-ingestion","title":"1. Multi-ERP Data Ingestion","text":"<p>Automatically extracts trial balances from four different ERP systems:</p> <ul> <li>TOTVS Protheus - Enterprise ERP (REST API)</li> <li>ContaAzul - Cloud accounting (OAuth 2.0)</li> <li>Omie - SMB ERP (API Key)</li> <li>Bling - E-commerce ERP (JSON API)</li> </ul> <p>Each connector handles authentication, rate limiting, retry logic, and data validation automatically.</p>"},{"location":"getting-started/overview/#2-ifrsus-gaap-compliant-consolidation","title":"2. IFRS/US GAAP Compliant Consolidation","text":"<p>Full-featured consolidation engine implementing:</p> <ul> <li>IFRS 10: Consolidated Financial Statements</li> <li>IFRS 3: Business Combinations (Purchase Price Allocation)</li> <li>IFRS 21: Foreign Currency Translation (BRL \u2192 USD)</li> <li>US GAAP ASC 810/805/830: Dual reporting capability</li> </ul> <p>The system handles: - Multi-currency FX conversion - Intercompany elimination (receivables, payables, revenue, expense) - Purchase Price Allocation (goodwill, intangibles amortization) - Cumulative Translation Adjustment (CTA) tracking</p>"},{"location":"getting-started/overview/#3-ai-powered-variance-analysis","title":"3. AI-Powered Variance Analysis","text":"<p>Claude Sonnet 4.5 / Opus 4.6 analyzes financial results and generates:</p> <ul> <li>Budget vs. Actual variance commentary: Why did revenue increase 15%?</li> <li>Month-over-month trends: What drove expense changes?</li> <li>KPI calculations: ARR, MRR, NRR, churn, Rule of 40</li> <li>Anomaly detection: Unusual patterns flagged for review</li> </ul> <p>The AI provides management-ready explanations, not just numbers.</p>"},{"location":"getting-started/overview/#4-automated-report-generation","title":"4. Automated Report Generation","text":"<p>Generates presentation-ready financial reports:</p> <ul> <li>Excel: Consolidated P&amp;L, Balance Sheet, Cash Flow Statement</li> <li>PowerPoint: Executive summary with charts and commentary</li> <li>PDF: Board-ready financial packages</li> <li>Email Distribution: Automatic delivery to stakeholders</li> </ul> <p>All reports are generated automatically within minutes of close completion.</p>"},{"location":"getting-started/overview/#5-human-in-the-loop-confidence-scoring","title":"5. Human-in-the-Loop Confidence Scoring","text":"<p>The system assigns confidence scores to every calculation:</p> <ul> <li>Green (95-100%): High confidence, auto-approve</li> <li>Yellow (80-94%): Medium confidence, human review recommended</li> <li>Red (&lt;80%): Low confidence, manual validation required</li> </ul> <p>This ensures accuracy while minimizing manual review time.</p>"},{"location":"getting-started/overview/#high-level-architecture","title":"High-Level Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    AI FP&amp;A System                            \u2502\n\u2502                                                               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502         Data Ingestion Layer                         \u2502   \u2502\n\u2502  \u2502                                                        \u2502   \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502   \u2502\n\u2502  \u2502  \u2502 TOTVS   \u2502  \u2502ContaAzul\u2502  \u2502  Omie   \u2502  \u2502  Bling  \u2502 \u2502   \u2502\n\u2502  \u2502  \u2502Connector\u2502  \u2502Connector\u2502  \u2502Connector\u2502  \u2502Connector\u2502 \u2502   \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502   \u2502\n\u2502  \u2502        \u2193            \u2193            \u2193            \u2193       \u2502   \u2502\n\u2502  \u2502  Authentication | Retry Logic | Validation          \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                           \u2193                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502         Consolidation Engine                         \u2502   \u2502\n\u2502  \u2502                                                        \u2502   \u2502\n\u2502  \u2502  \u2022 FX Conversion (BRL\u2192USD, BCB PTAX rates)           \u2502   \u2502\n\u2502  \u2502  \u2022 Intercompany Elimination (AR/AP, Revenue/Expense) \u2502   \u2502\n\u2502  \u2502  \u2022 PPA Amortization (Goodwill, Intangibles)          \u2502   \u2502\n\u2502  \u2502  \u2022 IFRS/US GAAP Reconciliation                       \u2502   \u2502\n\u2502  \u2502  \u2022 Validation (99.9% accuracy target)                \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                           \u2193                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502         Analysis &amp; Reporting Layer                   \u2502   \u2502\n\u2502  \u2502                                                        \u2502   \u2502\n\u2502  \u2502  \u2022 Claude AI Variance Analysis                       \u2502   \u2502\n\u2502  \u2502  \u2022 SaaS KPI Calculations                             \u2502   \u2502\n\u2502  \u2502  \u2022 Excel/PowerPoint Report Generation                \u2502   \u2502\n\u2502  \u2502  \u2022 PDF Export &amp; Distribution                         \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                           \u2193                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502         PostgreSQL Database                          \u2502   \u2502\n\u2502  \u2502                                                        \u2502   \u2502\n\u2502  \u2502  \u2022 Trial Balances (Partitioned by Year)              \u2502   \u2502\n\u2502  \u2502  \u2022 Consolidated Financials                           \u2502   \u2502\n\u2502  \u2502  \u2022 Chart of Accounts Mapping                         \u2502   \u2502\n\u2502  \u2502  \u2022 Audit Trail (7-Year Retention)                    \u2502   \u2502\n\u2502  \u2502  \u2022 Row-Level Security (Multi-Tenant)                 \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"getting-started/overview/#key-concepts","title":"Key Concepts","text":""},{"location":"getting-started/overview/#standard-chart-of-accounts","title":"Standard Chart of Accounts","text":"<p>The system uses a master Standard Chart of Accounts (150-200 accounts) that all entities map to. This enables consolidation across different local accounting practices.</p> <p>Example mapping:</p> <ul> <li>Standard: <code>1210 - Accounts Receivable - Trade</code></li> <li>Effecti (local): <code>1.01.01.001 - Contas a Receber - Clientes</code></li> <li>Mercos (local): <code>1.1.1.1 - Clientes a Receber</code></li> </ul> <p>AI-assisted mapping with 95%+ confidence.</p>"},{"location":"getting-started/overview/#multi-currency-translation","title":"Multi-Currency Translation","text":"<p>All entities report in Brazilian Reais (BRL), consolidated to US Dollars (USD):</p> <ul> <li>Balance Sheet items: Closing rate at period end (e.g., 5.20 BRL/USD)</li> <li>P&amp;L items: Average rate for the period (e.g., 5.15 BRL/USD)</li> <li>Equity items: Historical rate at transaction date</li> <li>CTA: Cumulative Translation Adjustment tracked in equity</li> </ul> <p>FX rates sourced from BCB (Brazilian Central Bank) PTAX daily.</p>"},{"location":"getting-started/overview/#intercompany-elimination","title":"Intercompany Elimination","text":"<p>The system automatically identifies and eliminates intercompany transactions:</p> <ul> <li>Receivables/Payables: Matched by invoice reference and amount</li> <li>Revenue/Expense: Matched by entity relationship</li> <li>Tolerance: \u00b11% for FX differences</li> </ul> <p>This ensures consolidated financials don't double-count internal transactions.</p>"},{"location":"getting-started/overview/#purchase-price-allocation-ppa","title":"Purchase Price Allocation (PPA)","text":"<p>For each acquired entity, the system tracks:</p> <ul> <li>Goodwill: Purchase price minus fair value of net assets</li> <li>Intangible Assets: Customer relationships, technology, brand</li> <li>Amortization: Monthly straight-line over useful life</li> <li>Impairment Testing: Annual qualitative and quantitative tests</li> </ul> <p>PPA entries are automatically generated each month.</p>"},{"location":"getting-started/overview/#confidence-scoring","title":"Confidence Scoring","text":"<p>Every calculation receives an AI-generated confidence score:</p> <ul> <li>Data completeness: Are all accounts present?</li> <li>Balance checks: Does the balance sheet balance?</li> <li>Variance reasonableness: Are changes explainable?</li> <li>Pattern consistency: Do trends make sense?</li> </ul> <p>Low confidence items are flagged for human review.</p>"},{"location":"getting-started/overview/#technology-stack","title":"Technology Stack","text":""},{"location":"getting-started/overview/#core-technologies","title":"Core Technologies","text":"<ul> <li>Language: Python 3.13+</li> <li>AI Model: Claude Sonnet 4.5 / Opus 4.6 (Anthropic)</li> <li>Database: PostgreSQL 15+</li> <li>API Framework: FastAPI</li> <li>Task Queue: Celery + Redis</li> <li>Deployment: AWS (ECS/EKS)</li> </ul>"},{"location":"getting-started/overview/#key-libraries","title":"Key Libraries","text":"<ul> <li>httpx: Async HTTP client for ERP connectors</li> <li>sqlalchemy: Database ORM</li> <li>pydantic: Data validation</li> <li>openpyxl: Excel generation</li> <li>python-pptx: PowerPoint generation</li> <li>pandas: Data manipulation</li> <li>pytest: Testing framework</li> </ul>"},{"location":"getting-started/overview/#infrastructure","title":"Infrastructure","text":"<ul> <li>AWS RDS: Managed PostgreSQL</li> <li>AWS Secrets Manager: Credential storage</li> <li>AWS S3: Report storage and archival</li> <li>AWS CloudWatch: Monitoring and logging</li> <li>AWS Lambda: Scheduled triggers</li> </ul>"},{"location":"getting-started/overview/#system-benefits","title":"System Benefits","text":""},{"location":"getting-started/overview/#for-fpa-teams","title":"For FP&amp;A Teams","text":"<ul> <li>96% time savings: Focus on analysis instead of data entry</li> <li>Real-time insights: Financial results available hours after close</li> <li>Audit trail: Complete history of all calculations and adjustments</li> <li>Error reduction: Eliminate manual calculation mistakes</li> </ul>"},{"location":"getting-started/overview/#for-cfos","title":"For CFOs","text":"<ul> <li>Faster decision-making: Timely financial information</li> <li>Scalability: Support M&amp;A growth without additional headcount</li> <li>Compliance: IFRS and US GAAP compliant out-of-the-box</li> <li>Transparency: Full visibility into consolidation process</li> </ul>"},{"location":"getting-started/overview/#for-it-teams","title":"For IT Teams","text":"<ul> <li>Low maintenance: Automated orchestration, minimal manual intervention</li> <li>Secure: Row-Level Security, credential encryption, audit logging</li> <li>Extensible: Modular architecture supports new ERPs and requirements</li> <li>Observable: Comprehensive monitoring and alerting</li> </ul>"},{"location":"getting-started/overview/#success-metrics","title":"Success Metrics","text":"Metric Current (Manual) Target (AI) Status Monthly Close Time 40 hours 1.5 hours \u2705 Target met Accuracy 95-98% 99%+ \u2705 Target met Human Review Time 40 hours 3 hours \u2705 Target met System Uptime N/A 99%+ \u2705 Target met Processing Time N/A &lt;2 hours (all 7 companies) \u2705 Target met Scalability +1 FTE per 3 companies Zero marginal cost \u2705 Validated"},{"location":"getting-started/overview/#next-steps","title":"Next Steps","text":"<p>To get started with the AI FP&amp;A system:</p> <ol> <li>Requirements - Verify system requirements and prerequisites</li> <li>Installation - Install and configure the system</li> <li>Quick Start - Run your first consolidation</li> <li>Architecture - Deep dive into system architecture</li> </ol>"},{"location":"getting-started/overview/#support","title":"Support","text":"<p>For questions or issues:</p> <ul> <li>Documentation: <code>/Volumes/AI/Code/FPA/manual/</code></li> <li>Technical Reference: <code>/Volumes/AI/Code/FPA/manual/technical-reference/</code></li> <li>GitHub Issues: Internal repository issue tracker</li> </ul> <p>Built for Nuvini Group Limited Supporting 7+ portfolio companies with enterprise-grade financial consolidation.</p>"},{"location":"getting-started/quick-start/","title":"Quick Start Tutorial","text":"<p>This tutorial walks you through running your first monthly consolidation using the AI FP&amp;A system.</p>"},{"location":"getting-started/quick-start/#prerequisites","title":"Prerequisites","text":"<p>Ensure you have completed:</p> <ol> <li>\u2705 Installation - System installed and verified</li> <li>\u2705 Database seeded with portfolio entities and standard CoA</li> <li>\u2705 ERP credentials configured in <code>.env</code></li> <li>\u2705 Application and Celery worker running</li> </ol>"},{"location":"getting-started/quick-start/#tutorial-overview","title":"Tutorial Overview","text":"<p>In this tutorial, you will:</p> <ol> <li>Extract trial balances from Effecti's ERP (TOTVS Protheus)</li> <li>Run a simple consolidation for a single entity</li> <li>View the consolidated financial statements</li> <li>Export results to Excel</li> <li>Run a full 7-entity consolidation</li> </ol> <p>Estimated time: 15-20 minutes</p>"},{"location":"getting-started/quick-start/#part-1-extract-trial-balance-from-one-entity","title":"Part 1: Extract Trial Balance from One Entity","text":""},{"location":"getting-started/quick-start/#step-1-start-python-interactive-shell","title":"Step 1: Start Python Interactive Shell","text":"<pre><code># Activate virtual environment\nsource .venv/bin/activate\n\n# Start Python shell\npython\n</code></pre>"},{"location":"getting-started/quick-start/#step-2-extract-trial-balance","title":"Step 2: Extract Trial Balance","text":"<pre><code>from datetime import datetime, date\nfrom src.connectors import create_connector\n\n# Create TOTVS connector for Effecti\nconnector = create_connector(\n    erp_type=\"totvs_protheus\",\n    auth_type=\"oauth2\",\n    credentials={\n        \"client_id\": \"your_totvs_client_id\",\n        \"client_secret\": \"your_totvs_client_secret\"\n    },\n    config={\n        \"base_url\": \"https://api.totvs.com.br\",\n        \"tenant\": \"your_tenant_id\"\n    }\n)\n\n# Extract trial balance for January 2026\nasync def extract_trial_balance():\n    async with connector:\n        # Check connection health\n        health = await connector.health_check()\n        print(f\"Connection status: {health.status}\")\n        print(f\"Latency: {health.latency_ms}ms\")\n\n        # Get trial balance\n        trial_balance = await connector.get_trial_balance(\n            company_id=\"01\",\n            period_start=datetime(2026, 1, 1),\n            period_end=datetime(2026, 1, 31)\n        )\n\n        return trial_balance\n\n# Run extraction\nimport asyncio\ntrial_balance = asyncio.run(extract_trial_balance())\n\n# Display summary\nprint(f\"\\nTrial Balance Extracted:\")\nprint(f\"Company: {trial_balance.company_name}\")\nprint(f\"Period: {trial_balance.period_start} to {trial_balance.period_end}\")\nprint(f\"Currency: {trial_balance.currency}\")\nprint(f\"Number of accounts: {len(trial_balance.accounts)}\")\nprint(f\"\\nSample accounts:\")\nfor account in trial_balance.accounts[:5]:\n    print(f\"  {account.account_code} - {account.account_name}: {account.closing_balance:,.2f}\")\n</code></pre> <p>Expected output:</p> <pre><code>Connection status: healthy\nLatency: 45ms\n\nTrial Balance Extracted:\nCompany: Effecti\nPeriod: 2026-01-01 00:00:00 to 2026-01-31 00:00:00\nCurrency: BRL\nNumber of accounts: 187\n\nSample accounts:\n  1.01.001 - Caixa: 125,430.50\n  1.01.002 - Bancos: 2,340,567.89\n  1.02.001 - Contas a Receber: 1,890,234.12\n  1.03.001 - Estoque: 456,789.00\n  2.01.001 - Fornecedores: -890,456.78\n</code></pre>"},{"location":"getting-started/quick-start/#step-3-save-trial-balance-to-database","title":"Step 3: Save Trial Balance to Database","text":"<pre><code>from src.database import SessionLocal\nfrom src.models import TrialBalanceEntry, AccountType\nfrom decimal import Decimal\n\n# Create database session\ndb = SessionLocal()\n\n# Map trial balance to database format\nfor account in trial_balance.accounts:\n    entry = TrialBalanceEntry(\n        entity_id=\"effecti-entity-id\",  # From portfolio_entities table\n        period_year=2026,\n        period_month=1,\n        period_end_date=date(2026, 1, 31),\n        entity_account_id=account.account_code,\n        account_type=account.account_type,\n        opening_balance=Decimal(str(account.opening_balance)),\n        debit_amount=Decimal(str(account.debit_amount)),\n        credit_amount=Decimal(str(account.credit_amount)),\n        ending_balance=Decimal(str(account.closing_balance)),\n        currency=trial_balance.currency\n    )\n    db.add(entry)\n\n# Commit to database\ndb.commit()\nprint(f\"\u2713 Saved {len(trial_balance.accounts)} accounts to database\")\n\n# Close session\ndb.close()\n</code></pre> <p>Expected output:</p> <pre><code>\u2713 Saved 187 accounts to database\n</code></pre>"},{"location":"getting-started/quick-start/#part-2-run-simple-consolidation","title":"Part 2: Run Simple Consolidation","text":""},{"location":"getting-started/quick-start/#step-4-run-single-entity-consolidation","title":"Step 4: Run Single-Entity Consolidation","text":"<pre><code>from src.consolidation import QuickConsolidator, Entity, Currency\nfrom decimal import Decimal\n\n# Create consolidator\nconsolidator = QuickConsolidator()\n\n# Define Effecti entity\neffecti = Entity(\n    entity_id=\"effecti-entity-id\",\n    name=\"Effecti\",\n    functional_currency=Currency.BRL,\n    ownership_percentage=Decimal(\"100\"),\n    country_code=\"BR\",\n    acquisition_date=date(2024, 3, 15)\n)\n\n# Load trial balance from database\nfrom src.database import SessionLocal\ndb = SessionLocal()\n\ntrial_balances = {\n    \"effecti\": db.query(TrialBalanceEntry).filter(\n        TrialBalanceEntry.entity_id == effecti.entity_id,\n        TrialBalanceEntry.period_year == 2026,\n        TrialBalanceEntry.period_month == 1\n    ).all()\n}\n\n# Run consolidation\nresult = consolidator.quick_consolidate(\n    entities=[effecti],\n    trial_balances=trial_balances,\n    period_end_date=date(2026, 1, 31),\n    period_start_date=date(2026, 1, 1),\n    presentation_currency=Currency.USD\n)\n\nprint(f\"\\n\u2713 Consolidation complete\")\nprint(f\"Consolidation ID: {result.consolidation_id}\")\nprint(f\"Status: {result.status}\")\n</code></pre> <p>Expected output:</p> <pre><code>\u2713 Consolidation complete\nConsolidation ID: cons-20260131-effecti\nStatus: completed\n</code></pre>"},{"location":"getting-started/quick-start/#step-5-view-consolidated-balance-sheet","title":"Step 5: View Consolidated Balance Sheet","text":"<pre><code># Extract Balance Sheet\nfrom src.models import AccountType\n\nbalance_sheet = result.consolidated_balances[\n    result.consolidated_balances['account_type'].isin([\n        AccountType.BALANCE_SHEET_ASSET,\n        AccountType.BALANCE_SHEET_LIABILITY,\n        AccountType.BALANCE_SHEET_EQUITY\n    ])\n]\n\n# Calculate totals\nassets = balance_sheet[\n    balance_sheet['account_type'] == AccountType.BALANCE_SHEET_ASSET\n]['ending_balance'].sum()\n\nliabilities = balance_sheet[\n    balance_sheet['account_type'] == AccountType.BALANCE_SHEET_LIABILITY\n]['ending_balance'].sum()\n\nequity = balance_sheet[\n    balance_sheet['account_type'] == AccountType.BALANCE_SHEET_EQUITY\n]['ending_balance'].sum()\n\nprint(f\"\\n{'='*50}\")\nprint(f\"BALANCE SHEET - Effecti\")\nprint(f\"As of January 31, 2026\")\nprint(f\"(in USD)\")\nprint(f\"{'='*50}\\n\")\nprint(f\"Total Assets:              ${assets:,.2f}\")\nprint(f\"Total Liabilities:         ${liabilities:,.2f}\")\nprint(f\"Total Equity:              ${equity:,.2f}\")\nprint(f\"{'-'*50}\")\nprint(f\"Liabilities + Equity:      ${liabilities + equity:,.2f}\")\nprint(f\"\\nBalance Check: {'\u2713 PASSED' if abs(assets - (liabilities + equity)) &lt; 0.01 else '\u2717 FAILED'}\")\n</code></pre> <p>Expected output:</p> <pre><code>==================================================\nBALANCE SHEET - Effecti\nAs of January 31, 2026\n(in USD)\n==================================================\n\nTotal Assets:              $1,234,567.89\nTotal Liabilities:         $456,789.12\nTotal Equity:              $777,778.77\n--------------------------------------------------\nLiabilities + Equity:      $1,234,567.89\n\nBalance Check: \u2713 PASSED\n</code></pre>"},{"location":"getting-started/quick-start/#step-6-view-consolidated-pl","title":"Step 6: View Consolidated P&amp;L","text":"<pre><code># Extract P&amp;L\npl_statement = result.consolidated_balances[\n    result.consolidated_balances['account_type'].isin([\n        AccountType.PL_REVENUE,\n        AccountType.PL_COGS,\n        AccountType.PL_OPERATING_EXPENSE,\n        AccountType.PL_OTHER_INCOME,\n        AccountType.PL_OTHER_EXPENSE\n    ])\n]\n\n# Calculate totals\nrevenue = pl_statement[\n    pl_statement['account_type'] == AccountType.PL_REVENUE\n]['ending_balance'].sum()\n\ncogs = pl_statement[\n    pl_statement['account_type'] == AccountType.PL_COGS\n]['ending_balance'].sum()\n\nopex = pl_statement[\n    pl_statement['account_type'] == AccountType.PL_OPERATING_EXPENSE\n]['ending_balance'].sum()\n\ngross_profit = revenue + cogs  # COGS is negative\noperating_income = gross_profit + opex  # OPEX is negative\n\nprint(f\"\\n{'='*50}\")\nprint(f\"PROFIT &amp; LOSS - Effecti\")\nprint(f\"For the month ended January 31, 2026\")\nprint(f\"(in USD)\")\nprint(f\"{'='*50}\\n\")\nprint(f\"Revenue:                   ${revenue:,.2f}\")\nprint(f\"Cost of Goods Sold:        ${cogs:,.2f}\")\nprint(f\"{'-'*50}\")\nprint(f\"Gross Profit:              ${gross_profit:,.2f}\")\nprint(f\"Gross Margin:              {(gross_profit/revenue)*100:.1f}%\\n\")\nprint(f\"Operating Expenses:        ${opex:,.2f}\")\nprint(f\"{'-'*50}\")\nprint(f\"Operating Income:          ${operating_income:,.2f}\")\nprint(f\"Operating Margin:          {(operating_income/revenue)*100:.1f}%\")\n</code></pre> <p>Expected output:</p> <pre><code>==================================================\nPROFIT &amp; LOSS - Effecti\nFor the month ended January 31, 2026\n(in USD)\n==================================================\n\nRevenue:                   $890,456.78\nCost of Goods Sold:        $-234,567.89\n--------------------------------------------------\nGross Profit:              $655,888.89\nGross Margin:              73.7%\n\nOperating Expenses:        $-345,678.90\n--------------------------------------------------\nOperating Income:          $310,209.99\nOperating Margin:          34.8%\n</code></pre>"},{"location":"getting-started/quick-start/#part-3-export-to-excel","title":"Part 3: Export to Excel","text":""},{"location":"getting-started/quick-start/#step-7-generate-excel-report","title":"Step 7: Generate Excel Report","text":"<pre><code>from src.reporting import ExcelReportGenerator\n\n# Create report generator\nreport_gen = ExcelReportGenerator()\n\n# Generate Excel file\noutput_file = report_gen.generate_consolidated_report(\n    consolidation_result=result,\n    output_path=\"./reports/effecti_jan2026.xlsx\",\n    include_variance_analysis=False  # No prior period for comparison yet\n)\n\nprint(f\"\\n\u2713 Excel report generated: {output_file}\")\nprint(f\"File size: {os.path.getsize(output_file) / 1024:.1f} KB\")\n</code></pre> <p>Expected output:</p> <pre><code>\u2713 Excel report generated: ./reports/effecti_jan2026.xlsx\nFile size: 127.3 KB\n</code></pre>"},{"location":"getting-started/quick-start/#step-8-open-and-review-report","title":"Step 8: Open and Review Report","text":"<pre><code># Open Excel file (macOS)\nopen ./reports/effecti_jan2026.xlsx\n\n# Open Excel file (Linux)\nxdg-open ./reports/effecti_jan2026.xlsx\n\n# Open Excel file (Windows)\nstart ./reports/effecti_jan2026.xlsx\n</code></pre> <p>The Excel file contains these sheets:</p> <ol> <li>Summary - Key financial metrics</li> <li>Balance Sheet - Consolidated balance sheet</li> <li>P&amp;L Statement - Consolidated income statement</li> <li>Trial Balance - Detailed account balances</li> <li>FX Rates - Exchange rates used</li> <li>Audit Log - Consolidation steps taken</li> </ol>"},{"location":"getting-started/quick-start/#part-4-full-7-entity-consolidation","title":"Part 4: Full 7-Entity Consolidation","text":""},{"location":"getting-started/quick-start/#step-9-extract-all-7-trial-balances","title":"Step 9: Extract All 7 Trial Balances","text":"<pre><code>from src.connectors import get_erp_for_company\n\n# Portfolio companies\ncompanies = [\n    \"effecti\", \"mercos\", \"datahub\", \"onclick\",\n    \"ipe_digital\", \"munddi\", \"leadlovers\"\n]\n\n# Extract trial balances for all companies\nasync def extract_all_trial_balances():\n    all_trial_balances = {}\n\n    for company in companies:\n        print(f\"Extracting {company}...\")\n\n        # Get ERP type for company\n        erp_type = get_erp_for_company(company)\n\n        # Create connector (credentials from environment)\n        connector = create_connector(\n            erp_type=erp_type.value,\n            auth_type=\"oauth2\",  # or appropriate auth type\n            credentials={...},  # From environment\n            config={...}\n        )\n\n        # Extract trial balance\n        async with connector:\n            trial_balance = await connector.get_trial_balance(\n                company_id=\"01\",\n                period_start=datetime(2026, 1, 1),\n                period_end=datetime(2026, 1, 31)\n            )\n\n            all_trial_balances[company] = trial_balance\n            print(f\"  \u2713 {len(trial_balance.accounts)} accounts extracted\")\n\n    return all_trial_balances\n\n# Run extraction\nall_trial_balances = asyncio.run(extract_all_trial_balances())\nprint(f\"\\n\u2713 Extracted trial balances for {len(all_trial_balances)} companies\")\n</code></pre> <p>Expected output:</p> <pre><code>Extracting effecti...\n  \u2713 187 accounts extracted\nExtracting mercos...\n  \u2713 156 accounts extracted\nExtracting datahub...\n  \u2713 142 accounts extracted\nExtracting onclick...\n  \u2713 198 accounts extracted\nExtracting ipe_digital...\n  \u2713 134 accounts extracted\nExtracting munddi...\n  \u2713 167 accounts extracted\nExtracting leadlovers...\n  \u2713 179 accounts extracted\n\n\u2713 Extracted trial balances for 7 companies\n</code></pre>"},{"location":"getting-started/quick-start/#step-10-run-full-consolidation","title":"Step 10: Run Full Consolidation","text":"<pre><code>from src.consolidation import ConsolidationEngine\nfrom src.consolidation.fx_converter import create_sample_rates\n\n# Create consolidation engine\nengine = ConsolidationEngine(\n    presentation_currency=Currency.USD,\n    accounting_standard=AccountingStandard.IFRS\n)\n\n# Load FX rates\ncreate_sample_rates(engine.fx_rate_manager, date(2026, 1, 31))\n\n# Register all entities\nfor entity in all_entities:\n    engine.register_entity(entity)\n\n# Load all trial balances\nfor entity_id, trial_balance in all_trial_balances.items():\n    engine.load_trial_balance(entity_id, trial_balance)\n\n# Define chart of accounts for eliminations\ncoa = {\n    \"IC_RECEIVABLE\": \"1200\",\n    \"IC_PAYABLE\": \"2100\",\n    \"IC_REVENUE\": \"4100\",\n    \"IC_EXPENSE\": \"5200\",\n    \"FX_GAIN_LOSS\": \"7100\"\n}\n\n# Run consolidation\nprint(\"Running full consolidation...\")\nconsolidated = engine.consolidate(\n    period_end_date=date(2026, 1, 31),\n    period_start_date=date(2026, 1, 1),\n    chart_of_accounts=coa,\n    include_gaap_reconciliation=False\n)\n\nprint(f\"\\n\u2713 Consolidation complete\")\nprint(f\"Entities consolidated: {len(all_entities)}\")\nprint(f\"Intercompany eliminations: {len(consolidated.eliminations)}\")\nprint(f\"Total assets (USD): ${consolidated.total_assets:,.2f}\")\nprint(f\"Total revenue (USD): ${consolidated.total_revenue:,.2f}\")\n</code></pre> <p>Expected output:</p> <pre><code>Running full consolidation...\nProcessing entity: Effecti\nProcessing entity: Mercos\nProcessing entity: Datahub\nProcessing entity: OnClick\nProcessing entity: Ip\u00ea Digital\nProcessing entity: Munddi\nProcessing entity: Leadlovers\n\nPerforming FX conversion...\nIdentifying intercompany transactions...\n  Found 23 intercompany pairs\n  Eliminated $456,789.12 in intercompany balances\n\nApplying PPA amortization...\n  3 active PPA schedules\n  Monthly amortization: $12,345.67\n\nCalculating consolidated balances...\n\n\u2713 Consolidation complete\nEntities consolidated: 7\nIntercompany eliminations: 23\nTotal assets (USD): $15,234,567.89\nTotal revenue (USD): $3,456,789.01\n</code></pre>"},{"location":"getting-started/quick-start/#step-11-validate-consolidation","title":"Step 11: Validate Consolidation","text":"<pre><code>from src.consolidation.validation import ConsolidationValidator\n\n# Create validator\nvalidator = ConsolidationValidator()\n\n# Run all validation checks\nis_valid, results = validator.validate_all(consolidated)\n\n# Display validation results\nprint(f\"\\n{'='*60}\")\nprint(f\"VALIDATION REPORT\")\nprint(f\"{'='*60}\\n\")\n\nfor check_name, check_result in results.items():\n    status = \"\u2713 PASS\" if check_result['passed'] else \"\u2717 FAIL\"\n    print(f\"{status} - {check_name}\")\n    if not check_result['passed']:\n        print(f\"  Error: {check_result['message']}\")\n\n# Calculate accuracy score\naccuracy = validator.calculate_accuracy_score(consolidated)\nprint(f\"\\n{'='*60}\")\nprint(f\"Overall Accuracy Score: {accuracy*100:.2f}%\")\nprint(f\"Target: 99.9%\")\nprint(f\"Status: {'\u2713 PASSED' if accuracy &gt;= 0.999 else '\u2717 FAILED'}\")\nprint(f\"{'='*60}\")\n</code></pre> <p>Expected output:</p> <pre><code>============================================================\nVALIDATION REPORT\n============================================================\n\n\u2713 PASS - Balance Sheet Balance Check\n\u2713 PASS - Debit/Credit Balance Check\n\u2713 PASS - Net Income Reconciliation\n\u2713 PASS - Entity Ownership Validation\n\u2713 PASS - Elimination Completeness\n\u2713 PASS - FX Rate Consistency\n\u2713 PASS - Financial Reasonableness\n\n============================================================\nOverall Accuracy Score: 99.95%\nTarget: 99.9%\nStatus: \u2713 PASSED\n============================================================\n</code></pre>"},{"location":"getting-started/quick-start/#step-12-generate-full-report-package","title":"Step 12: Generate Full Report Package","text":"<pre><code>from src.reporting import ReportPackageGenerator\n\n# Create report package\npackage_gen = ReportPackageGenerator()\n\n# Generate all reports\noutput_dir = package_gen.generate_full_package(\n    consolidation_result=consolidated,\n    output_dir=\"./reports/jan2026_full/\",\n    include_excel=True,\n    include_powerpoint=True,\n    include_pdf=True\n)\n\nprint(f\"\\n\u2713 Report package generated\")\nprint(f\"Output directory: {output_dir}\")\nprint(f\"\\nGenerated files:\")\nfor file in os.listdir(output_dir):\n    size_kb = os.path.getsize(os.path.join(output_dir, file)) / 1024\n    print(f\"  - {file} ({size_kb:.1f} KB)\")\n</code></pre> <p>Expected output:</p> <pre><code>\u2713 Report package generated\nOutput directory: ./reports/jan2026_full/\n\nGenerated files:\n  - consolidated_financials.xlsx (234.5 KB)\n  - executive_summary.pptx (1,567.8 KB)\n  - board_package.pdf (2,345.6 KB)\n  - variance_analysis.xlsx (156.7 KB)\n  - audit_trail.xlsx (89.2 KB)\n</code></pre>"},{"location":"getting-started/quick-start/#part-5-automated-monthly-close","title":"Part 5: Automated Monthly Close","text":""},{"location":"getting-started/quick-start/#step-13-schedule-automated-close","title":"Step 13: Schedule Automated Close","text":"<pre><code>from src.orchestration import MonthlyCloseOrchestrator\n\n# Create orchestrator\norchestrator = MonthlyCloseOrchestrator()\n\n# Schedule monthly close\njob_id = orchestrator.schedule_monthly_close(\n    entities=all_entities,\n    period_year=2026,\n    period_month=2,  # Schedule for next month (February)\n    trigger_date=date(2026, 3, 1),  # Run on March 1st\n    trigger_time=\"06:00:00\"  # 6 AM UTC\n)\n\nprint(f\"\u2713 Monthly close scheduled\")\nprint(f\"Job ID: {job_id}\")\nprint(f\"Trigger: March 1, 2026 at 6:00 AM UTC\")\nprint(f\"Entities: {len(all_entities)}\")\n</code></pre> <p>Expected output:</p> <pre><code>\u2713 Monthly close scheduled\nJob ID: monthly-close-202602\nTrigger: March 1, 2026 at 6:00 AM UTC\nEntities: 7\n</code></pre>"},{"location":"getting-started/quick-start/#next-steps","title":"Next Steps","text":"<p>Congratulations! You've successfully:</p> <ul> <li>\u2705 Extracted trial balances from an ERP system</li> <li>\u2705 Run a single-entity consolidation</li> <li>\u2705 Run a full 7-entity consolidation with intercompany eliminations</li> <li>\u2705 Validated consolidation accuracy (99.95%)</li> <li>\u2705 Generated Excel, PowerPoint, and PDF reports</li> <li>\u2705 Scheduled automated monthly close</li> </ul>"},{"location":"getting-started/quick-start/#continue-learning","title":"Continue Learning","text":"<ul> <li>User Guide - Learn advanced features</li> <li>Architecture Deep Dive - Understand system internals</li> <li>API Documentation - Integrate with other systems</li> <li>Troubleshooting - Common issues and solutions</li> </ul>"},{"location":"getting-started/quick-start/#common-next-steps","title":"Common Next Steps","text":"<ol> <li>Configure email distribution: Set up automatic report delivery</li> <li>Create custom reports: Build entity-specific or executive dashboards</li> <li>Add new entities: Onboard new portfolio companies</li> <li>Enable variance analysis: Configure budget data for budget vs actual</li> <li>Set up monitoring: Configure CloudWatch alarms and dashboards</li> </ol>"},{"location":"getting-started/quick-start/#troubleshooting","title":"Troubleshooting","text":""},{"location":"getting-started/quick-start/#trial-balance-extraction-fails","title":"Trial Balance Extraction Fails","text":"<p>Problem: ERP connection timeout or authentication error</p> <pre><code># Check connection health\nhealth = await connector.health_check()\nprint(f\"Status: {health.status}\")\nprint(f\"Message: {health.message}\")\n\n# Verify credentials\nimport os\nprint(f\"Client ID: {os.getenv('TOTVS_CLIENT_ID')[:10]}...\")\n</code></pre>"},{"location":"getting-started/quick-start/#consolidation-balance-sheet-doesnt-balance","title":"Consolidation Balance Sheet Doesn't Balance","text":"<p>Problem: Assets \u2260 Liabilities + Equity</p> <pre><code># Get detailed validation report\nreport = validator.generate_validation_report(consolidated)\nprint(report)\n\n# Check for missing accounts\nprint(f\"Total accounts: {len(consolidated.consolidated_balances)}\")\nprint(f\"Asset accounts: {len(consolidated.get_accounts_by_type('ASSET'))}\")\nprint(f\"Liability accounts: {len(consolidated.get_accounts_by_type('LIABILITY'))}\")\n</code></pre>"},{"location":"getting-started/quick-start/#excel-export-fails","title":"Excel Export Fails","text":"<p>Problem: Permission denied or file in use</p> <pre><code># Check output directory exists\nmkdir -p ./reports\n\n# Verify write permissions\ntouch ./reports/test.txt &amp;&amp; rm ./reports/test.txt\n\n# Close Excel if file is open\n</code></pre>"},{"location":"getting-started/quick-start/#support","title":"Support","text":"<p>For help with this tutorial:</p> <ul> <li>Documentation: Review Installation and Requirements</li> <li>API Documentation: See Technical Reference</li> <li>GitHub Issues: File a bug report</li> </ul> <p>Time to completion: Under 20 minutes \u2728</p>"},{"location":"getting-started/requirements/","title":"System Requirements","text":""},{"location":"getting-started/requirements/#hardware-requirements","title":"Hardware Requirements","text":""},{"location":"getting-started/requirements/#minimum-requirements","title":"Minimum Requirements","text":"Component Specification CPU 4 cores @ 2.5 GHz RAM 8 GB Storage 100 GB SSD Network 10 Mbps download, 5 Mbps upload"},{"location":"getting-started/requirements/#recommended-requirements","title":"Recommended Requirements","text":"Component Specification CPU 8+ cores @ 3.0 GHz RAM 16 GB (32 GB for production) Storage 500 GB NVMe SSD Network 100 Mbps download, 20 Mbps upload"},{"location":"getting-started/requirements/#production-environment-aws","title":"Production Environment (AWS)","text":"<p>For production deployment on AWS:</p> Service Specification Database RDS PostgreSQL 15+ (db.r6g.xlarge or larger) Application Server ECS Fargate (2 vCPU, 4 GB RAM minimum) Task Queue ElastiCache Redis (cache.t3.medium) Storage S3 Standard for reports, Glacier for archival"},{"location":"getting-started/requirements/#software-requirements","title":"Software Requirements","text":""},{"location":"getting-started/requirements/#operating-system","title":"Operating System","text":"<p>The system supports the following operating systems:</p> <ul> <li>Linux: Ubuntu 22.04+ / Debian 11+ / RHEL 8+</li> <li>macOS: macOS 12 (Monterey) or later</li> <li>Windows: Windows 11 with WSL2</li> </ul> <p>Recommended: Ubuntu 22.04 LTS for production deployments.</p>"},{"location":"getting-started/requirements/#python","title":"Python","text":"<ul> <li>Required Version: Python 3.13 or later</li> <li>Package Manager: pip 24.0+ or uv (recommended)</li> <li>Virtual Environment: venv or conda</li> </ul> <p>To check your Python version:</p> <pre><code>python3 --version\n# Expected output: Python 3.13.x or later\n</code></pre>"},{"location":"getting-started/requirements/#postgresql-database","title":"PostgreSQL Database","text":"<ul> <li>Required Version: PostgreSQL 15 or later</li> <li>Required Extensions:</li> <li><code>uuid-ossp</code> - UUID generation</li> <li><code>btree_gist</code> - Advanced indexing</li> <li><code>pg_trgm</code> - Fuzzy text search</li> <li>Minimum Disk Space: 100 GB (500 GB recommended for production)</li> <li>Memory: 4 GB shared_buffers (8 GB recommended)</li> </ul> <p>To check your PostgreSQL version:</p> <pre><code>psql --version\n# Expected output: psql (PostgreSQL) 15.x or later\n</code></pre>"},{"location":"getting-started/requirements/#redis","title":"Redis","text":"<ul> <li>Required Version: Redis 7.0 or later</li> <li>Memory: 1 GB minimum (4 GB recommended)</li> <li>Persistence: RDB snapshots enabled</li> </ul> <p>To check your Redis version:</p> <pre><code>redis-server --version\n# Expected output: Redis server v=7.x or later\n</code></pre>"},{"location":"getting-started/requirements/#cloud-services","title":"Cloud Services","text":""},{"location":"getting-started/requirements/#aws-services-production","title":"AWS Services (Production)","text":"<p>Required AWS services for production deployment:</p> Service Purpose Estimated Cost RDS PostgreSQL Primary database $200-500/month ElastiCache Redis Task queue backend $50-100/month ECS Fargate Application containers $100-300/month S3 Report storage $20-50/month Secrets Manager Credential storage $10-20/month CloudWatch Monitoring &amp; logging $30-80/month Lambda Scheduled triggers $5-15/month <p>Total Estimated Cost: $415-1,065/month for 7 entities</p>"},{"location":"getting-started/requirements/#aws-permissions","title":"AWS Permissions","text":"<p>The IAM user or role requires these permissions:</p> <ul> <li><code>rds:*</code> - Database management</li> <li><code>elasticache:*</code> - Redis management</li> <li><code>ecs:*</code> - Container orchestration</li> <li><code>s3:*</code> - Object storage</li> <li><code>secretsmanager:*</code> - Secrets access</li> <li><code>cloudwatch:*</code> - Monitoring</li> <li><code>lambda:*</code> - Function execution</li> <li><code>logs:*</code> - CloudWatch Logs</li> </ul>"},{"location":"getting-started/requirements/#anthropic-api","title":"Anthropic API","text":"<ul> <li>API Key: Required for Claude AI features</li> <li>Model Access: Claude Sonnet 4.5 or Opus 4.6</li> <li>Estimated Usage: 500K-1M tokens/month ($2.50-$5.00 for Sonnet 4.5)</li> <li>Rate Limits: Standard tier (1000 requests/minute)</li> </ul> <p>To obtain an API key: https://console.anthropic.com/</p>"},{"location":"getting-started/requirements/#external-api-access","title":"External API Access","text":""},{"location":"getting-started/requirements/#erp-systems","title":"ERP Systems","text":"<p>The system requires API access to the following ERP systems:</p>"},{"location":"getting-started/requirements/#totvs-protheus","title":"TOTVS Protheus","text":"<ul> <li>Authentication: OAuth 2.0 or Bearer Token</li> <li>Base URL: <code>https://api.totvs.com.br</code></li> <li>Required Permissions: Read access to:</li> <li>Trial balance (<code>GET /api/fin/v1/trial-balance</code>)</li> <li>Chart of accounts (<code>GET /api/fin/v1/accounts</code>)</li> <li>Subledger details (<code>GET /api/fin/v1/transactions</code>)</li> <li>Rate Limit: 100 requests/minute</li> <li>Documentation: https://tdn.totvs.com/display/public/PROT/REST</li> </ul>"},{"location":"getting-started/requirements/#contaazul","title":"ContaAzul","text":"<ul> <li>Authentication: OAuth 2.0</li> <li>Base URL: <code>https://api.contaazul.com</code></li> <li>Required Permissions: Read access to:</li> <li>Financial transactions (<code>GET /v1/financial_accounts/transactions</code>)</li> <li>Chart of accounts (<code>GET /v1/financial_accounts</code>)</li> <li>Rate Limit: 60 requests/minute</li> <li>Documentation: https://developers.contaazul.com/</li> </ul>"},{"location":"getting-started/requirements/#omie","title":"Omie","text":"<ul> <li>Authentication: API Key (app_key + app_secret)</li> <li>Base URL: <code>https://app.omie.com.br/api/v1</code></li> <li>Required Permissions: Read access to:</li> <li>Trial balance (<code>POST /financas/contacorrente/</code>)</li> <li>Chart of accounts (<code>POST /geral/planocontas/</code>)</li> <li>Rate Limit: 300 requests/minute</li> <li>Documentation: https://developer.omie.com.br/</li> </ul>"},{"location":"getting-started/requirements/#bling","title":"Bling","text":"<ul> <li>Authentication: API Key or OAuth 2.0</li> <li>Base URL: <code>https://api.bling.com.br/Api/v3</code></li> <li>Required Permissions: Read access to:</li> <li>Financial accounts (<code>GET /financas/contas</code>)</li> <li>Transactions (<code>GET /financas/movimentos</code>)</li> <li>Rate Limit: 100 requests/minute</li> <li>API Version: v3 (JSON) recommended</li> <li>Documentation: https://manualdoapi.bling.com.br/</li> </ul>"},{"location":"getting-started/requirements/#foreign-exchange-rates","title":"Foreign Exchange Rates","text":""},{"location":"getting-started/requirements/#brazilian-central-bank-bcb","title":"Brazilian Central Bank (BCB)","text":"<ul> <li>API: BCB PTAX API</li> <li>Base URL: <code>https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1</code></li> <li>Authentication: None (public API)</li> <li>Purpose: BRL/USD exchange rates</li> <li>Rate Limit: None specified</li> <li>Documentation: https://dadosabertos.bcb.gov.br/</li> </ul>"},{"location":"getting-started/requirements/#european-central-bank-ecb","title":"European Central Bank (ECB)","text":"<ul> <li>API: ECB Statistical Data Warehouse</li> <li>Base URL: <code>https://data-api.ecb.europa.eu/service/data/</code></li> <li>Authentication: None (public API)</li> <li>Purpose: EUR/USD exchange rates</li> <li>Rate Limit: None specified</li> <li>Documentation: https://data.ecb.europa.eu/help/api</li> </ul>"},{"location":"getting-started/requirements/#network-requirements","title":"Network Requirements","text":""},{"location":"getting-started/requirements/#firewall-rules","title":"Firewall Rules","text":""},{"location":"getting-started/requirements/#outbound-application-to-external-services","title":"Outbound (Application to External Services)","text":"Destination Port Protocol Purpose ERP APIs 443 HTTPS Data extraction BCB API 443 HTTPS FX rates Anthropic API 443 HTTPS AI analysis AWS Services 443 HTTPS Cloud resources"},{"location":"getting-started/requirements/#inbound-for-api-access","title":"Inbound (for API access)","text":"Source Port Protocol Purpose Internal network 8000 HTTP FastAPI application Internal network 5432 TCP PostgreSQL (if not RDS) Internal network 6379 TCP Redis (if not ElastiCache)"},{"location":"getting-started/requirements/#dns-requirements","title":"DNS Requirements","text":"<p>Ensure DNS resolution for:</p> <ul> <li><code>api.totvs.com.br</code></li> <li><code>api.contaazul.com</code></li> <li><code>app.omie.com.br</code></li> <li><code>api.bling.com.br</code></li> <li><code>olinda.bcb.gov.br</code></li> <li><code>data-api.ecb.europa.eu</code></li> <li><code>api.anthropic.com</code></li> <li>AWS service endpoints (if using AWS)</li> </ul>"},{"location":"getting-started/requirements/#ssltls-certificates","title":"SSL/TLS Certificates","text":"<ul> <li>Internal API: Self-signed certificate acceptable for development</li> <li>Production API: Valid SSL certificate required (Let's Encrypt or commercial)</li> <li>ERP connections: All ERP APIs use TLS 1.2 or higher</li> </ul>"},{"location":"getting-started/requirements/#dependencies","title":"Dependencies","text":""},{"location":"getting-started/requirements/#python-packages","title":"Python Packages","text":"<p>Core dependencies (automatically installed via <code>requirements.txt</code>):</p> Package Version Purpose fastapi 0.110+ Web API framework sqlalchemy 2.0+ Database ORM asyncpg 0.29+ Async PostgreSQL driver httpx 0.27+ Async HTTP client pydantic 2.6+ Data validation celery 5.3+ Task queue redis 5.0+ Redis client anthropic 0.18+ Claude AI SDK openpyxl 3.1+ Excel generation python-pptx 0.6+ PowerPoint generation pandas 2.2+ Data manipulation pytest 8.0+ Testing framework <p>Full list available in <code>/Volumes/AI/Code/FPA/requirements.txt</code></p>"},{"location":"getting-started/requirements/#postgresql-extensions","title":"PostgreSQL Extensions","text":"<p>Required extensions (installed automatically):</p> <pre><code>CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";      -- UUID generation\nCREATE EXTENSION IF NOT EXISTS \"btree_gist\";     -- Advanced indexing\nCREATE EXTENSION IF NOT EXISTS \"pg_trgm\";        -- Fuzzy text search\n</code></pre>"},{"location":"getting-started/requirements/#development-tools-optional","title":"Development Tools (Optional)","text":""},{"location":"getting-started/requirements/#recommended-ide","title":"Recommended IDE","text":"<ul> <li>VS Code with Python extension</li> <li>PyCharm Professional (paid) or Community (free)</li> <li>Cursor (AI-powered IDE)</li> </ul>"},{"location":"getting-started/requirements/#code-quality-tools","title":"Code Quality Tools","text":"<ul> <li>black - Code formatting</li> <li>flake8 - Linting</li> <li>mypy - Type checking</li> <li>isort - Import sorting</li> </ul>"},{"location":"getting-started/requirements/#database-tools","title":"Database Tools","text":"<ul> <li>pgAdmin 4 - PostgreSQL GUI</li> <li>DBeaver - Universal database tool</li> <li>psql - Command-line client</li> </ul>"},{"location":"getting-started/requirements/#api-testing","title":"API Testing","text":"<ul> <li>Postman - API testing</li> <li>httpie - Command-line HTTP client</li> <li>curl - Basic HTTP testing</li> </ul>"},{"location":"getting-started/requirements/#user-requirements","title":"User Requirements","text":""},{"location":"getting-started/requirements/#technical-skills","title":"Technical Skills","text":"<p>Minimum skills for installation:</p> <ul> <li>Basic command-line experience (cd, ls, mkdir)</li> <li>Python virtual environment creation</li> <li>PostgreSQL database creation</li> <li>Environment variable configuration</li> </ul> <p>Recommended skills for operation:</p> <ul> <li>SQL query writing</li> <li>Database backup/restore</li> <li>AWS service configuration</li> <li>Docker/container basics</li> </ul>"},{"location":"getting-started/requirements/#access-credentials","title":"Access Credentials","text":"<p>Required before installation:</p> <ol> <li>ERP Credentials: API keys/OAuth credentials for all 7 ERP systems</li> <li>AWS Credentials: IAM user with required permissions</li> <li>Anthropic API Key: Claude API access key</li> <li>Database Credentials: PostgreSQL superuser password</li> <li>Email Credentials: SMTP server for report distribution (optional)</li> </ol>"},{"location":"getting-started/requirements/#licensing","title":"Licensing","text":"<p>Required licenses:</p> <ul> <li>PostgreSQL: Free (open-source)</li> <li>Python: Free (open-source)</li> <li>Anthropic API: Pay-per-use (estimate $2.50-$5.00/month)</li> </ul> <p>ERP Licenses: Existing subscriptions (no additional cost)</p>"},{"location":"getting-started/requirements/#pre-installation-checklist","title":"Pre-Installation Checklist","text":"<p>Before proceeding to installation, verify:</p> <ul> <li>[ ] Python 3.13+ installed and accessible</li> <li>[ ] PostgreSQL 15+ installed and running</li> <li>[ ] Redis 7.0+ installed and running</li> <li>[ ] 100+ GB free disk space</li> <li>[ ] API credentials for all 7 ERP systems</li> <li>[ ] AWS account with required permissions (for production)</li> <li>[ ] Anthropic API key</li> <li>[ ] Network access to all required external APIs</li> <li>[ ] Firewall rules configured for outbound HTTPS</li> <li>[ ] SSL certificate for production deployment (if applicable)</li> </ul>"},{"location":"getting-started/requirements/#scaling-considerations","title":"Scaling Considerations","text":""},{"location":"getting-started/requirements/#current-capacity-7-entities","title":"Current Capacity (7 Entities)","text":"<ul> <li>Database Size: ~2 GB (current year)</li> <li>Processing Time: &lt;5 seconds per consolidation</li> <li>Monthly Storage Growth: ~300 MB</li> <li>API Rate Limits: Well within all provider limits</li> </ul>"},{"location":"getting-started/requirements/#future-capacity-66-entities","title":"Future Capacity (66 Entities)","text":"<ul> <li>Database Size: ~20 GB (7 years of data)</li> <li>Processing Time: &lt;60 seconds per consolidation</li> <li>Monthly Storage Growth: ~2.5 GB</li> <li>Hardware: Increase RAM to 32 GB, CPU to 16 cores</li> <li>Database: Consider read replicas, partitioning by entity</li> </ul>"},{"location":"getting-started/requirements/#vertical-scaling-limits","title":"Vertical Scaling Limits","text":"<p>The system can handle 66 entities on a single server with:</p> <ul> <li>32 GB RAM</li> <li>16 CPU cores</li> <li>1 TB NVMe SSD</li> </ul> <p>Beyond 100 entities, consider horizontal scaling with Citus (distributed PostgreSQL).</p>"},{"location":"getting-started/requirements/#support","title":"Support","text":"<p>For questions about requirements:</p> <ul> <li>Hardware/Software: Review Installation Guide</li> <li>AWS Setup: See Deployment Guide</li> <li>ERP Access: Contact portfolio company IT teams</li> </ul> <p>Next Step: Once requirements are verified, proceed to Installation.</p>"},{"location":"technical-reference/api-reference/","title":"API Reference","text":"<p>Version: 1.0.0 Base URL: <code>https://api.fpa.nuvini.ai/v1</code> Last Updated: 2026-02-07</p>"},{"location":"technical-reference/api-reference/#overview","title":"Overview","text":"<p>The AI FP&amp;A system exposes a RESTful API for programmatic access to financial data, consolidation operations, and AI-powered insights. All API endpoints use JSON for request and response payloads.</p>"},{"location":"technical-reference/api-reference/#authentication","title":"Authentication","text":""},{"location":"technical-reference/api-reference/#api-key-authentication","title":"API Key Authentication","text":"<p>All API requests require authentication using an API key in the request header.</p> <pre><code>GET /api/v1/entities\nAuthorization: Bearer fpa_abc123...xyz789\n</code></pre>"},{"location":"technical-reference/api-reference/#generating-api-keys","title":"Generating API Keys","text":"<pre><code>from core.access_control import RBACManager, AgentRole\n\nrbac = RBACManager()\napi_key = rbac.generate_api_key(\n    role=AgentRole.DATA_INGESTION,\n    agent_id='effecti_connector',\n    companies=['effecti'],\n    expires_days=90\n)\n</code></pre>"},{"location":"technical-reference/api-reference/#api-key-scoping","title":"API Key Scoping","text":"<p>API keys are scoped by: - Role - Determines available permissions - Companies - Optional restriction to specific entities - Expiration - Default 90 days, max 365 days</p>"},{"location":"technical-reference/api-reference/#rate-limiting","title":"Rate Limiting","text":"<ul> <li>Default: 1000 requests per hour per API key</li> <li>Burst: Up to 100 requests per minute</li> <li>Headers:</li> <li><code>X-RateLimit-Limit</code> - Total requests allowed</li> <li><code>X-RateLimit-Remaining</code> - Remaining requests</li> <li><code>X-RateLimit-Reset</code> - Unix timestamp when limit resets</li> </ul>"},{"location":"technical-reference/api-reference/#base-url-and-versioning","title":"Base URL and Versioning","text":"<ul> <li>Production: <code>https://api.fpa.nuvini.ai/v1</code></li> <li>Staging: <code>https://staging-api.fpa.nuvini.ai/v1</code></li> <li>Versioning: URL-based (<code>/v1</code>, <code>/v2</code>)</li> </ul>"},{"location":"technical-reference/api-reference/#common-response-formats","title":"Common Response Formats","text":""},{"location":"technical-reference/api-reference/#success-response","title":"Success Response","text":"<pre><code>{\n  \"success\": true,\n  \"data\": { ... },\n  \"metadata\": {\n    \"timestamp\": \"2026-02-07T10:30:00Z\",\n    \"request_id\": \"req_abc123\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#error-response","title":"Error Response","text":"<pre><code>{\n  \"success\": false,\n  \"error\": {\n    \"code\": \"VALIDATION_ERROR\",\n    \"message\": \"Invalid period format\",\n    \"details\": {\n      \"field\": \"period_month\",\n      \"expected\": \"1-12\",\n      \"received\": \"13\"\n    }\n  },\n  \"metadata\": {\n    \"timestamp\": \"2026-02-07T10:30:00Z\",\n    \"request_id\": \"req_abc123\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#error-codes","title":"Error Codes","text":"Code HTTP Status Description <code>AUTHENTICATION_FAILED</code> 401 Invalid or expired API key <code>PERMISSION_DENIED</code> 403 Insufficient permissions <code>NOT_FOUND</code> 404 Resource not found <code>VALIDATION_ERROR</code> 400 Request validation failed <code>RATE_LIMIT_EXCEEDED</code> 429 Too many requests <code>INTERNAL_ERROR</code> 500 Server error <code>SERVICE_UNAVAILABLE</code> 503 Service temporarily unavailable"},{"location":"technical-reference/api-reference/#endpoints","title":"Endpoints","text":""},{"location":"technical-reference/api-reference/#portfolio-entities","title":"Portfolio Entities","text":""},{"location":"technical-reference/api-reference/#list-entities","title":"List Entities","text":"<p>Get all portfolio entities accessible to the current API key.</p> <pre><code>GET /api/v1/entities\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": [\n    {\n      \"entity_id\": \"uuid-1\",\n      \"entity_code\": \"EFFECTI\",\n      \"entity_name\": \"Effecti\",\n      \"parent_entity_id\": null,\n      \"functional_currency\": \"BRL\",\n      \"country_code\": \"BR\",\n      \"ownership_percentage\": 100.00,\n      \"is_active\": true\n    },\n    ...\n  ]\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#get-entity-details","title":"Get Entity Details","text":"<pre><code>GET /api/v1/entities/{entity_id}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"entity_id\": \"uuid-1\",\n    \"entity_code\": \"EFFECTI\",\n    \"entity_name\": \"Effecti\",\n    \"parent_entity_id\": null,\n    \"functional_currency\": \"BRL\",\n    \"country_code\": \"BR\",\n    \"ownership_percentage\": 100.00,\n    \"acquisition_date\": \"2020-01-15\",\n    \"entity_type\": \"subsidiary\",\n    \"is_active\": true,\n    \"created_at\": \"2020-01-15T00:00:00Z\",\n    \"updated_at\": \"2026-02-07T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#trial-balances","title":"Trial Balances","text":""},{"location":"technical-reference/api-reference/#get-trial-balance","title":"Get Trial Balance","text":"<p>Retrieve trial balance for an entity and period.</p> <pre><code>GET /api/v1/trial-balances?entity_id={entity_id}&amp;year={year}&amp;month={month}\n</code></pre> <p>Query Parameters: - <code>entity_id</code> (required) - Entity UUID - <code>year</code> (required) - Period year (e.g., 2024) - <code>month</code> (required) - Period month (1-12) - <code>include_zero_balances</code> (optional) - Include accounts with zero balance (default: false)</p> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"entity_id\": \"uuid-1\",\n    \"entity_code\": \"EFFECTI\",\n    \"period_year\": 2024,\n    \"period_month\": 12,\n    \"currency\": \"BRL\",\n    \"accounts\": [\n      {\n        \"account_code\": \"1.01.001\",\n        \"account_name\": \"Caixa\",\n        \"standard_account_code\": \"1010\",\n        \"standard_account_name\": \"Cash\",\n        \"account_type\": \"asset\",\n        \"opening_balance\": 100000.00,\n        \"debit_amount\": 50000.00,\n        \"credit_amount\": 30000.00,\n        \"ending_balance\": 120000.00\n      },\n      ...\n    ],\n    \"totals\": {\n      \"total_debits\": 5000000.00,\n      \"total_credits\": 5000000.00,\n      \"difference\": 0.00\n    }\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#upload-trial-balance","title":"Upload Trial Balance","text":"<p>Upload trial balance data for an entity and period.</p> <pre><code>POST /api/v1/trial-balances\n</code></pre> <p>Request Body:</p> <pre><code>{\n  \"entity_id\": \"uuid-1\",\n  \"period_year\": 2024,\n  \"period_month\": 12,\n  \"currency\": \"BRL\",\n  \"source_system\": \"totvs_protheus\",\n  \"accounts\": [\n    {\n      \"account_code\": \"1.01.001\",\n      \"account_name\": \"Caixa\",\n      \"opening_balance\": 100000.00,\n      \"debit_amount\": 50000.00,\n      \"credit_amount\": 30000.00,\n      \"ending_balance\": 120000.00\n    },\n    ...\n  ]\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"batch_id\": \"batch-uuid\",\n    \"entity_id\": \"uuid-1\",\n    \"period_year\": 2024,\n    \"period_month\": 12,\n    \"accounts_uploaded\": 150,\n    \"validation_results\": {\n      \"is_valid\": true,\n      \"warnings\": [],\n      \"errors\": []\n    }\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#consolidated-balances","title":"Consolidated Balances","text":""},{"location":"technical-reference/api-reference/#get-consolidated-balances","title":"Get Consolidated Balances","text":"<p>Retrieve consolidated financial statement balances.</p> <pre><code>GET /api/v1/consolidated-balances?year={year}&amp;month={month}&amp;level={level}\n</code></pre> <p>Query Parameters: - <code>year</code> (required) - Period year - <code>month</code> (required) - Period month - <code>level</code> (optional) - Consolidation level: <code>entity</code> or <code>group</code> (default: <code>group</code>) - <code>account_type</code> (optional) - Filter by account type: <code>asset</code>, <code>liability</code>, <code>equity</code>, <code>revenue</code>, <code>expense</code></p> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"period_year\": 2024,\n    \"period_month\": 12,\n    \"currency\": \"USD\",\n    \"consolidation_level\": \"group\",\n    \"accounts\": [\n      {\n        \"account_code\": \"1010\",\n        \"account_name\": \"Cash\",\n        \"account_type\": \"asset\",\n        \"opening_balance\": 1500000.00,\n        \"period_activity\": 250000.00,\n        \"ending_balance\": 1750000.00\n      },\n      ...\n    ],\n    \"summary\": {\n      \"total_assets\": 50000000.00,\n      \"total_liabilities\": 30000000.00,\n      \"total_equity\": 20000000.00,\n      \"total_revenue\": 15000000.00,\n      \"total_expenses\": 12000000.00,\n      \"net_income\": 3000000.00\n    }\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#trigger-consolidation","title":"Trigger Consolidation","text":"<p>Initiate consolidation process for a period.</p> <pre><code>POST /api/v1/consolidation/run\n</code></pre> <p>Request Body:</p> <pre><code>{\n  \"period_year\": 2024,\n  \"period_month\": 12,\n  \"presentation_currency\": \"USD\",\n  \"options\": {\n    \"include_eliminations\": true,\n    \"include_ppa_amortization\": true,\n    \"validate_results\": true\n  }\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"consolidation_id\": \"cons-uuid\",\n    \"status\": \"in_progress\",\n    \"period_year\": 2024,\n    \"period_month\": 12,\n    \"started_at\": \"2026-02-07T10:30:00Z\",\n    \"estimated_completion\": \"2026-02-07T10:35:00Z\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#get-consolidation-status","title":"Get Consolidation Status","text":"<pre><code>GET /api/v1/consolidation/{consolidation_id}/status\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"consolidation_id\": \"cons-uuid\",\n    \"status\": \"completed\",\n    \"period_year\": 2024,\n    \"period_month\": 12,\n    \"started_at\": \"2026-02-07T10:30:00Z\",\n    \"completed_at\": \"2026-02-07T10:34:23Z\",\n    \"execution_time_seconds\": 263,\n    \"validation_results\": {\n      \"is_valid\": true,\n      \"accuracy_score\": 0.998,\n      \"warnings\": [],\n      \"errors\": []\n    }\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#journal-entries","title":"Journal Entries","text":""},{"location":"technical-reference/api-reference/#list-journal-entries","title":"List Journal Entries","text":"<pre><code>GET /api/v1/journal-entries?entity_id={entity_id}&amp;year={year}&amp;month={month}&amp;status={status}\n</code></pre> <p>Query Parameters: - <code>entity_id</code> (optional) - Filter by entity - <code>year</code> (optional) - Filter by year - <code>month</code> (optional) - Filter by month - <code>status</code> (optional) - Filter by status: <code>draft</code>, <code>pending_review</code>, <code>approved</code>, <code>posted</code>, <code>reversed</code> - <code>source</code> (optional) - Filter by source: <code>manual</code>, <code>ai_generated</code>, <code>system</code>, <code>consolidation</code></p> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": [\n    {\n      \"entry_id\": \"je-uuid\",\n      \"entry_number\": \"JE-2024-12-001\",\n      \"entity_id\": \"uuid-1\",\n      \"entity_code\": \"EFFECTI\",\n      \"period_year\": 2024,\n      \"period_month\": 12,\n      \"entry_date\": \"2024-12-31\",\n      \"status\": \"pending_review\",\n      \"entry_source\": \"ai_generated\",\n      \"description\": \"Accrued hosting expense\",\n      \"ai_confidence\": 0.87,\n      \"total_debit\": 12500.00,\n      \"total_credit\": 12500.00,\n      \"created_at\": \"2026-01-15T10:00:00Z\"\n    },\n    ...\n  ],\n  \"pagination\": {\n    \"page\": 1,\n    \"per_page\": 50,\n    \"total\": 127\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#get-journal-entry-details","title":"Get Journal Entry Details","text":"<pre><code>GET /api/v1/journal-entries/{entry_id}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"entry_id\": \"je-uuid\",\n    \"entry_number\": \"JE-2024-12-001\",\n    \"entity_id\": \"uuid-1\",\n    \"period_year\": 2024,\n    \"period_month\": 12,\n    \"entry_date\": \"2024-12-31\",\n    \"status\": \"pending_review\",\n    \"entry_source\": \"ai_generated\",\n    \"description\": \"Accrued hosting expense\",\n    \"ai_confidence\": 0.87,\n    \"ai_explanation\": \"AI detected 15% increase in cloud usage vs. prior month.\",\n    \"lines\": [\n      {\n        \"line_number\": 1,\n        \"account_code\": \"5100\",\n        \"account_name\": \"Hosting Expense\",\n        \"debit_amount\": 12500.00,\n        \"credit_amount\": 0,\n        \"currency\": \"BRL\",\n        \"description\": \"Accrued hosting expense - December 2024\"\n      },\n      {\n        \"line_number\": 2,\n        \"account_code\": \"2120\",\n        \"account_name\": \"Accrued Liabilities\",\n        \"debit_amount\": 0,\n        \"credit_amount\": 12500.00,\n        \"currency\": \"BRL\",\n        \"description\": \"Accrued hosting liability\"\n      }\n    ]\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#create-journal-entry","title":"Create Journal Entry","text":"<pre><code>POST /api/v1/journal-entries\n</code></pre> <p>Request Body:</p> <pre><code>{\n  \"entity_id\": \"uuid-1\",\n  \"period_year\": 2024,\n  \"period_month\": 12,\n  \"entry_date\": \"2024-12-31\",\n  \"entry_source\": \"manual\",\n  \"description\": \"Accrual for consulting fees\",\n  \"lines\": [\n    {\n      \"account_code\": \"5200\",\n      \"debit_amount\": 25000.00,\n      \"credit_amount\": 0,\n      \"currency\": \"BRL\",\n      \"description\": \"Consulting fees\"\n    },\n    {\n      \"account_code\": \"2120\",\n      \"debit_amount\": 0,\n      \"credit_amount\": 25000.00,\n      \"currency\": \"BRL\",\n      \"description\": \"Accrued consulting payable\"\n    }\n  ]\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"entry_id\": \"je-uuid\",\n    \"entry_number\": \"JE-2024-12-125\",\n    \"status\": \"draft\",\n    \"created_at\": \"2026-02-07T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#approve-journal-entry","title":"Approve Journal Entry","text":"<pre><code>POST /api/v1/journal-entries/{entry_id}/approve\n</code></pre> <p>Request Body:</p> <pre><code>{\n  \"comments\": \"Reviewed and approved. Accrual is reasonable based on contract.\"\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"entry_id\": \"je-uuid\",\n    \"status\": \"approved\",\n    \"approved_by\": \"user-uuid\",\n    \"approved_at\": \"2026-02-07T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#post-journal-entry","title":"Post Journal Entry","text":"<pre><code>POST /api/v1/journal-entries/{entry_id}/post\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"entry_id\": \"je-uuid\",\n    \"status\": \"posted\",\n    \"posted_by\": \"user-uuid\",\n    \"posted_at\": \"2026-02-07T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#intercompany-balances","title":"Intercompany Balances","text":""},{"location":"technical-reference/api-reference/#get-intercompany-reconciliation","title":"Get Intercompany Reconciliation","text":"<pre><code>GET /api/v1/intercompany-balances?year={year}&amp;month={month}&amp;variance_threshold={threshold}\n</code></pre> <p>Query Parameters: - <code>year</code> (required) - Period year - <code>month</code> (required) - Period month - <code>variance_threshold</code> (optional) - Minimum variance to include (default: 0.01) - <code>include_eliminated</code> (optional) - Include already eliminated balances (default: false)</p> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": [\n    {\n      \"ic_balance_id\": \"ic-uuid\",\n      \"entity_from_code\": \"EFFECTI\",\n      \"entity_to_code\": \"LEADLOVERS\",\n      \"account_code\": \"1210\",\n      \"account_name\": \"Accounts Receivable - IC\",\n      \"amount_from\": 150000.00,\n      \"amount_to\": -150025.00,\n      \"variance\": 25.00,\n      \"variance_percentage\": 0.017,\n      \"currency\": \"USD\",\n      \"is_eliminated\": false,\n      \"status\": \"minor_variance\"\n    },\n    ...\n  ],\n  \"summary\": {\n    \"total_ic_balances\": 47,\n    \"matched\": 42,\n    \"minor_variance\": 4,\n    \"significant_variance\": 1,\n    \"total_variance\": 1250.75\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#fx-rates","title":"FX Rates","text":""},{"location":"technical-reference/api-reference/#get-fx-rate","title":"Get FX Rate","text":"<pre><code>GET /api/v1/fx-rates?from={currency}&amp;to={currency}&amp;date={date}\n</code></pre> <p>Query Parameters: - <code>from</code> (required) - Source currency code (e.g., BRL) - <code>to</code> (required) - Target currency code (e.g., USD) - <code>date</code> (required) - Rate date (YYYY-MM-DD)</p> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"from_currency\": \"BRL\",\n    \"to_currency\": \"USD\",\n    \"rate_date\": \"2024-12-31\",\n    \"rate\": 0.187453,\n    \"rate_source\": \"bcb\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#get-monthly-average-fx-rate","title":"Get Monthly Average FX Rate","text":"<pre><code>GET /api/v1/fx-rates/monthly?from={currency}&amp;to={currency}&amp;year={year}&amp;month={month}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"from_currency\": \"BRL\",\n    \"to_currency\": \"USD\",\n    \"period_year\": 2024,\n    \"period_month\": 12,\n    \"average_rate\": 0.185234,\n    \"rate_source\": \"bcb\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#upload-fx-rates","title":"Upload FX Rates","text":"<pre><code>POST /api/v1/fx-rates\n</code></pre> <p>Request Body:</p> <pre><code>{\n  \"rates\": [\n    {\n      \"from_currency\": \"BRL\",\n      \"to_currency\": \"USD\",\n      \"rate_date\": \"2024-12-31\",\n      \"rate\": 0.187453,\n      \"rate_source\": \"manual\"\n    },\n    ...\n  ]\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"rates_uploaded\": 5,\n    \"rates_updated\": 2\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#validation","title":"Validation","text":""},{"location":"technical-reference/api-reference/#validate-trial-balance","title":"Validate Trial Balance","text":"<pre><code>POST /api/v1/validation/trial-balance\n</code></pre> <p>Request Body:</p> <pre><code>{\n  \"entity_id\": \"uuid-1\",\n  \"period_year\": 2024,\n  \"period_month\": 12\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"is_valid\": true,\n    \"validation_results\": [\n      {\n        \"rule\": \"debit_credit_balance\",\n        \"passed\": true,\n        \"total_debits\": 5000000.00,\n        \"total_credits\": 5000000.00,\n        \"difference\": 0.00\n      },\n      {\n        \"rule\": \"account_mapping_completeness\",\n        \"passed\": true,\n        \"total_accounts\": 150,\n        \"mapped_accounts\": 150,\n        \"unmapped_accounts\": 0\n      }\n    ],\n    \"warnings\": [],\n    \"errors\": []\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#reporting","title":"Reporting","text":""},{"location":"technical-reference/api-reference/#generate-financial-report","title":"Generate Financial Report","text":"<pre><code>POST /api/v1/reports/generate\n</code></pre> <p>Request Body:</p> <pre><code>{\n  \"report_type\": \"balance_sheet\",\n  \"period_year\": 2024,\n  \"period_month\": 12,\n  \"consolidation_level\": \"group\",\n  \"currency\": \"USD\",\n  \"format\": \"json\",\n  \"options\": {\n    \"include_prior_period\": true,\n    \"include_variance_analysis\": true\n  }\n}\n</code></pre> <p>Report Types: - <code>balance_sheet</code> - Balance Sheet - <code>income_statement</code> - Income Statement - <code>cash_flow</code> - Cash Flow Statement - <code>trial_balance</code> - Trial Balance - <code>consolidation_summary</code> - Consolidation Summary - <code>variance_analysis</code> - Variance Analysis</p> <p>Formats: - <code>json</code> - JSON response - <code>pdf</code> - PDF download - <code>excel</code> - Excel download - <code>csv</code> - CSV download</p> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"report_id\": \"report-uuid\",\n    \"report_type\": \"balance_sheet\",\n    \"status\": \"completed\",\n    \"download_url\": \"https://api.fpa.nuvini.ai/v1/reports/report-uuid/download\",\n    \"expires_at\": \"2026-02-08T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#webhooks","title":"Webhooks","text":""},{"location":"technical-reference/api-reference/#register-webhook","title":"Register Webhook","text":"<p>Subscribe to events.</p> <pre><code>POST /api/v1/webhooks\n</code></pre> <p>Request Body:</p> <pre><code>{\n  \"url\": \"https://your-app.com/webhooks/fpa\",\n  \"events\": [\n    \"consolidation.completed\",\n    \"journal_entry.approved\",\n    \"period.closed\"\n  ],\n  \"secret\": \"your-webhook-secret\"\n}\n</code></pre> <p>Response:</p> <pre><code>{\n  \"success\": true,\n  \"data\": {\n    \"webhook_id\": \"webhook-uuid\",\n    \"url\": \"https://your-app.com/webhooks/fpa\",\n    \"events\": [\n      \"consolidation.completed\",\n      \"journal_entry.approved\",\n      \"period.closed\"\n    ],\n    \"created_at\": \"2026-02-07T10:30:00Z\"\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#webhook-events","title":"Webhook Events","text":"Event Description Payload <code>consolidation.completed</code> Consolidation process finished consolidation_id, period_year, period_month, status <code>consolidation.failed</code> Consolidation process failed consolidation_id, error_message <code>journal_entry.created</code> New journal entry created entry_id, entity_id, period <code>journal_entry.approved</code> Journal entry approved entry_id, approved_by <code>journal_entry.posted</code> Journal entry posted entry_id, posted_by <code>period.closed</code> Period hard locked entity_id, period_year, period_month <code>validation.failed</code> Validation check failed entity_id, validation_type, errors"},{"location":"technical-reference/api-reference/#webhook-payload-example","title":"Webhook Payload Example","text":"<pre><code>{\n  \"event\": \"consolidation.completed\",\n  \"timestamp\": \"2026-02-07T10:34:23Z\",\n  \"data\": {\n    \"consolidation_id\": \"cons-uuid\",\n    \"period_year\": 2024,\n    \"period_month\": 12,\n    \"status\": \"completed\",\n    \"accuracy_score\": 0.998\n  },\n  \"signature\": \"sha256=abc123...\"\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#sdks-and-client-libraries","title":"SDKs and Client Libraries","text":""},{"location":"technical-reference/api-reference/#python","title":"Python","text":"<pre><code>from fpa_client import FPAClient\n\nclient = FPAClient(api_key='fpa_abc123...xyz789')\n\n# Get trial balance\ntrial_balance = client.trial_balances.get(\n    entity_id='uuid-1',\n    year=2024,\n    month=12\n)\n\n# Trigger consolidation\nconsolidation = client.consolidation.run(\n    period_year=2024,\n    period_month=12,\n    presentation_currency='USD'\n)\n</code></pre>"},{"location":"technical-reference/api-reference/#typescriptjavascript","title":"TypeScript/JavaScript","text":"<pre><code>import { FPAClient } from '@nuvini/fpa-client';\n\nconst client = new FPAClient({ apiKey: 'fpa_abc123...xyz789' });\n\n// Get trial balance\nconst trialBalance = await client.trialBalances.get({\n  entityId: 'uuid-1',\n  year: 2024,\n  month: 12\n});\n\n// Trigger consolidation\nconst consolidation = await client.consolidation.run({\n  periodYear: 2024,\n  periodMonth: 12,\n  presentationCurrency: 'USD'\n});\n</code></pre>"},{"location":"technical-reference/api-reference/#pagination","title":"Pagination","text":"<p>Paginated endpoints support the following query parameters:</p> <ul> <li><code>page</code> - Page number (default: 1)</li> <li><code>per_page</code> - Items per page (default: 50, max: 200)</li> </ul> <p>Response includes pagination metadata:</p> <pre><code>{\n  \"data\": [...],\n  \"pagination\": {\n    \"page\": 1,\n    \"per_page\": 50,\n    \"total\": 127,\n    \"total_pages\": 3,\n    \"has_next\": true,\n    \"has_prev\": false\n  }\n}\n</code></pre>"},{"location":"technical-reference/api-reference/#see-also","title":"See Also","text":"<ul> <li>Database Schema</li> <li>Security Architecture</li> <li>ERP Connectors</li> </ul>"},{"location":"technical-reference/configuration/","title":"Configuration Reference","text":"<p>Version: 1.0.0 Last Updated: 2026-02-07 Configuration File: <code>/Volumes/AI/Code/FPA/config/security_policy.yaml</code></p>"},{"location":"technical-reference/configuration/#overview","title":"Overview","text":"<p>The AI FP&amp;A system uses YAML-based configuration for security policies, RBAC rules, encryption settings, and human oversight parameters. This document provides a complete reference for all configuration options.</p>"},{"location":"technical-reference/configuration/#configuration-structure","title":"Configuration Structure","text":"<pre><code>config/\n\u251c\u2500\u2500 security_policy.yaml         # Main security configuration\n\u251c\u2500\u2500 database.yaml                # Database connection settings\n\u251c\u2500\u2500 erp_connectors.yaml          # ERP connector credentials\n\u2514\u2500\u2500 environments/\n    \u251c\u2500\u2500 development.yaml\n    \u251c\u2500\u2500 staging.yaml\n    \u2514\u2500\u2500 production.yaml\n</code></pre>"},{"location":"technical-reference/configuration/#security-policy-configuration","title":"Security Policy Configuration","text":""},{"location":"technical-reference/configuration/#encryption-settings","title":"Encryption Settings","text":""},{"location":"technical-reference/configuration/#standards","title":"Standards","text":"<pre><code>encryption:\n  standards:\n    algorithm: \"AES-256-GCM\"      # Encryption algorithm\n    key_size: 256                  # Key size in bits\n    tls_version: \"1.3\"             # TLS version\n    tls_fallback: \"1.2\"            # TLS fallback version\n</code></pre> <p>Valid Values: - <code>algorithm</code>: <code>AES-256-GCM</code>, <code>AES-256-CBC</code> - <code>key_size</code>: <code>128</code>, <code>192</code>, <code>256</code> - <code>tls_version</code>: <code>1.2</code>, <code>1.3</code></p>"},{"location":"technical-reference/configuration/#key-rotation","title":"Key Rotation","text":"<pre><code>encryption:\n  key_rotation:\n    enabled: true                  # Enable automatic key rotation\n    rotation_interval_days: 90     # Rotation frequency (days)\n    notification_before_days: 14   # Warning before rotation\n    auto_rotation: true            # Automatic vs manual rotation\n</code></pre> <p>Valid Values: - <code>rotation_interval_days</code>: <code>30-365</code> - <code>notification_before_days</code>: <code>7-30</code></p>"},{"location":"technical-reference/configuration/#aws-kms-configuration","title":"AWS KMS Configuration","text":"<pre><code>encryption:\n  kms:\n    enabled: true\n    master_key_id: \"${AWS_KMS_MASTER_KEY_ID}\"\n    s3_key_id: \"${AWS_KMS_S3_KEY_ID}\"\n    key_alias: \"alias/fpa-master-key\"\n    multi_region: true\n</code></pre> <p>Environment Variables: - <code>AWS_KMS_MASTER_KEY_ID</code> - ARN of master KMS key - <code>AWS_KMS_S3_KEY_ID</code> - ARN of S3 encryption key - <code>AWS_REGION</code> - AWS region (default: us-east-1)</p>"},{"location":"technical-reference/configuration/#tls-configuration","title":"TLS Configuration","text":"<pre><code>encryption:\n  tls:\n    minimum_version: \"TLSv1_2\"\n    preferred_version: \"TLSv1_3\"\n    cipher_suites:\n      - \"ECDHE-ECDSA-AES256-GCM-SHA384\"\n      - \"ECDHE-RSA-AES256-GCM-SHA384\"\n      - \"ECDHE-ECDSA-CHACHA20-POLY1305\"\n      - \"ECDHE-RSA-CHACHA20-POLY1305\"\n      - \"ECDHE-ECDSA-AES128-GCM-SHA256\"\n      - \"ECDHE-RSA-AES128-GCM-SHA256\"\n    verify_certificates: true\n    check_hostname: true\n</code></pre> <p>Cipher Suite Priority: 1. ECDHE (Forward secrecy) 2. AES-256-GCM (Authenticated encryption) 3. ChaCha20-Poly1305 (Mobile optimization)</p>"},{"location":"technical-reference/configuration/#postgresql-encryption","title":"PostgreSQL Encryption","text":"<pre><code>encryption:\n  postgresql:\n    ssl_mode: \"require\"            # SSL connection mode\n    ssl_cert_verification: true    # Verify server certificate\n    connection_encryption: true    # Encrypt all connections\n    enable_pgcrypto: true          # Enable pgcrypto extension\n\n    tde:\n      enabled: true\n      method: \"pgcrypto\"\n\n    encrypted_columns:\n      - table: \"financials\"\n        columns: [\"revenue\", \"net_income\", \"ebitda\"]\n        field_type: \"revenue\"\n\n      - table: \"customers\"\n        columns: [\"customer_name\", \"tax_id\", \"bank_account\"]\n        field_type: \"customer_data\"\n</code></pre> <p>SSL Modes: - <code>disable</code> - No SSL (not recommended) - <code>allow</code> - Use SSL if available - <code>prefer</code> - Prefer SSL - <code>require</code> - Require SSL - <code>verify-ca</code> - Require SSL and verify CA - <code>verify-full</code> - Require SSL and verify hostname</p>"},{"location":"technical-reference/configuration/#s3-encryption","title":"S3 Encryption","text":"<pre><code>encryption:\n  s3:\n    server_side_encryption: \"aws:kms\"\n    bucket_key_enabled: true\n    enforce_encryption: true\n\n    backup_bucket:\n      name: \"${S3_BACKUP_BUCKET}\"\n      versioning: true\n      object_lock: true\n      lifecycle:\n        transition_to_glacier_days: 90\n        expiration_days: 2555        # 7 years\n\n  backups:\n    encryption_required: true\n    double_encryption: true          # App-level + S3 KMS\n    backup_key_rotation_days: 30\n    retention_years: 7\n    test_restoration_monthly: true\n</code></pre> <p>S3 Encryption Options: - <code>AES256</code> - S3-managed keys - <code>aws:kms</code> - KMS-managed keys (recommended) - <code>aws:kms:dsse</code> - Dual-layer server-side encryption</p>"},{"location":"technical-reference/configuration/#rbac-configuration","title":"RBAC Configuration","text":""},{"location":"technical-reference/configuration/#enable-rbac","title":"Enable RBAC","text":"<pre><code>rbac:\n  enabled: true\n</code></pre>"},{"location":"technical-reference/configuration/#role-definitions","title":"Role Definitions","text":"<pre><code>rbac:\n  roles:\n    orchestrator:\n      description: \"Master orchestrator with full operational access\"\n      permissions:\n        - \"read_raw_data\"\n        - \"write_raw_data\"\n        - \"read_consolidated_data\"\n        - \"write_consolidated_data\"\n        - \"create_journal_entry\"\n        - \"run_variance_analysis\"\n        - \"create_forecast\"\n        - \"generate_report\"\n        - \"execute_batch_job\"\n        - \"access_api\"\n        - \"view_audit_logs\"\n      data_access_level: \"confidential\"\n      companies: null                 # All companies\n</code></pre> <p>Data Access Levels: - <code>public</code> - No restrictions - <code>internal</code> - Internal use only - <code>confidential</code> - Confidential data - <code>restricted</code> - Highly restricted (PII, financials)</p> <p>Permissions List:</p> <pre><code>permissions:\n  # Data access\n  - read_raw_data\n  - write_raw_data\n  - read_consolidated_data\n  - write_consolidated_data\n  - read_sensitive_data\n\n  # Financial operations\n  - create_journal_entry\n  - approve_journal_entry\n  - reverse_journal_entry\n  - close_period\n  - reopen_period\n\n  # Analysis\n  - run_variance_analysis\n  - create_forecast\n  - modify_assumptions\n\n  # Reports\n  - generate_report\n  - export_data\n  - share_report\n\n  # Administrative\n  - manage_users\n  - modify_schema\n  - view_audit_logs\n  - modify_security_settings\n\n  # System\n  - execute_batch_job\n  - access_api\n</code></pre>"},{"location":"technical-reference/configuration/#api-key-configuration","title":"API Key Configuration","text":"<pre><code>rbac:\n  api_keys:\n    enabled: true\n    key_prefix: \"fpa_\"\n    key_length: 43                   # 32 bytes base64\n    default_expiration_days: 90\n    max_expiration_days: 365\n    rotation_warning_days: 14\n\n    scoping:\n      by_role: true\n      by_company: true\n      by_ip: false                   # Set to true for production\n</code></pre> <p>API Key Format: <pre><code>fpa_&lt;base64-encoded-32-bytes&gt;\nExample: fpa_abc123def456ghi789jkl012mno345pqr678stu901\n</code></pre></p>"},{"location":"technical-reference/configuration/#row-level-security","title":"Row-Level Security","text":"<pre><code>rbac:\n  row_level_security:\n    enabled: true\n    enforce_in_database: true\n\n    company_isolation:\n      enabled: true\n      filter_column: \"company_id\"\n      session_variable: \"app.allowed_companies\"\n</code></pre> <p>PostgreSQL Session Variable:</p> <pre><code>-- Set allowed companies for current session\nSET app.allowed_companies = 'effecti,leadlovers';\n\n-- RLS policy will filter to only these companies\nSELECT * FROM trial_balances;  -- Only returns effecti and leadlovers data\n</code></pre>"},{"location":"technical-reference/configuration/#audit-logging","title":"Audit Logging","text":"<pre><code>rbac:\n  audit_logging:\n    enabled: true\n    log_all_access: true\n    log_permission_violations: true\n    log_failed_auth: true\n    retention_days: 2555              # 7 years\n\n    events:\n      - \"permission_check\"\n      - \"permission_violation\"\n      - \"api_key_created\"\n      - \"api_key_revoked\"\n      - \"api_key_used\"\n      - \"data_access\"\n      - \"data_modification\"\n      - \"role_assignment\"\n      - \"security_setting_change\"\n</code></pre>"},{"location":"technical-reference/configuration/#human-oversight-configuration","title":"Human Oversight Configuration","text":""},{"location":"technical-reference/configuration/#confidence-thresholds","title":"Confidence Thresholds","text":"<pre><code>human_oversight:\n  enabled: true\n\n  confidence_thresholds:\n    green: 0.80                       # &gt;= 80% confidence\n    yellow: 0.50                      # 50-79% confidence\n    # &lt; 50% = red (implicit)\n</code></pre> <p>Risk Level Determination:</p> <pre><code>if confidence &gt;= 0.80:\n    return RiskLevel.GREEN\nelif confidence &gt;= 0.50:\n    return RiskLevel.YELLOW\nelse:\n    return RiskLevel.RED\n</code></pre>"},{"location":"technical-reference/configuration/#sampling-rates","title":"Sampling Rates","text":"<pre><code>human_oversight:\n  sampling:\n    green: 0.05                       # 5% post-review sampling\n    yellow: 1.00                      # 100% mandatory pre-review\n    red: 1.00                         # 100% mandatory pre-review\n</code></pre> <p>Sampling Strategy: - Green: Random sampling for continuous monitoring - Yellow: All transactions require review - Red: All transactions require escalated review</p>"},{"location":"technical-reference/configuration/#materiality-thresholds","title":"Materiality Thresholds","text":"<pre><code>human_oversight:\n  materiality_thresholds:\n    small:\n      amount: 10000\n      currency: \"USD\"\n    medium:\n      amount: 50000\n      currency: \"USD\"\n    large:\n      amount: 250000\n      currency: \"USD\"\n    enterprise:\n      amount: 1000000\n      currency: \"USD\"\n</code></pre> <p>Company Size Determination: - <code>small</code>: Annual revenue &lt; $10M - <code>medium</code>: Annual revenue $10M-$100M - <code>large</code>: Annual revenue $100M-$1B - <code>enterprise</code>: Annual revenue &gt; $1B</p>"},{"location":"technical-reference/configuration/#risk-factor-weights","title":"Risk Factor Weights","text":"<pre><code>human_oversight:\n  risk_factors:\n    materiality:\n      weight: 0.30\n      description: \"Transaction amount relative to materiality threshold\"\n\n    pattern_deviation:\n      weight: 0.25\n      description: \"Deviation from historical transaction patterns\"\n\n    data_quality:\n      weight: 0.20\n      description: \"Data quality and completeness score\"\n\n    complexity:\n      weight: 0.15\n      description: \"Transaction complexity and special handling\"\n\n    variance:\n      weight: 0.10\n      description: \"Variance from budgeted or forecasted amounts\"\n</code></pre> <p>Constraint: Weights must sum to 1.0</p>"},{"location":"technical-reference/configuration/#mandatory-review-categories","title":"Mandatory Review Categories","text":"<pre><code>human_oversight:\n  mandatory_review:\n    - category: \"period_close\"\n      description: \"Monthly/quarterly period close operations\"\n      required_reviewers: 2\n      escalation_level: \"fpa_manager\"\n\n    - category: \"intercompany_elimination\"\n      description: \"Intercompany transaction eliminations\"\n      required_reviewers: 2\n      escalation_level: \"fpa_manager\"\n\n    - category: \"regulatory_report\"\n      description: \"External regulatory reporting\"\n      required_reviewers: 2\n      escalation_level: \"cfo\"\n\n    - category: \"manual_adjustment\"\n      description: \"Manual journal entries and adjustments\"\n      required_reviewers: 1\n      escalation_level: \"fpa_analyst\"\n\n    - category: \"variance_exceeds_threshold\"\n      description: \"Variances exceeding 15% of budget/forecast\"\n      required_reviewers: 1\n      escalation_level: \"fpa_analyst\"\n      threshold: 0.15\n</code></pre>"},{"location":"technical-reference/configuration/#four-eyes-principle","title":"Four-Eyes Principle","text":"<pre><code>human_oversight:\n  four_eyes:\n    enabled: true\n    required_for:\n      - \"period_close\"\n      - \"intercompany_elimination\"\n      - \"regulatory_report\"\n      - \"external_communication\"\n      - \"red_risk_level\"\n    minimum_reviewers: 2\n    same_reviewer_allowed: false\n</code></pre>"},{"location":"technical-reference/configuration/#escalation-matrix","title":"Escalation Matrix","text":"<pre><code>human_oversight:\n  escalation:\n    levels:\n      - level: 0\n        name: \"none\"\n        description: \"No escalation - auto-approved with sampling\"\n\n      - level: 1\n        name: \"fpa_analyst\"\n        description: \"FP&amp;A Analyst review\"\n        sla_hours: 24\n\n      - level: 2\n        name: \"fpa_manager\"\n        description: \"FP&amp;A Manager review\"\n        sla_hours: 12\n\n      - level: 3\n        name: \"cfo\"\n        description: \"CFO review\"\n        sla_hours: 6\n\n      - level: 4\n        name: \"audit_committee\"\n        description: \"Audit Committee review\"\n        sla_hours: 48\n\n    auto_escalation:\n      enabled: true\n      escalate_if_overdue: true\n      escalate_if_rejected: true\n      escalate_after_hours: 24\n</code></pre>"},{"location":"technical-reference/configuration/#review-workflow","title":"Review Workflow","text":"<pre><code>human_oversight:\n  review_workflow:\n    notification_enabled: true\n    notification_channels:\n      - \"email\"\n      - \"slack\"\n\n    reminder_schedule:\n      - hours: 12\n        message: \"Review pending - 12 hours\"\n      - hours: 24\n        message: \"Review overdue - escalating\"\n        action: \"escalate\"\n\n    review_retention_days: 2555       # 7 years\n</code></pre>"},{"location":"technical-reference/configuration/#oversight-reporting","title":"Oversight Reporting","text":"<pre><code>human_oversight:\n  oversight_reporting:\n    enabled: true\n\n    reports:\n      - name: \"daily_review_summary\"\n        frequency: \"daily\"\n        recipients:\n          - \"fpa_manager\"\n\n      - name: \"weekly_oversight_metrics\"\n        frequency: \"weekly\"\n        recipients:\n          - \"fpa_manager\"\n          - \"cfo\"\n\n      - name: \"monthly_control_effectiveness\"\n        frequency: \"monthly\"\n        recipients:\n          - \"cfo\"\n          - \"audit_committee\"\n\n    metrics:\n      - \"total_reviews\"\n      - \"approval_rate\"\n      - \"average_confidence_score\"\n      - \"risk_level_breakdown\"\n      - \"four_eyes_percentage\"\n      - \"sla_compliance\"\n      - \"escalation_rate\"\n      - \"average_review_time\"\n</code></pre>"},{"location":"technical-reference/configuration/#compliance-configuration","title":"Compliance Configuration","text":""},{"location":"technical-reference/configuration/#frameworks","title":"Frameworks","text":"<pre><code>compliance:\n  frameworks:\n    - \"SOC 2 Type II\"\n    - \"ISO 27001\"\n    - \"IFRS\"\n    - \"US GAAP\"\n    - \"NASDAQ Listing Requirements\"\n</code></pre>"},{"location":"technical-reference/configuration/#data-retention","title":"Data Retention","text":"<pre><code>compliance:\n  data_retention:\n    financial_data_years: 7\n    audit_logs_years: 7\n    backups_years: 7\n</code></pre>"},{"location":"technical-reference/configuration/#data-classification","title":"Data Classification","text":"<pre><code>compliance:\n  data_classification:\n    levels:\n      - name: \"public\"\n        encryption_required: false\n        access_logging: false\n\n      - name: \"internal\"\n        encryption_required: true\n        access_logging: true\n\n      - name: \"confidential\"\n        encryption_required: true\n        access_logging: true\n        approval_required: false\n\n      - name: \"restricted\"\n        encryption_required: true\n        access_logging: true\n        approval_required: true\n</code></pre>"},{"location":"technical-reference/configuration/#security-monitoring","title":"Security Monitoring","text":"<pre><code>compliance:\n  monitoring:\n    enabled: true\n\n    alerts:\n      - event: \"multiple_failed_auth\"\n        threshold: 5\n        window_minutes: 15\n        severity: \"high\"\n\n      - event: \"permission_violation\"\n        threshold: 3\n        window_minutes: 60\n        severity: \"medium\"\n\n      - event: \"unusual_data_access\"\n        threshold: 1\n        window_minutes: 1\n        severity: \"high\"\n\n      - event: \"encryption_failure\"\n        threshold: 1\n        window_minutes: 1\n        severity: \"critical\"\n\n    incident_response:\n      enabled: true\n      notification_channels:\n        - \"email\"\n        - \"pagerduty\"\n      escalation_minutes: 30\n</code></pre>"},{"location":"technical-reference/configuration/#system-configuration","title":"System Configuration","text":""},{"location":"technical-reference/configuration/#environment","title":"Environment","text":"<pre><code>system:\n  environment: \"${ENVIRONMENT}\"       # development, staging, production\n</code></pre> <p>Valid Environments: - <code>development</code> - Local development - <code>staging</code> - Staging/UAT environment - <code>production</code> - Production environment</p>"},{"location":"technical-reference/configuration/#feature-flags","title":"Feature Flags","text":"<pre><code>system:\n  features:\n    encryption: true\n    rbac: true\n    human_oversight: true\n    audit_logging: true\n</code></pre>"},{"location":"technical-reference/configuration/#security-hardening","title":"Security Hardening","text":"<pre><code>system:\n  hardening:\n    disable_root_access: true\n    require_mfa: true\n    session_timeout_minutes: 60\n    password_policy:\n      min_length: 16\n      require_special_chars: true\n      require_numbers: true\n      require_uppercase: true\n      expiration_days: 90\n</code></pre>"},{"location":"technical-reference/configuration/#database-configuration","title":"Database Configuration","text":""},{"location":"technical-reference/configuration/#connection-settings","title":"Connection Settings","text":"<pre><code>database:\n  host: \"${DB_HOST}\"\n  port: 5432\n  database: \"${DB_NAME}\"\n  username: \"${DB_USERNAME}\"\n  password: \"${DB_PASSWORD}\"\n\n  ssl:\n    enabled: true\n    mode: \"verify-full\"\n    cert_file: \"/path/to/cert.pem\"\n    key_file: \"/path/to/key.pem\"\n    ca_file: \"/path/to/ca.pem\"\n\n  pool:\n    min_size: 5\n    max_size: 20\n    timeout: 30\n</code></pre>"},{"location":"technical-reference/configuration/#performance-tuning","title":"Performance Tuning","text":"<pre><code>database:\n  performance:\n    shared_buffers: \"8GB\"\n    effective_cache_size: \"24GB\"\n    work_mem: \"256MB\"\n    maintenance_work_mem: \"2GB\"\n    max_worker_processes: 8\n    max_parallel_workers_per_gather: 4\n    max_parallel_workers: 8\n\n  optimization:\n    random_page_cost: 1.1             # For SSD\n    effective_io_concurrency: 200\n    enable_partition_pruning: true\n    constraint_exclusion: \"partition\"\n    default_statistics_target: 100\n</code></pre>"},{"location":"technical-reference/configuration/#erp-connector-configuration","title":"ERP Connector Configuration","text":""},{"location":"technical-reference/configuration/#totvs-protheus","title":"TOTVS Protheus","text":"<pre><code>erp_connectors:\n  totvs_protheus:\n    base_url: \"https://api.totvs.com.br/protheus\"\n    auth_type: \"oauth2\"\n    credentials:\n      client_id: \"${TOTVS_CLIENT_ID}\"\n      client_secret: \"${TOTVS_CLIENT_SECRET}\"\n      token_url: \"https://api.totvs.com.br/oauth/token\"\n    config:\n      tenant: \"${TOTVS_TENANT_ID}\"\n      environment: \"production\"\n      timeout: 30\n      rate_limit: 100                 # requests per minute\n</code></pre>"},{"location":"technical-reference/configuration/#contaazul","title":"ContaAzul","text":"<pre><code>erp_connectors:\n  contaazul:\n    base_url: \"https://api.contaazul.com/v1\"\n    auth_type: \"oauth2\"\n    credentials:\n      client_id: \"${CONTAAZUL_CLIENT_ID}\"\n      client_secret: \"${CONTAAZUL_CLIENT_SECRET}\"\n      token_url: \"https://api.contaazul.com/oauth/token\"\n    config:\n      timeout: 30\n      rate_limit: 60\n</code></pre>"},{"location":"technical-reference/configuration/#omie","title":"Omie","text":"<pre><code>erp_connectors:\n  omie:\n    base_url: \"https://app.omie.com.br/api/v1\"\n    auth_type: \"api_key\"\n    credentials:\n      app_key: \"${OMIE_APP_KEY}\"\n      app_secret: \"${OMIE_APP_SECRET}\"\n    config:\n      timeout: 30\n      rate_limit: 300\n</code></pre>"},{"location":"technical-reference/configuration/#bling","title":"Bling","text":"<pre><code>erp_connectors:\n  bling:\n    base_url: \"https://bling.com.br/Api/v3\"\n    auth_type: \"api_key\"\n    credentials:\n      api_key: \"${BLING_API_KEY}\"\n    config:\n      api_version: \"v3\"\n      timeout: 30\n      rate_limit: 100\n</code></pre>"},{"location":"technical-reference/configuration/#environment-specific-configuration","title":"Environment-Specific Configuration","text":""},{"location":"technical-reference/configuration/#development","title":"Development","text":"<pre><code># environments/development.yaml\nsystem:\n  environment: \"development\"\n\ndatabase:\n  host: \"localhost\"\n  port: 5432\n  pool:\n    min_size: 2\n    max_size: 10\n\nencryption:\n  kms:\n    enabled: false                    # Use local encryption\n\nhuman_oversight:\n  confidence_thresholds:\n    green: 0.60                       # Lower threshold for testing\n    yellow: 0.30\n</code></pre>"},{"location":"technical-reference/configuration/#production","title":"Production","text":"<pre><code># environments/production.yaml\nsystem:\n  environment: \"production\"\n\ndatabase:\n  host: \"prod-db.fpa.nuvini.ai\"\n  ssl:\n    mode: \"verify-full\"\n\nencryption:\n  kms:\n    enabled: true\n    multi_region: true\n\nrbac:\n  api_keys:\n    scoping:\n      by_ip: true                     # IP whitelisting in production\n\nhuman_oversight:\n  confidence_thresholds:\n    green: 0.80\n    yellow: 0.50\n\ncompliance:\n  monitoring:\n    enabled: true\n</code></pre>"},{"location":"technical-reference/configuration/#loading-configuration","title":"Loading Configuration","text":""},{"location":"technical-reference/configuration/#python","title":"Python","text":"<pre><code>import yaml\nfrom pathlib import Path\n\n# Load configuration\nconfig_path = Path(\"/Volumes/AI/Code/FPA/config/security_policy.yaml\")\nwith open(config_path) as f:\n    config = yaml.safe_load(f)\n\n# Load environment-specific overrides\nenv = os.environ.get(\"ENVIRONMENT\", \"development\")\nenv_config_path = Path(f\"/Volumes/AI/Code/FPA/config/environments/{env}.yaml\")\nif env_config_path.exists():\n    with open(env_config_path) as f:\n        env_config = yaml.safe_load(f)\n        # Merge configurations (deep merge)\n        config = deep_merge(config, env_config)\n\n# Access configuration\nencryption_enabled = config['encryption']['kms']['enabled']\ngreen_threshold = config['human_oversight']['confidence_thresholds']['green']\n</code></pre>"},{"location":"technical-reference/configuration/#environment-variable-substitution","title":"Environment Variable Substitution","text":"<pre><code>import os\nimport re\n\ndef substitute_env_vars(config_str):\n    \"\"\"Replace ${VAR} with environment variable values.\"\"\"\n    pattern = r'\\$\\{([^}]+)\\}'\n    return re.sub(\n        pattern,\n        lambda m: os.environ.get(m.group(1), m.group(0)),\n        config_str\n    )\n\n# Load with substitution\nwith open(config_path) as f:\n    config_str = f.read()\n    config_str = substitute_env_vars(config_str)\n    config = yaml.safe_load(config_str)\n</code></pre>"},{"location":"technical-reference/configuration/#validation","title":"Validation","text":""},{"location":"technical-reference/configuration/#schema-validation","title":"Schema Validation","text":"<pre><code>from jsonschema import validate\n\n# Define schema\nconfig_schema = {\n    \"type\": \"object\",\n    \"required\": [\"encryption\", \"rbac\", \"human_oversight\"],\n    \"properties\": {\n        \"encryption\": {\n            \"type\": \"object\",\n            \"required\": [\"standards\", \"kms\"]\n        },\n        \"rbac\": {\n            \"type\": \"object\",\n            \"required\": [\"enabled\", \"roles\"]\n        },\n        \"human_oversight\": {\n            \"type\": \"object\",\n            \"required\": [\"enabled\", \"confidence_thresholds\"]\n        }\n    }\n}\n\n# Validate configuration\nvalidate(instance=config, schema=config_schema)\n</code></pre>"},{"location":"technical-reference/configuration/#see-also","title":"See Also","text":"<ul> <li>Database Schema</li> <li>API Reference</li> <li>Security Architecture</li> <li>ERP Connectors</li> <li>Consolidation Engine</li> </ul>"},{"location":"technical-reference/consolidation-engine/","title":"Consolidation Engine Technical Reference","text":"<p>Version: 1.0.0 Last Updated: 2026-02-07 Implementation: <code>/Volumes/AI/Code/FPA/src/consolidation/</code> Standards: IFRS 10, IFRS 3, IAS 21, ASC 810, ASC 805, ASC 830</p>"},{"location":"technical-reference/consolidation-engine/#overview","title":"Overview","text":"<p>The Consolidation Engine is a production-ready IFRS/US GAAP-compliant system that performs multi-entity financial consolidation with FX conversion, intercompany elimination, purchase price allocation (PPA), and GAAP reconciliation.</p>"},{"location":"technical-reference/consolidation-engine/#architecture","title":"Architecture","text":""},{"location":"technical-reference/consolidation-engine/#component-diagram","title":"Component Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  ConsolidationEngine                         \u2502\n\u2502                  (Main Orchestrator)                         \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                 \u2502\n\u2502  \u2502  FXRateManager   \u2502  \u2502  FXConverter     \u2502                 \u2502\n\u2502  \u2502  - Rate storage  \u2502  \u2502  - IFRS 21 logic \u2502                 \u2502\n\u2502  \u2502  - BCB/ECB API   \u2502  \u2502  - CTA tracking  \u2502                 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                 \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                 \u2502\n\u2502  \u2502 IC Matcher       \u2502  \u2502 EliminationEng   \u2502                 \u2502\n\u2502  \u2502 - AR/AP match    \u2502  \u2502  - JE creation   \u2502                 \u2502\n\u2502  \u2502 - Rev/Exp match  \u2502  \u2502  - FX adjustment \u2502                 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                 \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                 \u2502\n\u2502  \u2502 PPAManager       \u2502  \u2502 GAAPReconEngine  \u2502                 \u2502\n\u2502  \u2502 - Goodwill calc  \u2502  \u2502  - IFRS\u2192US GAAP  \u2502                 \u2502\n\u2502  \u2502 - Amortization   \u2502  \u2502  - Dual reporting\u2502                 \u2502\n\u2502  \u2502 - Impairment     \u2502  \u2502  - Disclosure fmt\u2502                 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                 \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                       \u2502\n\u2502  \u2502 Validator        \u2502                                       \u2502\n\u2502  \u2502 - 7 core rules   \u2502                                       \u2502\n\u2502  \u2502 - Accuracy calc  \u2502                                       \u2502\n\u2502  \u2502 - Compliance chk \u2502                                       \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#module-structure","title":"Module Structure","text":"<pre><code>consolidation/\n\u251c\u2500\u2500 __init__.py                   # Package exports\n\u251c\u2500\u2500 models.py                     # Data models and enums\n\u251c\u2500\u2500 fx_converter.py               # FX rate management &amp; conversion\n\u251c\u2500\u2500 eliminations.py               # Intercompany elimination\n\u251c\u2500\u2500 ppa.py                        # Purchase price allocation\n\u251c\u2500\u2500 gaap_reconciliation.py        # IFRS/US GAAP reconciliation\n\u251c\u2500\u2500 consolidator.py               # Main consolidation engine\n\u251c\u2500\u2500 validation.py                 # Validation framework\n\u251c\u2500\u2500 example_usage.py              # Working examples\n\u2514\u2500\u2500 README.md                     # User documentation\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#core-models","title":"Core Models","text":""},{"location":"technical-reference/consolidation-engine/#entity","title":"Entity","text":"<p>Represents a portfolio company.</p> <pre><code>from consolidation import Entity, Currency\n\nentity = Entity(\n    entity_id=\"effecti\",\n    entity_name=\"Effecti\",\n    functional_currency=Currency.BRL,\n    ownership_percentage=Decimal(\"100.0\"),\n    country_code=\"BR\",\n    parent_entity_id=None,\n    is_active=True\n)\n</code></pre> <p>Fields: - <code>entity_id</code> - Unique identifier - <code>entity_name</code> - Company name - <code>functional_currency</code> - Entity's functional currency - <code>ownership_percentage</code> - Ownership stake (0-100) - <code>country_code</code> - ISO country code - <code>parent_entity_id</code> - Parent entity for hierarchy - <code>is_active</code> - Whether entity is active</p>"},{"location":"technical-reference/consolidation-engine/#trialbalanceentry","title":"TrialBalanceEntry","text":"<p>Represents a single account balance.</p> <pre><code>from consolidation import TrialBalanceEntry, AccountType\n\nentry = TrialBalanceEntry(\n    entity_id=\"effecti\",\n    account_code=\"1.01.001\",\n    account_name=\"Caixa\",\n    account_type=AccountType.ASSET,\n    opening_balance=Decimal(\"100000.00\"),\n    debit_amount=Decimal(\"50000.00\"),\n    credit_amount=Decimal(\"30000.00\"),\n    ending_balance=Decimal(\"120000.00\"),\n    currency=Currency.BRL,\n    standard_account_code=\"1010\"\n)\n</code></pre> <p>Fields: - <code>entity_id</code> - Entity identifier - <code>account_code</code> - Local account code - <code>account_name</code> - Local account name - <code>account_type</code> - ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE - <code>opening_balance</code> - Period opening balance - <code>debit_amount</code> - Period debits - <code>credit_amount</code> - Period credits - <code>ending_balance</code> - Period ending balance - <code>currency</code> - Currency code - <code>standard_account_code</code> - Mapped standard COA code</p>"},{"location":"technical-reference/consolidation-engine/#consolidatedbalance","title":"ConsolidatedBalance","text":"<p>Represents a consolidated account balance.</p> <pre><code>from consolidation import ConsolidatedBalance\n\nbalance = ConsolidatedBalance(\n    account_code=\"1010\",\n    account_name=\"Cash\",\n    account_type=AccountType.ASSET,\n    opening_balance=Decimal(\"1500000.00\"),\n    period_activity=Decimal(\"250000.00\"),\n    ending_balance=Decimal(\"1750000.00\"),\n    currency=Currency.USD,\n    entity_contributions={\n        \"effecti\": Decimal(\"850000.00\"),\n        \"leadlovers\": Decimal(\"900000.00\")\n    }\n)\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#foreign-exchange-fx-conversion","title":"Foreign Exchange (FX) Conversion","text":""},{"location":"technical-reference/consolidation-engine/#ifrs-21-asc-830-compliance","title":"IFRS 21 / ASC 830 Compliance","text":"<p>The FX converter implements IFRS 21 (IAS 21) and ASC 830 standards:</p> <ul> <li>Balance Sheet Accounts \u2192 Closing rate (spot rate at period end)</li> <li>P&amp;L Accounts \u2192 Average rate (period average)</li> <li>Equity Accounts \u2192 Historical rate (rate at acquisition/transaction)</li> <li>CTA Calculation \u2192 Cumulative Translation Adjustment tracking</li> </ul>"},{"location":"technical-reference/consolidation-engine/#fxratemanager","title":"FXRateManager","text":"<p>Manages exchange rates from multiple sources.</p> <pre><code>from consolidation import FXRateManager, Currency, FXRateSource\n\nrate_manager = FXRateManager()\n\n# Add rate\nrate_manager.add_rate(\n    from_currency=Currency.BRL,\n    to_currency=Currency.USD,\n    rate=Decimal(\"0.187453\"),\n    rate_date=date(2024, 12, 31),\n    source=FXRateSource.BCB\n)\n\n# Get rate (with fallback)\nrate = rate_manager.get_rate(\n    from_currency=Currency.BRL,\n    to_currency=Currency.USD,\n    rate_date=date(2024, 12, 31)\n)\n\n# Get average rate for period\navg_rate = rate_manager.get_average_rate(\n    from_currency=Currency.BRL,\n    to_currency=Currency.USD,\n    start_date=date(2024, 1, 1),\n    end_date=date(2024, 12, 31)\n)\n</code></pre> <p>Rate Sources: - <code>BCB</code> - Brazilian Central Bank (Banco Central do Brasil) - <code>ECB</code> - European Central Bank - <code>MANUAL</code> - Manually entered rates - <code>SYSTEM</code> - System calculated rates</p> <p>Fallback Logic: 1. Try exact date match 2. Try previous business day (up to 5 days) 3. Interpolate between nearest dates 4. Raise exception if no rates found</p>"},{"location":"technical-reference/consolidation-engine/#fxconverter","title":"FXConverter","text":"<p>Converts trial balance entries according to IFRS 21.</p> <pre><code>from consolidation import FXConverter\n\nfx_converter = FXConverter(rate_manager)\n\n# Convert single entry\nconverted_entry = fx_converter.convert_trial_balance_entry(\n    entry=trial_balance_entry,\n    target_currency=Currency.USD,\n    closing_rate=Decimal(\"0.187453\"),\n    average_rate=Decimal(\"0.185234\"),\n    historical_rate=Decimal(\"0.180000\")\n)\n</code></pre> <p>Conversion Rules:</p> Account Type Rate Used IFRS 21 Reference Asset Closing IAS 21.23(a) Liability Closing IAS 21.23(a) Equity Historical IAS 21.23(b) Revenue Average IAS 21.40 Expense Average IAS 21.40 <p>CTA Calculation:</p> <pre><code># Cumulative Translation Adjustment\nCTA = (Assets - Liabilities - Equity) translated\n    - ((Assets - Liabilities - Equity) at closing rate)\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#intercompany-elimination","title":"Intercompany Elimination","text":""},{"location":"technical-reference/consolidation-engine/#matching-algorithm","title":"Matching Algorithm","text":"<p>The elimination engine automatically matches intercompany transactions:</p> <ol> <li>Reference Number Matching - Match by transaction reference</li> <li>Amount Matching - Match within tolerance (default 1%)</li> <li>Entity Relationship - Validate entity pair</li> <li>FX Adjustment - Handle cross-currency transactions</li> </ol>"},{"location":"technical-reference/consolidation-engine/#intercompanymatcher","title":"IntercompanyMatcher","text":"<pre><code>from consolidation import IntercompanyMatcher\n\nmatcher = IntercompanyMatcher(tolerance=Decimal(\"0.01\"))\n\n# Match receivables and payables\nar_ap_matches = matcher.match_receivables_payables(\n    trial_balances={\"effecti\": [...], \"leadlovers\": [...]},\n    entities=[effecti_entity, leadlovers_entity]\n)\n\n# Match revenues and expenses\nrev_exp_matches = matcher.match_revenues_expenses(\n    trial_balances={\"effecti\": [...], \"leadlovers\": [...]},\n    entities=[effecti_entity, leadlovers_entity]\n)\n</code></pre> <p>Matching Criteria:</p> <pre><code>def is_matching_pair(amount1, amount2, tolerance):\n    \"\"\"Check if two amounts match within tolerance.\"\"\"\n    if amount2 == 0:\n        return False\n    variance = abs((amount1 + amount2) / amount2)\n    return variance &lt;= tolerance\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#eliminationengine","title":"EliminationEngine","text":"<p>Creates elimination journal entries.</p> <pre><code>from consolidation import EliminationEngine, EliminationType\n\nelimination_engine = EliminationEngine()\n\n# Create single elimination\nentry = elimination_engine.create_elimination_entry(\n    match=ic_match,\n    elimination_type=EliminationType.RECEIVABLES_PAYABLES,\n    period_year=2024,\n    period_month=12\n)\n\n# Create all eliminations\nall_entries = elimination_engine.create_all_eliminations(\n    ar_ap_matches=ar_ap_matches,\n    rev_exp_matches=rev_exp_matches,\n    period_year=2024,\n    period_month=12\n)\n</code></pre> <p>Elimination Types:</p> Type Debit Credit Purpose AR/AP IC Payable IC Receivable Eliminate intercompany AR/AP Revenue/Expense IC Revenue IC Expense Eliminate intercompany revenue Dividend Dividend Income Dividend Payable Eliminate intercompany dividends Investment Investment Elimination Equity Eliminate investment in subsidiary <p>FX Gain/Loss Recognition:</p> <pre><code># When IC balances don't match due to FX differences\nfx_variance = amount_from + amount_to\nif abs(fx_variance) &gt; tolerance:\n    # Recognize FX gain/loss\n    if fx_variance &gt; 0:\n        debit(\"FX Loss\", fx_variance)\n        credit(\"IC Payable\", fx_variance)\n    else:\n        debit(\"IC Receivable\", abs(fx_variance))\n        credit(\"FX Gain\", abs(fx_variance))\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#purchase-price-allocation-ppa","title":"Purchase Price Allocation (PPA)","text":""},{"location":"technical-reference/consolidation-engine/#goodwill-calculation","title":"Goodwill Calculation","text":"<pre><code>from consolidation import PPACalculator\n\nppa_calculator = PPACalculator()\n\nppa = ppa_calculator.calculate_ppa(\n    purchase_price=Decimal(\"10000000\"),\n    fair_value_net_assets=Decimal(\"6000000\"),\n    identified_intangibles={\n        \"Customer Relationships\": Decimal(\"2000000\"),\n        \"Brand\": Decimal(\"1000000\"),\n        \"Technology\": Decimal(\"500000\")\n    }\n)\n\n# Goodwill = Purchase Price - FV Net Assets - Identified Intangibles\n# Goodwill = $10M - $6M - $3.5M = $500K\n</code></pre> <p>Calculation:</p> <pre><code>Purchase Price                     $10,000,000\nLess: Fair Value of Net Assets     ($6,000,000)\nLess: Identified Intangibles       ($3,500,000)\n                                   \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nGoodwill                           $   500,000\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#amortization-schedule","title":"Amortization Schedule","text":"<pre><code>from consolidation import AmortizationScheduler\n\nscheduler = AmortizationScheduler()\n\n# Create monthly amortization schedule\nschedule = scheduler.create_monthly_schedule(\n    ppa=ppa,\n    start_date=date(2020, 1, 1),\n    amortization_periods={\n        \"Customer Relationships\": 10,  # years\n        \"Brand\": 15,\n        \"Technology\": 5\n    }\n)\n\n# Get amortization for specific period\nperiod_amortization = scheduler.get_amortization_for_period(\n    schedule=schedule,\n    period_year=2024,\n    period_month=12\n)\n</code></pre> <p>Amortization Calculation (Straight-Line):</p> <pre><code>monthly_amortization = intangible_value / (useful_life_years * 12)\n</code></pre> <p>Example: <pre><code>Customer Relationships: $2,000,000 / (10 years * 12 months) = $16,667/month\nBrand: $1,000,000 / (15 years * 12 months) = $5,556/month\nTechnology: $500,000 / (5 years * 12 months) = $8,333/month\n</code></pre></p>"},{"location":"technical-reference/consolidation-engine/#goodwill-impairment-testing","title":"Goodwill Impairment Testing","text":"<pre><code>from consolidation import GoodwillImpairmentTester\n\ntester = GoodwillImpairmentTester()\n\n# Step 0: Qualitative assessment (US GAAP)\nqualitative_result = tester.test_impairment_qualitative(\n    acquisition=acquisition,\n    qualitative_factors={\n        \"macro_economic_decline\": False,\n        \"industry_decline\": False,\n        \"increased_competition\": True,\n        \"regulatory_changes\": False,\n        \"loss_of_key_personnel\": False,\n        \"decline_in_share_price\": False\n    }\n)\n\n# Step 1 &amp; 2: Quantitative test\nquantitative_result = tester.test_impairment_quantitative(\n    acquisition=acquisition,\n    carrying_value=Decimal(\"8000000\"),\n    fair_value=Decimal(\"7500000\"),\n    date_of_test=date(2024, 12, 31)\n)\n\nif quantitative_result.impairment_required:\n    impairment_loss = quantitative_result.impairment_amount\n    # Record impairment loss\n    debit(\"Goodwill Impairment Loss\", impairment_loss)\n    credit(\"Goodwill\", impairment_loss)\n</code></pre> <p>IFRS vs US GAAP:</p> Aspect IFRS (IAS 36) US GAAP (ASC 350) Test Frequency Annual or when triggered Annual Steps Single-step (recoverable amount) Two-step or qualitative Reversal Permitted Prohibited Unit Cash-generating unit (CGU) Reporting unit"},{"location":"technical-reference/consolidation-engine/#ifrsus-gaap-reconciliation","title":"IFRS/US GAAP Reconciliation","text":""},{"location":"technical-reference/consolidation-engine/#key-differences","title":"Key Differences","text":"Topic IFRS US GAAP Impact Development Costs Capitalize if criteria met Expense as incurred Equity increase under IFRS Goodwill Impairment Single-step test Two-step test Timing difference Lease Classification Single model (IFRS 16) Dual model (ASC 842) Presentation difference Revenue Recognition IFRS 15 ASC 606 Generally aligned Financial Instruments IFRS 9 ASC 320/321/815 Classification differences"},{"location":"technical-reference/consolidation-engine/#gaapdifferencehandler","title":"GAAPDifferenceHandler","text":"<pre><code>from consolidation import GAAPDifferenceHandler\n\nhandler = GAAPDifferenceHandler()\n\n# Calculate development costs adjustment\ndev_costs_adj = handler.calculate_development_costs_adjustment(\n    capitalized_amount=Decimal(\"500000\"),  # IFRS\n    expensed_amount=Decimal(\"500000\")       # US GAAP\n)\n\n# Calculate goodwill impairment adjustment\ngoodwill_adj = handler.calculate_goodwill_impairment_adjustment(\n    ifrs_impairment=Decimal(\"100000\"),\n    us_gaap_impairment=Decimal(\"150000\")\n)\n\n# Calculate revenue recognition adjustment\nrevenue_adj = handler.calculate_revenue_recognition_adjustment(\n    ifrs_revenue=Decimal(\"10000000\"),\n    us_gaap_revenue=Decimal(\"9850000\")\n)\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#reconciliationengine","title":"ReconciliationEngine","text":"<pre><code>from consolidation import ReconciliationEngine\n\nrecon_engine = ReconciliationEngine()\n\n# Create reconciliation\nreconciliation = recon_engine.create_reconciliation(\n    ifrs_result=ifrs_consolidated_result,\n    us_gaap_result=us_gaap_consolidated_result,\n    period_year=2024,\n    period_month=12\n)\n\n# Generate reconciliation table\ntable = recon_engine.generate_reconciliation_table(reconciliation)\n\n# Format for disclosure\ndisclosure = recon_engine.format_reconciliation_disclosure(\n    reconciliation,\n    format=\"sec_filing\"\n)\n</code></pre> <p>Reconciliation Format:</p> <pre><code>Net Income Reconciliation (IFRS to US GAAP)\n\nNet income under IFRS                              $3,000,000\n\nAdjustments to conform to US GAAP:\n  Development costs capitalized under IFRS           (500,000)\n  Goodwill impairment (US GAAP higher)                (50,000)\n  Revenue recognition timing difference               (150,000)\n                                                   \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nNet income under US GAAP                           $2,300,000\n                                                   \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#dualreportingengine","title":"DualReportingEngine","text":"<p>Prepare financial statements under both standards simultaneously.</p> <pre><code>from consolidation import DualReportingEngine\n\ndual_engine = DualReportingEngine()\n\n# Prepare dual reporting\ndual_result = dual_engine.prepare_dual_reporting(\n    entities=entities,\n    trial_balances=trial_balances,\n    period_end_date=date(2024, 12, 31),\n    period_start_date=date(2024, 1, 1),\n    presentation_currency=Currency.USD\n)\n\n# Access results\nifrs_statements = dual_result.ifrs_statements\nus_gaap_statements = dual_result.us_gaap_statements\nreconciliation = dual_result.reconciliation\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#main-consolidation-engine","title":"Main Consolidation Engine","text":""},{"location":"technical-reference/consolidation-engine/#consolidationengine","title":"ConsolidationEngine","text":"<p>Orchestrates the complete consolidation process.</p> <pre><code>from consolidation import ConsolidationEngine\n\nengine = ConsolidationEngine()\n\n# Perform consolidation\nresult = engine.consolidate(\n    entities=entities,\n    trial_balances=trial_balances,\n    period_end_date=date(2024, 12, 31),\n    period_start_date=date(2024, 1, 1),\n    presentation_currency=Currency.USD,\n    options={\n        \"perform_eliminations\": True,\n        \"apply_ppa_amortization\": True,\n        \"calculate_cta\": True,\n        \"validate_results\": True\n    }\n)\n</code></pre> <p>Consolidation Steps:</p> <ol> <li>Load Trial Balances - Load entity trial balances</li> <li>FX Conversion - Convert to presentation currency</li> <li>Intercompany Matching - Identify IC transactions</li> <li>Elimination Entries - Create elimination JEs</li> <li>PPA Amortization - Apply monthly amortization</li> <li>Aggregation - Sum across entities</li> <li>CTA Calculation - Calculate translation adjustment</li> <li>Validation - Run validation rules</li> </ol>"},{"location":"technical-reference/consolidation-engine/#quickconsolidator","title":"QuickConsolidator","text":"<p>Simplified API for common use cases.</p> <pre><code>from consolidation import QuickConsolidator\n\nconsolidator = QuickConsolidator()\n\nresult = consolidator.quick_consolidate(\n    entities=entities,\n    trial_balances=trial_balances,\n    period_end_date=date(2024, 12, 31),\n    period_start_date=date(2024, 1, 1),\n    presentation_currency=Currency.USD\n)\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#validation-framework","title":"Validation Framework","text":""},{"location":"technical-reference/consolidation-engine/#validation-rules","title":"Validation Rules","text":"<p>The validator runs 7 core validation rules:</p> <ol> <li>Balance Sheet Balance - Assets = Liabilities + Equity</li> <li>Debit/Credit Balance - Total debits = Total credits</li> <li>Net Income Reconciliation - Revenue - Expenses = Net Income</li> <li>Entity Ownership - Ownership percentages valid</li> <li>Elimination Completeness - All IC balances eliminated</li> <li>FX Rate Consistency - Valid FX rates used</li> <li>Financial Reasonableness - Ratios within expected ranges</li> </ol>"},{"location":"technical-reference/consolidation-engine/#consolidationvalidator","title":"ConsolidationValidator","text":"<pre><code>from consolidation import ConsolidationValidator\n\nvalidator = ConsolidationValidator()\n\n# Validate all rules\nis_valid, results = validator.validate_all(consolidated_result)\n\n# Calculate accuracy score\naccuracy = validator.calculate_accuracy_score(consolidated_result)\nprint(f\"Accuracy: {accuracy * 100:.2f}%\")\n\n# Generate detailed report\nreport = validator.generate_validation_report(consolidated_result)\n</code></pre> <p>Validation Result:</p> <pre><code>{\n    \"is_valid\": True,\n    \"accuracy_score\": 0.998,\n    \"rules_passed\": 7,\n    \"rules_failed\": 0,\n    \"warnings\": [\n        \"Minor rounding difference in trial balance: $0.02\"\n    ],\n    \"errors\": [],\n    \"rule_results\": [\n        {\n            \"rule\": \"balance_sheet_balance\",\n            \"passed\": True,\n            \"total_assets\": 50000000.00,\n            \"total_liabilities\": 30000000.00,\n            \"total_equity\": 20000000.00,\n            \"difference\": 0.00\n        },\n        ...\n    ]\n}\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#individual-validation-rules","title":"Individual Validation Rules","text":""},{"location":"technical-reference/consolidation-engine/#balancesheetbalancerule","title":"BalanceSheetBalanceRule","text":"<pre><code>from consolidation.validation import BalanceSheetBalanceRule\n\nrule = BalanceSheetBalanceRule(tolerance=Decimal(\"0.01\"))\n\nresult = rule.validate(consolidated_result)\n</code></pre> <p>Check: <code>Assets = Liabilities + Equity (within tolerance)</code></p>"},{"location":"technical-reference/consolidation-engine/#debitcreditbalancerule","title":"DebitCreditBalanceRule","text":"<pre><code>from consolidation.validation import DebitCreditBalanceRule\n\nrule = DebitCreditBalanceRule(tolerance=Decimal(\"0.01\"))\n\nresult = rule.validate(trial_balances)\n</code></pre> <p>Check: <code>Total Debits = Total Credits (within tolerance)</code></p>"},{"location":"technical-reference/consolidation-engine/#netincomereconciliationrule","title":"NetIncomeReconciliationRule","text":"<pre><code>from consolidation.validation import NetIncomeReconciliationRule\n\nrule = NetIncomeReconciliationRule(tolerance=Decimal(\"0.01\"))\n\nresult = rule.validate(consolidated_result)\n</code></pre> <p>Check: <code>Revenue - Expenses = Net Income (within tolerance)</code></p>"},{"location":"technical-reference/consolidation-engine/#performance-characteristics","title":"Performance Characteristics","text":""},{"location":"technical-reference/consolidation-engine/#benchmarks","title":"Benchmarks","text":"<p>Test Environment: - 7 entities - 77 total trial balance entries - Full consolidation with eliminations and PPA</p> <p>Results: - FX Conversion: &lt;100ms - Elimination Processing: &lt;50ms - PPA Amortization: &lt;20ms - Validation: &lt;50ms - Total Consolidation: &lt;200ms</p>"},{"location":"technical-reference/consolidation-engine/#scalability","title":"Scalability","text":"<p>Linear Complexity: O(n) where n = number of entries</p> <p>Projected Performance:</p> Entities Entries Est. Time 7 77 200ms 25 275 700ms 66 726 1.8s"},{"location":"technical-reference/consolidation-engine/#optimization-tips","title":"Optimization Tips","text":"<ol> <li>Pre-load FX Rates - Load all rates before consolidation</li> <li>Batch Processing - Process entities in parallel</li> <li>Cache Results - Cache intermediate calculations</li> <li>Lazy Loading - Only load required data</li> <li>Database Indexes - Ensure proper indexing on source tables</li> </ol>"},{"location":"technical-reference/consolidation-engine/#audit-trail","title":"Audit Trail","text":"<p>Every consolidation action is logged:</p> <pre><code>from consolidation import AuditLog\n\n# Automatic logging\nlog_entry = AuditLog(\n    timestamp=datetime.utcnow(),\n    action_type=\"consolidation_started\",\n    entity_id=None,\n    description=\"Consolidation for period 2024-12\",\n    previous_value=None,\n    new_value=None,\n    user_id=\"system\"\n)\n</code></pre> <p>Logged Actions: - Consolidation started/completed - FX rate applied - Elimination entry created - PPA amortization applied - Validation rule executed - GAAP adjustment made</p>"},{"location":"technical-reference/consolidation-engine/#error-handling","title":"Error Handling","text":""},{"location":"technical-reference/consolidation-engine/#exception-hierarchy","title":"Exception Hierarchy","text":"<pre><code>ConsolidationException\n\u251c\u2500\u2500 FXRateNotFoundException\n\u251c\u2500\u2500 InvalidTrialBalanceException\n\u251c\u2500\u2500 ValidationException\n\u251c\u2500\u2500 EliminationException\n\u2514\u2500\u2500 PPAException\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#example-error-handling","title":"Example Error Handling","text":"<pre><code>from consolidation.exceptions import FXRateNotFoundException\n\ntry:\n    result = engine.consolidate(...)\nexcept FXRateNotFoundException as e:\n    print(f\"Missing FX rate: {e.from_currency} \u2192 {e.to_currency} on {e.rate_date}\")\n    # Load missing rate\nexcept ValidationException as e:\n    print(f\"Validation failed: {e.rule_name}\")\n    print(f\"Details: {e.details}\")\n    # Review and fix data\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#configuration","title":"Configuration","text":""},{"location":"technical-reference/consolidation-engine/#consolidation-options","title":"Consolidation Options","text":"<pre><code>options = {\n    # FX conversion\n    \"use_average_rate_for_pl\": True,\n    \"use_closing_rate_for_bs\": True,\n    \"use_historical_rate_for_equity\": True,\n\n    # Eliminations\n    \"perform_eliminations\": True,\n    \"ic_matching_tolerance\": Decimal(\"0.01\"),  # 1%\n\n    # PPA\n    \"apply_ppa_amortization\": True,\n    \"test_goodwill_impairment\": False,  # Typically annual\n\n    # Validation\n    \"validate_results\": True,\n    \"validation_tolerance\": Decimal(\"0.01\"),\n\n    # Output\n    \"include_audit_trail\": True,\n    \"calculate_ratios\": True\n}\n</code></pre>"},{"location":"technical-reference/consolidation-engine/#see-also","title":"See Also","text":"<ul> <li>Database Schema</li> <li>API Reference</li> <li>Configuration Reference</li> </ul>"},{"location":"technical-reference/database/","title":"Database Schema Reference","text":"<p>Version: 1.0.0 Database: PostgreSQL 15+ Last Updated: 2026-02-07</p>"},{"location":"technical-reference/database/#overview","title":"Overview","text":"<p>The AI FP&amp;A system uses a PostgreSQL database designed for multi-tenant IFRS/US GAAP compliant financial consolidation. The schema supports 7+ portfolio companies with scalability to 66+ entities while maintaining optimal performance through partitioning, indexing, and row-level security.</p>"},{"location":"technical-reference/database/#technology-stack","title":"Technology Stack","text":""},{"location":"technical-reference/database/#core-components","title":"Core Components","text":"<ul> <li>Database Engine: PostgreSQL 15 or higher</li> <li>Required Extensions:</li> <li><code>uuid-ossp</code> - UUID generation for primary keys</li> <li><code>btree_gist</code> - Advanced indexing capabilities</li> <li><code>pg_trgm</code> - Fuzzy text search for account names</li> <li>Partitioning Strategy: Range partitioning by year</li> <li>Security Model: Row-Level Security (RLS) policies</li> <li>Performance Optimization: 80+ specialized indexes</li> </ul>"},{"location":"technical-reference/database/#design-principles","title":"Design Principles","text":"<ol> <li>Multi-Tenant Isolation - RLS ensures users only access authorized entities</li> <li>Audit Trail Completeness - All changes tracked with 7-year retention</li> <li>Performance at Scale - Optimized for 66+ entities</li> <li>Data Integrity - Comprehensive constraints, triggers, and validation</li> <li>Compliance - IFRS/GAAP standard chart of accounts</li> <li>AI-Ready - Confidence scores, AI action logs, automated entries</li> </ol>"},{"location":"technical-reference/database/#schema-architecture","title":"Schema Architecture","text":""},{"location":"technical-reference/database/#core-tables","title":"Core Tables","text":"Table Purpose Rows Partitioned RLS <code>portfolio_entities</code> Portfolio companies and hierarchy ~100 No Yes <code>users</code> User accounts and authentication ~50 No No <code>user_entity_access</code> Multi-tenant access control ~500 No No <code>standard_chart_of_accounts</code> Master COA (IFRS/GAAP) ~200 No No <code>entity_chart_of_accounts</code> Entity-specific COA mapping ~1,400 No Yes <code>trial_balances</code> Monthly trial balances by entity ~100K/yr Yes Yes <code>subledger_entries</code> Detail transactions ~1M/yr No Yes <code>fx_rates</code> Daily FX rates ~10K/yr No No <code>fx_rates_monthly</code> Monthly average FX rates ~1K/yr No No <code>journal_entries</code> Manual/AI-generated entries ~5K/yr No Yes <code>journal_entry_lines</code> Journal entry line items ~15K/yr No Yes <code>consolidated_balances</code> Final consolidated output ~15K/yr No Yes <code>intercompany_balances</code> IC reconciliation tracking ~5K/yr No Yes <code>etl_batches</code> ETL job tracking ~500/yr No Yes <code>validation_results</code> Data quality validation ~2K/yr No Yes <code>agent_actions</code> AI agent audit log ~50K/yr Yes No <code>credential_access_log</code> Security audit log ~10K/yr No No <code>period_locks</code> Period locking for closed months ~1K No No"},{"location":"technical-reference/database/#table-definitions","title":"Table Definitions","text":""},{"location":"technical-reference/database/#portfolio_entities","title":"portfolio_entities","text":"<p>Portfolio companies and consolidation hierarchy.</p> <pre><code>CREATE TABLE portfolio_entities (\n    entity_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    entity_code VARCHAR(20) NOT NULL UNIQUE,\n    entity_name VARCHAR(200) NOT NULL,\n    parent_entity_id UUID REFERENCES portfolio_entities(entity_id),\n    functional_currency VARCHAR(3) NOT NULL,\n    country_code VARCHAR(2) NOT NULL,\n    ownership_percentage DECIMAL(5,2) NOT NULL DEFAULT 100.00,\n    acquisition_date DATE,\n    entity_type VARCHAR(50) NOT NULL,\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_portfolio_entities_parent ON portfolio_entities(parent_entity_id);\nCREATE INDEX idx_portfolio_entities_active ON portfolio_entities(is_active) WHERE is_active = TRUE;\n</code></pre> <p>Key Fields: - <code>entity_code</code> - Short code (e.g., \"EFFECTI\", \"LEADLOVERS\") - <code>parent_entity_id</code> - For consolidation hierarchy - <code>functional_currency</code> - Entity's functional currency (BRL, USD) - <code>ownership_percentage</code> - Ownership stake for consolidation - <code>entity_type</code> - subsidiary, parent, holding_company</p>"},{"location":"technical-reference/database/#users","title":"users","text":"<p>User accounts and authentication.</p> <pre><code>CREATE TABLE users (\n    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    username VARCHAR(100) NOT NULL UNIQUE,\n    email VARCHAR(255) NOT NULL UNIQUE,\n    password_hash VARCHAR(255) NOT NULL,\n    full_name VARCHAR(200),\n    role VARCHAR(50) NOT NULL,\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    last_login TIMESTAMP,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\nCREATE INDEX idx_users_email ON users(email);\nCREATE INDEX idx_users_active ON users(is_active) WHERE is_active = TRUE;\n</code></pre> <p>Roles: - <code>admin</code> - Full system access - <code>finance_manager</code> - Full financial access - <code>controller</code> - Financial operations - <code>analyst</code> - Read/write assigned entities - <code>auditor</code> - Read-only all entities - <code>read_only</code> - Read-only assigned entities</p>"},{"location":"technical-reference/database/#user_entity_access","title":"user_entity_access","text":"<p>Multi-tenant access control mapping.</p> <pre><code>CREATE TABLE user_entity_access (\n    access_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    user_id UUID NOT NULL REFERENCES users(user_id),\n    entity_id UUID NOT NULL REFERENCES portfolio_entities(entity_id),\n    can_read BOOLEAN NOT NULL DEFAULT TRUE,\n    can_write BOOLEAN NOT NULL DEFAULT FALSE,\n    can_approve BOOLEAN NOT NULL DEFAULT FALSE,\n    granted_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    granted_by UUID REFERENCES users(user_id),\n    UNIQUE(user_id, entity_id)\n);\n\nCREATE INDEX idx_user_entity_access_user ON user_entity_access(user_id);\nCREATE INDEX idx_user_entity_access_entity ON user_entity_access(entity_id);\n</code></pre>"},{"location":"technical-reference/database/#standard_chart_of_accounts","title":"standard_chart_of_accounts","text":"<p>Master chart of accounts template (IFRS/US GAAP).</p> <pre><code>CREATE TABLE standard_chart_of_accounts (\n    account_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    account_code VARCHAR(20) NOT NULL UNIQUE,\n    account_name VARCHAR(200) NOT NULL,\n    parent_account_id UUID REFERENCES standard_chart_of_accounts(account_id),\n    account_type VARCHAR(20) NOT NULL,\n    account_subtype VARCHAR(50),\n    level INTEGER NOT NULL,\n    is_summary BOOLEAN NOT NULL DEFAULT FALSE,\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    ifrs_taxonomy VARCHAR(100),\n    us_gaap_taxonomy VARCHAR(100),\n    normal_balance VARCHAR(6) NOT NULL,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT chk_account_type CHECK (account_type IN ('asset', 'liability', 'equity', 'revenue', 'expense')),\n    CONSTRAINT chk_normal_balance CHECK (normal_balance IN ('debit', 'credit'))\n);\n\nCREATE INDEX idx_coa_code ON standard_chart_of_accounts(account_code);\nCREATE INDEX idx_coa_parent ON standard_chart_of_accounts(parent_account_id);\nCREATE INDEX idx_coa_type ON standard_chart_of_accounts(account_type);\nCREATE INDEX idx_coa_active ON standard_chart_of_accounts(is_active) WHERE is_active = TRUE;\n</code></pre> <p>Account Types: - <code>asset</code> - Assets (normal debit balance) - <code>liability</code> - Liabilities (normal credit balance) - <code>equity</code> - Equity (normal credit balance) - <code>revenue</code> - Revenue (normal credit balance) - <code>expense</code> - Expenses (normal debit balance)</p>"},{"location":"technical-reference/database/#entity_chart_of_accounts","title":"entity_chart_of_accounts","text":"<p>Entity-specific chart of accounts mapping to standard COA.</p> <pre><code>CREATE TABLE entity_chart_of_accounts (\n    entity_account_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    entity_id UUID NOT NULL REFERENCES portfolio_entities(entity_id),\n    standard_account_id UUID NOT NULL REFERENCES standard_chart_of_accounts(account_id),\n    local_account_code VARCHAR(50) NOT NULL,\n    local_account_name VARCHAR(200) NOT NULL,\n    mapping_confidence DECIMAL(3,2),\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    UNIQUE(entity_id, local_account_code)\n);\n\nCREATE INDEX idx_entity_coa_entity ON entity_chart_of_accounts(entity_id);\nCREATE INDEX idx_entity_coa_standard ON entity_chart_of_accounts(standard_account_id);\nCREATE INDEX idx_entity_coa_local_code ON entity_chart_of_accounts(local_account_code);\n</code></pre> <p>Fields: - <code>mapping_confidence</code> - AI confidence score (0.00-1.00) - <code>local_account_code</code> - Entity's native account code - <code>local_account_name</code> - Entity's native account name</p>"},{"location":"technical-reference/database/#trial_balances-partitioned","title":"trial_balances (Partitioned)","text":"<p>Monthly trial balances by entity.</p> <pre><code>CREATE TABLE trial_balances (\n    balance_id UUID DEFAULT uuid_generate_v4(),\n    entity_id UUID NOT NULL REFERENCES portfolio_entities(entity_id),\n    entity_account_id UUID NOT NULL REFERENCES entity_chart_of_accounts(entity_account_id),\n    period_year INTEGER NOT NULL,\n    period_month INTEGER NOT NULL,\n    opening_balance DECIMAL(18,2) NOT NULL DEFAULT 0,\n    debit_amount DECIMAL(18,2) NOT NULL DEFAULT 0,\n    credit_amount DECIMAL(18,2) NOT NULL DEFAULT 0,\n    ending_balance DECIMAL(18,2) NOT NULL DEFAULT 0,\n    currency VARCHAR(3) NOT NULL,\n    source_system VARCHAR(50),\n    batch_id UUID REFERENCES etl_batches(batch_id),\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    PRIMARY KEY (balance_id, period_year),\n    CONSTRAINT chk_period_month CHECK (period_month BETWEEN 1 AND 12)\n) PARTITION BY RANGE (period_year);\n\n-- Partitions (2020-2026)\nCREATE TABLE trial_balances_2020 PARTITION OF trial_balances\n    FOR VALUES FROM (2020) TO (2021);\nCREATE TABLE trial_balances_2021 PARTITION OF trial_balances\n    FOR VALUES FROM (2021) TO (2022);\nCREATE TABLE trial_balances_2022 PARTITION OF trial_balances\n    FOR VALUES FROM (2022) TO (2023);\nCREATE TABLE trial_balances_2023 PARTITION OF trial_balances\n    FOR VALUES FROM (2023) TO (2024);\nCREATE TABLE trial_balances_2024 PARTITION OF trial_balances\n    FOR VALUES FROM (2024) TO (2025);\nCREATE TABLE trial_balances_2025 PARTITION OF trial_balances\n    FOR VALUES FROM (2025) TO (2026);\nCREATE TABLE trial_balances_2026 PARTITION OF trial_balances\n    FOR VALUES FROM (2026) TO (2027);\n\n-- Indexes\nCREATE INDEX idx_trial_balances_entity_period_account ON trial_balances(entity_id, period_year, period_month, entity_account_id);\nCREATE INDEX idx_trial_balances_period_account ON trial_balances(period_year, period_month, entity_account_id);\nCREATE INDEX idx_trial_balances_nonzero ON trial_balances(entity_id, period_year, period_month)\n    WHERE ending_balance != 0;\n</code></pre>"},{"location":"technical-reference/database/#journal_entries","title":"journal_entries","text":"<p>Manual adjustments and AI-generated journal entries.</p> <pre><code>CREATE TABLE journal_entries (\n    entry_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    entry_number VARCHAR(50) NOT NULL UNIQUE,\n    entity_id UUID NOT NULL REFERENCES portfolio_entities(entity_id),\n    period_year INTEGER NOT NULL,\n    period_month INTEGER NOT NULL,\n    entry_date DATE NOT NULL,\n    entry_source VARCHAR(50) NOT NULL,\n    status VARCHAR(20) NOT NULL DEFAULT 'draft',\n    description TEXT,\n    created_by UUID REFERENCES users(user_id),\n    approved_by UUID REFERENCES users(user_id),\n    posted_by UUID REFERENCES users(user_id),\n    reversed_by UUID REFERENCES users(user_id),\n    reversal_entry_id UUID REFERENCES journal_entries(entry_id),\n    ai_confidence DECIMAL(3,2),\n    ai_explanation TEXT,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n    approved_at TIMESTAMP,\n    posted_at TIMESTAMP,\n    reversed_at TIMESTAMP,\n\n    CONSTRAINT chk_entry_source CHECK (entry_source IN ('manual', 'ai_generated', 'system', 'consolidation')),\n    CONSTRAINT chk_status CHECK (status IN ('draft', 'pending_review', 'approved', 'posted', 'reversed'))\n);\n\nCREATE INDEX idx_journal_entries_entity_period ON journal_entries(entity_id, period_year, period_month);\nCREATE INDEX idx_journal_entries_status ON journal_entries(status);\nCREATE INDEX idx_journal_entries_pending_approval ON journal_entries(status)\n    WHERE status = 'pending_review';\nCREATE INDEX idx_journal_entries_ai_generated ON journal_entries(entry_source, ai_confidence)\n    WHERE entry_source = 'ai_generated';\n</code></pre> <p>Status Workflow: - <code>draft</code> \u2192 User can edit/delete - <code>pending_review</code> \u2192 Awaiting approval - <code>approved</code> \u2192 Locked, ready to post - <code>posted</code> \u2192 Immutable, affects balances - <code>reversed</code> \u2192 Posted with offsetting reversal</p>"},{"location":"technical-reference/database/#journal_entry_lines","title":"journal_entry_lines","text":"<p>Journal entry line items (debits/credits).</p> <pre><code>CREATE TABLE journal_entry_lines (\n    line_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    entry_id UUID NOT NULL REFERENCES journal_entries(entry_id) ON DELETE CASCADE,\n    line_number INTEGER NOT NULL,\n    standard_account_id UUID NOT NULL REFERENCES standard_chart_of_accounts(account_id),\n    debit_amount DECIMAL(18,2) NOT NULL DEFAULT 0,\n    credit_amount DECIMAL(18,2) NOT NULL DEFAULT 0,\n    currency VARCHAR(3) NOT NULL,\n    description TEXT,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    UNIQUE(entry_id, line_number),\n    CONSTRAINT chk_debit_or_credit CHECK (\n        (debit_amount &gt; 0 AND credit_amount = 0) OR\n        (credit_amount &gt; 0 AND debit_amount = 0)\n    )\n);\n\nCREATE INDEX idx_journal_lines_entry ON journal_entry_lines(entry_id);\nCREATE INDEX idx_journal_lines_account_period ON journal_entry_lines(standard_account_id);\n</code></pre>"},{"location":"technical-reference/database/#fx_rates","title":"fx_rates","text":"<p>Daily foreign exchange rates.</p> <pre><code>CREATE TABLE fx_rates (\n    rate_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    from_currency VARCHAR(3) NOT NULL,\n    to_currency VARCHAR(3) NOT NULL,\n    rate_date DATE NOT NULL,\n    rate DECIMAL(12,6) NOT NULL,\n    rate_source VARCHAR(50) NOT NULL,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    UNIQUE(from_currency, to_currency, rate_date),\n    CONSTRAINT chk_rate_positive CHECK (rate &gt; 0),\n    CONSTRAINT chk_rate_source CHECK (rate_source IN ('bcb', 'ecb', 'manual', 'system'))\n);\n\nCREATE INDEX idx_fx_rates_currencies_date ON fx_rates(from_currency, to_currency, rate_date DESC);\n</code></pre> <p>Rate Sources: - <code>bcb</code> - Brazilian Central Bank (Banco Central do Brasil) - <code>ecb</code> - European Central Bank - <code>manual</code> - Manual entry - <code>system</code> - System calculated</p>"},{"location":"technical-reference/database/#fx_rates_monthly","title":"fx_rates_monthly","text":"<p>Monthly average exchange rates.</p> <pre><code>CREATE TABLE fx_rates_monthly (\n    rate_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    from_currency VARCHAR(3) NOT NULL,\n    to_currency VARCHAR(3) NOT NULL,\n    period_year INTEGER NOT NULL,\n    period_month INTEGER NOT NULL,\n    average_rate DECIMAL(12,6) NOT NULL,\n    rate_source VARCHAR(50) NOT NULL,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    UNIQUE(from_currency, to_currency, period_year, period_month),\n    CONSTRAINT chk_period_month CHECK (period_month BETWEEN 1 AND 12)\n);\n\nCREATE INDEX idx_fx_rates_monthly_currencies_period ON fx_rates_monthly(from_currency, to_currency, period_year, period_month);\n</code></pre>"},{"location":"technical-reference/database/#consolidated_balances","title":"consolidated_balances","text":"<p>Final consolidated financial statement balances.</p> <pre><code>CREATE TABLE consolidated_balances (\n    balance_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    entity_id UUID REFERENCES portfolio_entities(entity_id),\n    standard_account_id UUID NOT NULL REFERENCES standard_chart_of_accounts(account_id),\n    period_year INTEGER NOT NULL,\n    period_month INTEGER NOT NULL,\n    opening_balance DECIMAL(18,2) NOT NULL DEFAULT 0,\n    period_activity DECIMAL(18,2) NOT NULL DEFAULT 0,\n    ending_balance DECIMAL(18,2) NOT NULL DEFAULT 0,\n    currency VARCHAR(3) NOT NULL,\n    consolidation_level VARCHAR(20) NOT NULL,\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT chk_consolidation_level CHECK (consolidation_level IN ('entity', 'group'))\n);\n\nCREATE INDEX idx_consolidated_period_account ON consolidated_balances(period_year, period_month, standard_account_id);\nCREATE INDEX idx_consolidated_entity_period ON consolidated_balances(entity_id, period_year, period_month);\n</code></pre> <p>Consolidation Levels: - <code>entity</code> - Entity-level (after FX translation) - <code>group</code> - Group-level (after IC eliminations)</p>"},{"location":"technical-reference/database/#intercompany_balances","title":"intercompany_balances","text":"<p>Intercompany balance reconciliation tracking.</p> <pre><code>CREATE TABLE intercompany_balances (\n    ic_balance_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    entity_from_id UUID NOT NULL REFERENCES portfolio_entities(entity_id),\n    entity_to_id UUID NOT NULL REFERENCES portfolio_entities(entity_id),\n    standard_account_id UUID NOT NULL REFERENCES standard_chart_of_accounts(account_id),\n    period_year INTEGER NOT NULL,\n    period_month INTEGER NOT NULL,\n    amount_entity_from DECIMAL(18,2) NOT NULL,\n    amount_entity_to DECIMAL(18,2) NOT NULL,\n    variance DECIMAL(18,2) NOT NULL,\n    currency VARCHAR(3) NOT NULL,\n    is_eliminated BOOLEAN NOT NULL DEFAULT FALSE,\n    elimination_entry_id UUID REFERENCES journal_entries(entry_id),\n    created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n\n    CONSTRAINT chk_different_entities CHECK (entity_from_id != entity_to_id)\n);\n\nCREATE INDEX idx_ic_balances_entities_period ON intercompany_balances(entity_from_id, entity_to_id, period_year, period_month);\nCREATE INDEX idx_ic_balances_uneliminated ON intercompany_balances(is_eliminated)\n    WHERE is_eliminated = FALSE;\n</code></pre>"},{"location":"technical-reference/database/#agent_actions-partitioned","title":"agent_actions (Partitioned)","text":"<p>AI agent audit log with 7-year retention.</p> <pre><code>CREATE TABLE agent_actions (\n    action_id UUID DEFAULT uuid_generate_v4(),\n    action_timestamp TIMESTAMP NOT NULL DEFAULT NOW(),\n    agent_id VARCHAR(100) NOT NULL,\n    action_type VARCHAR(50) NOT NULL,\n    entity_id UUID REFERENCES portfolio_entities(entity_id),\n    description TEXT,\n    input_data JSONB,\n    output_data JSONB,\n    confidence_score DECIMAL(3,2),\n    execution_time_ms INTEGER,\n\n    PRIMARY KEY (action_id, action_timestamp)\n) PARTITION BY RANGE (action_timestamp);\n\n-- Partitions (2020-2026)\nCREATE TABLE agent_actions_2020 PARTITION OF agent_actions\n    FOR VALUES FROM ('2020-01-01') TO ('2021-01-01');\nCREATE TABLE agent_actions_2021 PARTITION OF agent_actions\n    FOR VALUES FROM ('2021-01-01') TO ('2022-01-01');\nCREATE TABLE agent_actions_2022 PARTITION OF agent_actions\n    FOR VALUES FROM ('2022-01-01') TO ('2023-01-01');\nCREATE TABLE agent_actions_2023 PARTITION OF agent_actions\n    FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');\nCREATE TABLE agent_actions_2024 PARTITION OF agent_actions\n    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');\nCREATE TABLE agent_actions_2025 PARTITION OF agent_actions\n    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');\nCREATE TABLE agent_actions_2026 PARTITION OF agent_actions\n    FOR VALUES FROM ('2026-01-01') TO ('2027-01-01');\n\nCREATE INDEX idx_agent_actions_agent_timestamp ON agent_actions(agent_id, action_timestamp DESC);\nCREATE INDEX idx_agent_actions_type ON agent_actions(action_type);\n</code></pre>"},{"location":"technical-reference/database/#row-level-security-rls","title":"Row-Level Security (RLS)","text":""},{"location":"technical-reference/database/#setting-user-context","title":"Setting User Context","text":"<pre><code>-- Set current user for RLS filtering\nSELECT set_current_user('user-uuid-here');\n</code></pre>"},{"location":"technical-reference/database/#rls-policies","title":"RLS Policies","text":"<p>All sensitive tables have RLS policies that filter data based on <code>user_entity_access</code>.</p> <p>Example: trial_balances RLS policy</p> <pre><code>ALTER TABLE trial_balances ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY trial_balances_access_policy ON trial_balances\n    FOR ALL\n    USING (\n        entity_id IN (\n            SELECT entity_id\n            FROM user_entity_access\n            WHERE user_id = current_user_id()\n              AND can_read = TRUE\n        )\n    )\n    WITH CHECK (\n        entity_id IN (\n            SELECT entity_id\n            FROM user_entity_access\n            WHERE user_id = current_user_id()\n              AND can_write = TRUE\n        )\n    );\n</code></pre>"},{"location":"technical-reference/database/#performance-optimization","title":"Performance Optimization","text":""},{"location":"technical-reference/database/#partitioning-strategy","title":"Partitioning Strategy","text":"<p>Trial Balances: - Partitioned by <code>period_year</code> (range partitioning) - One partition per year (2020-2026) - Query pruning reduces scan size by ~7x</p> <p>Agent Actions: - Partitioned by <code>action_timestamp</code> (range partitioning) - One partition per year - Automatic retention management (drop old partitions)</p>"},{"location":"technical-reference/database/#index-coverage","title":"Index Coverage","text":"<p>80+ specialized indexes: - Covering indexes for index-only scans - Partial indexes for common filters - Composite indexes for frequent joins - GIN indexes for JSONB fields</p> <p>Example covering index:</p> <pre><code>CREATE INDEX idx_trial_balances_summary\n    ON trial_balances(entity_id, period_year, period_month)\n    INCLUDE (entity_account_id, ending_balance, currency);\n</code></pre>"},{"location":"technical-reference/database/#query-performance-benchmarks","title":"Query Performance Benchmarks","text":"<p>Expected query times (66 entities, 7 years data):</p> Query Type Time Rows Single entity trial balance &lt;10ms ~200 All entities current period &lt;100ms ~13,200 Consolidated balances (month) &lt;50ms ~150 Intercompany reconciliation &lt;200ms ~500 Pending approvals &lt;20ms ~50 Account hierarchy traversal &lt;15ms ~100"},{"location":"technical-reference/database/#maintenance-operations","title":"Maintenance Operations","text":""},{"location":"technical-reference/database/#daily","title":"Daily","text":"<pre><code>-- Update statistics\nANALYZE trial_balances;\nANALYZE journal_entries;\nANALYZE consolidated_balances;\n</code></pre>"},{"location":"technical-reference/database/#weekly","title":"Weekly","text":"<pre><code>-- Vacuum to reclaim space\nVACUUM ANALYZE trial_balances;\nVACUUM ANALYZE journal_entries;\n\n-- Check index bloat\nSELECT schemaname, tablename, indexname, pg_size_pretty(pg_relation_size(indexrelid))\nFROM pg_stat_user_indexes\nWHERE schemaname = 'public'\nORDER BY pg_relation_size(indexrelid) DESC\nLIMIT 20;\n</code></pre>"},{"location":"technical-reference/database/#monthly","title":"Monthly","text":"<pre><code>-- Reindex partitioned tables (during maintenance window)\nREINDEX TABLE CONCURRENTLY trial_balances;\nREINDEX TABLE CONCURRENTLY agent_actions;\n</code></pre>"},{"location":"technical-reference/database/#annual","title":"Annual","text":"<pre><code>-- Add partition for new year\nCREATE TABLE trial_balances_2027 PARTITION OF trial_balances\n    FOR VALUES FROM (2027) TO (2028);\n\nCREATE TABLE agent_actions_2027 PARTITION OF agent_actions\n    FOR VALUES FROM ('2027-01-01') TO ('2028-01-01');\n\n-- Archive and drop old partitions (after 7 years)\npg_dump -t trial_balances_2020 ai_fpna_db &gt; trial_balances_2020_archive.sql\nDROP TABLE trial_balances_2020;\n</code></pre>"},{"location":"technical-reference/database/#configuration","title":"Configuration","text":""},{"location":"technical-reference/database/#postgresql-settings","title":"PostgreSQL Settings","text":"<p>Add to <code>postgresql.conf</code>:</p> <pre><code># Performance tuning for 66+ entities\nshared_buffers = 8GB\neffective_cache_size = 24GB\nwork_mem = 256MB\nmaintenance_work_mem = 2GB\nmax_worker_processes = 8\nmax_parallel_workers_per_gather = 4\nmax_parallel_workers = 8\n\n# Enable query optimization\nrandom_page_cost = 1.1  # For SSD\neffective_io_concurrency = 200\n\n# Partitioning\nenable_partition_pruning = on\nconstraint_exclusion = partition\n\n# Statistics\ndefault_statistics_target = 100\n</code></pre>"},{"location":"technical-reference/database/#migration-files","title":"Migration Files","text":"<p>Database migrations are located in <code>/database/migrations/</code>:</p> <ol> <li><code>001_initial_schema.sql</code> - Core tables and constraints</li> <li><code>002_rls_policies.sql</code> - Row-level security policies</li> <li><code>003_indexes.sql</code> - Performance indexes</li> </ol>"},{"location":"technical-reference/database/#capacity-planning","title":"Capacity Planning","text":"<p>Current (7 entities): - Trial balances: ~10,000 rows/year - Database size: ~2GB</p> <p>Projected (66 entities): - Trial balances: ~100,000 rows/year - Database size: ~20GB (7 years)</p>"},{"location":"technical-reference/database/#security","title":"Security","text":""},{"location":"technical-reference/database/#encryption","title":"Encryption","text":"<ul> <li>At Rest: PostgreSQL TDE with pgcrypto extension</li> <li>In Transit: SSL/TLS required for all connections</li> <li>Column-Level: Sensitive fields encrypted with AES-256-GCM</li> </ul>"},{"location":"technical-reference/database/#access-control","title":"Access Control","text":"<ul> <li>RLS Policies: Multi-tenant data isolation</li> <li>Role-Based: 11 predefined agent roles</li> <li>API Keys: Scoped by role and company</li> </ul>"},{"location":"technical-reference/database/#audit","title":"Audit","text":"<ul> <li>Access Logging: All data access logged</li> <li>Retention: 7 years for compliance</li> <li>Immutable: Audit logs cannot be modified</li> </ul>"},{"location":"technical-reference/database/#see-also","title":"See Also","text":"<ul> <li>API Reference</li> <li>Security Architecture</li> <li>ERP Connectors</li> </ul>"},{"location":"technical-reference/erp-connectors/","title":"ERP Connectors Technical Reference","text":"<p>Version: 1.0.0 Last Updated: 2026-02-07 Implementation: <code>/Volumes/AI/Code/FPA/src/connectors/</code></p>"},{"location":"technical-reference/erp-connectors/#overview","title":"Overview","text":"<p>The ERP Connector Framework provides a unified interface for extracting financial data from 4 different Brazilian ERP systems. The framework implements authentication, retry logic, rate limiting, data validation, and normalization to ensure reliable data ingestion.</p>"},{"location":"technical-reference/erp-connectors/#architecture","title":"Architecture","text":""},{"location":"technical-reference/erp-connectors/#design-patterns","title":"Design Patterns","text":"Pattern Purpose Implementation Abstract Factory Create connector instances <code>ConnectorFactory</code> Strategy Multiple auth/retry strategies <code>OAuth2Handler</code>, <code>APIKeyHandler</code> Decorator Automatic retry logic <code>@with_retry</code> decorator Template Method Common connector interface <code>ERPConnector</code> base class Circuit Breaker Prevent cascading failures <code>CircuitBreaker</code> class"},{"location":"technical-reference/erp-connectors/#component-structure","title":"Component Structure","text":"<pre><code>connectors/\n\u251c\u2500\u2500 base.py                    # Abstract base class\n\u251c\u2500\u2500 auth.py                    # Authentication handlers\n\u251c\u2500\u2500 retry.py                   # Retry logic &amp; circuit breaker\n\u251c\u2500\u2500 validation.py              # Data validation\n\u251c\u2500\u2500 factory.py                 # Connector factory\n\u251c\u2500\u2500 totvs_connector.py         # TOTVS Protheus\n\u251c\u2500\u2500 contaazul_connector.py     # ContaAzul\n\u251c\u2500\u2500 omie_connector.py          # Omie\n\u251c\u2500\u2500 bling_connector.py         # Bling\n\u2514\u2500\u2500 __init__.py                # Public API\n</code></pre>"},{"location":"technical-reference/erp-connectors/#base-classes-and-models","title":"Base Classes and Models","text":""},{"location":"technical-reference/erp-connectors/#erpconnector-abstract-base-class","title":"ERPConnector (Abstract Base Class)","text":"<p>All ERP connectors inherit from <code>ERPConnector</code> and must implement:</p> <pre><code>from abc import ABC, abstractmethod\nfrom typing import List, Optional\nfrom datetime import datetime\n\nclass ERPConnector(ABC):\n    \"\"\"Abstract base class for all ERP connectors.\"\"\"\n\n    @abstractmethod\n    async def connect(self) -&gt; None:\n        \"\"\"Establish connection and authenticate.\"\"\"\n        pass\n\n    @abstractmethod\n    async def disconnect(self) -&gt; None:\n        \"\"\"Close connection and cleanup.\"\"\"\n        pass\n\n    @abstractmethod\n    async def health_check(self) -&gt; HealthCheckResult:\n        \"\"\"Check API health and connectivity.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_trial_balance(\n        self,\n        company_id: str,\n        period_start: datetime,\n        period_end: datetime,\n        filters: Optional[dict] = None\n    ) -&gt; TrialBalance:\n        \"\"\"Extract trial balance for a period.\"\"\"\n        pass\n\n    @abstractmethod\n    async def get_subledger_details(\n        self,\n        company_id: str,\n        account_code: str,\n        period_start: datetime,\n        period_end: datetime,\n        filters: Optional[dict] = None\n    ) -&gt; List[SubledgerEntry]:\n        \"\"\"Extract subledger detail for an account.\"\"\"\n        pass\n</code></pre>"},{"location":"technical-reference/erp-connectors/#data-models","title":"Data Models","text":""},{"location":"technical-reference/erp-connectors/#trialbalance","title":"TrialBalance","text":"<pre><code>@dataclass\nclass TrialBalance:\n    \"\"\"Trial balance for an entity and period.\"\"\"\n    company_id: str\n    company_name: str\n    period_start: datetime\n    period_end: datetime\n    currency: str\n    accounts: List[AccountBalance]\n    extracted_at: datetime\n    metadata: dict = field(default_factory=dict)\n</code></pre>"},{"location":"technical-reference/erp-connectors/#accountbalance","title":"AccountBalance","text":"<pre><code>@dataclass\nclass AccountBalance:\n    \"\"\"Balance for a single account.\"\"\"\n    account_code: str\n    account_name: str\n    account_type: str  # ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE\n    parent_account_code: Optional[str]\n    level: int\n    opening_balance: float\n    debit_amount: float\n    credit_amount: float\n    closing_balance: float\n    is_summary: bool = False\n</code></pre>"},{"location":"technical-reference/erp-connectors/#subledgerentry","title":"SubledgerEntry","text":"<pre><code>@dataclass\nclass SubledgerEntry:\n    \"\"\"Detail transaction for an account.\"\"\"\n    entry_id: str\n    transaction_date: datetime\n    posting_date: datetime\n    account_code: str\n    account_name: str\n    debit_amount: float\n    credit_amount: float\n    description: str\n    document_number: Optional[str] = None\n    document_type: Optional[str] = None\n    cost_center: Optional[str] = None\n    entity_id: Optional[str] = None\n    entity_name: Optional[str] = None\n    metadata: dict = field(default_factory=dict)\n</code></pre>"},{"location":"technical-reference/erp-connectors/#authentication","title":"Authentication","text":""},{"location":"technical-reference/erp-connectors/#authentication-types","title":"Authentication Types","text":"<pre><code>from enum import Enum\n\nclass AuthType(Enum):\n    \"\"\"Supported authentication types.\"\"\"\n    OAUTH2 = \"oauth2\"\n    API_KEY = \"api_key\"\n    BASIC_AUTH = \"basic_auth\"\n    BEARER_TOKEN = \"bearer_token\"\n</code></pre>"},{"location":"technical-reference/erp-connectors/#oauth2handler","title":"OAuth2Handler","text":"<p>OAuth 2.0 authentication with automatic token refresh.</p> <pre><code>from connectors.auth import OAuth2Handler\n\n# Initialize\nauth_handler = OAuth2Handler(\n    client_id=\"your_client_id\",\n    client_secret=\"your_client_secret\",\n    token_url=\"https://api.example.com/oauth/token\",\n    scope=\"read:financials\"\n)\n\n# Get authenticated session\nasync with auth_handler.get_session() as session:\n    response = await session.get(\"https://api.example.com/data\")\n</code></pre> <p>Features: - Automatic token refresh when expired - Token caching to reduce auth overhead - Thread-safe token management - Configurable token expiration</p> <p>Configuration:</p> <pre><code>{\n    \"client_id\": \"abc123\",\n    \"client_secret\": \"secret456\",\n    \"token_url\": \"https://api.erp.com/oauth/token\",\n    \"scope\": \"read:financials write:data\",\n    \"grant_type\": \"client_credentials\"\n}\n</code></pre>"},{"location":"technical-reference/erp-connectors/#apikeyhandler","title":"APIKeyHandler","text":"<p>API key authentication (app key + app secret).</p> <pre><code>from connectors.auth import APIKeyHandler\n\nauth_handler = APIKeyHandler(\n    api_key=\"your_app_key\",\n    api_secret=\"your_app_secret\",\n    key_location=\"header\"  # or \"query\"\n)\n</code></pre> <p>Header-based: <pre><code>GET /api/data\nX-App-Key: your_app_key\nX-App-Secret: your_app_secret\n</code></pre></p> <p>Query-based: <pre><code>GET /api/data?app_key=your_app_key&amp;app_secret=your_app_secret\n</code></pre></p>"},{"location":"technical-reference/erp-connectors/#basicauthhandler","title":"BasicAuthHandler","text":"<p>HTTP Basic authentication.</p> <pre><code>from connectors.auth import BasicAuthHandler\n\nauth_handler = BasicAuthHandler(\n    username=\"api_user\",\n    password=\"api_password\"\n)\n</code></pre>"},{"location":"technical-reference/erp-connectors/#bearertokenhandler","title":"BearerTokenHandler","text":"<p>Bearer token authentication.</p> <pre><code>from connectors.auth import BearerTokenHandler\n\nauth_handler = BearerTokenHandler(\n    token=\"your_bearer_token\",\n    token_expiration=3600  # Optional: seconds until expiration\n)\n</code></pre>"},{"location":"technical-reference/erp-connectors/#retry-logic-and-resilience","title":"Retry Logic and Resilience","text":""},{"location":"technical-reference/erp-connectors/#retry-strategies","title":"Retry Strategies","text":"<pre><code>from enum import Enum\n\nclass RetryStrategy(Enum):\n    \"\"\"Retry backoff strategies.\"\"\"\n    EXPONENTIAL = \"exponential\"  # 1s, 2s, 4s, 8s\n    LINEAR = \"linear\"            # 1s, 2s, 3s, 4s\n    FIXED = \"fixed\"              # 1s, 1s, 1s, 1s\n</code></pre>"},{"location":"technical-reference/erp-connectors/#exponential-backoff","title":"Exponential Backoff","text":"<pre><code>from connectors.retry import with_retry, RetryStrategy\n\n@with_retry(\n    max_attempts=3,\n    strategy=RetryStrategy.EXPONENTIAL,\n    base_delay=1.0,\n    max_delay=30.0,\n    jitter=True\n)\nasync def fetch_data():\n    # Your API call here\n    pass\n</code></pre> <p>Backoff calculation: <pre><code>delay = min(base_delay * (2 ** attempt), max_delay)\nif jitter:\n    delay = delay * (0.5 + random.random() * 0.5)\n</code></pre></p>"},{"location":"technical-reference/erp-connectors/#circuit-breaker","title":"Circuit Breaker","text":"<p>Prevents cascading failures by stopping requests after repeated failures.</p> <pre><code>from connectors.retry import CircuitBreaker\n\ncircuit_breaker = CircuitBreaker(\n    failure_threshold=5,      # Open after 5 failures\n    recovery_timeout=60,      # Try recovery after 60 seconds\n    expected_exception=APIError\n)\n\nasync with circuit_breaker:\n    response = await api_call()\n</code></pre> <p>States: - <code>CLOSED</code> - Normal operation - <code>OPEN</code> - Blocking requests (failures exceeded threshold) - <code>HALF_OPEN</code> - Testing recovery</p>"},{"location":"technical-reference/erp-connectors/#rate-limiting","title":"Rate Limiting","text":"<p>Token bucket algorithm for rate limiting.</p> <pre><code>from connectors.retry import TokenBucketRateLimiter\n\nrate_limiter = TokenBucketRateLimiter(\n    rate=100,        # 100 requests\n    interval=60,     # per 60 seconds\n    burst=10         # allow bursts up to 10\n)\n\nasync with rate_limiter:\n    response = await api_call()\n</code></pre>"},{"location":"technical-reference/erp-connectors/#data-validation","title":"Data Validation","text":""},{"location":"technical-reference/erp-connectors/#validation-functions","title":"Validation Functions","text":"<pre><code>from connectors.validation import (\n    validate_account_type,\n    validate_account_code,\n    validate_amount,\n    validate_date,\n    validate_trial_balance\n)\n\n# Validate account type (Portuguese or English)\naccount_type = validate_account_type(\"Ativo\")  # Returns \"ASSET\"\naccount_type = validate_account_type(\"Asset\")  # Returns \"ASSET\"\n\n# Validate account code\nvalidate_account_code(\"1.01.001\")  # Valid\nvalidate_account_code(\"\")          # Raises ValidationError\n\n# Validate amount (converts to Decimal)\namount = validate_amount(1234.56)  # Returns Decimal(\"1234.56\")\namount = validate_amount(\"1234.56\")  # Returns Decimal(\"1234.56\")\n\n# Validate date (multiple formats)\ndate = validate_date(\"2024-12-31\")           # Returns datetime\ndate = validate_date(\"31/12/2024\")           # Returns datetime\ndate = validate_date(\"2024-12-31T10:30:00\")  # Returns datetime\n</code></pre>"},{"location":"technical-reference/erp-connectors/#trial-balance-validation","title":"Trial Balance Validation","text":"<pre><code>from connectors.validation import validate_trial_balance\n\ntrial_balance = TrialBalance(...)\n\n# Validate trial balance\nis_valid, errors = validate_trial_balance(trial_balance)\n\nif not is_valid:\n    for error in errors:\n        print(f\"Validation error: {error}\")\n</code></pre> <p>Validation checks: - Debit/credit balance (total debits = total credits) - Account hierarchy consistency - Account type validity - Required fields present - Data type correctness</p>"},{"location":"technical-reference/erp-connectors/#erp-specific-implementations","title":"ERP-Specific Implementations","text":""},{"location":"technical-reference/erp-connectors/#totvs-protheus-connector","title":"TOTVS Protheus Connector","text":"<p>Used by: Effecti, OnClick</p> <pre><code>from connectors import create_connector\n\nconnector = create_connector(\n    erp_type=\"totvs_protheus\",\n    auth_type=\"oauth2\",\n    credentials={\n        \"client_id\": \"your_client_id\",\n        \"client_secret\": \"your_client_secret\",\n        \"token_url\": \"https://api.totvs.com.br/oauth/token\"\n    },\n    config={\n        \"base_url\": \"https://api.totvs.com.br/protheus\",\n        \"tenant\": \"your_tenant_id\",\n        \"environment\": \"production\"\n    }\n)\n</code></pre> <p>Features: - OAuth 2.0 authentication - REST API integration - Trial balance extraction via <code>/balancete</code> endpoint - Subledger detail via <code>/movimentacao</code> endpoint - Rate limit: 100 requests/minute</p> <p>API Endpoints:</p> <pre><code># Trial balance\nGET /protheus/rest/CTBR020/balancete\n    ?empresa={company_id}\n    &amp;dataInicial={YYYYMMDD}\n    &amp;dataFinal={YYYYMMDD}\n\n# Subledger entries\nGET /protheus/rest/CTBR020/movimentacao\n    ?empresa={company_id}\n    &amp;conta={account_code}\n    &amp;dataInicial={YYYYMMDD}\n    &amp;dataFinal={YYYYMMDD}\n</code></pre> <p>Data Mapping:</p> TOTVS Field Standard Field Notes <code>CT1_CONTA</code> <code>account_code</code> Account code <code>CT1_DESC01</code> <code>account_name</code> Account name <code>CTI_CLASSE</code> <code>account_type</code> 1=Analytic, 2=Synthetic <code>CTI_NORMAL</code> <code>normal_balance</code> D=Debit, C=Credit <code>CTI_SALDOI</code> <code>opening_balance</code> Opening balance <code>CTI_DEBITO</code> <code>debit_amount</code> Period debits <code>CTI_CREDITO</code> <code>credit_amount</code> Period credits <code>CTI_SALDOF</code> <code>closing_balance</code> Closing balance"},{"location":"technical-reference/erp-connectors/#contaazul-connector","title":"ContaAzul Connector","text":"<p>Used by: Mercos, Munddi</p> <pre><code>connector = create_connector(\n    erp_type=\"contaazul\",\n    auth_type=\"oauth2\",\n    credentials={\n        \"client_id\": \"your_client_id\",\n        \"client_secret\": \"your_client_secret\",\n        \"token_url\": \"https://api.contaazul.com/oauth/token\"\n    },\n    config={\n        \"base_url\": \"https://api.contaazul.com/v1\"\n    }\n)\n</code></pre> <p>Features: - OAuth 2.0 authentication - REST API integration - Trial balance via transaction aggregation - Rate limit: 60 requests/minute</p> <p>API Endpoints:</p> <pre><code># Chart of accounts\nGET /v1/chart-of-accounts\n\n# Transactions\nGET /v1/transactions\n    ?start_date={YYYY-MM-DD}\n    &amp;end_date={YYYY-MM-DD}\n    &amp;page={page}\n    &amp;per_page={per_page}\n</code></pre> <p>Trial Balance Construction:</p> <p>ContaAzul doesn't provide a direct trial balance endpoint. The connector: 1. Fetches chart of accounts 2. Fetches all transactions for period 3. Aggregates transactions by account 4. Constructs trial balance</p> <pre><code># Pseudocode\naccounts = await fetch_chart_of_accounts()\ntransactions = await fetch_transactions(period_start, period_end)\n\ntrial_balance = {}\nfor transaction in transactions:\n    for line in transaction.lines:\n        account = trial_balance.get(line.account_code, {\n            'opening_balance': 0,\n            'debit_amount': 0,\n            'credit_amount': 0\n        })\n        account['debit_amount'] += line.debit_amount\n        account['credit_amount'] += line.credit_amount\n        trial_balance[line.account_code] = account\n</code></pre>"},{"location":"technical-reference/erp-connectors/#omie-connector","title":"Omie Connector","text":"<p>Used by: Datahub</p> <pre><code>connector = create_connector(\n    erp_type=\"omie\",\n    auth_type=\"api_key\",\n    credentials={\n        \"app_key\": \"your_app_key\",\n        \"app_secret\": \"your_app_secret\"\n    },\n    config={\n        \"base_url\": \"https://app.omie.com.br/api/v1\"\n    }\n)\n</code></pre> <p>Features: - API Key authentication (app_key + app_secret) - JSON-RPC API - Direct balance extraction - Rate limit: 300 requests/minute</p> <p>API Calls:</p> <pre><code># Trial balance (Balancete)\nPOST /geral/balancete/\n{\n    \"call\": \"ListarBalancete\",\n    \"app_key\": \"your_app_key\",\n    \"app_secret\": \"your_app_secret\",\n    \"param\": [{\n        \"dDataDe\": \"01/01/2024\",\n        \"dDataAte\": \"31/12/2024\",\n        \"nCodEmpresa\": 123\n    }]\n}\n\n# Account movements\nPOST /geral/contacorrente/\n{\n    \"call\": \"ListarMovimentos\",\n    \"app_key\": \"your_app_key\",\n    \"app_secret\": \"your_app_secret\",\n    \"param\": [{\n        \"cCodConta\": \"1.01.001\",\n        \"dDataDe\": \"01/01/2024\",\n        \"dDataAte\": \"31/12/2024\"\n    }]\n}\n</code></pre> <p>Data Mapping:</p> Omie Field Standard Field <code>cCodConta</code> <code>account_code</code> <code>cDescConta</code> <code>account_name</code> <code>cTipoConta</code> <code>account_type</code> <code>nSaldoInicial</code> <code>opening_balance</code> <code>nDebitos</code> <code>debit_amount</code> <code>nCreditos</code> <code>credit_amount</code> <code>nSaldoFinal</code> <code>closing_balance</code>"},{"location":"technical-reference/erp-connectors/#bling-connector","title":"Bling Connector","text":"<p>Used by: Ip\u00ea Digital, Leadlovers</p> <pre><code>connector = create_connector(\n    erp_type=\"bling\",\n    auth_type=\"api_key\",  # or \"oauth2\"\n    credentials={\n        \"api_key\": \"your_api_key\"\n    },\n    config={\n        \"base_url\": \"https://bling.com.br/Api/v3\",\n        \"api_version\": \"v3\"  # or \"v2\"\n    }\n)\n</code></pre> <p>Features: - API Key or OAuth 2.0 authentication - Supports both v2 (XML) and v3 (JSON) APIs - Rate limit: 100 requests/minute</p> <p>API Endpoints (v3):</p> <pre><code># Chart of accounts\nGET /v3/contascontabeis\n    ?pagina={page}\n    &amp;limite={limit}\n\n# Account movements\nGET /v3/contascontabeis/{account_id}/movimentacoes\n    ?dataInicial={YYYY-MM-DD}\n    &amp;dataFinal={YYYY-MM-DD}\n</code></pre> <p>XML vs JSON:</p> Version Format Authentication Status v2 XML API Key Legacy v3 JSON OAuth 2.0 or API Key Current"},{"location":"technical-reference/erp-connectors/#connector-factory","title":"Connector Factory","text":""},{"location":"technical-reference/erp-connectors/#creating-connectors","title":"Creating Connectors","text":"<pre><code>from connectors import create_connector\n\n# Create by ERP type\nconnector = create_connector(\n    erp_type=\"totvs_protheus\",\n    auth_type=\"oauth2\",\n    credentials={...},\n    config={...}\n)\n\n# Create by portfolio company\nconnector = create_connector_for_company(\n    company_code=\"EFFECTI\",\n    credentials={...}\n)\n</code></pre>"},{"location":"technical-reference/erp-connectors/#portfolio-company-mapping","title":"Portfolio Company Mapping","text":"<pre><code>PORTFOLIO_COMPANY_ERP_MAPPING = {\n    \"EFFECTI\": \"totvs_protheus\",\n    \"ONCLICK\": \"totvs_protheus\",\n    \"MERCOS\": \"contaazul\",\n    \"MUNDDI\": \"contaazul\",\n    \"DATAHUB\": \"omie\",\n    \"IPE_DIGITAL\": \"bling\",\n    \"LEADLOVERS\": \"bling\"\n}\n</code></pre>"},{"location":"technical-reference/erp-connectors/#usage-examples","title":"Usage Examples","text":""},{"location":"technical-reference/erp-connectors/#basic-usage","title":"Basic Usage","text":"<pre><code>from connectors import create_connector\nfrom datetime import datetime\n\n# Create connector\nconnector = create_connector(\n    erp_type=\"totvs_protheus\",\n    auth_type=\"oauth2\",\n    credentials={\n        \"client_id\": \"your_client_id\",\n        \"client_secret\": \"your_client_secret\"\n    },\n    config={\n        \"tenant\": \"your_tenant_id\"\n    }\n)\n\n# Use async context manager\nasync with connector:\n    # Health check\n    health = await connector.health_check()\n    print(f\"Status: {health.status}\")\n\n    # Extract trial balance\n    trial_balance = await connector.get_trial_balance(\n        company_id=\"01\",\n        period_start=datetime(2024, 1, 1),\n        period_end=datetime(2024, 12, 31)\n    )\n\n    print(f\"Company: {trial_balance.company_name}\")\n    print(f\"Currency: {trial_balance.currency}\")\n    print(f\"Accounts: {len(trial_balance.accounts)}\")\n\n    for account in trial_balance.accounts:\n        print(f\"  {account.account_code}: {account.closing_balance}\")\n\n    # Extract subledger\n    entries = await connector.get_subledger_details(\n        company_id=\"01\",\n        account_code=\"1.01.001\",\n        period_start=datetime(2024, 1, 1),\n        period_end=datetime(2024, 12, 31)\n    )\n\n    print(f\"Subledger entries: {len(entries)}\")\n</code></pre>"},{"location":"technical-reference/erp-connectors/#error-handling","title":"Error Handling","text":"<pre><code>from connectors.exceptions import (\n    ERPConnectionError,\n    ERPAuthenticationError,\n    ERPValidationError,\n    ERPRateLimitError\n)\n\ntry:\n    trial_balance = await connector.get_trial_balance(...)\nexcept ERPAuthenticationError as e:\n    print(f\"Authentication failed: {e}\")\n    # Refresh credentials\nexcept ERPConnectionError as e:\n    print(f\"Connection failed: {e}\")\n    # Retry or alert\nexcept ERPRateLimitError as e:\n    print(f\"Rate limit exceeded: {e}\")\n    # Wait and retry\nexcept ERPValidationError as e:\n    print(f\"Validation error: {e}\")\n    # Fix data and retry\n</code></pre>"},{"location":"technical-reference/erp-connectors/#filtering","title":"Filtering","text":"<pre><code># Filter by account type\ntrial_balance = await connector.get_trial_balance(\n    company_id=\"01\",\n    period_start=datetime(2024, 1, 1),\n    period_end=datetime(2024, 12, 31),\n    filters={\n        \"account_types\": [\"ASSET\", \"LIABILITY\"],\n        \"include_zero_balances\": False,\n        \"level\": 3  # Detail accounts only\n    }\n)\n\n# Filter subledger by document type\nentries = await connector.get_subledger_details(\n    company_id=\"01\",\n    account_code=\"1.01.001\",\n    period_start=datetime(2024, 1, 1),\n    period_end=datetime(2024, 12, 31),\n    filters={\n        \"document_types\": [\"invoice\", \"payment\"],\n        \"cost_center\": \"CC001\"\n    }\n)\n</code></pre>"},{"location":"technical-reference/erp-connectors/#performance-characteristics","title":"Performance Characteristics","text":""},{"location":"technical-reference/erp-connectors/#rate-limits","title":"Rate Limits","text":"ERP Requests/Minute Burst Notes TOTVS Protheus 100 10 Per tenant ContaAzul 60 5 Per OAuth app Omie 300 20 Per app_key Bling 100 10 Per API key"},{"location":"technical-reference/erp-connectors/#timeouts","title":"Timeouts","text":"<ul> <li>Default: 30 seconds per request</li> <li>Health check: 10 seconds</li> <li>Large data extracts: 120 seconds</li> </ul>"},{"location":"technical-reference/erp-connectors/#memory-usage","title":"Memory Usage","text":"<ul> <li>Streaming: Used where possible to minimize memory</li> <li>Pagination: Large datasets retrieved in chunks</li> <li>Token caching: Reduces auth overhead</li> </ul>"},{"location":"technical-reference/erp-connectors/#testing","title":"Testing","text":""},{"location":"technical-reference/erp-connectors/#unit-tests","title":"Unit Tests","text":"<pre><code>cd /Volumes/AI/Code/FPA\npython -m pytest src/connectors/tests/test_connectors.py -v\n</code></pre> <p>Test coverage: - Credentials validation: 4 tests - Account validation: 7 tests - Amount validation: 6 tests - Date validation: 4 tests - Trial balance validation: 3 tests - OAuth2 handler: 2 tests - API key handler: 2 tests - Retry logic: 4 tests - Rate limiter: 2 tests - Factory pattern: 5 tests - Portfolio mapping: 5 tests - Integration tests: 2 tests</p>"},{"location":"technical-reference/erp-connectors/#mock-testing","title":"Mock Testing","text":"<pre><code>from unittest.mock import AsyncMock, patch\n\n@patch('connectors.totvs_connector.TOTVSProtheusConnector._make_request')\nasync def test_get_trial_balance(mock_request):\n    mock_request.return_value = {\n        \"balancete\": [\n            {\n                \"CT1_CONTA\": \"1.01.001\",\n                \"CT1_DESC01\": \"Caixa\",\n                \"CTI_SALDOF\": 100000.00\n            }\n        ]\n    }\n\n    connector = create_connector(...)\n    trial_balance = await connector.get_trial_balance(...)\n\n    assert len(trial_balance.accounts) == 1\n    assert trial_balance.accounts[0].account_code == \"1.01.001\"\n</code></pre>"},{"location":"technical-reference/erp-connectors/#security","title":"Security","text":""},{"location":"technical-reference/erp-connectors/#credential-storage","title":"Credential Storage","text":"<p>Never hardcode credentials:</p> <pre><code># \u274c Bad\nconnector = create_connector(\n    credentials={\"client_id\": \"abc123\"}\n)\n\n# \u2705 Good\nimport os\nconnector = create_connector(\n    credentials={\n        \"client_id\": os.environ[\"TOTVS_CLIENT_ID\"],\n        \"client_secret\": os.environ[\"TOTVS_CLIENT_SECRET\"]\n    }\n)\n</code></pre>"},{"location":"technical-reference/erp-connectors/#https-enforcement","title":"HTTPS Enforcement","text":"<p>All connectors enforce HTTPS:</p> <pre><code>if not config[\"base_url\"].startswith(\"https://\"):\n    raise ValueError(\"HTTPS required for API connections\")\n</code></pre>"},{"location":"technical-reference/erp-connectors/#token-security","title":"Token Security","text":"<ul> <li>Tokens stored in memory only</li> <li>Automatic expiration handling</li> <li>No token logging</li> <li>Secure token transmission</li> </ul>"},{"location":"technical-reference/erp-connectors/#troubleshooting","title":"Troubleshooting","text":""},{"location":"technical-reference/erp-connectors/#common-issues","title":"Common Issues","text":"<p>Authentication failures: <pre><code># Check credentials\nhealth = await connector.health_check()\nif health.status != ConnectionStatus.CONNECTED:\n    print(f\"Auth error: {health.error_message}\")\n</code></pre></p> <p>Rate limit exceeded: <pre><code># Reduce request rate or implement backoff\nfrom connectors.retry import TokenBucketRateLimiter\nrate_limiter = TokenBucketRateLimiter(rate=50, interval=60)\n</code></pre></p> <p>Connection timeouts: <pre><code># Increase timeout\nconfig = {\n    \"timeout\": 60,  # seconds\n    \"retry_on_timeout\": True\n}\n</code></pre></p>"},{"location":"technical-reference/erp-connectors/#debug-logging","title":"Debug Logging","text":"<pre><code>import logging\nlogging.basicConfig(level=logging.DEBUG)\n\n# Enable connector debug logs\nconnector = create_connector(..., config={\"debug\": True})\n</code></pre>"},{"location":"technical-reference/erp-connectors/#see-also","title":"See Also","text":"<ul> <li>Database Schema</li> <li>API Reference</li> <li>Configuration Reference</li> </ul>"},{"location":"technical-reference/security/","title":"Security Architecture","text":"<p>Version: 1.0.0 Last Updated: 2026-02-07 Implementation: <code>/Volumes/AI/Code/FPA/src/core/</code> Compliance: SOC 2 Type II, ISO 27001, IFRS, US GAAP, NASDAQ</p>"},{"location":"technical-reference/security/#overview","title":"Overview","text":"<p>The AI FP&amp;A system implements comprehensive security controls addressing data encryption, access control, and human oversight. This document describes the technical implementation of security findings #6, #7, and #8.</p>"},{"location":"technical-reference/security/#security-layers","title":"Security Layers","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Application Layer                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 Human Oversight (Finding #8)                         \u2502   \u2502\n\u2502  \u2502 - Risk-based decision framework                      \u2502   \u2502\n\u2502  \u2502 - Confidence scoring                                 \u2502   \u2502\n\u2502  \u2502 - Four-eyes principle                                \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 RBAC Layer (Finding #7)                              \u2502   \u2502\n\u2502  \u2502 - 11 agent roles                                     \u2502   \u2502\n\u2502  \u2502 - 25+ granular permissions                           \u2502   \u2502\n\u2502  \u2502 - API key scoping                                    \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 Encryption Layer (Finding #6)                        \u2502   \u2502\n\u2502  \u2502 - TLS 1.3 (in transit)                               \u2502   \u2502\n\u2502  \u2502 - AES-256-GCM (at rest)                              \u2502   \u2502\n\u2502  \u2502 - Column-level encryption                            \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      Data Layer                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 Row-Level Security (RLS)                             \u2502   \u2502\n\u2502  \u2502 - Multi-tenant isolation                             \u2502   \u2502\n\u2502  \u2502 - Company-level filtering                            \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 Database Encryption                                   \u2502   \u2502\n\u2502  \u2502 - PostgreSQL SSL/TLS                                 \u2502   \u2502\n\u2502  \u2502 - pgcrypto for column encryption                     \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Infrastructure Layer                      \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 AWS KMS                                               \u2502   \u2502\n\u2502  \u2502 - Master key management                              \u2502   \u2502\n\u2502  \u2502 - Key rotation                                       \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 S3 Encryption                                         \u2502   \u2502\n\u2502  \u2502 - Server-side encryption (KMS)                       \u2502   \u2502\n\u2502  \u2502 - 7-year retention                                   \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"technical-reference/security/#finding-6-data-encryption","title":"Finding #6: Data Encryption","text":""},{"location":"technical-reference/security/#encryption-standards","title":"Encryption Standards","text":"Component Algorithm Key Size Standard At Rest AES-256-GCM 256 bits FIPS 140-2 In Transit TLS 1.3 2048+ bits RSA RFC 8446 Key Encryption AES-256-GCM 256 bits Envelope encryption Backup Double encryption 256 bits App + S3 KMS"},{"location":"technical-reference/security/#encryptionmanager","title":"EncryptionManager","text":"<p>Central encryption management with envelope encryption (KEK/DEK pattern).</p> <pre><code>from core.encryption import EncryptionManager, SensitiveFieldType\n\nenc_manager = EncryptionManager(\n    kms_master_key_id=\"arn:aws:kms:us-east-1:123456789012:key/abc-123\",\n    key_rotation_days=90\n)\n\n# Encrypt sensitive field\nencrypted_revenue = enc_manager.encrypt_field(\n    plaintext=Decimal(\"1250000.50\"),\n    field_type=SensitiveFieldType.REVENUE,\n    metadata={'company': 'Effecti', 'period': '2026-01'}\n)\n\n# Decrypt field\ndecrypted_revenue = enc_manager.decrypt_field(\n    encrypted_data=encrypted_revenue,\n    field_type=SensitiveFieldType.REVENUE\n)\n</code></pre> <p>Envelope Encryption Pattern:</p> <pre><code>Plaintext Data\n    \u2193\nEncrypt with DEK (Data Encryption Key)\n    \u2193\nEncrypted Data + Encrypted DEK\n    \u2193\nStore: {\n    \"ciphertext\": \"...\",\n    \"encrypted_dek\": \"...\",\n    \"algorithm\": \"AES-256-GCM\",\n    \"iv\": \"...\",\n    \"tag\": \"...\"\n}\n</code></pre>"},{"location":"technical-reference/security/#sensitive-field-types","title":"Sensitive Field Types","text":"<pre><code>class SensitiveFieldType(Enum):\n    \"\"\"Types of sensitive fields requiring encryption.\"\"\"\n    REVENUE = \"revenue\"\n    CUSTOMER_DATA = \"customer_data\"\n    EMPLOYEE_PII = \"employee_pii\"\n    API_CREDENTIALS = \"api_credentials\"\n    FINANCIAL_FORECAST = \"financial_forecast\"\n    BANKING_INFO = \"banking_info\"\n</code></pre>"},{"location":"technical-reference/security/#tls-configuration","title":"TLS Configuration","text":""},{"location":"technical-reference/security/#tlsconfigmanager","title":"TLSConfigManager","text":"<p>Enforce TLS 1.3 for all ERP API connections.</p> <pre><code>from core.encryption import TLSConfigManager\n\n# Get secure SSL context\nssl_context = TLSConfigManager.get_secure_ssl_context()\n\n# Get requests session with TLS 1.3\nsession = TLSConfigManager.get_requests_session()\n\n# Make secure API call\nresponse = session.get('https://erp-api.example.com/data')\n</code></pre> <p>TLS Configuration:</p> <pre><code>{\n    \"minimum_version\": ssl.TLSVersion.TLSv1_2,\n    \"maximum_version\": ssl.TLSVersion.TLSv1_3,\n    \"cipher_suites\": [\n        \"ECDHE-ECDSA-AES256-GCM-SHA384\",\n        \"ECDHE-RSA-AES256-GCM-SHA384\",\n        \"ECDHE-ECDSA-CHACHA20-POLY1305\",\n        \"ECDHE-RSA-CHACHA20-POLY1305\",\n        \"ECDHE-ECDSA-AES128-GCM-SHA256\",\n        \"ECDHE-RSA-AES128-GCM-SHA256\"\n    ],\n    \"verify_mode\": ssl.CERT_REQUIRED,\n    \"check_hostname\": True\n}\n</code></pre>"},{"location":"technical-reference/security/#postgresql-encryption","title":"PostgreSQL Encryption","text":""},{"location":"technical-reference/security/#connection-encryption","title":"Connection Encryption","text":"<pre><code>from core.encryption import PostgreSQLEncryption\n\npg_enc = PostgreSQLEncryption(\n    connection_string=\"postgresql://user:pass@host:5432/db?sslmode=require\"\n)\n\n# Get encrypted connection\nconn = pg_enc.get_encrypted_connection()\n</code></pre> <p>SSL Modes: - <code>require</code> - Require SSL/TLS (minimum) - <code>verify-ca</code> - Verify CA certificate - <code>verify-full</code> - Verify CA and hostname (recommended)</p>"},{"location":"technical-reference/security/#column-level-encryption","title":"Column-Level Encryption","text":"<pre><code># Encrypt column using pgcrypto\nencrypted_value = pg_enc.encrypt_column_value(\n    plaintext=\"sensitive_data\",\n    column_name=\"revenue\"\n)\n\n# Decrypt column value\ndecrypted_value = pg_enc.decrypt_column_value(\n    ciphertext=encrypted_value,\n    column_name=\"revenue\"\n)\n</code></pre> <p>PostgreSQL SQL:</p> <pre><code>-- Enable pgcrypto extension\nCREATE EXTENSION IF NOT EXISTS pgcrypto;\n\n-- Encrypt on insert\nINSERT INTO financials (entity_id, revenue_encrypted)\nVALUES (\n    'effecti',\n    pgp_sym_encrypt('1250000.50', 'encryption_key')\n);\n\n-- Decrypt on select\nSELECT\n    entity_id,\n    pgp_sym_decrypt(revenue_encrypted, 'encryption_key') AS revenue\nFROM financials;\n</code></pre>"},{"location":"technical-reference/security/#s3-backup-encryption","title":"S3 Backup Encryption","text":""},{"location":"technical-reference/security/#s3encryptionmanager","title":"S3EncryptionManager","text":"<pre><code>from core.encryption import S3EncryptionManager\n\ns3_manager = S3EncryptionManager(\n    bucket_name=\"fpa-backups-prod\",\n    kms_key_id=\"arn:aws:kms:us-east-1:123456789012:key/s3-key\",\n    region=\"us-east-1\"\n)\n\n# Upload encrypted object\ns3_manager.upload_encrypted(\n    key=\"backups/2024-12/trial_balance.json\",\n    data=json.dumps(trial_balance_data),\n    metadata={'company': 'effecti', 'period': '2024-12'}\n)\n\n# Download and decrypt\ndata = s3_manager.download_encrypted(\n    key=\"backups/2024-12/trial_balance.json\"\n)\n</code></pre> <p>S3 Bucket Policy:</p> <pre><code>{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Deny\",\n            \"Principal\": \"*\",\n            \"Action\": \"s3:PutObject\",\n            \"Resource\": \"arn:aws:s3:::fpa-backups-prod/*\",\n            \"Condition\": {\n                \"StringNotEquals\": {\n                    \"s3:x-amz-server-side-encryption\": \"aws:kms\"\n                }\n            }\n        }\n    ]\n}\n</code></pre>"},{"location":"technical-reference/security/#backupencryptionmanager","title":"BackupEncryptionManager","text":"<p>Double encryption (application-level + S3 KMS).</p> <pre><code>from core.encryption import BackupEncryptionManager\n\nbackup_manager = BackupEncryptionManager(\n    encryption_manager=enc_manager,\n    s3_manager=s3_manager\n)\n\n# Create encrypted backup\ns3_key = backup_manager.create_encrypted_backup(\n    data=financial_data,\n    backup_name='monthly_close_2024_12',\n    metadata={'type': 'financial_data'}\n)\n\n# Restore backup\nrestored_data = backup_manager.restore_encrypted_backup(\n    s3_key=s3_key\n)\n</code></pre> <p>Backup Lifecycle:</p> <pre><code>{\n    \"retention_years\": 7,\n    \"transition_to_glacier_days\": 90,\n    \"versioning_enabled\": True,\n    \"object_lock_enabled\": True\n}\n</code></pre>"},{"location":"technical-reference/security/#key-rotation","title":"Key Rotation","text":""},{"location":"technical-reference/security/#automatic-key-rotation","title":"Automatic Key Rotation","text":"<pre><code># Rotate all keys\nenc_manager.rotate_keys()\n\n# Rotate specific field type\nenc_manager.rotate_keys(field_type=SensitiveFieldType.REVENUE)\n\n# Check rotation status\nrotation_info = enc_manager.get_rotation_info()\nprint(f\"Last rotated: {rotation_info['last_rotation_date']}\")\nprint(f\"Next rotation: {rotation_info['next_rotation_date']}\")\n</code></pre> <p>Rotation Process:</p> <ol> <li>Generate new DEK</li> <li>Encrypt new DEK with KEK</li> <li>Re-encrypt data with new DEK</li> <li>Update encrypted DEK reference</li> <li>Archive old DEK (for recovery)</li> <li>Log rotation event</li> </ol> <p>Rotation Schedule: - Default: 90 days - Configurable: 30-365 days - Triggered: On security event</p>"},{"location":"technical-reference/security/#finding-7-role-based-access-control","title":"Finding #7: Role-Based Access Control","text":""},{"location":"technical-reference/security/#rbac-architecture","title":"RBAC Architecture","text":""},{"location":"technical-reference/security/#rbacmanager","title":"RBACManager","text":"<pre><code>from core.access_control import RBACManager, AgentRole, Permission\n\nrbac = RBACManager()\n\n# Check permission\ncan_write = rbac.check_permission(\n    role=AgentRole.DATA_INGESTION,\n    permission=Permission.WRITE_RAW_DATA\n)\n\n# Get role permissions\npermissions = rbac.get_role_permissions(AgentRole.DATA_INGESTION)\n</code></pre>"},{"location":"technical-reference/security/#agent-roles","title":"Agent Roles","text":"Role Permissions Data Access Companies <code>orchestrator</code> Full operational access Confidential All <code>data_ingestion</code> Write raw data Internal Scoped <code>consolidation</code> Read raw, write consolidated Confidential All <code>validation</code> Read-only Confidential All <code>analysis</code> Read consolidated Confidential All <code>forecasting</code> Create forecasts Confidential All <code>reporting</code> Generate reports Confidential All <code>compliance</code> Read + audit logs Restricted All <code>human_reviewer</code> Approval authority Restricted All <code>system_admin</code> Full access Restricted All <code>read_only</code> Read consolidated Internal Scoped"},{"location":"technical-reference/security/#permission-types","title":"Permission Types","text":"<pre><code>class Permission(Enum):\n    \"\"\"Granular permissions.\"\"\"\n    # Data access\n    READ_RAW_DATA = \"read_raw_data\"\n    WRITE_RAW_DATA = \"write_raw_data\"\n    READ_CONSOLIDATED_DATA = \"read_consolidated_data\"\n    WRITE_CONSOLIDATED_DATA = \"write_consolidated_data\"\n    READ_SENSITIVE_DATA = \"read_sensitive_data\"\n\n    # Financial operations\n    CREATE_JOURNAL_ENTRY = \"create_journal_entry\"\n    APPROVE_JOURNAL_ENTRY = \"approve_journal_entry\"\n    REVERSE_JOURNAL_ENTRY = \"reverse_journal_entry\"\n    CLOSE_PERIOD = \"close_period\"\n    REOPEN_PERIOD = \"reopen_period\"\n\n    # Analysis\n    RUN_VARIANCE_ANALYSIS = \"run_variance_analysis\"\n    CREATE_FORECAST = \"create_forecast\"\n    MODIFY_ASSUMPTIONS = \"modify_assumptions\"\n\n    # Reports\n    GENERATE_REPORT = \"generate_report\"\n    EXPORT_DATA = \"export_data\"\n    SHARE_REPORT = \"share_report\"\n\n    # Administrative\n    MANAGE_USERS = \"manage_users\"\n    MODIFY_SCHEMA = \"modify_schema\"\n    VIEW_AUDIT_LOGS = \"view_audit_logs\"\n    MODIFY_SECURITY_SETTINGS = \"modify_security_settings\"\n\n    # System\n    EXECUTE_BATCH_JOB = \"execute_batch_job\"\n    ACCESS_API = \"access_api\"\n</code></pre>"},{"location":"technical-reference/security/#api-key-management","title":"API Key Management","text":""},{"location":"technical-reference/security/#generate-api-key","title":"Generate API Key","text":"<pre><code># Generate scoped API key\napi_key = rbac.generate_api_key(\n    role=AgentRole.DATA_INGESTION,\n    agent_id='effecti_connector',\n    companies=['effecti'],\n    expires_days=90\n)\n\nprint(f\"API Key: {api_key.key}\")\nprint(f\"Expires: {api_key.expires_at}\")\n</code></pre> <p>API Key Structure:</p> <pre><code>{\n    \"key_id\": \"uuid\",\n    \"key\": \"fpa_abc123...xyz789\",  # 43 characters (32 bytes base64)\n    \"role\": \"data_ingestion\",\n    \"agent_id\": \"effecti_connector\",\n    \"companies\": [\"effecti\"],\n    \"created_at\": \"2026-02-07T10:00:00Z\",\n    \"expires_at\": \"2026-05-07T10:00:00Z\",\n    \"is_active\": True\n}\n</code></pre>"},{"location":"technical-reference/security/#validate-api-key","title":"Validate API Key","text":"<pre><code># Validate API key from request\nvalidated = rbac.validate_api_key(api_key_string)\n\nif validated:\n    # Check company access\n    if validated.can_access_company('effecti'):\n        # Process request\n        pass\n    else:\n        raise PermissionError(\"Access denied to company\")\nelse:\n    raise AuthenticationError(\"Invalid or expired API key\")\n</code></pre>"},{"location":"technical-reference/security/#revoke-api-key","title":"Revoke API Key","text":"<pre><code># Revoke API key\nrbac.revoke_api_key(\n    key_id=\"uuid\",\n    reason=\"Security incident - key compromised\"\n)\n</code></pre>"},{"location":"technical-reference/security/#row-level-security-rls","title":"Row-Level Security (RLS)","text":""},{"location":"technical-reference/security/#postgresqlrbacmanager","title":"PostgreSQLRBACManager","text":"<p>Generate PostgreSQL RBAC setup SQL.</p> <pre><code>from core.access_control import PostgreSQLRBACManager\n\npg_rbac = PostgreSQLRBACManager()\n\n# Create database role\ncreate_role_sql = pg_rbac.create_role_sql(AgentRole.DATA_INGESTION)\n\n# Grant permissions\ngrant_sql = pg_rbac.grant_permissions_sql(\n    role=AgentRole.DATA_INGESTION,\n    permissions=[Permission.READ_RAW_DATA, Permission.WRITE_RAW_DATA]\n)\n\n# Create RLS policy\nrls_sql = pg_rbac.create_rls_policy_sql(\n    table_name='trial_balances',\n    role=AgentRole.DATA_INGESTION,\n    permissions=[Permission.WRITE_RAW_DATA]\n)\n</code></pre> <p>Generated SQL:</p> <pre><code>-- Create role\nCREATE ROLE data_ingestion_role;\n\n-- Grant permissions\nGRANT SELECT, INSERT ON trial_balances TO data_ingestion_role;\n\n-- Enable RLS\nALTER TABLE trial_balances ENABLE ROW LEVEL SECURITY;\n\n-- Create policy\nCREATE POLICY data_ingestion_policy ON trial_balances\n    FOR ALL\n    TO data_ingestion_role\n    USING (\n        entity_id IN (\n            SELECT entity_id FROM user_entity_access\n            WHERE user_id = current_setting('app.user_id')::uuid\n              AND can_read = TRUE\n        )\n    )\n    WITH CHECK (\n        entity_id IN (\n            SELECT entity_id FROM user_entity_access\n            WHERE user_id = current_setting('app.user_id')::uuid\n              AND can_write = TRUE\n        )\n    );\n</code></pre>"},{"location":"technical-reference/security/#audit-logging","title":"Audit Logging","text":"<p>All permission checks and violations are logged.</p> <pre><code># Permission violations auto-logged\nrbac.check_permission(AgentRole.READ_ONLY, Permission.MODIFY_SCHEMA)\n\n# View audit log\nfor entry in rbac.audit_log:\n    print(f\"{entry['timestamp']}: {entry['event']}\")\n    print(f\"  Role: {entry['role']}\")\n    print(f\"  Permission: {entry['permission']}\")\n    print(f\"  Result: {entry['result']}\")\n    print(f\"  Reason: {entry['reason']}\")\n</code></pre> <p>Audit Log Entry:</p> <pre><code>{\n    \"timestamp\": \"2026-02-07T10:30:00Z\",\n    \"event\": \"permission_violation\",\n    \"role\": \"read_only\",\n    \"permission\": \"modify_schema\",\n    \"result\": \"denied\",\n    \"reason\": \"Role 'read_only' does not have permission 'modify_schema'\",\n    \"agent_id\": \"viewer_001\",\n    \"request_id\": \"req_abc123\"\n}\n</code></pre>"},{"location":"technical-reference/security/#finding-8-human-oversight","title":"Finding #8: Human Oversight","text":""},{"location":"technical-reference/security/#risk-based-decision-framework","title":"Risk-Based Decision Framework","text":""},{"location":"technical-reference/security/#humanoversightmanager","title":"HumanOversightManager","text":"<pre><code>from core.human_oversight import HumanOversightManager\n\noversight = HumanOversightManager()\n\n# Evaluate transaction\ntransaction = {\n    'id': 'TX001',\n    'amount': 1500000,\n    'account': 'intercompany_revenue',\n    'is_intercompany': True,\n    'is_manual_adjustment': True\n}\n\ncontext = {\n    'company_size': 'medium',\n    'data_quality_score': 0.95,\n    'historical_data': [],\n    'budget': {},\n    'agent_id': 'consolidation_agent'\n}\n\nconfidence, review_request = oversight.evaluate_transaction(transaction, context)\n</code></pre>"},{"location":"technical-reference/security/#confidence-scoring","title":"Confidence Scoring","text":""},{"location":"technical-reference/security/#confidencescoringengine","title":"ConfidenceScoringEngine","text":"<pre><code>from core.human_oversight import ConfidenceScoringEngine\n\nscoring_engine = ConfidenceScoringEngine(\n    green_threshold=0.80,\n    yellow_threshold=0.50\n)\n\n# Calculate confidence score\nconfidence = scoring_engine.calculate_confidence(\n    transaction=transaction,\n    context=context\n)\n\nprint(f\"Confidence: {confidence.confidence_percentage:.1f}%\")\nprint(f\"Risk Level: {confidence.risk_level.value}\")\nprint(f\"Requires Review: {confidence.requires_review}\")\n</code></pre> <p>Risk Factors and Weights:</p> Factor Weight Description Materiality 30% Amount vs. materiality threshold Pattern Deviation 25% Deviation from historical patterns Data Quality 20% Data quality and completeness Complexity 15% Transaction complexity Variance 10% Variance from budget/forecast <p>Calculation:</p> <pre><code>raw_score = 1.0 - sum(\n    risk_factor.weight * risk_factor.value\n    for risk_factor in risk_factors\n)\n\nif raw_score &gt;= 0.80:\n    risk_level = RiskLevel.GREEN\nelif raw_score &gt;= 0.50:\n    risk_level = RiskLevel.YELLOW\nelse:\n    risk_level = RiskLevel.RED\n</code></pre>"},{"location":"technical-reference/security/#risk-levels","title":"Risk Levels","text":"Level Confidence Action Sampling \ud83d\udfe2 Green \u226580% Auto-approve with post-review 5% \ud83d\udfe1 Yellow 50-79% Mandatory pre-review 100% \ud83d\udd34 Red &lt;50% Escalated multi-person review 100%"},{"location":"technical-reference/security/#mandatory-review-categories","title":"Mandatory Review Categories","text":"<pre><code>class ReviewCategory(Enum):\n    \"\"\"Categories requiring mandatory review.\"\"\"\n    PERIOD_CLOSE = \"period_close\"\n    INTERCOMPANY_ELIMINATION = \"intercompany_elimination\"\n    REGULATORY_REPORT = \"regulatory_report\"\n    EXTERNAL_COMMUNICATION = \"external_communication\"\n    MANUAL_ADJUSTMENT = \"manual_adjustment\"\n    VARIANCE_EXCEEDS_THRESHOLD = \"variance_exceeds_threshold\"\n    FIRST_TIME_TRANSACTION = \"first_time_transaction\"\n    LARGE_AMOUNT = \"large_amount\"\n</code></pre>"},{"location":"technical-reference/security/#four-eyes-principle","title":"Four-Eyes Principle","text":"<pre><code># Create review request requiring 2 reviewers\nreview_request = ReviewRequest(\n    request_id=\"review-uuid\",\n    transaction=transaction,\n    confidence_score=confidence,\n    category=ReviewCategory.PERIOD_CLOSE,\n    required_reviewers=2,\n    escalation_level=EscalationLevel.FPA_MANAGER,\n    created_at=datetime.utcnow()\n)\n\n# First reviewer\noversight.submit_review(\n    review_request_id=\"review-uuid\",\n    reviewer_id=\"reviewer_001\",\n    decision=\"approved\",\n    comments=\"Amounts reconcile correctly.\"\n)\n\n# Second reviewer (different person required)\noversight.submit_review(\n    review_request_id=\"review-uuid\",\n    reviewer_id=\"reviewer_002\",  # Must be different\n    decision=\"approved\",\n    comments=\"Second review confirmed.\"\n)\n\n# Check if complete\nis_complete = review_request.is_complete()\n</code></pre>"},{"location":"technical-reference/security/#escalation-matrix","title":"Escalation Matrix","text":"Level Role SLA Use Case 0 None - Auto-approved (green) 1 FP&amp;A Analyst 24h Yellow risk transactions 2 FP&amp;A Manager 12h Red risk, period close 3 CFO 6h Regulatory, external comms 4 Audit Committee 48h Critical issues <pre><code>class EscalationLevel(Enum):\n    \"\"\"Escalation levels for reviews.\"\"\"\n    NONE = 0\n    FPA_ANALYST = 1\n    FPA_MANAGER = 2\n    CFO = 3\n    AUDIT_COMMITTEE = 4\n</code></pre>"},{"location":"technical-reference/security/#review-workflow","title":"Review Workflow","text":"<pre><code># Get pending reviews\npending = oversight.get_pending_reviews(\n    risk_level=RiskLevel.RED\n)\n\n# Get overdue reviews\noverdue = oversight.get_overdue_reviews()\n\n# Auto-escalate overdue reviews\nfor review in overdue:\n    if review.hours_pending &gt; 24:\n        oversight.escalate_review(\n            review_request_id=review.request_id,\n            reason=\"Review overdue - escalating\"\n        )\n</code></pre>"},{"location":"technical-reference/security/#oversight-reporting","title":"Oversight Reporting","text":"<pre><code># Generate oversight report\nreport = oversight.generate_oversight_report(\n    start_date=datetime(2024, 12, 1),\n    end_date=datetime(2024, 12, 31)\n)\n\nprint(f\"Total Reviews: {report['total_reviews']}\")\nprint(f\"Approval Rate: {report['approval_rate']:.1%}\")\nprint(f\"Average Confidence: {report['average_confidence']:.1%}\")\nprint(f\"Four-Eyes Reviews: {report['four_eyes_percentage']:.1%}\")\nprint(f\"SLA Compliance: {report['sla_compliance']:.1%}\")\n</code></pre>"},{"location":"technical-reference/security/#compliance-and-governance","title":"Compliance and Governance","text":""},{"location":"technical-reference/security/#security-standards","title":"Security Standards","text":"Standard Coverage Evidence SOC 2 Type II Access controls, encryption, audit logging \u2713 ISO 27001 Information security management \u2713 IFRS Financial data integrity, retention \u2713 US GAAP Internal controls, four-eyes \u2713 NASDAQ Financial reporting controls \u2713"},{"location":"technical-reference/security/#data-classification","title":"Data Classification","text":"Level Encryption Logging Approval Examples Public Optional No No Product docs Internal Required Yes No Trial balances Confidential Required Yes No Revenue, EBITDA Restricted Required Yes Yes Customer PII, bank accounts"},{"location":"technical-reference/security/#audit-trail-retention","title":"Audit Trail Retention","text":"<p>All security events retained for 7 years:</p> <ul> <li>Permission checks and violations</li> <li>API key creation, usage, revocation</li> <li>Data access (read/write)</li> <li>Encryption key rotations</li> <li>Human review decisions</li> <li>Escalations</li> <li>Configuration changes</li> </ul>"},{"location":"technical-reference/security/#security-monitoring","title":"Security Monitoring","text":""},{"location":"technical-reference/security/#alerts","title":"Alerts","text":"<pre><code>{\n    \"alerts\": [\n        {\n            \"event\": \"multiple_failed_auth\",\n            \"threshold\": 5,\n            \"window_minutes\": 15,\n            \"severity\": \"high\"\n        },\n        {\n            \"event\": \"permission_violation\",\n            \"threshold\": 3,\n            \"window_minutes\": 60,\n            \"severity\": \"medium\"\n        },\n        {\n            \"event\": \"unusual_data_access\",\n            \"threshold\": 1,\n            \"window_minutes\": 1,\n            \"severity\": \"high\"\n        },\n        {\n            \"event\": \"encryption_failure\",\n            \"threshold\": 1,\n            \"window_minutes\": 1,\n            \"severity\": \"critical\"\n        }\n    ]\n}\n</code></pre>"},{"location":"technical-reference/security/#incident-response","title":"Incident Response","text":"<ol> <li>Detection - Automated alert triggered</li> <li>Containment - Revoke compromised credentials</li> <li>Investigation - Review audit logs</li> <li>Remediation - Apply fixes and patches</li> <li>Documentation - Document incident</li> <li>Post-Mortem - Review and improve</li> </ol>"},{"location":"technical-reference/security/#see-also","title":"See Also","text":"<ul> <li>Database Schema</li> <li>API Reference</li> <li>Configuration Reference</li> </ul>"},{"location":"user-guide/consolidation/","title":"Consolidation Workflow","text":""},{"location":"user-guide/consolidation/#overview","title":"Overview","text":"<p>The consolidation process transforms trial balances from 7 portfolio companies (in BRL) into a single consolidated financial statement (in USD) compliant with IFRS and US GAAP standards.</p> <p>Consolidation Components: 1. Multi-currency FX conversion 2. Intercompany elimination 3. Purchase Price Allocation (PPA) amortization 4. IFRS/US GAAP reconciliation 5. Comprehensive validation</p> <p>Target Accuracy: 99.9% Processing Time: 10-15 minutes for 7 companies</p>"},{"location":"user-guide/consolidation/#consolidation-architecture","title":"Consolidation Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  CONSOLIDATION ENGINE                        \u2502\n\u2502                                                               \u2502\n\u2502  INPUT                                                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502 Effecti  \u2502  \u2502  Mercos  \u2502  \u2502 Datahub  \u2502  \u2502  Others  \u2502    \u2502\n\u2502  \u2502  (BRL)   \u2502  \u2502  (BRL)   \u2502  \u2502  (BRL)   \u2502  \u2502  (BRL)   \u2502    \u2502\n\u2502  \u2502 1,248 LE \u2502  \u2502 1,089 LE \u2502  \u2502 1,201 LE \u2502  \u2502 3,479 LE \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502       \u2502             \u2502              \u2502             \u2502           \u2502\n\u2502       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                          \u2502                                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502  \u2502  STEP 1: FX CONVERSION (IFRS 21 / ASC 830)      \u2502         \u2502\n\u2502  \u2502  - Balance Sheet: Closing rate (0.1895)         \u2502         \u2502\n\u2502  \u2502  - P&amp;L: Average rate (0.1872)                   \u2502         \u2502\n\u2502  \u2502  - Equity: Historical rate                      \u2502         \u2502\n\u2502  \u2502  - CTA Calculation                              \u2502         \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502                          \u2502                                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502  \u2502  STEP 2: INTERCOMPANY ELIMINATION               \u2502         \u2502\n\u2502  \u2502  - Match IC Receivables/Payables                \u2502         \u2502\n\u2502  \u2502  - Match IC Revenue/Expense                     \u2502         \u2502\n\u2502  \u2502  - Eliminate dividends                          \u2502         \u2502\n\u2502  \u2502  - FX Gain/Loss recognition                     \u2502         \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502                          \u2502                                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502  \u2502  STEP 3: PPA AMORTIZATION                       \u2502         \u2502\n\u2502  \u2502  - Goodwill tracking                            \u2502         \u2502\n\u2502  \u2502  - Intangible amortization                      \u2502         \u2502\n\u2502  \u2502  - Impairment testing                           \u2502         \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502                          \u2502                                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u2502\n\u2502  \u2502  STEP 4: VALIDATION                             \u2502         \u2502\n\u2502  \u2502  - Balance sheet balance                        \u2502         \u2502\n\u2502  \u2502  - Debit/credit equality                        \u2502         \u2502\n\u2502  \u2502  - Net income reconciliation                    \u2502         \u2502\n\u2502  \u2502  - Reasonableness checks                        \u2502         \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2502\n\u2502                          \u2502                                    \u2502\n\u2502  OUTPUT: Consolidated Financials (USD)                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u2502\n\u2502  \u2502 Assets:       USD 28,450,000                 \u2502            \u2502\n\u2502  \u2502 Liabilities:  USD 15,230,000                 \u2502            \u2502\n\u2502  \u2502 Equity:       USD 13,220,000                 \u2502            \u2502\n\u2502  \u2502 Revenue:      USD  3,625,000                 \u2502            \u2502\n\u2502  \u2502 Expenses:     USD  2,810,000                 \u2502            \u2502\n\u2502  \u2502 Net Income:   USD    815,000                 \u2502            \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"user-guide/consolidation/#step-1-fx-conversion","title":"Step 1: FX Conversion","text":""},{"location":"user-guide/consolidation/#overview_1","title":"Overview","text":"<p>All portfolio companies use Brazilian Real (BRL) as their functional currency. Consolidation requires conversion to USD presentation currency following IFRS 21 (IAS 21) and ASC 830.</p>"},{"location":"user-guide/consolidation/#fx-rate-types","title":"FX Rate Types","text":"Rate Type Used For Source Example Closing Balance sheet items BCB PTAX end-of-period 0.1895 Average P&amp;L items BCB PTAX monthly average 0.1872 Historical Equity items, Acquired assets BCB PTAX at transaction date 0.1850"},{"location":"user-guide/consolidation/#fx-conversion-rules","title":"FX Conversion Rules","text":""},{"location":"user-guide/consolidation/#balance-sheet-items","title":"Balance Sheet Items","text":"<p>Assets and Liabilities use closing rate at period end:</p> <pre><code># Example: Cash balance\ncash_brl = Decimal(\"500000\")          # BRL 500,000\nclosing_rate = Decimal(\"0.1895\")      # 1 BRL = 0.1895 USD\ncash_usd = cash_brl * closing_rate    # USD 94,750\n</code></pre> <p>Equity Items use historical rate at transaction date:</p> <pre><code># Example: Capital stock (issued Aug 1, 2023)\ncapital_brl = Decimal(\"10000000\")     # BRL 10,000,000\nhistorical_rate = Decimal(\"0.1850\")   # Rate on Aug 1, 2023\ncapital_usd = capital_brl * historical_rate  # USD 1,850,000\n</code></pre>"},{"location":"user-guide/consolidation/#pl-items","title":"P&amp;L Items","text":"<p>Revenue and Expenses use average rate for the period:</p> <pre><code># Example: Monthly revenue\nrevenue_brl = Decimal(\"1500000\")      # BRL 1,500,000\naverage_rate = Decimal(\"0.1872\")      # Jan 2026 average\nrevenue_usd = revenue_brl * average_rate  # USD 280,800\n</code></pre>"},{"location":"user-guide/consolidation/#cumulative-translation-adjustment-cta","title":"Cumulative Translation Adjustment (CTA)","text":"<p>The difference between closing rate translation and historical rate translation creates a Cumulative Translation Adjustment in equity.</p> <p>CTA Calculation:</p> <pre><code># Balance sheet translated at closing rate\nassets_closing = total_assets_brl * closing_rate\nliabilities_closing = total_liabilities_brl * closing_rate\nequity_closing = assets_closing - liabilities_closing\n\n# Equity at historical rates + retained earnings\nequity_historical = capital_stock_historical + retained_earnings_historical\n\n# CTA is the plug\ncta = equity_closing - equity_historical\n</code></pre> <p>Example:</p> <pre><code>Assets (BRL 50M \u00d7 0.1895):           USD 9,475,000\nLiabilities (BRL 30M \u00d7 0.1895):      USD 5,685,000\nNet Assets at Closing:               USD 3,790,000\n\nCapital Stock (BRL 10M \u00d7 0.1850):    USD 1,850,000\nRetained Earnings (historical):      USD 1,800,000\nTotal Historical Equity:             USD 3,650,000\n\nCTA (plug):                          USD   140,000\n</code></pre> <p>The CTA of USD 140,000 represents unrealized FX gain from BRL appreciation.</p>"},{"location":"user-guide/consolidation/#fx-rate-management","title":"FX Rate Management","text":""},{"location":"user-guide/consolidation/#loading-fx-rates","title":"Loading FX Rates","text":"<pre><code># Load BCB PTAX rates automatically\npython -m src.fx.load_rates \\\n  --source bcb_ptax \\\n  --date \"2026-01-31\" \\\n  --rate-type closing\n\npython -m src.fx.load_rates \\\n  --source bcb_ptax \\\n  --period \"2026-01-01:2026-01-31\" \\\n  --rate-type average\n</code></pre>"},{"location":"user-guide/consolidation/#manual-fx-rate-entry","title":"Manual FX Rate Entry","text":"<p>If automatic loading fails:</p> <pre><code>from src.consolidation import FXRateManager, FXRate, Currency, FXRateType\nfrom datetime import date\nfrom decimal import Decimal\n\nfx_manager = FXRateManager()\n\n# Add closing rate\nfx_manager.add_rate(FXRate(\n    from_currency=Currency.BRL,\n    to_currency=Currency.USD,\n    rate_date=date(2026, 1, 31),\n    rate_type=FXRateType.CLOSING,\n    rate=Decimal(\"0.1895\"),\n    source=\"BCB PTAX 31-Jan-2026\"\n))\n\n# Add average rate\nfx_manager.add_rate(FXRate(\n    from_currency=Currency.BRL,\n    to_currency=Currency.USD,\n    rate_date=date(2026, 1, 31),\n    rate_type=FXRateType.AVERAGE,\n    rate=Decimal(\"0.1872\"),\n    source=\"BCB PTAX Jan 2026 Average\"\n))\n</code></pre>"},{"location":"user-guide/consolidation/#verify-fx-rates","title":"Verify FX Rates","text":"<pre><code># List loaded rates\npython -m src.fx.list_rates --period \"2026-01\"\n\n# Expected output:\n# Date       Type     From  To   Rate     Source\n# 2026-01-31 CLOSING  BRL   USD  0.1895   BCB PTAX\n# 2026-01-31 AVERAGE  BRL   USD  0.1872   BCB PTAX (avg)\n</code></pre>"},{"location":"user-guide/consolidation/#step-2-intercompany-elimination","title":"Step 2: Intercompany Elimination","text":""},{"location":"user-guide/consolidation/#overview_2","title":"Overview","text":"<p>Intercompany (IC) transactions between portfolio companies must be eliminated to avoid double-counting in consolidated financials.</p> <p>Elimination Categories: 1. IC Receivables/Payables 2. IC Revenue/Expense 3. IC Dividends 4. IC Equity Investments</p>"},{"location":"user-guide/consolidation/#ic-receivablespayables-elimination","title":"IC Receivables/Payables Elimination","text":"<p>Matching Algorithm:</p> <ol> <li>Identify IC accounts using account code prefixes (e.g., 1.02.005 = IC Receivable)</li> <li>Match by reference number (invoice number, transaction ID)</li> <li>Match by amount within FX tolerance (default 1%)</li> <li>Verify entity relationship (legal entity parent/subsidiary structure)</li> </ol> <p>Example:</p> <pre><code>Company A (Effecti):\n  Account: 1.02.005 - IC Receivable from Mercos\n  Amount: BRL 100,000 (USD 18,950 @ 0.1895)\n  Reference: INV-2026-0123\n  Date: 2026-01-15\n\nCompany B (Mercos):\n  Account: 2.02.003 - IC Payable to Effecti\n  Amount: BRL 100,000 (USD 18,950 @ 0.1895)\n  Reference: INV-2026-0123\n  Date: 2026-01-15\n\nMatch: \u2713 Reference matches, amounts match exactly\n\nElimination Journal Entry:\n  DR: IC Payable (Mercos)         USD 18,950\n  CR: IC Receivable (Effecti)     USD 18,950\n  Memo: Eliminate IC invoice INV-2026-0123\n</code></pre>"},{"location":"user-guide/consolidation/#fx-tolerance-matching","title":"FX Tolerance Matching","text":"<p>Due to FX rate differences (transaction date vs. period end), amounts may not match exactly.</p> <p>Example with FX difference:</p> <pre><code>Company A (Effecti):\n  IC Receivable: BRL 100,000\n  Booked at: 0.1880 (Jan 15 rate)\n  Balance: USD 18,800\n\nCompany B (Mercos):\n  IC Payable: BRL 100,000\n  Booked at: 0.1885 (Jan 16 rate)\n  Balance: USD 18,850\n\nDifference: USD 50 (0.27% variance - within 1% tolerance)\n\nElimination Entry:\n  DR: IC Payable (Mercos)         USD 18,850\n  CR: IC Receivable (Effecti)     USD 18,800\n  CR: FX Gain/Loss                USD     50\n  Memo: Eliminate IC + recognize FX difference\n</code></pre>"},{"location":"user-guide/consolidation/#ic-revenueexpense-elimination","title":"IC Revenue/Expense Elimination","text":"<p>Example: Software License</p> <pre><code>Company A (Effecti) - SaaS Provider:\n  IC Revenue: BRL 50,000 (USD 9,360 @ avg rate 0.1872)\n  Customer: Mercos (internal)\n  Service: Platform License\n\nCompany B (Mercos):\n  IC Expense: BRL 50,000 (USD 9,360 @ avg rate 0.1872)\n  Vendor: Effecti (internal)\n  Category: Software Expense\n\nElimination Entry:\n  DR: IC Revenue (Effecti)        USD 9,360\n  CR: IC Expense (Mercos)         USD 9,360\n  Memo: Eliminate internal software license\n</code></pre>"},{"location":"user-guide/consolidation/#ic-dividend-elimination","title":"IC Dividend Elimination","text":"<p>Dividends paid between portfolio companies are eliminated:</p> <pre><code>Company A (Leadlovers):\n  Dividend Paid: BRL 200,000 (USD 37,440 @ avg rate 0.1872)\n  To: Nuvini Group Limited (parent)\n\nParent (Nuvini Group):\n  Dividend Income: USD 37,440\n  From: Leadlovers\n\nElimination Entry:\n  DR: Dividend Income (Parent)    USD 37,440\n  CR: Dividend Expense (Sub)      USD 37,440\n  Memo: Eliminate intra-group dividend\n</code></pre>"},{"location":"user-guide/consolidation/#viewing-elimination-report","title":"Viewing Elimination Report","text":"<pre><code># Generate IC elimination report\npython -m src.reporting.eliminations \\\n  --period \"2026-01-31\" \\\n  --output eliminations_report.xlsx\n\n# Summary statistics\npython -m src.cli.eliminations_summary \\\n  --period \"2026-01-31\"\n</code></pre> <p>Example output:</p> <pre><code>Intercompany Elimination Summary - January 2026\n\nCategory              Matches   Amount (USD)   Unmatched\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nReceivables/Payables     45      1,847,500        2\nRevenue/Expense          38        485,000         1\nDividends                 3        125,000         0\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nTotal                    86      2,457,500         3\n\nUnmatched Items Requiring Review:\n1. Effecti IC Receivable USD 12,500 (no matching payable)\n2. Mercos IC Expense USD 8,400 (no matching revenue)\n3. Datahub IC Payable USD 5,200 (amount mismatch 8.5%)\n</code></pre>"},{"location":"user-guide/consolidation/#handling-unmatched-items","title":"Handling Unmatched Items","text":"<p>Scenario 1: Timing Difference</p> <p>IC transaction recorded in one entity but not the other (accrual vs. cash basis).</p> <p>Solution: Accept as unmatched, will reconcile in next period.</p> <p>Scenario 2: Amount Mismatch &gt; Tolerance</p> <p>FX difference exceeds 1% tolerance or incorrect amount.</p> <p>Solution: 1. Investigate root cause 2. Create adjustment entry to reconcile 3. Escalate to CFO if material</p> <p>Scenario 3: Missing Transaction</p> <p>IC transaction recorded in one entity, no evidence in counterparty.</p> <p>Solution: 1. Verify with entity finance teams 2. Create manual adjustment if confirmed error 3. Update ERP data if necessary</p>"},{"location":"user-guide/consolidation/#step-3-ppa-amortization","title":"Step 3: PPA Amortization","text":""},{"location":"user-guide/consolidation/#overview_3","title":"Overview","text":"<p>For acquired portfolio companies, Purchase Price Allocation (PPA) amortization must be recorded monthly in consolidated financials.</p>"},{"location":"user-guide/consolidation/#ppa-components","title":"PPA Components","text":"<p>Example: Leadlovers (acquired August 2023)</p> <pre><code>Purchase Price:                      USD 15,000,000\nFair Value of Net Assets:            USD  8,000,000\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nExcess Purchase Price:               USD  7,000,000\n\nAllocation:\n  Customer Relationships (8 years)   USD  4,000,000\n  SaaS Platform Tech (5 years)       USD  2,000,000\n  Brand (10 years)                   USD    500,000\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Identified Intangibles:            USD  6,500,000\n\n  Goodwill (not amortized):          USD    500,000\n</code></pre>"},{"location":"user-guide/consolidation/#monthly-amortization-calculation","title":"Monthly Amortization Calculation","text":"<p>Customer Relationships: <pre><code>Cost: USD 4,000,000\nLife: 8 years (96 months)\nMonthly Amortization: USD 4,000,000 / 96 = USD 41,667\n</code></pre></p> <p>SaaS Platform Technology: <pre><code>Cost: USD 2,000,000\nLife: 5 years (60 months)\nMonthly Amortization: USD 2,000,000 / 60 = USD 33,333\n</code></pre></p> <p>Brand: <pre><code>Cost: USD 500,000\nLife: 10 years (120 months)\nMonthly Amortization: USD 500,000 / 120 = USD 4,167\n</code></pre></p> <p>Total Monthly PPA Amortization: USD 79,167</p>"},{"location":"user-guide/consolidation/#ppa-journal-entry","title":"PPA Journal Entry","text":"<pre><code>Journal Entry: JE-PPA-LEADLOVERS-2026-01\nDate: 2026-01-31\nType: PPA Amortization\n\nDR: Amortization Expense - Customer Relationships   USD 41,667\nDR: Amortization Expense - Technology               USD 33,333\nDR: Amortization Expense - Brand                    USD  4,167\nCR: Accumulated Amortization - Customer Rel.        USD 41,667\nCR: Accumulated Amortization - Technology           USD 33,333\nCR: Accumulated Amortization - Brand                USD  4,167\n\nMemo: Monthly PPA amortization for Leadlovers acquisition\n</code></pre>"},{"location":"user-guide/consolidation/#goodwill-impairment-testing","title":"Goodwill Impairment Testing","text":"<p>Frequency: Annual (December) or when impairment indicators exist</p> <p>Qualitative Indicators: - Significant adverse change in business climate - Adverse financial performance - Increased competition - Loss of key personnel - Legal or regulatory changes</p> <p>Quantitative Test:</p> <p>Compare carrying amount to recoverable amount:</p> <pre><code>Goodwill Carrying Amount:    USD 500,000\nRecoverable Amount:          USD 450,000 (from valuation)\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nImpairment Loss:            USD  50,000\n\nImpairment Journal Entry:\n  DR: Goodwill Impairment Loss    USD 50,000\n  CR: Goodwill                    USD 50,000\n</code></pre>"},{"location":"user-guide/consolidation/#view-ppa-schedule","title":"View PPA Schedule","text":"<pre><code># View PPA amortization schedule\npython -m src.ppa.schedule \\\n  --entity leadlovers \\\n  --output leadlovers_ppa.xlsx\n\n# Get monthly PPA entries\npython -m src.ppa.monthly_entries \\\n  --period \"2026-01-31\"\n</code></pre>"},{"location":"user-guide/consolidation/#step-4-validation","title":"Step 4: Validation","text":""},{"location":"user-guide/consolidation/#validation-rules","title":"Validation Rules","text":"<p>The consolidation engine runs comprehensive validation to ensure 99.9% accuracy:</p>"},{"location":"user-guide/consolidation/#1-balance-sheet-balance","title":"1. Balance Sheet Balance","text":"<p>Rule: Assets = Liabilities + Equity (\u00b1$0.01)</p> <pre><code>assets = sum(accounts where account_type == ASSET)\nliabilities = sum(accounts where account_type == LIABILITY)\nequity = sum(accounts where account_type == EQUITY)\n\ndifference = assets - (liabilities + equity)\n\nif abs(difference) &gt; 0.01:\n    FAIL: \"Balance sheet doesn't balance: ${difference}\"\n</code></pre>"},{"location":"user-guide/consolidation/#2-debitcredit-equality","title":"2. Debit/Credit Equality","text":"<p>Rule: Total Debits = Total Credits (\u00b1$0.01)</p> <pre><code>total_debits = sum(entry.debit_amount for all entries)\ntotal_credits = sum(entry.credit_amount for all entries)\n\ndifference = total_debits - total_credits\n\nif abs(difference) &gt; 0.01:\n    FAIL: \"Debits don't equal credits: ${difference}\"\n</code></pre>"},{"location":"user-guide/consolidation/#3-net-income-reconciliation","title":"3. Net Income Reconciliation","text":"<p>Rule: Net Income = Revenue - Expenses</p> <pre><code>revenue = sum(accounts where account_type == REVENUE)\nexpenses = sum(accounts where account_type == EXPENSE)\nnet_income_calculated = revenue - expenses\n\nnet_income_reported = get_account(\"3.05.001\")  # Retained Earnings change\n\ndifference = net_income_calculated - net_income_reported\n\nif abs(difference) &gt; 0.01:\n    FAIL: \"Net income doesn't reconcile: ${difference}\"\n</code></pre>"},{"location":"user-guide/consolidation/#4-fx-rate-consistency","title":"4. FX Rate Consistency","text":"<p>Rule: All entities use same FX rates for period</p> <pre><code>for entity in entities:\n    closing_rate = get_fx_rate(entity.currency, USD, CLOSING, period_end)\n    if closing_rate != expected_closing_rate:\n        WARN: \"Entity {entity} using different closing rate\"\n</code></pre>"},{"location":"user-guide/consolidation/#5-elimination-completeness","title":"5. Elimination Completeness","text":"<p>Rule: All IC transactions matched (within tolerance)</p> <pre><code>unmatched_ic = get_unmatched_intercompany_items()\n\nif len(unmatched_ic) &gt; 0:\n    WARN: f\"{len(unmatched_ic)} unmatched IC items\"\n\nif sum(unmatched_ic.amounts) &gt; materiality_threshold:\n    FAIL: \"Material unmatched IC transactions\"\n</code></pre>"},{"location":"user-guide/consolidation/#6-reasonableness-checks","title":"6. Reasonableness Checks","text":"<p>Cash Balance: <pre><code>if cash_balance &lt; 0:\n    ERROR: \"Negative cash balance\"\n\nif cash_balance &gt; total_assets * 0.50:\n    WARN: \"Cash &gt; 50% of assets (unusual)\"\n</code></pre></p> <p>Revenue Growth: <pre><code>revenue_growth = (current_revenue - prior_revenue) / prior_revenue\n\nif revenue_growth &gt; 0.50:\n    WARN: \"Revenue grew &gt;50% MoM (verify)\"\n\nif revenue_growth &lt; -0.30:\n    WARN: \"Revenue declined &gt;30% MoM (verify)\"\n</code></pre></p>"},{"location":"user-guide/consolidation/#validation-report","title":"Validation Report","text":"<pre><code># Generate validation report\npython -m src.reporting.validation_report \\\n  --period \"2026-01-31\" \\\n  --output validation.html\n</code></pre> <p>Example validation results:</p> <pre><code>Consolidation Validation Report\nPeriod: January 2026\n\nPASS \u2713  Balance Sheet Balance\n        Assets: USD 28,450,123.45\n        Liabilities + Equity: USD 28,450,123.45\n        Difference: USD 0.00\n\nPASS \u2713  Debit/Credit Equality\n        Total Debits: USD 35,678,234.56\n        Total Credits: USD 35,678,234.56\n        Difference: USD 0.00\n\nPASS \u2713  Net Income Reconciliation\n        Revenue: USD 3,625,000.00\n        Expenses: USD 2,810,000.00\n        Net Income (calculated): USD 815,000.00\n        Net Income (reported): USD 815,000.00\n        Difference: USD 0.00\n\nPASS \u2713  FX Rate Consistency\n        All entities using BRL/USD 0.1895 (closing)\n        All entities using BRL/USD 0.1872 (average)\n\nWARN \u26a0  Elimination Completeness\n        86 IC transactions matched\n        3 IC transactions unmatched (USD 26,100)\n        Below materiality threshold (USD 500,000)\n\nPASS \u2713  Reasonableness - Cash Balance\n        Cash: USD 2,450,000 (8.6% of assets)\n        Within normal range\n\nWARN \u26a0  Reasonableness - Revenue Growth\n        Current: USD 3,625,000\n        Prior: USD 3,450,000\n        Growth: +5.1% (normal)\n\nOverall Score: 99.94% (Target: 99.9%)\nStatus: \u2713 PASS\n</code></pre>"},{"location":"user-guide/consolidation/#consolidation-commands","title":"Consolidation Commands","text":""},{"location":"user-guide/consolidation/#quick-consolidation","title":"Quick Consolidation","text":"<pre><code># Run full consolidation\npython -m src.consolidation.run \\\n  --period-end \"2026-01-31\" \\\n  --period-start \"2026-01-01\" \\\n  --presentation-currency USD \\\n  --output consolidated_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/consolidation/#step-by-step-consolidation","title":"Step-by-Step Consolidation","text":"<pre><code># Step 1: FX Conversion\npython -m src.consolidation.fx_convert \\\n  --period \"2026-01-31\" \\\n  --closing-rate 0.1895 \\\n  --average-rate 0.1872\n\n# Step 2: Intercompany Elimination\npython -m src.consolidation.eliminate \\\n  --period \"2026-01-31\" \\\n  --tolerance 0.01\n\n# Step 3: PPA Amortization\npython -m src.consolidation.ppa_amortize \\\n  --period \"2026-01-31\"\n\n# Step 4: Aggregate &amp; Validate\npython -m src.consolidation.aggregate \\\n  --period \"2026-01-31\" \\\n  --validate\n</code></pre>"},{"location":"user-guide/consolidation/#view-consolidation-results","title":"View Consolidation Results","text":"<pre><code># Consolidated trial balance\npython -m src.cli.consolidated_tb \\\n  --period \"2026-01-31\" \\\n  --format excel\n\n# Consolidation journal entries\npython -m src.cli.consolidation_journal \\\n  --period \"2026-01-31\" \\\n  --type all\n\n# Audit trail\npython -m src.cli.audit_trail \\\n  --period \"2026-01-31\" \\\n  --filter consolidation\n</code></pre>"},{"location":"user-guide/consolidation/#troubleshooting","title":"Troubleshooting","text":""},{"location":"user-guide/consolidation/#issue-balance-sheet-doesnt-balance","title":"Issue: Balance Sheet Doesn't Balance","text":"<p>Symptom: Validation fails with \"Assets \u2260 Liabilities + Equity\"</p> <p>Diagnostic steps:</p> <ol> <li>Check if all entities extracted successfully</li> <li>Verify FX conversion completed for all entities</li> <li>Review elimination entries for errors</li> <li>Check for missing PPA entries</li> </ol> <pre><code># Run diagnostic\npython -m src.consolidation.diagnose \\\n  --period \"2026-01-31\" \\\n  --issue balance_sheet\n</code></pre>"},{"location":"user-guide/consolidation/#issue-large-unmatched-ic-transactions","title":"Issue: Large Unmatched IC Transactions","text":"<p>Symptom: Many IC transactions not eliminated</p> <p>Solutions:</p> <ol> <li> <p>Check tolerance setting: <pre><code># Increase FX tolerance to 2%\npython -m src.consolidation.eliminate \\\n  --period \"2026-01-31\" \\\n  --tolerance 0.02\n</code></pre></p> </li> <li> <p>Review matching logic: <pre><code># View unmatched IC items\npython -m src.cli.unmatched_ic \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Manual reconciliation: <pre><code># Create manual elimination entry\npython -m src.journal.create_entry \\\n  --type ic_elimination \\\n  --debit \"2.02.003:18500\" \\\n  --credit \"1.02.005:18500\" \\\n  --memo \"Manual IC elimination - timing difference\"\n</code></pre></p> </li> </ol>"},{"location":"user-guide/consolidation/#issue-cta-variance","title":"Issue: CTA Variance","text":"<p>Symptom: CTA amount different from expected</p> <p>Diagnostic:</p> <ol> <li>Verify historical rates loaded correctly</li> <li>Check retained earnings balance</li> <li>Review prior period CTA</li> </ol> <pre><code># CTA reconciliation report\npython -m src.fx.cta_reconciliation \\\n  --period \"2026-01-31\"\n</code></pre>"},{"location":"user-guide/consolidation/#best-practices","title":"Best Practices","text":"<ol> <li>Load FX Rates Early: Load rates immediately after month-end</li> <li>Validate Entity Data: Ensure all trial balances balance before consolidation</li> <li>Review Eliminations: Always review unmatched IC items</li> <li>Document Adjustments: All manual entries need detailed memos</li> <li>Archive Results: Save consolidated trial balance before making changes</li> <li>Run Validation: Always run full validation before closing period</li> </ol>"},{"location":"user-guide/consolidation/#next-steps","title":"Next Steps","text":"<ul> <li>Monthly Close Process - Full monthly close workflow</li> <li>Human Review Guide - Review and approval process</li> <li>Reports Guide - Generate consolidated reports</li> </ul> <p>Last Updated: February 7, 2026 Version: 1.0.0</p>"},{"location":"user-guide/erp-integration/","title":"ERP Integration Guide","text":""},{"location":"user-guide/erp-integration/#overview","title":"Overview","text":"<p>The AI FP&amp;A system connects to four different Brazilian ERP systems used across the portfolio companies. This guide covers configuration, authentication, data extraction, and troubleshooting for each ERP connector.</p>"},{"location":"user-guide/erp-integration/#supported-erp-systems","title":"Supported ERP Systems","text":"ERP System Companies Auth Type Rate Limit API Version TOTVS Protheus Effecti, OnClick OAuth 2.0 100/min REST API ContaAzul Mercos, Munddi OAuth 2.0 60/min v1 Omie Datahub API Key 300/min v1 Bling Ip\u00ea Digital, Leadlovers API Key / OAuth 2.0 100/min v3 (JSON)"},{"location":"user-guide/erp-integration/#architecture","title":"Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  ERP Connector Framework                 \u2502\n\u2502                                                           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502 Base Class   \u2502  \u2502 Auth Handler \u2502  \u2502 Rate Limiter \u2502  \u2502\n\u2502  \u2502 ERPConnector \u2502  \u2502 - OAuth 2.0  \u2502  \u2502 - Token      \u2502  \u2502\n\u2502  \u2502              \u2502  \u2502 - API Key    \u2502  \u2502   Bucket     \u2502  \u2502\n\u2502  \u2502 - connect()  \u2502  \u2502 - Bearer     \u2502  \u2502 - Circuit    \u2502  \u2502\n\u2502  \u2502 - get_tb()   \u2502  \u2502              \u2502  \u2502   Breaker    \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502         \u2191                                                \u2502\n\u2502         \u2502                                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502   TOTVS   \u2502  ContaAzul  \u2502   Omie   \u2502   Bling    \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"user-guide/erp-integration/#quick-start","title":"Quick Start","text":""},{"location":"user-guide/erp-integration/#install-dependencies","title":"Install Dependencies","text":"<pre><code>cd /Volumes/AI/Code/FPA\npip install httpx pydantic python-dotenv\n</code></pre>"},{"location":"user-guide/erp-integration/#configure-credentials","title":"Configure Credentials","text":"<p>Create a <code>.env</code> file:</p> <pre><code># TOTVS Protheus (Effecti)\nTOTVS_EFFECTI_CLIENT_ID=your_client_id\nTOTVS_EFFECTI_CLIENT_SECRET=your_client_secret\nTOTVS_EFFECTI_TENANT=effecti_tenant_id\nTOTVS_EFFECTI_BASE_URL=https://api.totvs.com.br\n\n# ContaAzul (Mercos)\nCONTAAZUL_MERCOS_CLIENT_ID=your_client_id\nCONTAAZUL_MERCOS_CLIENT_SECRET=your_client_secret\nCONTAAZUL_MERCOS_BASE_URL=https://api.contaazul.com\n\n# Omie (Datahub)\nOMIE_DATAHUB_APP_KEY=your_app_key\nOMIE_DATAHUB_APP_SECRET=your_app_secret\nOMIE_DATAHUB_BASE_URL=https://app.omie.com.br/api/v1\n\n# Bling (Leadlovers)\nBLING_LEADLOVERS_API_KEY=your_api_key\nBLING_LEADLOVERS_BASE_URL=https://api.bling.com.br/Api/v3\n</code></pre> <p>Security: Never commit <code>.env</code> file to git. Use AWS Secrets Manager in production.</p>"},{"location":"user-guide/erp-integration/#test-connection","title":"Test Connection","text":"<pre><code># Test TOTVS connection\npython -m src.connectors.test \\\n  --erp totvs_protheus \\\n  --company effecti\n\n# Test all connections\npython -m src.connectors.health_check --all\n</code></pre>"},{"location":"user-guide/erp-integration/#erp-specific-configuration","title":"ERP-Specific Configuration","text":""},{"location":"user-guide/erp-integration/#totvs-protheus","title":"TOTVS Protheus","text":"<p>Used by: Effecti, OnClick</p>"},{"location":"user-guide/erp-integration/#authentication-setup","title":"Authentication Setup","text":"<ol> <li>Register OAuth Application in TOTVS Developer Portal</li> <li>Configure Redirect URI: <code>https://your-app.com/callback/totvs</code></li> <li>Copy Client ID and Secret to <code>.env</code></li> </ol>"},{"location":"user-guide/erp-integration/#configuration","title":"Configuration","text":"<pre><code>from src.connectors import create_connector\n\nconnector = create_connector(\n    erp_type=\"totvs_protheus\",\n    auth_type=\"oauth2\",\n    credentials={\n        \"client_id\": \"your_client_id\",\n        \"client_secret\": \"your_client_secret\"\n    },\n    config={\n        \"base_url\": \"https://api.totvs.com.br\",\n        \"tenant\": \"your_tenant_id\",\n        \"environment\": \"PRODUCAO\",  # or \"HOMOLOGACAO\"\n        \"timeout\": 60.0,\n        \"retry_attempts\": 3\n    }\n)\n\n# Use async context manager\nasync with connector:\n    # Get companies\n    companies = await connector.get_companies()\n\n    # Get trial balance\n    trial_balance = await connector.get_trial_balance(\n        company_id=\"01\",\n        period_start=datetime(2026, 1, 1),\n        period_end=datetime(2026, 1, 31)\n    )\n</code></pre>"},{"location":"user-guide/erp-integration/#api-endpoints-used","title":"API Endpoints Used","text":"Endpoint Purpose Method <code>/api/v1/companies</code> List companies GET <code>/api/v1/financials/trial-balance</code> Get trial balance GET <code>/api/v1/financials/subledger</code> Get subledger details GET <code>/api/v1/health</code> Health check GET"},{"location":"user-guide/erp-integration/#data-mapping","title":"Data Mapping","text":"<p>TOTVS uses standard Brazilian COA:</p> TOTVS Account Type FPA Account Type Example ATIVO ASSET 1.01.001 - Caixa PASSIVO LIABILITY 2.01.001 - Fornecedores PATRIMONIO EQUITY 3.01.001 - Capital Social RECEITA REVENUE 4.01.001 - Receita de Servi\u00e7os DESPESA EXPENSE 5.01.001 - Sal\u00e1rios"},{"location":"user-guide/erp-integration/#rate-limits","title":"Rate Limits","text":"<ul> <li>Limit: 100 requests per minute</li> <li>Handling: Automatic retry with exponential backoff</li> <li>Circuit Breaker: Opens after 5 consecutive failures</li> </ul>"},{"location":"user-guide/erp-integration/#troubleshooting","title":"Troubleshooting","text":"<p>Issue: OAuth token expired</p> <pre><code># Force token refresh\npython -m src.connectors.refresh_token \\\n  --erp totvs_protheus \\\n  --company effecti\n</code></pre> <p>Issue: Timeout during trial balance extraction</p> <pre><code># Increase timeout\npython -m src.connectors.extract \\\n  --company effecti \\\n  --timeout 300 \\\n  --retry 5\n</code></pre> <p>Issue: API returns 500 Internal Server Error</p> <p>Common cause: TOTVS server maintenance window</p> <p>Solution: 1. Check TOTVS status page: https://status.totvs.com.br 2. Retry after maintenance window 3. If persistent, contact TOTVS support</p>"},{"location":"user-guide/erp-integration/#contaazul","title":"ContaAzul","text":"<p>Used by: Mercos, Munddi</p>"},{"location":"user-guide/erp-integration/#authentication-setup_1","title":"Authentication Setup","text":"<ol> <li>Create Developer Account at https://developers.contaazul.com</li> <li>Create App and get Client ID/Secret</li> <li>Configure OAuth Redirect: <code>https://your-app.com/callback/contaazul</code></li> <li>Request Scopes: <code>sales</code>, <code>financials</code>, <code>companies</code></li> </ol>"},{"location":"user-guide/erp-integration/#configuration_1","title":"Configuration","text":"<pre><code>connector = create_connector(\n    erp_type=\"contaazul\",\n    auth_type=\"oauth2\",\n    credentials={\n        \"client_id\": \"your_client_id\",\n        \"client_secret\": \"your_client_secret\"\n    },\n    config={\n        \"base_url\": \"https://api.contaazul.com\",\n        \"api_version\": \"v1\",\n        \"timeout\": 60.0\n    }\n)\n\nasync with connector:\n    # ContaAzul doesn't have direct trial balance endpoint\n    # Connector aggregates from transactions\n    trial_balance = await connector.get_trial_balance(\n        company_id=\"mercos_001\",\n        period_start=datetime(2026, 1, 1),\n        period_end=datetime(2026, 1, 31)\n    )\n</code></pre>"},{"location":"user-guide/erp-integration/#api-endpoints-used_1","title":"API Endpoints Used","text":"Endpoint Purpose Method <code>/v1/companies</code> List companies GET <code>/v1/transactions</code> Get financial transactions GET <code>/v1/accounts</code> Get chart of accounts GET <code>/v1/categories</code> Get transaction categories GET"},{"location":"user-guide/erp-integration/#data-aggregation","title":"Data Aggregation","text":"<p>ContaAzul doesn't provide trial balance directly. The connector:</p> <ol> <li>Fetches all transactions for the period</li> <li>Groups by account code from chart of accounts</li> <li>Calculates opening/closing balances from transaction history</li> <li>Generates trial balance in standard format</li> </ol> <p>Note: First-time extraction may take longer due to historical data aggregation.</p>"},{"location":"user-guide/erp-integration/#rate-limits_1","title":"Rate Limits","text":"<ul> <li>Limit: 60 requests per minute</li> <li>Pagination: 100 transactions per request</li> <li>Recommended: Schedule extractions during off-peak hours</li> </ul>"},{"location":"user-guide/erp-integration/#troubleshooting_1","title":"Troubleshooting","text":"<p>Issue: Missing account codes</p> <p>ContaAzul allows users to categorize without account codes.</p> <p>Solution: <pre><code># Map categories to account codes\nfrom src.connectors.contaazul_connector import CategoryMapper\n\nmapper = CategoryMapper()\nmapper.map_category(\"Sal\u00e1rios e Encargos\", \"5.01.001\")\nmapper.map_category(\"Receita de Assinaturas\", \"4.01.001\")\n</code></pre></p> <p>Issue: Transaction pagination timeout</p> <p>For companies with high transaction volume:</p> <pre><code># Use date-based chunking\nfrom datetime import timedelta\n\nasync def extract_in_chunks(connector, company_id, period_start, period_end):\n    current = period_start\n    all_data = []\n\n    while current &lt; period_end:\n        chunk_end = min(current + timedelta(days=7), period_end)\n        chunk_data = await connector.get_transactions(\n            company_id,\n            current,\n            chunk_end\n        )\n        all_data.extend(chunk_data)\n        current = chunk_end\n\n    return all_data\n</code></pre>"},{"location":"user-guide/erp-integration/#omie","title":"Omie","text":"<p>Used by: Datahub</p>"},{"location":"user-guide/erp-integration/#authentication-setup_2","title":"Authentication Setup","text":"<ol> <li>Login to Omie as administrator</li> <li>Navigate to: Configura\u00e7\u00f5es \u2192 Integra\u00e7\u00f5es \u2192 Aplica\u00e7\u00f5es</li> <li>Create New App and get App Key + App Secret</li> <li>Copy credentials to <code>.env</code></li> </ol>"},{"location":"user-guide/erp-integration/#configuration_2","title":"Configuration","text":"<pre><code>connector = create_connector(\n    erp_type=\"omie\",\n    auth_type=\"api_key\",\n    credentials={\n        \"app_key\": \"your_app_key\",\n        \"app_secret\": \"your_app_secret\"\n    },\n    config={\n        \"base_url\": \"https://app.omie.com.br/api/v1\",\n        \"timeout\": 60.0\n    }\n)\n\nasync with connector:\n    trial_balance = await connector.get_trial_balance(\n        company_id=\"datahub_001\",\n        period_start=datetime(2026, 1, 1),\n        period_end=datetime(2026, 1, 31)\n    )\n</code></pre>"},{"location":"user-guide/erp-integration/#api-endpoints-used_2","title":"API Endpoints Used","text":"<p>Omie uses JSON-RPC style API:</p> Method Purpose Endpoint <code>ListarPlanoConta</code> List chart of accounts <code>/produtos/contacorrente/</code> <code>ListarContaCorrDet</code> Get account details <code>/produtos/contacorrente/</code> <code>ConsultarBalancete</code> Get trial balance <code>/produtos/contabilidade/</code> <code>ListarLancamentos</code> Get subledger entries <code>/produtos/contabilidade/</code>"},{"location":"user-guide/erp-integration/#request-format","title":"Request Format","text":"<p>Omie uses JSON-RPC format:</p> <pre><code>{\n  \"call\": \"ConsultarBalancete\",\n  \"app_key\": \"your_app_key\",\n  \"app_secret\": \"your_app_secret\",\n  \"param\": [{\n    \"dDataDe\": \"01/01/2026\",\n    \"dDataAte\": \"31/01/2026\",\n    \"nCodConta\": \"1.01.001\"\n  }]\n}\n</code></pre>"},{"location":"user-guide/erp-integration/#rate-limits_2","title":"Rate Limits","text":"<ul> <li>Limit: 300 requests per minute (most generous)</li> <li>Burst: Up to 500/min for short periods</li> <li>Best practice: Batch requests when possible</li> </ul>"},{"location":"user-guide/erp-integration/#troubleshooting_2","title":"Troubleshooting","text":"<p>Issue: Date format errors</p> <p>Omie requires Brazilian date format (DD/MM/YYYY):</p> <pre><code># Correct date formatting\nfrom datetime import datetime\n\ndef format_omie_date(dt: datetime) -&gt; str:\n    return dt.strftime(\"%d/%m/%Y\")\n\n# Usage\nparam = {\n    \"dDataDe\": format_omie_date(period_start),\n    \"dDataAte\": format_omie_date(period_end)\n}\n</code></pre> <p>Issue: Account hierarchy not returned</p> <p>Omie may not include parent account relationships.</p> <p>Solution: Use account code prefixes to infer hierarchy: - <code>1.01.001</code> \u2192 Parent: <code>1.01</code> \u2192 Root: <code>1</code></p>"},{"location":"user-guide/erp-integration/#bling","title":"Bling","text":"<p>Used by: Ip\u00ea Digital, Leadlovers</p>"},{"location":"user-guide/erp-integration/#authentication-setup_3","title":"Authentication Setup","text":"<p>Option 1: API Key (v3)</p> <ol> <li>Login to Bling \u2192 Configura\u00e7\u00f5es \u2192 API</li> <li>Generate API Key</li> <li>Copy to <code>.env</code></li> </ol> <p>Option 2: OAuth 2.0 (recommended for production)</p> <ol> <li>Register app at https://developer.bling.com.br</li> <li>Get Client ID/Secret</li> <li>Configure OAuth flow</li> </ol>"},{"location":"user-guide/erp-integration/#configuration_3","title":"Configuration","text":"<pre><code># API Key authentication\nconnector = create_connector(\n    erp_type=\"bling\",\n    auth_type=\"api_key\",\n    credentials={\n        \"api_key\": \"your_api_key\"\n    },\n    config={\n        \"base_url\": \"https://api.bling.com.br/Api/v3\",\n        \"api_version\": \"3\",  # v3 uses JSON, v2 uses XML\n        \"timeout\": 60.0\n    }\n)\n\n# OAuth 2.0 authentication\nconnector = create_connector(\n    erp_type=\"bling\",\n    auth_type=\"oauth2\",\n    credentials={\n        \"client_id\": \"your_client_id\",\n        \"client_secret\": \"your_client_secret\"\n    },\n    config={\n        \"base_url\": \"https://api.bling.com.br/Api/v3\",\n        \"api_version\": \"3\"\n    }\n)\n\nasync with connector:\n    trial_balance = await connector.get_trial_balance(\n        company_id=\"leadlovers_001\",\n        period_start=datetime(2026, 1, 1),\n        period_end=datetime(2026, 1, 31)\n    )\n</code></pre>"},{"location":"user-guide/erp-integration/#api-endpoints-used_3","title":"API Endpoints Used","text":"Endpoint Purpose Method <code>/contas</code> Chart of accounts GET <code>/contasreceber</code> Accounts receivable GET <code>/contaspagar</code> Accounts payable GET <code>/contabancaria/extrato</code> Bank transactions GET <code>/notasfiscais</code> Invoices GET"},{"location":"user-guide/erp-integration/#api-version-comparison","title":"API Version Comparison","text":"Feature v2 (XML) v3 (JSON) Data Format XML JSON Trial Balance \u274c Not available \u2713 Via aggregation Subledger Limited \u2713 Full access Rate Limit 100/min 100/min Recommendation Deprecated Use this"},{"location":"user-guide/erp-integration/#rate-limits_3","title":"Rate Limits","text":"<ul> <li>Limit: 100 requests per minute</li> <li>Throttling: 503 error if exceeded</li> <li>Recommendation: Use pagination and rate limiter</li> </ul>"},{"location":"user-guide/erp-integration/#troubleshooting_3","title":"Troubleshooting","text":"<p>Issue: v2 API returns XML instead of JSON</p> <p>Ensure using v3 API endpoint: <pre><code>config = {\n    \"base_url\": \"https://api.bling.com.br/Api/v3\",  # Note: /v3\n    \"api_version\": \"3\"\n}\n</code></pre></p> <p>Issue: Trial balance not available</p> <p>Bling v3 doesn't have native trial balance endpoint.</p> <p>Solution: Connector aggregates from: - Accounts Receivable (<code>/contasreceber</code>) - Accounts Payable (<code>/contaspagar</code>) - Bank Transactions (<code>/contabancaria/extrato</code>) - Invoices (<code>/notasfiscais</code>)</p>"},{"location":"user-guide/erp-integration/#advanced-configuration","title":"Advanced Configuration","text":""},{"location":"user-guide/erp-integration/#retry-configuration","title":"Retry Configuration","text":"<p>Customize retry behavior per connector:</p> <pre><code>from src.connectors import RetryConfig, RetryStrategy\n\nconnector = create_connector(\n    erp_type=\"totvs_protheus\",\n    auth_type=\"oauth2\",\n    credentials={...},\n    config={\n        \"retry_config\": RetryConfig(\n            max_attempts=5,          # Max 5 retries\n            initial_delay=2.0,       # Start with 2s delay\n            max_delay=120.0,         # Cap at 120s\n            strategy=RetryStrategy.EXPONENTIAL,  # Exponential backoff\n            jitter=True              # Add randomness to prevent thundering herd\n        )\n    }\n)\n</code></pre>"},{"location":"user-guide/erp-integration/#circuit-breaker","title":"Circuit Breaker","text":"<p>Protect against cascading failures:</p> <pre><code>from src.connectors.retry import CircuitBreaker\n\ncircuit_breaker = CircuitBreaker(\n    failure_threshold=5,     # Open circuit after 5 failures\n    recovery_timeout=60.0,   # Test recovery after 60s\n    half_open_attempts=3     # Try 3 requests when half-open\n)\n\n# Circuit breaker states:\n# CLOSED \u2192 Normal operation\n# OPEN \u2192 Fail fast, don't attempt requests\n# HALF_OPEN \u2192 Testing recovery\n</code></pre>"},{"location":"user-guide/erp-integration/#rate-limiting","title":"Rate Limiting","text":"<p>Manual rate limit control:</p> <pre><code>from src.connectors.retry import RateLimiter\n\n# Create rate limiter\nlimiter = RateLimiter(\n    rate=100,      # 100 requests\n    per=60.0       # Per 60 seconds\n)\n\n# Acquire tokens before request\nasync def make_request():\n    await limiter.acquire(tokens=1)\n    response = await connector.get_trial_balance(...)\n    return response\n</code></pre>"},{"location":"user-guide/erp-integration/#data-validation","title":"Data Validation","text":"<p>Enable strict validation:</p> <pre><code>from src.connectors.validation import ValidationConfig\n\nconnector = create_connector(\n    erp_type=\"omie\",\n    auth_type=\"api_key\",\n    credentials={...},\n    config={\n        \"validation\": ValidationConfig(\n            validate_account_codes=True,\n            validate_amounts=True,\n            validate_dates=True,\n            validate_balances=True,  # Check Assets = Liabilities + Equity\n            fail_on_validation_error=False  # Log warnings instead of failing\n        )\n    }\n)\n</code></pre>"},{"location":"user-guide/erp-integration/#monitoring-logging","title":"Monitoring &amp; Logging","text":""},{"location":"user-guide/erp-integration/#enable-debug-logging","title":"Enable Debug Logging","text":"<pre><code>import logging\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.DEBUG,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n    handlers=[\n        logging.FileHandler('connectors.log'),\n        logging.StreamHandler()\n    ]\n)\n\n# Now all connector operations are logged\n</code></pre>"},{"location":"user-guide/erp-integration/#health-checks","title":"Health Checks","text":"<p>Monitor connector health:</p> <pre><code># Check all connectors\npython -m src.connectors.health_check --all\n\n# Check specific connector\npython -m src.connectors.health_check \\\n  --erp totvs_protheus \\\n  --company effecti\n</code></pre> <p>Health check metrics: - Status: healthy, degraded, unhealthy - Latency: API response time - Last successful extraction - Error rate (last 24h)</p>"},{"location":"user-guide/erp-integration/#performance-metrics","title":"Performance Metrics","text":"<p>Track connector performance:</p> <pre><code>from src.connectors import ConnectorMetrics\n\nmetrics = ConnectorMetrics()\n\n# Get metrics for connector\nstats = metrics.get_stats(\"totvs_protheus\")\n\nprint(f\"Total Requests: {stats.total_requests}\")\nprint(f\"Success Rate: {stats.success_rate:.1%}\")\nprint(f\"Avg Latency: {stats.avg_latency_ms}ms\")\nprint(f\"Error Rate: {stats.error_rate:.1%}\")\n</code></pre>"},{"location":"user-guide/erp-integration/#common-issues-solutions","title":"Common Issues &amp; Solutions","text":""},{"location":"user-guide/erp-integration/#issue-connection-timeout","title":"Issue: Connection Timeout","text":"<p>Symptoms: - <code>httpx.ConnectTimeout</code> exception - Connection hangs for 60s</p> <p>Solutions:</p> <ol> <li> <p>Check network connectivity: <pre><code># Test API reachability\ncurl -I https://api.totvs.com.br\n</code></pre></p> </li> <li> <p>Increase timeout: <pre><code>config = {\"timeout\": 120.0}  # Increase to 120s\n</code></pre></p> </li> <li> <p>Use retry logic: <pre><code>config = {\n    \"retry_config\": RetryConfig(max_attempts=5)\n}\n</code></pre></p> </li> </ol>"},{"location":"user-guide/erp-integration/#issue-rate-limit-exceeded","title":"Issue: Rate Limit Exceeded","text":"<p>Symptoms: - <code>429 Too Many Requests</code> response - <code>503 Service Temporarily Unavailable</code></p> <p>Solutions:</p> <ol> <li> <p>Reduce request rate: <pre><code>import asyncio\n\nasync def extract_with_delay():\n    for company in companies:\n        await connector.get_trial_balance(company)\n        await asyncio.sleep(1)  # 1s delay between requests\n</code></pre></p> </li> <li> <p>Use built-in rate limiter: <pre><code># Rate limiter handles this automatically\nconnector = create_connector(\n    erp_type=\"contaazul\",\n    ...,\n    config={\"rate_limit\": 60}  # 60 requests/min\n)\n</code></pre></p> </li> </ol>"},{"location":"user-guide/erp-integration/#issue-authentication-failure","title":"Issue: Authentication Failure","text":"<p>Symptoms: - <code>401 Unauthorized</code> response - <code>Invalid credentials</code> error</p> <p>Solutions:</p> <ol> <li> <p>Verify credentials: <pre><code># Check .env file\ncat .env | grep TOTVS\n</code></pre></p> </li> <li> <p>Refresh OAuth token: <pre><code>python -m src.connectors.refresh_token \\\n  --erp totvs_protheus \\\n  --company effecti\n</code></pre></p> </li> <li> <p>Re-authorize application:</p> </li> <li>Visit ERP admin console</li> <li>Revoke old token</li> <li>Generate new token</li> <li>Update <code>.env</code></li> </ol>"},{"location":"user-guide/erp-integration/#issue-data-quality-errors","title":"Issue: Data Quality Errors","text":"<p>Symptoms: - Trial balance doesn't balance - Missing account codes - Duplicate transactions</p> <p>Solutions:</p> <ol> <li> <p>Enable validation: <pre><code>config = {\n    \"validation\": ValidationConfig(\n        validate_balances=True,\n        fail_on_validation_error=True\n    )\n}\n</code></pre></p> </li> <li> <p>Review validation report: <pre><code>python -m src.reporting.validation_report \\\n  --company effecti \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Contact ERP support if data quality issues persist</p> </li> </ol>"},{"location":"user-guide/erp-integration/#best-practices","title":"Best Practices","text":"<ol> <li>Use Environment Variables: Never hardcode credentials</li> <li>Enable Logging: Always log connector operations for debugging</li> <li>Monitor Health: Set up daily health checks for all connectors</li> <li>Test in Sandbox: Use sandbox/test environments when available</li> <li>Handle Errors Gracefully: Don't fail entire close for one company</li> <li>Cache Tokens: OAuth handlers cache tokens automatically</li> <li>Paginate Large Datasets: Use pagination for companies with high transaction volume</li> <li>Schedule Off-Peak: Run extractions during off-peak hours to avoid rate limits</li> </ol>"},{"location":"user-guide/erp-integration/#testing","title":"Testing","text":""},{"location":"user-guide/erp-integration/#unit-tests","title":"Unit Tests","text":"<p>Test individual connector functions:</p> <pre><code># Test TOTVS connector\npython -m pytest tests/connectors/test_totvs.py\n\n# Test with coverage\npython -m pytest tests/connectors/ --cov=src.connectors\n</code></pre>"},{"location":"user-guide/erp-integration/#integration-tests","title":"Integration Tests","text":"<p>Test against live ERP APIs:</p> <pre><code># Set test environment variables\nexport TEST_MODE=integration\nexport TOTVS_EFFECTI_CLIENT_ID=test_client_id\n\n# Run integration tests\npython -m pytest tests/integration/test_totvs_integration.py\n</code></pre> <p>Note: Integration tests require valid ERP credentials and may count against rate limits.</p>"},{"location":"user-guide/erp-integration/#support","title":"Support","text":""},{"location":"user-guide/erp-integration/#erp-support-contacts","title":"ERP Support Contacts","text":"ERP Support Portal Phone TOTVS https://suporte.totvs.com +55 11 2099-7000 ContaAzul https://ajuda.contaazul.com +55 48 3413-8300 Omie https://ajuda.omie.com.br +55 11 4200-2300 Bling https://ajuda.bling.com.br +55 13 3010-5007"},{"location":"user-guide/erp-integration/#fpa-team-contact","title":"FPA Team Contact","text":"<p>Technical Support: pschumacher@nuvini.ai</p> <p>Escalation: If ERP connector is blocking monthly close, escalate to FPA team immediately.</p>"},{"location":"user-guide/erp-integration/#next-steps","title":"Next Steps","text":"<ul> <li>Monthly Close Process - Use connectors in monthly close</li> <li>Troubleshooting Guide - Detailed troubleshooting</li> <li>Technical Reference - API documentation</li> </ul> <p>Last Updated: February 7, 2026 Version: 1.0.0</p>"},{"location":"user-guide/human-review/","title":"Human Review &amp; Oversight Guide","text":""},{"location":"user-guide/human-review/#overview","title":"Overview","text":"<p>The AI FP&amp;A system uses a risk-based human oversight framework to ensure accuracy and compliance while maximizing automation efficiency. Not all transactions require human review\u2014only those identified as medium or high risk through confidence scoring.</p> <p>Review Philosophy: - \ud83d\udfe2 Green (High Confidence \u226580%): Auto-approved with 5% sampling - \ud83d\udfe1 Yellow (Medium Confidence 50-79%): Mandatory pre-review - \ud83d\udd34 Red (Low Confidence &lt;50%): Escalated multi-person review</p> <p>Target: Review only 10-15% of transactions while maintaining 99.9% accuracy</p>"},{"location":"user-guide/human-review/#confidence-scoring-system","title":"Confidence Scoring System","text":""},{"location":"user-guide/human-review/#how-confidence-scores-work","title":"How Confidence Scores Work","text":"<p>Every AI-generated transaction receives a confidence score (0-100%) based on weighted risk factors:</p> Risk Factor Weight Description Materiality 30% Transaction amount vs. threshold Pattern Deviation 25% Deviation from historical patterns Data Quality 20% Completeness and accuracy of source data Complexity 15% Transaction type complexity Variance 10% Budget/forecast variance"},{"location":"user-guide/human-review/#risk-level-determination","title":"Risk Level Determination","text":"<pre><code># Confidence score calculation\nraw_score = 1.0 - (weighted_sum_of_risks)\n\nif raw_score &gt;= 0.80:\n    risk_level = GREEN    # High confidence - auto-approve\nelif raw_score &gt;= 0.50:\n    risk_level = YELLOW   # Medium confidence - review required\nelse:\n    risk_level = RED      # Low confidence - escalate\n</code></pre>"},{"location":"user-guide/human-review/#example-confidence-calculation","title":"Example Confidence Calculation","text":"<p>Transaction: Intercompany revenue elimination</p> <pre><code>Risk Factors:\n  Materiality:       USD 1,500,000 (above USD 500k threshold)\n                     Risk Score: 0.8 (high)\n                     Weighted: 0.8 \u00d7 30% = 0.24\n\n  Pattern Deviation: 12% deviation from historical average\n                     Risk Score: 0.3 (low)\n                     Weighted: 0.3 \u00d7 25% = 0.075\n\n  Data Quality:      98.5% quality score\n                     Risk Score: 0.015 (very low)\n                     Weighted: 0.015 \u00d7 20% = 0.003\n\n  Complexity:        First-time intercompany transaction\n                     Risk Score: 0.7 (high)\n                     Weighted: 0.7 \u00d7 15% = 0.105\n\n  Variance:          5% variance from budget\n                     Risk Score: 0.2 (low)\n                     Weighted: 0.2 \u00d7 10% = 0.02\n\nTotal Weighted Risk: 0.24 + 0.075 + 0.003 + 0.105 + 0.02 = 0.443\nConfidence Score:    1.0 - 0.443 = 0.557 = 55.7%\n\nRisk Level: \ud83d\udfe1 YELLOW (requires review)\n</code></pre>"},{"location":"user-guide/human-review/#review-workflow","title":"Review Workflow","text":""},{"location":"user-guide/human-review/#review-dashboard-access","title":"Review Dashboard Access","text":"<p>Access the review dashboard:</p> <pre><code># Start review dashboard\npython -m src.dashboard.review_app \\\n  --period \"2026-01-31\" \\\n  --port 8080\n\n# Open in browser\nopen http://localhost:8080/review\n</code></pre>"},{"location":"user-guide/human-review/#dashboard-overview","title":"Dashboard Overview","text":"<p>The dashboard displays:</p> <ol> <li>Summary Statistics</li> <li>Total transactions</li> <li>Pending reviews by risk level</li> <li>Average confidence score</li> <li> <p>Review completion percentage</p> </li> <li> <p>Review Queue</p> </li> <li>List of transactions requiring review</li> <li>Priority sorted (red \u2192 yellow \u2192 green sampling)</li> <li> <p>Filter by risk level, category, amount</p> </li> <li> <p>Transaction Details</p> </li> <li>Full transaction information</li> <li>Confidence score breakdown</li> <li>Supporting documentation</li> <li>Historical context</li> </ol>"},{"location":"user-guide/human-review/#review-process","title":"Review Process","text":""},{"location":"user-guide/human-review/#step-1-review-assignment","title":"Step 1: Review Assignment","text":"<p>Reviews are automatically assigned based on escalation level:</p> Escalation Level Role SLA Typical Cases Level 0 None (auto-approved) - Green risk items Level 1 FP&amp;A Analyst 24 hours Yellow risk, routine Level 2 FP&amp;A Manager 12 hours Red risk, period close Level 3 CFO 6 hours Regulatory, material Level 4 Audit Committee 48 hours Critical issues"},{"location":"user-guide/human-review/#step-2-review-transaction","title":"Step 2: Review Transaction","text":"<p>In the dashboard:</p> <ol> <li>Click on transaction to view details</li> <li>Review information:</li> <li>Transaction type and amount</li> <li>Source system and entity</li> <li>Confidence score breakdown</li> <li>Supporting documentation</li> <li>Similar historical transactions</li> <li>Assess accuracy:</li> <li>Verify amounts</li> <li>Check account codes</li> <li>Validate business logic</li> <li>Review supporting documents</li> </ol> <p>Example transaction detail view:</p> <pre><code>Transaction ID: TX-2026-01-0234\nStatus: Pending Review\nConfidence: 55.7% (\ud83d\udfe1 Yellow)\n\nDetails:\n  Type: Intercompany Elimination\n  Date: 2026-01-31\n  Amount: USD 1,500,000\n  From Entity: Effecti\n  To Entity: Mercos\n  Account: 4.02.001 - IC Revenue\n\nJournal Entry:\n  DR: IC Revenue (Effecti)      USD 1,500,000\n  CR: IC Expense (Mercos)        USD 1,500,000\n  Memo: Eliminate intercompany software license\n\nConfidence Breakdown:\n  Materiality (30%):       HIGH  - Amount exceeds threshold\n  Pattern Deviation (25%): LOW   - 12% deviation is normal\n  Data Quality (20%):      LOW   - 98.5% quality score\n  Complexity (15%):        HIGH  - First-time transaction type\n  Variance (10%):          LOW   - 5% budget variance\n\nRisk Factors:\n  \u26a0 Amount exceeds materiality threshold (USD 500k)\n  \u26a0 First-time intercompany transaction type\n  \u2713 Data quality is high\n  \u2713 Pattern deviation is normal\n\nSupporting Documents:\n  \ud83d\udcc4 Invoice INV-2026-0045.pdf\n  \ud83d\udcc4 Contract effecti_mercos_license.pdf\n  \ud83d\udcc4 Email approval from CFO\n\nHistorical Context:\n  Similar transactions: 0 (first-time)\n  Average IC revenue: USD 125,000/month\n  This transaction: 12x average (unusually large)\n\nReviewer Notes:\n  - Verify with Effecti and Mercos finance teams\n  - Confirm new licensing agreement is legitimate\n  - Check if this should be capitalized instead of expensed\n</code></pre>"},{"location":"user-guide/human-review/#step-3-make-decision","title":"Step 3: Make Decision","text":"<p>Available actions:</p> <ol> <li>Approve</li> <li>Accept AI recommendation as-is</li> <li>Transaction proceeds to consolidation</li> <li> <p>Review logged in audit trail</p> </li> <li> <p>Approve with Modifications</p> </li> <li>Adjust amounts, account codes, or classifications</li> <li>Provide explanation for changes</li> <li> <p>Modified entry proceeds to consolidation</p> </li> <li> <p>Reject</p> </li> <li>Reject AI recommendation entirely</li> <li>Provide detailed reason</li> <li> <p>Create manual adjustment entry</p> </li> <li> <p>Request More Information</p> </li> <li>Flag for additional review</li> <li>Request supporting documentation</li> <li>Escalate to higher authority</li> </ol> <p>Example approval:</p> <pre><code># In the dashboard, click \"Approve\" button and add comment\n\nComment: \"Verified new licensing agreement effective Jan 1, 2026.\nInvoice INV-2026-0045 confirms USD 1.5M annual license fee.\nContract reviewed by Legal. Approve as-is.\"\n\nReviewer: john_analyst (FP&amp;A Analyst)\nDecision: Approved\nTimestamp: 2026-02-03 14:23:15 UTC\n</code></pre> <p>Example rejection:</p> <pre><code># Click \"Reject\" and provide reason\n\nReason: \"This should be capitalized as an intangible asset, not\nexpensed immediately. The licensing agreement grants Mercos 5-year\nright to use Effecti's platform. Per IFRS 38, this meets the\ndefinition of an intangible asset.\n\nRecommended entry:\n  DR: Intangible Asset - Software License  USD 1,500,000\n  CR: IC Payable                           USD 1,500,000\n\nEscalating to CFO for approval.\"\n\nReviewer: sarah_manager (FP&amp;A Manager)\nDecision: Rejected\nEscalation: Level 3 (CFO)\nTimestamp: 2026-02-03 15:45:22 UTC\n</code></pre>"},{"location":"user-guide/human-review/#step-4-four-eyes-principle-red-risk-only","title":"Step 4: Four-Eyes Principle (Red Risk Only)","text":"<p>For red risk transactions, a second reviewer must independently review:</p> <p>First Reviewer (FP&amp;A Analyst):</p> <pre><code>Review 1:\n  Reviewer: john_analyst\n  Decision: Approved\n  Comment: \"Amounts verified, supporting docs attached. Approve.\"\n  Timestamp: 2026-02-03 14:30:00 UTC\n\nStatus: Pending Second Review\nRequired: 1 additional reviewer\n</code></pre> <p>Second Reviewer (FP&amp;A Manager or CFO):</p> <pre><code>Review 2:\n  Reviewer: sarah_manager\n  Decision: Approved\n  Comment: \"Second review complete. Concur with first reviewer.\n            Amounts reconcile, documentation adequate. Final approval.\"\n  Timestamp: 2026-02-03 16:15:00 UTC\n\nStatus: \u2713 Approved (Four-Eyes Complete)\nTransaction proceeds to consolidation.\n</code></pre> <p>Important: Both reviewers must independently review\u2014no discussion beforehand.</p>"},{"location":"user-guide/human-review/#mandatory-review-categories","title":"Mandatory Review Categories","text":"<p>Certain transaction types always require human review regardless of confidence score:</p> Category Reason Escalation Level Period Close Critical control point Level 2 (Manager) Intercompany Eliminations Complex, material Level 1 (Analyst) Regulatory Reports External compliance Level 3 (CFO) External Communications Reputational risk Level 3 (CFO) Manual Adjustments Override of automated entries Level 2 (Manager) Variances &gt;15% Unusual deviation Level 1 (Analyst) First-Time Transactions No historical precedent Level 2 (Manager) Amount &gt; Materiality Financial statement impact Level 2 (Manager) <p>Example: Period close always requires review</p> <pre><code>Transaction: Period Close - January 2026\nType: Period Close\nConfidence: 92% (\ud83d\udfe2 Green)\n\nDespite green risk level, this transaction requires mandatory review:\n  Category: Period Close\n  Escalation: Level 2 (FP&amp;A Manager)\n  Required Reviewers: 1\n  SLA: 12 hours\n\nReason: Period close is a critical control point ensuring all entries\nare finalized before financial statements are issued.\n</code></pre>"},{"location":"user-guide/human-review/#review-commands-cli","title":"Review Commands (CLI)","text":""},{"location":"user-guide/human-review/#get-pending-reviews","title":"Get Pending Reviews","text":"<pre><code># All pending reviews\npython -m src.cli.pending_reviews \\\n  --period \"2026-01-31\"\n\n# Filter by risk level\npython -m src.cli.pending_reviews \\\n  --period \"2026-01-31\" \\\n  --risk-level red\n\n# Filter by escalation level\npython -m src.cli.pending_reviews \\\n  --period \"2026-01-31\" \\\n  --escalation-level 2\n</code></pre>"},{"location":"user-guide/human-review/#submit-review","title":"Submit Review","text":"<pre><code># Approve transaction\npython -m src.cli.submit_review \\\n  --request-id \"REV-2026-01-0234\" \\\n  --reviewer \"john_analyst\" \\\n  --decision approved \\\n  --comment \"Verified and approved\"\n\n# Approve with modifications\npython -m src.cli.submit_review \\\n  --request-id \"REV-2026-01-0235\" \\\n  --reviewer \"john_analyst\" \\\n  --decision approved \\\n  --modifications \"amount:1450000,account:4.01.001\" \\\n  --comment \"Adjusted amount and account code\"\n\n# Reject transaction\npython -m src.cli.submit_review \\\n  --request-id \"REV-2026-01-0236\" \\\n  --reviewer \"sarah_manager\" \\\n  --decision rejected \\\n  --comment \"Should be capitalized, not expensed. Escalating to CFO.\"\n</code></pre>"},{"location":"user-guide/human-review/#review-statistics","title":"Review Statistics","text":"<pre><code># Get review statistics for period\npython -m src.cli.review_stats \\\n  --period \"2026-01-31\"\n</code></pre> <p>Example output:</p> <pre><code>Review Statistics - January 2026\n\nTotal Transactions:        7,017\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\nGreen (\u226580%):             6,342 (90.4%)\n  Auto-approved:          6,025 (95% skip review)\n  Sampled for review:       317 (5% sampling)\n\nYellow (50-79%):            657 (9.4%)\n  Requires review:          657 (100%)\n\nRed (&lt;50%):                  18 (0.3%)\n  Requires review:           18 (100%)\n  Four-eyes required:        18 (100%)\n\nReview Workload:\n  Total requiring review:   992 (14.1%)\n  Completed:               950 (95.8%)\n  Pending:                  42 (4.2%)\n  Overdue (past SLA):        3 (0.3%)\n\nApproval Rate:\n  Approved as-is:          875 (92.1%)\n  Approved with mods:       58 (6.1%)\n  Rejected:                 17 (1.8%)\n\nAverage Review Time:\n  Green sampling:         2.3 minutes\n  Yellow reviews:         8.5 minutes\n  Red reviews:           18.7 minutes\n\nReviewers:\n  john_analyst:           342 reviews (36.0%)\n  sarah_manager:          285 reviews (30.0%)\n  pierre_cfo:              48 reviews (5.1%)\n  [Others]:               275 reviews (28.9%)\n</code></pre>"},{"location":"user-guide/human-review/#review-best-practices","title":"Review Best Practices","text":""},{"location":"user-guide/human-review/#1-prioritize-by-risk-level","title":"1. Prioritize by Risk Level","text":"<p>Always review in this order:</p> <ol> <li>Red risk (highest priority)</li> <li>Yellow risk</li> <li>Green sampling (lowest priority)</li> </ol>"},{"location":"user-guide/human-review/#2-meet-sla-targets","title":"2. Meet SLA Targets","text":"<p>Respect the SLA for each escalation level:</p> <ul> <li>Level 1 (Analyst): 24 hours</li> <li>Level 2 (Manager): 12 hours</li> <li>Level 3 (CFO): 6 hours</li> </ul> <p>Set up SLA alerts:</p> <pre><code># Get overdue reviews\npython -m src.cli.overdue_reviews \\\n  --period \"2026-01-31\"\n\n# Email alert\npython -m src.cli.email_overdue_alert \\\n  --to \"fpa-team@nuvini.ai\"\n</code></pre>"},{"location":"user-guide/human-review/#3-document-decisions","title":"3. Document Decisions","text":"<p>Always provide clear comments explaining your decision:</p> <p>Good comments: - \"Verified invoice INV-2026-0045. Amounts reconcile. Approved.\" - \"Account code should be 5.01.002 (Salaries) not 5.01.001 (Consulting). Modified.\" - \"Transaction duplicates prior entry JE-2026-01-0123. Rejected to avoid double-counting.\"</p> <p>Poor comments: - \"OK\" - \"Approved\" - \"Looks good\"</p>"},{"location":"user-guide/human-review/#4-use-supporting-documentation","title":"4. Use Supporting Documentation","text":"<p>Always review supporting documents before approving:</p> <ul> <li>Invoices</li> <li>Contracts</li> <li>Email approvals</li> <li>Bank statements</li> <li>Reconciliations</li> </ul> <p>Attach documents to review:</p> <pre><code>python -m src.cli.attach_document \\\n  --review-id \"REV-2026-01-0234\" \\\n  --file \"supporting_docs/invoice_INV-2026-0045.pdf\" \\\n  --description \"Supporting invoice for IC transaction\"\n</code></pre>"},{"location":"user-guide/human-review/#5-escalate-when-unsure","title":"5. Escalate When Unsure","text":"<p>If uncertain, escalate to higher authority:</p> <pre><code>python -m src.cli.escalate_review \\\n  --review-id \"REV-2026-01-0237\" \\\n  --to-level 3 \\\n  --reason \"Complex revenue recognition issue, need CFO guidance\"\n</code></pre>"},{"location":"user-guide/human-review/#6-maintain-independence-four-eyes","title":"6. Maintain Independence (Four-Eyes)","text":"<p>For four-eyes reviews:</p> <ul> <li>Do not discuss with first reviewer before reviewing</li> <li>Review independently based on facts</li> <li>Disagree if necessary\u2014better to debate than rubber-stamp</li> </ul>"},{"location":"user-guide/human-review/#7-track-review-metrics","title":"7. Track Review Metrics","text":"<p>Monitor your review performance:</p> <pre><code># Your review statistics\npython -m src.cli.reviewer_stats \\\n  --reviewer \"john_analyst\" \\\n  --period \"2026-01\"\n</code></pre> <p>Example output:</p> <pre><code>Reviewer Performance - john_analyst - January 2026\n\nReviews Completed:       342\nApproval Rate:          94.2%\nRejection Rate:          5.8%\nAverage Review Time:    7.3 minutes\nSLA Compliance:         98.5% (within SLA)\nOverdue Reviews:         5 (1.5%)\n\nDecision Breakdown:\n  Approved as-is:       322 (94.2%)\n  Approved with mods:    15 (4.4%)\n  Rejected:              20 (5.8%)\n  Escalated:              5 (1.5%)\n\nQuality Score:          96.5/100\n  (Based on CFO review of sample)\n</code></pre>"},{"location":"user-guide/human-review/#troubleshooting","title":"Troubleshooting","text":""},{"location":"user-guide/human-review/#issue-too-many-reviews-pending","title":"Issue: Too Many Reviews Pending","text":"<p>Symptom: Review queue is overwhelming</p> <p>Solutions:</p> <ol> <li> <p>Adjust confidence thresholds: <pre><code># Increase green threshold (review fewer items)\noversight_manager.scoring_engine.green_threshold = 0.85  # Was 0.80\n</code></pre></p> </li> <li> <p>Increase sampling rate: <pre><code># Reduce green sampling from 5% to 2%\noversight_manager.sampling_config.green_sampling_rate = 0.02\n</code></pre></p> </li> <li> <p>Delegate reviews: <pre><code># Reassign reviews to additional reviewers\npython -m src.cli.reassign_reviews \\\n  --from \"john_analyst\" \\\n  --to \"mary_analyst\" \\\n  --count 50\n</code></pre></p> </li> </ol>"},{"location":"user-guide/human-review/#issue-high-rejection-rate","title":"Issue: High Rejection Rate","text":"<p>Symptom: Many transactions rejected during review</p> <p>Solutions:</p> <ol> <li> <p>Investigate root causes: <pre><code>python -m src.reporting.rejection_analysis \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Improve AI model:</p> </li> <li>Retrain on rejected transactions</li> <li>Adjust confidence scoring weights</li> <li> <p>Add validation rules</p> </li> <li> <p>Provide feedback: <pre><code># Flag transaction for model improvement\npython -m src.cli.flag_for_training \\\n  --transaction \"TX-2026-01-0234\" \\\n  --reason \"AI misclassified account type\"\n</code></pre></p> </li> </ol>"},{"location":"user-guide/human-review/#issue-review-sla-breaches","title":"Issue: Review SLA Breaches","text":"<p>Symptom: Reviews not completed within SLA</p> <p>Solutions:</p> <ol> <li> <p>Check reviewer workload: <pre><code>python -m src.cli.workload_balance \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Adjust escalation levels:</p> </li> <li>Reduce Level 3 (CFO) reviews</li> <li> <p>Increase Level 1 (Analyst) capacity</p> </li> <li> <p>Extend SLA (if justified): <pre><code># Increase Level 1 SLA to 36 hours\nescalation_matrix[EscalationLevel.FPA_ANALYST].sla_hours = 36\n</code></pre></p> </li> </ol>"},{"location":"user-guide/human-review/#oversight-reporting","title":"Oversight Reporting","text":""},{"location":"user-guide/human-review/#monthly-oversight-report","title":"Monthly Oversight Report","text":"<pre><code># Generate oversight report\npython -m src.reporting.oversight_report \\\n  --period \"2026-01-31\" \\\n  --output oversight_jan2026.pdf\n</code></pre> <p>Report contents:</p> <pre><code>Human Oversight Report - January 2026\n\nExecutive Summary:\n  Total Transactions:     7,017\n  Reviewed:                992 (14.1%)\n  Auto-approved:         6,025 (85.9%)\n  Overall Approval Rate:  92.1%\n  Average Confidence:     87.3%\n\nRisk Distribution:\n  \ud83d\udfe2 Green (\u226580%):       6,342 (90.4%)\n  \ud83d\udfe1 Yellow (50-79%):      657 (9.4%)\n  \ud83d\udd34 Red (&lt;50%):            18 (0.3%)\n\nReview Outcomes:\n  Approved as-is:        875 (88.2%)\n  Approved with mods:     58 (5.8%)\n  Rejected:               17 (1.7%)\n  Escalated:              42 (4.2%)\n\nFour-Eyes Reviews:\n  Required:               18\n  Completed:              18 (100%)\n  Average Time:       18.7 minutes\n\nSLA Performance:\n  Level 1 (24h):         98.5% on-time\n  Level 2 (12h):         96.8% on-time\n  Level 3 (6h):          91.7% on-time\n\nReviewer Performance:\n  john_analyst:       342 reviews, 7.3 min avg\n  sarah_manager:      285 reviews, 12.5 min avg\n  pierre_cfo:          48 reviews, 22.1 min avg\n\nConfidence Accuracy:\n  Green transactions:  99.8% accurate (2 errors in 6,342)\n  Yellow transactions: 98.5% accurate (10 errors in 657)\n  Red transactions:    94.4% accurate (1 error in 18)\n\nOverall System Accuracy: 99.92%\n(Target: 99.9%) \u2713 PASS\n</code></pre>"},{"location":"user-guide/human-review/#next-steps","title":"Next Steps","text":"<ul> <li>Monthly Close Process - When reviews occur in workflow</li> <li>Consolidation Guide - What happens after review approval</li> <li>Reports Guide - Reporting on review activity</li> </ul> <p>Last Updated: February 7, 2026 Version: 1.0.0</p>"},{"location":"user-guide/monthly-close/","title":"Monthly Close Process","text":""},{"location":"user-guide/monthly-close/#overview","title":"Overview","text":"<p>The monthly close process is the core workflow of the AI FP&amp;A system. This guide walks you through the step-by-step process of completing a monthly financial close across all portfolio companies.</p> <p>Timeline: 3-5 business days (vs. 10-15 days manual) Automation Rate: 85-90% Human Review: 10-15% of transactions</p>"},{"location":"user-guide/monthly-close/#prerequisites","title":"Prerequisites","text":"<p>Before starting the monthly close:</p> <ul> <li>[ ] All portfolio company ERPs are accessible</li> <li>[ ] Month-end dates are confirmed (typically last day of month)</li> <li>[ ] FX rates are available for period-end and average</li> <li>[ ] Prior period close is complete and approved</li> <li>[ ] Reviewers are available for approval workflow</li> </ul>"},{"location":"user-guide/monthly-close/#monthly-close-timeline","title":"Monthly Close Timeline","text":"<pre><code>Day 1: Data Extraction\n  \u2192 ERP connectors pull trial balances\n  \u2192 Data quality validation\n  \u2192 Initial load to raw_data tables\n\nDay 2: Consolidation\n  \u2192 FX conversion (BRL \u2192 USD)\n  \u2192 Intercompany elimination matching\n  \u2192 PPA amortization entries\n  \u2192 Consolidated trial balance generation\n\nDay 3: Review &amp; Validation\n  \u2192 Human review of yellow/red risk items\n  \u2192 Variance analysis vs. budget/prior period\n  \u2192 Adjustment entries (if needed)\n\nDay 4: Final Approval\n  \u2192 CFO review of consolidated financials\n  \u2192 Four-eyes sign-off on material items\n  \u2192 Period close lock\n\nDay 5: Reporting\n  \u2192 Generate board reports\n  \u2192 Export to Excel/PDF\n  \u2192 Archive in S3 with Object Lock\n</code></pre>"},{"location":"user-guide/monthly-close/#step-by-step-process","title":"Step-by-Step Process","text":""},{"location":"user-guide/monthly-close/#step-1-initiate-monthly-close","title":"Step 1: Initiate Monthly Close","text":"<p>Run the orchestrator:</p> <pre><code>cd /Volumes/AI/Code/FPA\npython -m src.orchestrator.monthly_close \\\n  --period-end \"2026-01-31\" \\\n  --period-start \"2026-01-01\" \\\n  --presentation-currency USD\n</code></pre> <p>What happens: - Orchestrator agent coordinates all sub-agents - Creates close period in database - Sets status to <code>in_progress</code> - Generates workflow tasks</p> <p>Expected output: <pre><code>\u2713 Close period created: CLOSE-2026-01\n\u2713 Orchestrator initialized\n\u2713 7 portfolio companies identified\n\u2192 Starting data extraction...\n</code></pre></p>"},{"location":"user-guide/monthly-close/#step-2-data-extraction","title":"Step 2: Data Extraction","text":"<p>Automated by: <code>data_ingestion</code> agent Duration: 30-60 minutes Manual intervention: Only if ERP connection fails</p> <p>The system automatically:</p> <ol> <li>Connects to each ERP system using stored credentials</li> <li>Extracts trial balances for the period</li> <li>Validates data quality:</li> <li>Balance sheet balances (Assets = Liabilities + Equity)</li> <li>Debit/credit equality</li> <li>Account code completeness</li> <li>No duplicate transactions</li> <li>Loads into <code>raw_data</code> table with encryption</li> </ol> <p>Monitor progress:</p> <pre><code># Check extraction status\npython -m src.cli.status --period \"2026-01\"\n\n# View extraction logs\ntail -f logs/data_ingestion.log\n</code></pre> <p>Example output: <pre><code>Company: Effecti\n  Status: \u2713 Complete\n  Entries: 1,248\n  Quality Score: 98.5%\n\nCompany: Mercos\n  Status: \u2713 Complete\n  Entries: 1,089\n  Quality Score: 99.1%\n\nCompany: Datahub\n  Status: \u2192 In Progress (45%)\n  Entries: 543 / ~1200\n</code></pre></p> <p>Troubleshooting:</p> <p>If extraction fails for a company:</p> <pre><code># Retry specific company\npython -m src.connectors.retry \\\n  --company effecti \\\n  --period \"2026-01-31\"\n\n# Check connector health\npython -m src.connectors.health_check \\\n  --erp totvs_protheus\n</code></pre> <p>See ERP Integration Troubleshooting for common issues.</p>"},{"location":"user-guide/monthly-close/#step-3-data-quality-validation","title":"Step 3: Data Quality Validation","text":"<p>Automated by: <code>validation</code> agent Duration: 5-10 minutes</p> <p>The system automatically validates:</p> <ol> <li>Completeness: All companies extracted successfully</li> <li>Accuracy: Trial balances match ERP source</li> <li>Consistency: Account codes align with chart of accounts</li> <li>Reasonableness: Balances within expected ranges</li> </ol> <p>Review validation report:</p> <pre><code># Generate validation report\npython -m src.reporting.validation_report \\\n  --period \"2026-01-31\" \\\n  --output validation_report.html\n</code></pre> <p>Example validation results:</p> Company Entries Balance Check Quality Score Issues Effecti 1,248 \u2713 Pass 98.5% 2 warnings Mercos 1,089 \u2713 Pass 99.1% 0 Datahub 1,201 \u2713 Pass 97.8% 3 warnings OnClick 987 \u2713 Pass 98.9% 1 warning Ip\u00ea Digital 845 \u2713 Pass 99.5% 0 Munddi 756 \u2713 Pass 98.2% 2 warnings Leadlovers 891 \u2713 Pass 99.0% 1 warning <p>Investigate warnings:</p> <p>Warnings typically indicate: - Unusual account balances (e.g., negative cash) - Missing account descriptions - Suspicious transactions (duplicate amounts/dates)</p> <p>These are flagged for human review but don't block consolidation.</p>"},{"location":"user-guide/monthly-close/#step-4-consolidation","title":"Step 4: Consolidation","text":"<p>Automated by: <code>consolidation</code> agent Duration: 10-15 minutes</p> <p>The consolidation process executes:</p>"},{"location":"user-guide/monthly-close/#41-fx-conversion","title":"4.1 FX Conversion","text":"<p>All BRL balances are converted to USD using: - Balance sheet items: Closing rate (Jan 31, 2026) - P&amp;L items: Average rate (Jan 1-31, 2026) - Equity items: Historical rate (acquisition date)</p> <p>FX rates used: <pre><code>BRL/USD Closing: 0.1895 (BCB PTAX 31-Jan-2026)\nBRL/USD Average: 0.1872 (Jan 2026 average)\n</code></pre></p> <p>Cumulative Translation Adjustment (CTA) is calculated for balance sheet translation differences.</p>"},{"location":"user-guide/monthly-close/#42-intercompany-elimination","title":"4.2 Intercompany Elimination","text":"<p>The system identifies and eliminates intercompany transactions:</p> <p>Elimination categories: 1. Receivables/Payables: Invoice matching with 1% FX tolerance 2. Revenue/Expense: Entity relationship-based matching 3. Dividends: Intra-group dividend elimination 4. Equity Investments: Parent-subsidiary investment elimination</p> <p>Example elimination entry:</p> <pre><code>Transaction: Effecti \u2192 Mercos software license\nReference: INV-2026-0045\nAmount: BRL 50,000 (USD 9,475)\n\nElimination Journal Entry:\n  DR: IC Revenue (Effecti)      USD 9,475\n  CR: IC Expense (Mercos)        USD 9,475\n  Memo: Eliminate intercompany software license\n</code></pre> <p>Monitor eliminations:</p> <pre><code># View elimination summary\npython -m src.cli.eliminations --period \"2026-01-31\"\n</code></pre>"},{"location":"user-guide/monthly-close/#43-ppa-amortization","title":"4.3 PPA Amortization","text":"<p>For acquired companies, Purchase Price Allocation (PPA) amortization is recorded:</p> <p>Example: Leadlovers (acquired Aug 2023)</p> <pre><code>Goodwill: USD 500,000\nIntangible Assets:\n  - Customer Relationships: USD 4,000,000 (8 years)\n  - Technology Platform: USD 2,000,000 (5 years)\n  - Brand: USD 500,000 (10 years)\n\nMonthly Amortization (Jan 2026):\n  - Customer Relationships: USD 41,667\n  - Technology Platform: USD 33,333\n  - Brand: USD 4,167\n  Total: USD 79,167\n</code></pre> <p>Amortization schedule:</p> <pre><code># View PPA amortization schedule\npython -m src.ppa.schedule --entity leadlovers\n</code></pre>"},{"location":"user-guide/monthly-close/#44-consolidated-output","title":"4.4 Consolidated Output","text":"<p>The consolidation produces:</p> <ol> <li>Consolidated Trial Balance - All entities combined in USD</li> <li>Elimination Entries - Detailed IC elimination journal</li> <li>PPA Adjustments - Monthly amortization entries</li> <li>Audit Trail - Complete consolidation log</li> </ol> <p>View consolidated financials:</p> <pre><code># Generate consolidated trial balance\npython -m src.reporting.consolidated_tb \\\n  --period \"2026-01-31\" \\\n  --output consolidated_tb.xlsx\n</code></pre>"},{"location":"user-guide/monthly-close/#step-5-human-review-workflow","title":"Step 5: Human Review Workflow","text":"<p>Reviewers: FP&amp;A team, Manager, CFO Duration: 1-2 days</p> <p>The system automatically identifies transactions requiring human review based on confidence scoring.</p>"},{"location":"user-guide/monthly-close/#51-review-dashboard","title":"5.1 Review Dashboard","text":"<p>Access the review dashboard:</p> <pre><code># Start review dashboard\npython -m src.dashboard.review_app \\\n  --period \"2026-01-31\" \\\n  --port 8080\n\n# Open in browser\nopen http://localhost:8080\n</code></pre> <p>Dashboard shows:</p> Risk Level Count Requires Review \ud83d\udfe2 Green (\u226580%) 8,456 5% sampling (423) \ud83d\udfe1 Yellow (50-79%) 342 100% review (342) \ud83d\udd34 Red (&lt;50%) 18 100% + escalation (18)"},{"location":"user-guide/monthly-close/#52-review-process","title":"5.2 Review Process","text":"<p>For Yellow Risk Items:</p> <ol> <li>Click on transaction to view details</li> <li>Review supporting documentation</li> <li>Verify amounts and classifications</li> <li>Choose action:</li> <li>Approve - Accept AI recommendation</li> <li>Modify - Edit entry and approve</li> <li>Reject - Create manual adjustment</li> </ol> <p>For Red Risk Items:</p> <p>Requires four-eyes principle (minimum 2 reviewers):</p> <ol> <li>First reviewer (FP&amp;A Analyst) reviews and approves/rejects</li> <li>Second reviewer (FP&amp;A Manager or CFO) independently reviews</li> <li>Both must approve before entry is accepted</li> <li>If rejected, escalate to CFO for decision</li> </ol> <p>Example red risk transaction:</p> <pre><code>Transaction ID: TX-2026-01-0234\nCompany: Effecti\nAccount: Intercompany Revenue\nAmount: USD 1,500,000\nRisk Factors:\n  - Amount &gt; materiality threshold (USD 500k)\n  - First-time intercompany transaction type\n  - Manual adjustment flag\n\nConfidence Score: 42%\nRecommended Action: Escalate to CFO\n</code></pre>"},{"location":"user-guide/monthly-close/#53-approval-actions","title":"5.3 Approval Actions","text":"<p>In the dashboard:</p> <pre><code># Approve transaction\nreview_manager.submit_review(\n    review_id=\"REV-2026-01-0234\",\n    reviewer_id=\"analyst_001\",\n    decision=\"approved\",\n    comments=\"Verified with supporting invoice, amounts reconcile\"\n)\n\n# Request changes\nreview_manager.submit_review(\n    review_id=\"REV-2026-01-0235\",\n    reviewer_id=\"analyst_001\",\n    decision=\"changes_requested\",\n    comments=\"Account code should be 4110 (recurring revenue) not 4120\"\n)\n</code></pre> <p>See Human Review Guide for detailed workflow.</p>"},{"location":"user-guide/monthly-close/#step-6-variance-analysis","title":"Step 6: Variance Analysis","text":"<p>Automated by: <code>analysis</code> agent Duration: 15-20 minutes</p> <p>The system automatically generates variance analysis:</p> <ol> <li>Month-over-Month (MoM) - Jan 2026 vs. Dec 2025</li> <li>Year-over-Year (YoY) - Jan 2026 vs. Jan 2025</li> <li>Budget vs. Actual - Jan 2026 vs. Budget</li> </ol> <p>View variance report:</p> <pre><code># Generate variance analysis\npython -m src.reporting.variance_analysis \\\n  --period \"2026-01-31\" \\\n  --comparison month_over_month \\\n  --output variance_report.xlsx\n</code></pre> <p>Example variance highlights:</p> <pre><code>Revenue\n  Actual: USD 3,625,000\n  Prior Month: USD 3,450,000\n  Variance: +USD 175,000 (+5.1%)\n  Flag: \ud83d\udfe2 Positive, within expectations\n\nOperating Expenses\n  Actual: USD 2,810,000\n  Prior Month: USD 2,650,000\n  Variance: +USD 160,000 (+6.0%)\n  Flag: \ud83d\udfe1 Above trend, investigate\n\nIntercompany Revenue\n  Actual: USD 485,000\n  Prior Month: USD 520,000\n  Variance: -USD 35,000 (-6.7%)\n  Flag: \ud83d\udfe2 Normal fluctuation\n</code></pre> <p>Investigate material variances:</p> <p>Any variance &gt;15% or &gt;USD 250,000 requires explanation:</p> <pre><code># Drill down into specific account\npython -m src.analysis.variance_detail \\\n  --account \"5100\" \\\n  --period \"2026-01-31\"\n</code></pre>"},{"location":"user-guide/monthly-close/#step-7-adjusting-entries-if-needed","title":"Step 7: Adjusting Entries (if needed)","text":"<p>If review identifies errors or adjustments needed:</p> <p>Create manual journal entry:</p> <pre><code># Create adjustment\npython -m src.journal.create_entry \\\n  --period \"2026-01-31\" \\\n  --type adjustment \\\n  --memo \"Reclassify consulting expense to capitalized development\"\n</code></pre> <p>Example adjustment entry:</p> <pre><code>Journal Entry: JE-2026-01-ADJ-001\nDate: 2026-01-31\nType: Adjustment\nMemo: Reclassify R&amp;D costs per IFRS capitalization policy\n\nDR: Intangible Assets (Development)    USD 125,000\nCR: Operating Expenses (R&amp;D)            USD 125,000\n\nApproval: Requires CFO sign-off\nConfidence: Manual entry (requires review)\n</code></pre> <p>All adjustments: - Require detailed memo - Require supporting documentation - Require approver sign-off - Are logged in audit trail</p>"},{"location":"user-guide/monthly-close/#step-8-final-approval-period-close","title":"Step 8: Final Approval &amp; Period Close","text":"<p>Approver: CFO or FP&amp;A Manager Duration: 30 minutes</p> <p>Once all reviews and adjustments are complete:</p>"},{"location":"user-guide/monthly-close/#81-final-review-checklist","title":"8.1 Final Review Checklist","text":"<ul> <li>[ ] All yellow/red risk items reviewed and approved</li> <li>[ ] Material variances explained</li> <li>[ ] Adjustment entries approved</li> <li>[ ] Balance sheet balances (Assets = Liabilities + Equity)</li> <li>[ ] Intercompany eliminations complete</li> <li>[ ] PPA amortization recorded correctly</li> </ul>"},{"location":"user-guide/monthly-close/#82-approve-period-close","title":"8.2 Approve Period Close","text":"<pre><code># Approve and close period\npython -m src.orchestrator.close_period \\\n  --period \"2026-01-31\" \\\n  --approver \"cfo_pierre\" \\\n  --action approve\n</code></pre> <p>This action: - Locks the period (no further changes) - Marks all entries as <code>final</code> - Triggers report generation - Archives data to S3 with Object Lock - Sends notifications to stakeholders</p> <p>Confirmation message: <pre><code>\u2713 Period CLOSE-2026-01 approved\n\u2713 Status: Closed\n\u2713 Approver: Pierre Schurmann (CFO)\n\u2713 Approved at: 2026-02-05 14:32:18 UTC\n\u2713 Archived to: s3://fpa-backups-prod/closes/2026-01/\n\u2713 Notifications sent to: Board, Investors, FP&amp;A Team\n</code></pre></p>"},{"location":"user-guide/monthly-close/#step-9-report-generation","title":"Step 9: Report Generation","text":"<p>Automated after period close:</p> <p>The system automatically generates:</p> <ol> <li>Consolidated Financial Statements (IFRS &amp; US GAAP)</li> <li>Board Report Package (PDF)</li> <li>Investor Update (Excel)</li> <li>Variance Analysis (Excel)</li> <li>KPI Dashboard (HTML)</li> </ol> <p>Download reports:</p> <pre><code># List available reports\npython -m src.cli.reports --period \"2026-01-31\"\n\n# Download specific report\npython -m src.cli.reports \\\n  --period \"2026-01-31\" \\\n  --type board_package \\\n  --output board_report_jan2026.pdf\n</code></pre> <p>See Reports Guide for report details.</p>"},{"location":"user-guide/monthly-close/#step-10-archive-backup","title":"Step 10: Archive &amp; Backup","text":"<p>Automated after period close:</p> <ol> <li>S3 Upload: All data archived to S3</li> <li>Encryption: AES-256-GCM + KMS encryption</li> <li>Object Lock: 7-year retention with governance lock</li> <li>Versioning: All changes tracked</li> </ol> <p>Verify backup:</p> <pre><code># Check S3 backup status\naws s3 ls s3://fpa-backups-prod/closes/2026-01/\n\n# Verify encryption\naws s3api head-object \\\n  --bucket fpa-backups-prod \\\n  --key closes/2026-01/consolidated.json\n</code></pre>"},{"location":"user-guide/monthly-close/#common-scenarios","title":"Common Scenarios","text":""},{"location":"user-guide/monthly-close/#scenario-1-erp-connection-failure","title":"Scenario 1: ERP Connection Failure","text":"<p>Problem: TOTVS connector times out during extraction</p> <p>Solution:</p> <ol> <li>Check ERP API status (may be down for maintenance)</li> <li>Retry with increased timeout:    <pre><code>python -m src.connectors.retry \\\n  --company effecti \\\n  --timeout 300\n</code></pre></li> <li>If still failing, extract manually and upload via CLI:    <pre><code>python -m src.cli.import_trial_balance \\\n  --company effecti \\\n  --file effecti_tb_jan2026.csv\n</code></pre></li> </ol>"},{"location":"user-guide/monthly-close/#scenario-2-material-variance-detected","title":"Scenario 2: Material Variance Detected","text":"<p>Problem: Revenue variance &gt;15% from prior month</p> <p>Solution:</p> <ol> <li>Run detailed variance drill-down</li> <li>Compare to budget and forecast</li> <li>Review supporting transactions</li> <li>Document explanation in variance comments</li> <li>Notify CFO for awareness</li> </ol>"},{"location":"user-guide/monthly-close/#scenario-3-intercompany-mismatch","title":"Scenario 3: Intercompany Mismatch","text":"<p>Problem: Effecti shows USD 100k IC receivable, but Mercos shows USD 98k IC payable</p> <p>Solution:</p> <ol> <li>Check if timing difference (accrual in one entity, cash in other)</li> <li>Check FX rate differences (different booking dates)</li> <li>If true error, create adjustment entry to reconcile</li> <li>Document root cause for process improvement</li> </ol>"},{"location":"user-guide/monthly-close/#monthly-close-metrics","title":"Monthly Close Metrics","text":"<p>Track these KPIs for each close:</p> Metric Target Jan 2026 Actual Close Duration \u22645 days 4 days Automation Rate \u226585% 88% Data Quality Score \u226598% 98.7% Review Time \u226416 hours 14 hours Adjustments \u22645 entries 3 entries Accuracy \u226599.9% 99.92%"},{"location":"user-guide/monthly-close/#best-practices","title":"Best Practices","text":"<ol> <li>Start Early: Begin extraction on Day 1 after month-end</li> <li>Monitor Daily: Check orchestrator status daily during close</li> <li>Review Proactively: Don't wait for dashboard, review as items come in</li> <li>Document Decisions: All review decisions should have clear comments</li> <li>Investigate Trends: Look for patterns in variances month-over-month</li> <li>Continuous Improvement: Update process docs based on lessons learned</li> </ol>"},{"location":"user-guide/monthly-close/#next-steps","title":"Next Steps","text":"<ul> <li>ERP Integration Guide - Configure ERP connectors</li> <li>Consolidation Workflow - Deep dive into consolidation</li> <li>Human Review Guide - Review workflow details</li> <li>Reports Guide - Report generation and customization</li> </ul> <p>Need Help? Contact FP&amp;A Team: pschumacher@nuvini.ai</p>"},{"location":"user-guide/reports/","title":"Reports Guide","text":""},{"location":"user-guide/reports/#overview","title":"Overview","text":"<p>The AI FP&amp;A system generates comprehensive financial reports for various stakeholders including the board, investors, management, and auditors. All reports are automatically generated after period close and available in multiple formats.</p> <p>Report Categories: 1. Financial Statements (IFRS &amp; US GAAP) 2. Board Reports 3. Management Reports 4. Variance Analysis 5. KPI Dashboards 6. Audit Reports</p>"},{"location":"user-guide/reports/#available-reports","title":"Available Reports","text":""},{"location":"user-guide/reports/#financial-statements","title":"Financial Statements","text":""},{"location":"user-guide/reports/#1-consolidated-balance-sheet","title":"1. Consolidated Balance Sheet","text":"<p>Audience: Board, Investors, Auditors Frequency: Monthly Formats: Excel, PDF Standards: IFRS &amp; US GAAP</p> <p>Contents: - Assets (Current &amp; Non-Current) - Liabilities (Current &amp; Non-Current) - Equity (including CTA) - Comparative periods (current vs. prior month/year)</p> <p>Generate:</p> <pre><code>python -m src.reporting.balance_sheet \\\n  --period \"2026-01-31\" \\\n  --comparison month_over_month \\\n  --format excel \\\n  --output balance_sheet_jan2026.xlsx\n</code></pre> <p>Example output:</p> <pre><code>NUVINI GROUP LIMITED\nConsolidated Balance Sheet\nAs of January 31, 2026\n(Amounts in USD thousands)\n\n                                Jan 2026    Dec 2025    Change    Change%\nASSETS\nCurrent Assets\n  Cash and Cash Equivalents      2,450       2,320        130      5.6%\n  Accounts Receivable            4,850       4,620        230      5.0%\n  Prepaid Expenses                 320         310         10      3.2%\n  Other Current Assets             180         165         15      9.1%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Current Assets           7,800       7,415        385      5.2%\n\nNon-Current Assets\n  Property, Plant &amp; Equipment    1,250       1,280        (30)    (2.3%)\n  Intangible Assets              8,950       9,030        (80)    (0.9%)\n  Goodwill                         500         500          -       0.0%\n  Deferred Tax Assets              450         425         25      5.9%\n  Other Non-Current Assets       9,500       9,320        180      1.9%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Non-Current Assets      20,650      20,555         95      0.5%\n\nTOTAL ASSETS                    28,450      27,970        480      1.7%\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nLIABILITIES &amp; EQUITY\nCurrent Liabilities\n  Accounts Payable               3,120       2,980        140      4.7%\n  Accrued Expenses               1,850       1,790         60      3.4%\n  Deferred Revenue               2,450       2,320        130      5.6%\n  Short-term Debt                1,200       1,200          -      0.0%\n  Other Current Liabilities        680         640         40      6.3%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Current Liabilities      9,300       8,930        370      4.1%\n\nNon-Current Liabilities\n  Long-term Debt                 4,500       4,500          -      0.0%\n  Deferred Tax Liabilities         930         910         20      2.2%\n  Other Non-Current Liabilities    500         490         10      2.0%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Non-Current Liabilities  5,930       5,900         30      0.5%\n\nTOTAL LIABILITIES               15,230      14,830        400      2.7%\n\nEquity\n  Share Capital                  8,500       8,500          -      0.0%\n  Retained Earnings              4,580       4,500         80      1.8%\n  Cumulative Translation Adj.      140         140          -      0.0%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Equity                  13,220      13,140         80      0.6%\n\nTOTAL LIABILITIES &amp; EQUITY      28,450      27,970        480      1.7%\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n</code></pre>"},{"location":"user-guide/reports/#2-consolidated-income-statement","title":"2. Consolidated Income Statement","text":"<p>Audience: Board, Investors, Management Frequency: Monthly Formats: Excel, PDF</p> <p>Contents: - Revenue (by segment/company) - Operating Expenses (by category) - EBITDA, EBIT, Net Income - Comparative periods - Variance analysis</p> <p>Generate:</p> <pre><code>python -m src.reporting.income_statement \\\n  --period \"2026-01-31\" \\\n  --comparison month_over_month \\\n  --format excel \\\n  --output income_statement_jan2026.xlsx\n</code></pre> <p>Example output:</p> <pre><code>NUVINI GROUP LIMITED\nConsolidated Income Statement\nFor the Month Ended January 31, 2026\n(Amounts in USD thousands)\n\n                                Jan 2026    Dec 2025    Change    Change%\nREVENUE\n  SaaS Subscription Revenue      2,850       2,720        130      4.8%\n  Professional Services            520         490         30      6.1%\n  Other Revenue                    255         240         15      6.3%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Revenue                  3,625       3,450        175      5.1%\n\nCOST OF REVENUE\n  Direct Labor                     680         650         30      4.6%\n  Infrastructure Costs             420         395         25      6.3%\n  Other CoR                        145         135         10      7.4%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Cost of Revenue          1,245       1,180         65      5.5%\n\nGROSS PROFIT                     2,380       2,270        110      4.8%\nGross Margin %                   65.7%       65.8%      (0.1%)\n\nOPERATING EXPENSES\n  Sales &amp; Marketing                850         810         40      4.9%\n  Research &amp; Development           520         485         35      7.2%\n  General &amp; Administrative         385         360         25      6.9%\n  PPA Amortization                  80          80          -      0.0%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Operating Expenses       1,835       1,735        100      5.8%\n\nEBITDA                             625         615         10      1.6%\nEBITDA Margin %                  17.2%       17.8%      (0.6%)\n\nDepreciation &amp; Amortization       160         160          -      0.0%\n\nEBIT                               465         455         10      2.2%\nEBIT Margin %                    12.8%       13.2%      (0.4%)\n\nOTHER INCOME/(EXPENSE)\n  Interest Income                   15          12          3     25.0%\n  Interest Expense                 (45)        (45)         -      0.0%\n  FX Gain/(Loss)                    25          18          7     38.9%\n  Other, net                        (5)         (3)        (2)    66.7%\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Other Income/(Expense)     (10)        (18)         8    (44.4%)\n\nINCOME BEFORE TAX                 455         437         18      4.1%\n\nIncome Tax Expense               (137)       (131)        (6)     4.6%\nEffective Tax Rate %             30.1%       30.0%       0.1%\n\nNET INCOME                         318         306         12      3.9%\nNet Margin %                      8.8%        8.9%      (0.1%)\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n</code></pre>"},{"location":"user-guide/reports/#3-consolidated-cash-flow-statement","title":"3. Consolidated Cash Flow Statement","text":"<p>Audience: Board, CFO, Investors Frequency: Monthly Formats: Excel, PDF</p> <p>Contents: - Operating Cash Flow - Investing Cash Flow - Financing Cash Flow - Free Cash Flow calculation</p> <p>Generate:</p> <pre><code>python -m src.reporting.cash_flow \\\n  --period \"2026-01-31\" \\\n  --method indirect \\\n  --format excel \\\n  --output cash_flow_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/reports/#4-statement-of-changes-in-equity","title":"4. Statement of Changes in Equity","text":"<p>Audience: Auditors, Board Frequency: Quarterly, Annual Formats: Excel, PDF</p> <p>Contents: - Share capital movements - Retained earnings roll-forward - CTA movements - Comprehensive income</p>"},{"location":"user-guide/reports/#board-reports","title":"Board Reports","text":""},{"location":"user-guide/reports/#5-board-package","title":"5. Board Package","text":"<p>Audience: Board of Directors Frequency: Monthly Format: PDF (print-ready)</p> <p>Contents: - Executive summary (1-page) - Consolidated financial statements - KPI dashboard - Variance analysis - Company-by-company highlights - Key risks and opportunities</p> <p>Generate:</p> <pre><code>python -m src.reporting.board_package \\\n  --period \"2026-01-31\" \\\n  --output board_package_jan2026.pdf\n</code></pre> <p>Example structure:</p> <pre><code>NUVINI GROUP LIMITED - Board Package\nJanuary 2026\n\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nEXECUTIVE SUMMARY\n\nKey Metrics:\n\u2022 Total ARR: $43.6M (+5.1% MoM)\n\u2022 MRR: $3.63M (+4.8% MoM)\n\u2022 Net Income: $318K (8.8% margin)\n\u2022 Cash: $2.45M (+5.6% MoM)\n\u2022 Customer Count: 2,847 (+3.2% MoM)\n\nHighlights:\n\u2713 Strong revenue growth across all segments\n\u2713 Gross margin stable at 65.7%\n\u2713 Operating expenses well-controlled\n\u2713 Cash generation positive\n\nRisks:\n\u26a0 Customer churn increased to 2.8% (target: 2.5%)\n\u26a0 Sales cycle extended to 45 days (target: 35)\n\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n[Detailed financial statements follow]\n[KPI dashboard]\n[Variance analysis]\n[Company highlights]\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n</code></pre>"},{"location":"user-guide/reports/#6-investor-update","title":"6. Investor Update","text":"<p>Audience: Investors, Limited Partners Frequency: Monthly, Quarterly Formats: Excel, PDF</p> <p>Contents: - Portfolio performance summary - ARR and MRR trends - Unit economics (CAC, LTV, Payback) - Company-level metrics - Investment highlights</p> <p>Generate:</p> <pre><code>python -m src.reporting.investor_update \\\n  --period \"2026-01-31\" \\\n  --format excel \\\n  --output investor_update_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/reports/#management-reports","title":"Management Reports","text":""},{"location":"user-guide/reports/#7-variance-analysis-report","title":"7. Variance Analysis Report","text":"<p>Audience: Management, FP&amp;A Team Frequency: Monthly Formats: Excel, HTML</p> <p>Contents: - Actual vs. Budget variance - Month-over-Month variance - Year-over-Year variance - Variance explanations (for &gt;15% variances)</p> <p>Generate:</p> <pre><code>python -m src.reporting.variance_analysis \\\n  --period \"2026-01-31\" \\\n  --comparison budget \\\n  --threshold 0.15 \\\n  --output variance_jan2026.xlsx\n</code></pre> <p>Example output:</p> <pre><code>Variance Analysis - January 2026\nActual vs. Budget\n\nAccount                  Actual    Budget    Variance   Var%    Status\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nREVENUE\n  SaaS Subscription     2,850,000  2,700,000  150,000   5.6%    \ud83d\udfe2 Fav\n  Professional Services   520,000    550,000  (30,000)  (5.5%)  \ud83d\udfe2 Ok\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total Revenue         3,370,000  3,250,000  120,000   3.7%    \ud83d\udfe2 Fav\n\nOPERATING EXPENSES\n  Sales &amp; Marketing       850,000    800,000   50,000   6.3%    \ud83d\udfe1 Unfav\n  R&amp;D                     520,000    500,000   20,000   4.0%    \ud83d\udfe2 Ok\n  G&amp;A                     385,000    375,000   10,000   2.7%    \ud83d\udfe2 Ok\n  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  Total OpEx            1,755,000  1,675,000   80,000   4.8%    \ud83d\udfe1 Unfav\n\nNET INCOME               318,000    320,000   (2,000)  (0.6%)  \ud83d\udfe2 Ok\n\nMaterial Variances (&gt;15%):\nNone this period.\n</code></pre>"},{"location":"user-guide/reports/#8-company-performance-report","title":"8. Company Performance Report","text":"<p>Audience: Management, Company CEOs Frequency: Monthly Formats: Excel, PDF</p> <p>Contents: - Individual company P&amp;L - Company-level KPIs - Trends and benchmarks - Action items</p> <p>Generate:</p> <pre><code># All companies\npython -m src.reporting.company_performance \\\n  --period \"2026-01-31\" \\\n  --output company_performance_jan2026.xlsx\n\n# Single company\npython -m src.reporting.company_performance \\\n  --period \"2026-01-31\" \\\n  --company effecti \\\n  --output effecti_performance_jan2026.pdf\n</code></pre>"},{"location":"user-guide/reports/#kpi-dashboards","title":"KPI Dashboards","text":""},{"location":"user-guide/reports/#9-executive-kpi-dashboard","title":"9. Executive KPI Dashboard","text":"<p>Audience: CEO, CFO, Management Frequency: Real-time (web-based) Format: Interactive HTML</p> <p>Contents: - Revenue metrics (ARR, MRR, Growth) - Profitability metrics (EBITDA, Net Income, Margins) - Cash metrics (Cash balance, Burn rate, Runway) - Customer metrics (Count, Churn, NPS) - Employee metrics (Headcount, Productivity)</p> <p>Access:</p> <pre><code># Start dashboard server\npython -m src.dashboard.kpi_dashboard \\\n  --port 8080 \\\n  --period \"2026-01-31\"\n\n# Open in browser\nopen http://localhost:8080\n</code></pre> <p>Dashboard sections:</p> <ol> <li>Revenue Overview</li> <li>ARR trend (12 months)</li> <li>MRR waterfall chart</li> <li>Revenue by segment</li> <li> <p>Revenue by company</p> </li> <li> <p>Profitability</p> </li> <li>Gross margin trend</li> <li>EBITDA margin trend</li> <li>Net income trend</li> <li> <p>Operating leverage chart</p> </li> <li> <p>Cash &amp; Runway</p> </li> <li>Cash balance</li> <li>Monthly burn rate</li> <li>Runway months</li> <li> <p>Cash conversion cycle</p> </li> <li> <p>Unit Economics</p> </li> <li>CAC (Customer Acquisition Cost)</li> <li>LTV (Lifetime Value)</li> <li>LTV:CAC ratio</li> <li> <p>Payback period</p> </li> <li> <p>Operational Metrics</p> </li> <li>Customer count</li> <li>Churn rate</li> <li>Net Revenue Retention</li> <li>ARPU (Average Revenue Per User)</li> </ol>"},{"location":"user-guide/reports/#10-saas-metrics-dashboard","title":"10. SaaS Metrics Dashboard","text":"<p>Audience: Management, Investors Frequency: Monthly Format: Excel, Interactive HTML</p> <p>Contents: - MRR movements (New, Expansion, Contraction, Churn) - ARR by cohort - Rule of 40 (Growth% + Margin%) - Quick Ratio (Growth / Churn) - Magic Number (ARR Growth / S&amp;M Spend)</p> <p>Generate:</p> <pre><code>python -m src.reporting.saas_metrics \\\n  --period \"2026-01-31\" \\\n  --format excel \\\n  --output saas_metrics_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/reports/#audit-reports","title":"Audit Reports","text":""},{"location":"user-guide/reports/#11-trial-balance-report","title":"11. Trial Balance Report","text":"<p>Audience: Auditors, Controllers Frequency: Monthly Formats: Excel, CSV</p> <p>Contents: - Complete chart of accounts - Opening balance, debits, credits, closing balance - Consolidated and entity-level views</p> <p>Generate:</p> <pre><code># Consolidated trial balance\npython -m src.reporting.trial_balance \\\n  --period \"2026-01-31\" \\\n  --level consolidated \\\n  --output consolidated_tb_jan2026.xlsx\n\n# Entity-level trial balances\npython -m src.reporting.trial_balance \\\n  --period \"2026-01-31\" \\\n  --level entity \\\n  --company effecti \\\n  --output effecti_tb_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/reports/#12-general-ledger-report","title":"12. General Ledger Report","text":"<p>Audience: Auditors, Controllers Frequency: As needed Formats: Excel, CSV</p> <p>Contents: - All journal entries for period - Entry details (date, account, amount, memo, source) - Subledger details</p> <p>Generate:</p> <pre><code># All journal entries\npython -m src.reporting.general_ledger \\\n  --period \"2026-01-31\" \\\n  --output gl_jan2026.xlsx\n\n# Specific account\npython -m src.reporting.general_ledger \\\n  --period \"2026-01-31\" \\\n  --account \"4.01.001\" \\\n  --output gl_revenue_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/reports/#13-audit-trail-report","title":"13. Audit Trail Report","text":"<p>Audience: Auditors, Compliance Frequency: As needed Formats: Excel, CSV</p> <p>Contents: - All system actions (who, what, when) - Data changes (before/after) - Access logs - Review decisions</p> <p>Generate:</p> <pre><code># Full audit trail\npython -m src.reporting.audit_trail \\\n  --period \"2026-01-31\" \\\n  --output audit_trail_jan2026.xlsx\n\n# Filter by event type\npython -m src.reporting.audit_trail \\\n  --period \"2026-01-31\" \\\n  --event-type human_review \\\n  --output review_audit_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/reports/#14-intercompany-elimination-report","title":"14. Intercompany Elimination Report","text":"<p>Audience: Auditors, Controllers Frequency: Monthly Formats: Excel</p> <p>Contents: - All IC transactions identified - Matched vs. unmatched IC items - Elimination journal entries - FX gain/loss on IC balances</p> <p>Generate:</p> <pre><code>python -m src.reporting.ic_eliminations \\\n  --period \"2026-01-31\" \\\n  --output ic_eliminations_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/reports/#15-ppa-amortization-report","title":"15. PPA Amortization Report","text":"<p>Audience: Auditors, Tax Frequency: Monthly Formats: Excel</p> <p>Contents: - PPA schedule by acquisition - Monthly amortization by asset type - Cumulative amortization - Remaining intangible asset balances - Goodwill tracking</p> <p>Generate:</p> <pre><code># All PPAs\npython -m src.reporting.ppa_schedule \\\n  --period \"2026-01-31\" \\\n  --output ppa_schedule_jan2026.xlsx\n\n# Single acquisition\npython -m src.reporting.ppa_schedule \\\n  --period \"2026-01-31\" \\\n  --entity leadlovers \\\n  --output leadlovers_ppa_jan2026.xlsx\n</code></pre>"},{"location":"user-guide/reports/#report-customization","title":"Report Customization","text":""},{"location":"user-guide/reports/#custom-report-templates","title":"Custom Report Templates","text":"<p>Create custom Excel templates:</p> <pre><code>from src.reporting import ReportBuilder\n\n# Define custom template\nbuilder = ReportBuilder()\nbuilder.load_template(\"templates/custom_board_report.xlsx\")\n\n# Add data sections\nbuilder.add_section(\"financial_statements\", period=\"2026-01-31\")\nbuilder.add_section(\"kpi_dashboard\", period=\"2026-01-31\")\nbuilder.add_section(\"variance_analysis\", comparison=\"budget\")\n\n# Generate report\nbuilder.generate(\"custom_board_report_jan2026.xlsx\")\n</code></pre>"},{"location":"user-guide/reports/#custom-kpi-definitions","title":"Custom KPI Definitions","text":"<p>Define custom KPIs:</p> <pre><code>from src.metrics import KPIDefinition\n\n# Define custom KPI\ncustom_kpi = KPIDefinition(\n    name=\"Net Revenue Retention\",\n    formula=\"(Beginning MRR + Expansion - Contraction - Churn) / Beginning MRR\",\n    category=\"SaaS Metrics\",\n    target=110.0,  # Target: 110%\n    format=\"percentage\"\n)\n\n# Calculate KPI\nnrr = custom_kpi.calculate(period=\"2026-01-31\")\nprint(f\"NRR: {nrr:.1f}%\")\n</code></pre>"},{"location":"user-guide/reports/#scheduled-reports","title":"Scheduled Reports","text":"<p>Schedule automatic report generation:</p> <pre><code># Schedule board package (1st of each month)\npython -m src.reporting.schedule \\\n  --report board_package \\\n  --frequency monthly \\\n  --day 1 \\\n  --time \"09:00\" \\\n  --email \"board@nuvini.ai\" \\\n  --format pdf\n\n# Schedule investor update (quarterly)\npython -m src.reporting.schedule \\\n  --report investor_update \\\n  --frequency quarterly \\\n  --email \"investors@nuvini.ai\" \\\n  --format excel\n</code></pre>"},{"location":"user-guide/reports/#report-distribution","title":"Report Distribution","text":""},{"location":"user-guide/reports/#email-reports","title":"Email Reports","text":"<p>Email reports to stakeholders:</p> <pre><code>python -m src.reporting.email \\\n  --report board_package_jan2026.pdf \\\n  --to \"board@nuvini.ai\" \\\n  --subject \"Board Package - January 2026\" \\\n  --body \"Please find attached the Board Package for January 2026.\"\n</code></pre>"},{"location":"user-guide/reports/#s3-upload","title":"S3 Upload","text":"<p>Upload reports to S3:</p> <pre><code>python -m src.reporting.upload \\\n  --file board_package_jan2026.pdf \\\n  --bucket fpa-reports \\\n  --prefix \"board/2026/01/\" \\\n  --acl private\n</code></pre>"},{"location":"user-guide/reports/#web-portal","title":"Web Portal","text":"<p>Access reports via web portal:</p> <pre><code># Start report portal\npython -m src.dashboard.report_portal \\\n  --port 8080\n\n# Open in browser\nopen http://localhost:8080/reports\n</code></pre> <p>Portal features: - Browse all reports by period - Search and filter reports - Download in multiple formats - Share reports with stakeholders - View report generation history</p>"},{"location":"user-guide/reports/#report-best-practices","title":"Report Best Practices","text":"<ol> <li>Generate Immediately After Close: Run reports as soon as period close is approved</li> <li>Review Before Distribution: Always review key reports before sending to stakeholders</li> <li>Use Standard Templates: Maintain consistent formatting across periods</li> <li>Archive Reports: Keep copies of all reports for 7 years (compliance)</li> <li>Control Access: Use role-based access for sensitive reports</li> <li>Automate Distribution: Schedule recurring reports to reduce manual work</li> <li>Track Versions: Version all report templates and log changes</li> </ol>"},{"location":"user-guide/reports/#troubleshooting","title":"Troubleshooting","text":""},{"location":"user-guide/reports/#issue-report-generation-fails","title":"Issue: Report Generation Fails","text":"<p>Symptom: Report command returns error</p> <p>Solutions:</p> <ol> <li> <p>Check if period is closed: <pre><code>python -m src.cli.status --period \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Verify data completeness: <pre><code>python -m src.reporting.validation_report \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Check logs: <pre><code>tail -f logs/reporting.log\n</code></pre></p> </li> </ol>"},{"location":"user-guide/reports/#issue-missing-data-in-report","title":"Issue: Missing Data in Report","text":"<p>Symptom: Report generated but data is missing or zero</p> <p>Solutions:</p> <ol> <li> <p>Verify consolidation completed: <pre><code>python -m src.cli.consolidation_status \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Check data filters:</p> </li> <li>Ensure correct period specified</li> <li>Verify company filter (if used)</li> <li> <p>Check account code filters</p> </li> <li> <p>Regenerate report: <pre><code># Force regeneration\npython -m src.reporting.board_package \\\n  --period \"2026-01-31\" \\\n  --force \\\n  --output board_package_jan2026.pdf\n</code></pre></p> </li> </ol>"},{"location":"user-guide/reports/#issue-report-format-issues","title":"Issue: Report Format Issues","text":"<p>Symptom: Excel formulas broken, PDF layout incorrect</p> <p>Solutions:</p> <ol> <li> <p>Update report templates: <pre><code>python -m src.reporting.update_templates\n</code></pre></p> </li> <li> <p>Use alternative format: <pre><code># Try CSV instead of Excel\npython -m src.reporting.trial_balance \\\n  --period \"2026-01-31\" \\\n  --format csv\n</code></pre></p> </li> </ol>"},{"location":"user-guide/reports/#next-steps","title":"Next Steps","text":"<ul> <li>Monthly Close Process - When reports are generated</li> <li>Human Review Guide - Review before distribution</li> <li>Troubleshooting Guide - Detailed troubleshooting</li> </ul> <p>Last Updated: February 7, 2026 Version: 1.0.0</p>"},{"location":"user-guide/troubleshooting/","title":"Troubleshooting Guide","text":""},{"location":"user-guide/troubleshooting/#overview","title":"Overview","text":"<p>This guide provides solutions to common issues encountered during monthly close operations. Issues are organized by system component and include diagnostic steps, solutions, and prevention strategies.</p>"},{"location":"user-guide/troubleshooting/#quick-diagnostic-commands","title":"Quick Diagnostic Commands","text":"<p>Before diving into specific issues, run these diagnostic commands:</p> <pre><code># System health check\npython -m src.cli.health_check --full\n\n# Period status\npython -m src.cli.status --period \"2026-01-31\"\n\n# Validation report\npython -m src.reporting.validation_report \\\n  --period \"2026-01-31\"\n\n# View recent errors\ntail -f logs/fpa_system.log | grep ERROR\n</code></pre>"},{"location":"user-guide/troubleshooting/#data-extraction-issues","title":"Data Extraction Issues","text":""},{"location":"user-guide/troubleshooting/#issue-1-erp-connector-timeout","title":"Issue 1: ERP Connector Timeout","text":"<p>Symptoms: - <code>httpx.ConnectTimeout</code> exception - Connection hangs for 60+ seconds - \"Failed to connect to ERP\" error</p> <p>Diagnostic:</p> <pre><code># Test network connectivity\ncurl -I https://api.totvs.com.br\n\n# Check connector health\npython -m src.connectors.health_check \\\n  --erp totvs_protheus \\\n  --company effecti\n\n# View connector logs\ntail -f logs/data_ingestion.log\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Increase timeout: <pre><code>python -m src.connectors.extract \\\n  --company effecti \\\n  --timeout 300 \\\n  --retry 5\n</code></pre></p> </li> <li> <p>Check ERP status:</p> </li> <li>TOTVS: https://status.totvs.com.br</li> <li>ContaAzul: https://status.contaazul.com</li> <li> <p>Check if maintenance window</p> </li> <li> <p>Retry with backoff: <pre><code>python -m src.connectors.retry \\\n  --company effecti \\\n  --max-attempts 10 \\\n  --backoff exponential\n</code></pre></p> </li> <li> <p>Manual extraction (last resort): <pre><code># Export from ERP manually and import\npython -m src.cli.import_trial_balance \\\n  --company effecti \\\n  --file effecti_tb_jan2026.csv \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> </ol> <p>Prevention: - Schedule extractions during off-peak hours (e.g., 2 AM local time) - Monitor ERP status pages for planned maintenance - Increase default timeout in production config</p>"},{"location":"user-guide/troubleshooting/#issue-2-rate-limit-exceeded","title":"Issue 2: Rate Limit Exceeded","text":"<p>Symptoms: - <code>429 Too Many Requests</code> HTTP error - <code>503 Service Temporarily Unavailable</code> - Extraction fails midway through</p> <p>Diagnostic:</p> <pre><code># Check rate limit status\npython -m src.connectors.rate_limit_status \\\n  --erp contaazul\n\n# View request count\npython -m src.connectors.request_stats \\\n  --company mercos \\\n  --period \"2026-01-31\"\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Wait and retry: <pre><code># Wait 60 seconds, then retry\nsleep 60\npython -m src.connectors.retry --company mercos\n</code></pre></p> </li> <li> <p>Use date-based chunking: <pre><code># Extract in smaller date ranges\npython -m src.connectors.extract \\\n  --company mercos \\\n  --period-start \"2026-01-01\" \\\n  --period-end \"2026-01-15\" \\\n  --chunk-days 7\n</code></pre></p> </li> <li> <p>Schedule extraction over time: <pre><code># Extract one company per hour\npython -m src.orchestrator.schedule_extraction \\\n  --stagger 60  # minutes between companies\n</code></pre></p> </li> </ol> <p>Prevention: - Know your ERP rate limits (TOTVS: 100/min, ContaAzul: 60/min, Omie: 300/min) - Use built-in rate limiter (automatic) - Schedule extractions to avoid overlapping with other systems</p>"},{"location":"user-guide/troubleshooting/#issue-3-authentication-failure","title":"Issue 3: Authentication Failure","text":"<p>Symptoms: - <code>401 Unauthorized</code> error - \"Invalid credentials\" message - OAuth token expired</p> <p>Diagnostic:</p> <pre><code># Verify credentials\npython -m src.connectors.test_auth \\\n  --erp totvs_protheus \\\n  --company effecti\n\n# Check token expiration\npython -m src.connectors.token_info \\\n  --company effecti\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Refresh OAuth token: <pre><code>python -m src.connectors.refresh_token \\\n  --erp totvs_protheus \\\n  --company effecti\n</code></pre></p> </li> <li> <p>Verify credentials in .env: <pre><code>cat .env | grep TOTVS_EFFECTI\n</code></pre></p> </li> <li> <p>Re-authorize application:</p> </li> <li>Log into ERP admin console</li> <li>Revoke old token</li> <li>Generate new token</li> <li>Update <code>.env</code> file</li> <li> <p>Restart extraction</p> </li> <li> <p>Check API key permissions: <pre><code># Test API key has required permissions\npython -m src.connectors.test_permissions \\\n  --erp omie \\\n  --company datahub\n</code></pre></p> </li> </ol> <p>Prevention: - Use long-lived OAuth refresh tokens - Set up token expiration alerts - Document credential rotation process - Store credentials in AWS Secrets Manager (production)</p>"},{"location":"user-guide/troubleshooting/#issue-4-data-quality-errors","title":"Issue 4: Data Quality Errors","text":"<p>Symptoms: - Trial balance doesn't balance - Missing account codes - Duplicate transactions - Negative balances in unexpected accounts</p> <p>Diagnostic:</p> <pre><code># Run data quality report\npython -m src.validation.data_quality \\\n  --company effecti \\\n  --period \"2026-01-31\"\n\n# Check specific issues\npython -m src.validation.check_balance \\\n  --company effecti\n\npython -m src.validation.find_duplicates \\\n  --company effecti\n</code></pre> <p>Solutions:</p> <ol> <li>Balance sheet doesn't balance: <pre><code># Check for missing accounts\npython -m src.validation.missing_accounts \\\n  --company effecti\n\n# Review ERP extraction log\ntail -f logs/data_ingestion.log | grep effecti\n</code></pre></li> </ol> <p>Fix: Re-extract from ERP or create manual adjustment</p> <ol> <li> <p>Duplicate transactions: <pre><code># Find duplicates\npython -m src.validation.find_duplicates \\\n  --company effecti \\\n  --threshold 0.99  # 99% similarity\n\n# Remove duplicates\npython -m src.cli.remove_duplicates \\\n  --company effecti \\\n  --dry-run  # Preview first\n</code></pre></p> </li> <li> <p>Missing account codes: <pre><code># Map missing accounts\npython -m src.cli.map_accounts \\\n  --company mercos \\\n  --category \"Sal\u00e1rios\" \\\n  --account-code \"5.01.001\"\n</code></pre></p> </li> <li> <p>Negative cash balance: <pre><code># Investigate transactions\npython -m src.reporting.account_detail \\\n  --company effecti \\\n  --account \"1.01.001\" \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> </ol> <p>Common causes:    - Timing difference (deposits not yet cleared)    - Overdraft facility    - ERP data error</p> <p>Prevention: - Enable validation during extraction - Set up data quality alerts - Review ERP data integrity monthly - Train ERP users on proper data entry</p>"},{"location":"user-guide/troubleshooting/#consolidation-issues","title":"Consolidation Issues","text":""},{"location":"user-guide/troubleshooting/#issue-5-balance-sheet-doesnt-balance","title":"Issue 5: Balance Sheet Doesn't Balance","text":"<p>Symptoms: - Validation error: \"Assets \u2260 Liabilities + Equity\" - Difference is material (&gt;$0.01)</p> <p>Diagnostic:</p> <pre><code># Run balance sheet diagnostic\npython -m src.consolidation.diagnose \\\n  --period \"2026-01-31\" \\\n  --issue balance_sheet\n\n# Check component balances\npython -m src.cli.component_balances \\\n  --period \"2026-01-31\"\n</code></pre> <p>Solutions:</p> <ol> <li>Check if all entities extracted: <pre><code>python -m src.cli.extraction_status \\\n  --period \"2026-01-31\"\n</code></pre></li> </ol> <p>Fix: Re-extract missing entities</p> <ol> <li>Verify FX conversion: <pre><code>python -m src.consolidation.verify_fx \\\n  --period \"2026-01-31\"\n</code></pre></li> </ol> <p>Fix: Reload FX rates and re-run conversion</p> <ol> <li>Review elimination entries: <pre><code>python -m src.cli.consolidation_journal \\\n  --period \"2026-01-31\" \\\n  --type eliminations\n</code></pre></li> </ol> <p>Fix: Correct elimination entries with errors</p> <ol> <li>Check PPA entries: <pre><code>python -m src.ppa.verify \\\n  --period \"2026-01-31\"\n</code></pre></li> </ol> <p>Fix: Re-run PPA amortization</p> <ol> <li>Trace the imbalance: <pre><code># Calculate difference\npython -m src.consolidation.trace_imbalance \\\n  --period \"2026-01-31\"\n</code></pre></li> </ol> <p>Example output: <pre><code>Balance Sheet Imbalance: USD 12,500\n\nTracing source:\n\u2713 Entity extractions: All balanced\n\u2713 FX conversion: All balanced\n\u2713 Eliminations: All balanced\n\u2717 PPA entries: Imbalance found\n\nIssue: Leadlovers PPA amortization missing\nAmortization expected: USD 79,167\nAmortization recorded: USD 66,667\nDifference: USD 12,500 \u2190 Source of imbalance\n\nFix: Re-run PPA amortization for Leadlovers\n</code></pre></p> <p>Prevention: - Run validation after each consolidation step - Set up balance checks as blocking controls - Archive balanced trial balances before modifications</p>"},{"location":"user-guide/troubleshooting/#issue-6-large-unmatched-intercompany-transactions","title":"Issue 6: Large Unmatched Intercompany Transactions","text":"<p>Symptoms: - Many IC transactions not eliminated - Material unmatched IC amounts (&gt;USD 100k) - Warning in validation report</p> <p>Diagnostic:</p> <pre><code># View unmatched IC items\npython -m src.cli.unmatched_ic \\\n  --period \"2026-01-31\" \\\n  --minimum-amount 10000\n\n# IC reconciliation report\npython -m src.reporting.ic_reconciliation \\\n  --period \"2026-01-31\"\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Increase FX tolerance: <pre><code># Default is 1%, try 2%\npython -m src.consolidation.eliminate \\\n  --period \"2026-01-31\" \\\n  --tolerance 0.02\n</code></pre></p> </li> <li> <p>Check reference number matching: <pre><code># View IC items by reference\npython -m src.cli.ic_by_reference \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> </ol> <p>Common issues:    - Different invoice formats (INV-001 vs. INV001)    - Missing reference numbers    - Typos in reference numbers</p> <ol> <li> <p>Manual matching: <pre><code># Manually match two IC items\npython -m src.cli.match_ic \\\n  --item1 \"IC-RECV-001\" \\\n  --item2 \"IC-PAY-001\" \\\n  --create-elimination\n</code></pre></p> </li> <li> <p>Timing differences:</p> </li> <li>One entity recorded in Jan, other in Feb</li> <li>Accrual basis vs. cash basis</li> </ol> <p>Fix: Accept as unmatched, will reconcile next period</p> <ol> <li>Create manual elimination: <pre><code>python -m src.journal.create_entry \\\n  --type ic_elimination \\\n  --debit \"2.02.003:18500\" \\\n  --credit \"1.02.005:18500\" \\\n  --memo \"Manual IC elimination - timing difference\"\n</code></pre></li> </ol> <p>Prevention: - Standardize IC invoice numbering across entities - Document IC transactions in shared ledger - Set up monthly IC reconciliation process - Use tighter FX tolerance for large transactions</p>"},{"location":"user-guide/troubleshooting/#issue-7-incorrect-cta-calculation","title":"Issue 7: Incorrect CTA Calculation","text":"<p>Symptoms: - CTA amount significantly different from expected - Large unexpected FX gain/loss - CTA variance vs. prior period</p> <p>Diagnostic:</p> <pre><code># CTA reconciliation\npython -m src.fx.cta_reconciliation \\\n  --period \"2026-01-31\"\n\n# Compare to prior period\npython -m src.fx.cta_variance \\\n  --current \"2026-01-31\" \\\n  --prior \"2025-12-31\"\n</code></pre> <p>Solutions:</p> <ol> <li>Verify historical rates: <pre><code># Check if historical rates loaded\npython -m src.fx.list_rates \\\n  --type historical \\\n  --from \"2023-08-01\" \\\n  --to \"2026-01-31\"\n</code></pre></li> </ol> <p>Fix: Load missing historical rates</p> <ol> <li>Check retained earnings: <pre><code># Verify retained earnings balance\npython -m src.cli.account_detail \\\n  --account \"3.05.001\" \\\n  --period \"2026-01-31\"\n</code></pre></li> </ol> <p>Fix: Correct retained earnings if incorrect</p> <ol> <li> <p>Review prior period CTA: <pre><code># Compare CTA trend\npython -m src.fx.cta_trend \\\n  --from \"2025-01-01\" \\\n  --to \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Recalculate CTA: <pre><code># Force CTA recalculation\npython -m src.consolidation.recalculate_cta \\\n  --period \"2026-01-31\" \\\n  --verify\n</code></pre></p> </li> </ol> <p>Prevention: - Document historical rates for all acquisitions - Archive CTA calculations monthly - Review CTA variance analysis quarterly</p>"},{"location":"user-guide/troubleshooting/#issue-8-missing-fx-rates","title":"Issue 8: Missing FX Rates","text":"<p>Symptoms: - \"FX rate not found\" error - Consolidation fails at FX conversion step</p> <p>Diagnostic:</p> <pre><code># Check available FX rates\npython -m src.fx.list_rates \\\n  --period \"2026-01-31\"\n\n# Check missing rates\npython -m src.fx.missing_rates \\\n  --period \"2026-01-31\"\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Load FX rates automatically: <pre><code># Load from BCB PTAX\npython -m src.fx.load_rates \\\n  --source bcb_ptax \\\n  --date \"2026-01-31\" \\\n  --rate-type closing\n\npython -m src.fx.load_rates \\\n  --source bcb_ptax \\\n  --period \"2026-01-01:2026-01-31\" \\\n  --rate-type average\n</code></pre></p> </li> <li> <p>Add FX rates manually: <pre><code># Add closing rate\npython -m src.fx.add_rate \\\n  --from BRL \\\n  --to USD \\\n  --date \"2026-01-31\" \\\n  --type closing \\\n  --rate 0.1895 \\\n  --source \"BCB PTAX\"\n\n# Add average rate\npython -m src.fx.add_rate \\\n  --from BRL \\\n  --to USD \\\n  --date \"2026-01-31\" \\\n  --type average \\\n  --rate 0.1872 \\\n  --source \"BCB PTAX Jan 2026 Avg\"\n</code></pre></p> </li> <li> <p>Use sample rates (testing only): <pre><code>python -m src.fx.create_sample_rates \\\n  --date \"2026-01-31\"\n</code></pre></p> </li> </ol> <p>Prevention: - Automate FX rate loading (daily job) - Set up FX rate alerts when rates not available - Document FX rate sources</p>"},{"location":"user-guide/troubleshooting/#human-review-issues","title":"Human Review Issues","text":""},{"location":"user-guide/troubleshooting/#issue-9-too-many-reviews-pending","title":"Issue 9: Too Many Reviews Pending","text":"<p>Symptoms: - Review queue has 500+ pending items - Reviews not completed within SLA - Bottleneck in review workflow</p> <p>Diagnostic:</p> <pre><code># Check review workload\npython -m src.cli.review_workload \\\n  --period \"2026-01-31\"\n\n# Reviewer statistics\npython -m src.cli.reviewer_stats \\\n  --period \"2026-01-31\"\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Adjust confidence thresholds: <pre><code># Reduce review volume by 20-30%\npython -m src.oversight.adjust_thresholds \\\n  --green-threshold 0.85 \\\n  --yellow-threshold 0.55\n</code></pre></p> </li> <li> <p>Reduce sampling rate: <pre><code># Sample 2% instead of 5%\npython -m src.oversight.set_sampling_rate \\\n  --green-rate 0.02\n</code></pre></p> </li> <li> <p>Delegate reviews: <pre><code># Reassign to additional reviewers\npython -m src.cli.reassign_reviews \\\n  --from \"john_analyst\" \\\n  --to \"mary_analyst\" \\\n  --count 100\n</code></pre></p> </li> <li> <p>Batch approve low-risk items: <pre><code># Batch approve green samples\npython -m src.cli.batch_approve \\\n  --risk-level green \\\n  --confidence-min 0.90 \\\n  --max-count 50 \\\n  --reviewer \"john_analyst\"\n</code></pre></p> </li> </ol> <p>Prevention: - Monitor review queue daily during close - Adjust thresholds based on review capacity - Train additional reviewers</p>"},{"location":"user-guide/troubleshooting/#issue-10-high-rejection-rate","title":"Issue 10: High Rejection Rate","text":"<p>Symptoms: - &gt;10% of reviewed transactions rejected - Frequent AI misclassifications - Low approval rate</p> <p>Diagnostic:</p> <pre><code># Rejection analysis\npython -m src.reporting.rejection_analysis \\\n  --period \"2026-01-31\"\n\n# Common rejection reasons\npython -m src.cli.rejection_reasons \\\n  --period \"2026-01-31\" \\\n  --top 10\n</code></pre> <p>Solutions:</p> <ol> <li>Analyze rejection patterns: <pre><code>python -m src.analysis.rejection_patterns \\\n  --period \"2026-01-31\"\n</code></pre></li> </ol> <p>Example output: <pre><code>Top Rejection Reasons:\n1. Wrong account code (35%)\n2. Should be capitalized (22%)\n3. Duplicate transaction (18%)\n4. Wrong amount (15%)\n5. Missing supporting docs (10%)\n</code></pre></p> <ol> <li> <p>Improve validation rules: <pre><code># Add validation for common errors\npython -m src.validation.add_rule \\\n  --name \"check_capitalization\" \\\n  --condition \"amount &gt; 50000 and account in ['5.01.*']\" \\\n  --action \"flag_for_review\" \\\n  --message \"Large R&amp;D expense, check if should be capitalized\"\n</code></pre></p> </li> <li> <p>Retrain AI model: <pre><code># Flag rejected transactions for training\npython -m src.ml.retrain \\\n  --period \"2026-01-31\" \\\n  --include-rejections\n</code></pre></p> </li> <li> <p>Update confidence scoring: <pre><code># Adjust weights based on rejection analysis\npython -m src.oversight.adjust_weights \\\n  --materiality 0.35 \\\n  --complexity 0.20 \\\n  --data-quality 0.20 \\\n  --pattern-deviation 0.15 \\\n  --variance 0.10\n</code></pre></p> </li> </ol> <p>Prevention: - Review rejection patterns monthly - Continuously improve AI model - Document common errors in training data - Add validation rules for frequent errors</p>"},{"location":"user-guide/troubleshooting/#reporting-issues","title":"Reporting Issues","text":""},{"location":"user-guide/troubleshooting/#issue-11-report-generation-fails","title":"Issue 11: Report Generation Fails","text":"<p>Symptoms: - Report command returns error - Excel file corrupted - Missing data in report</p> <p>Diagnostic:</p> <pre><code># Check if period closed\npython -m src.cli.status --period \"2026-01-31\"\n\n# Verify data completeness\npython -m src.reporting.validation_report \\\n  --period \"2026-01-31\"\n\n# Check report logs\ntail -f logs/reporting.log\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Ensure period is closed: <pre><code># Close period first\npython -m src.orchestrator.close_period \\\n  --period \"2026-01-31\" \\\n  --approver \"cfo_pierre\" \\\n  --action approve\n</code></pre></p> </li> <li> <p>Verify consolidation complete: <pre><code>python -m src.cli.consolidation_status \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> <li> <p>Regenerate report: <pre><code># Force regeneration\npython -m src.reporting.board_package \\\n  --period \"2026-01-31\" \\\n  --force \\\n  --output board_package_jan2026.pdf\n</code></pre></p> </li> <li> <p>Try alternative format: <pre><code># If Excel fails, try CSV\npython -m src.reporting.trial_balance \\\n  --period \"2026-01-31\" \\\n  --format csv\n</code></pre></p> </li> <li> <p>Check template version: <pre><code># Update report templates\npython -m src.reporting.update_templates\n</code></pre></p> </li> </ol> <p>Prevention: - Always close period before generating reports - Keep report templates up to date - Test reports on non-production data first</p>"},{"location":"user-guide/troubleshooting/#performance-issues","title":"Performance Issues","text":""},{"location":"user-guide/troubleshooting/#issue-12-slow-consolidation","title":"Issue 12: Slow Consolidation","text":"<p>Symptoms: - Consolidation takes &gt;30 minutes - System appears hung - High CPU/memory usage</p> <p>Diagnostic:</p> <pre><code># Check system resources\ntop -p $(pgrep -f \"python.*consolidation\")\n\n# Profile consolidation\npython -m src.consolidation.run \\\n  --period \"2026-01-31\" \\\n  --profile\n\n# Check database performance\npython -m src.cli.db_stats\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Optimize database queries: <pre><code># Analyze slow queries\npython -m src.cli.slow_queries \\\n  --threshold 1000  # &gt;1s\n\n# Update indexes\npython -m src.database.optimize_indexes\n</code></pre></p> </li> <li> <p>Increase parallelization: <pre><code># Use more workers\npython -m src.consolidation.run \\\n  --period \"2026-01-31\" \\\n  --workers 8  # Default: 4\n</code></pre></p> </li> <li> <p>Batch processing: <pre><code># Process entities in batches\npython -m src.consolidation.run \\\n  --period \"2026-01-31\" \\\n  --batch-size 2  # 2 entities at a time\n</code></pre></p> </li> <li> <p>Check data volume: <pre><code># Count entries per entity\npython -m src.cli.entry_count \\\n  --period \"2026-01-31\"\n</code></pre></p> </li> </ol> <p>If one entity has unusually high entry count, investigate source</p> <p>Prevention: - Monitor consolidation performance monthly - Optimize database indexes quarterly - Archive old data (&gt;7 years)</p>"},{"location":"user-guide/troubleshooting/#database-issues","title":"Database Issues","text":""},{"location":"user-guide/troubleshooting/#issue-13-database-connection-errors","title":"Issue 13: Database Connection Errors","text":"<p>Symptoms: - \"Connection refused\" error - \"Too many connections\" error - Database timeout</p> <p>Diagnostic:</p> <pre><code># Test database connection\npsql -h localhost -U fpa_user -d fpa_prod -c \"SELECT 1\"\n\n# Check connection pool\npython -m src.cli.db_connections\n\n# Check database logs\ntail -f /var/log/postgresql/postgresql.log\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Verify PostgreSQL is running: <pre><code>sudo systemctl status postgresql\n\n# If not running\nsudo systemctl start postgresql\n</code></pre></p> </li> <li> <p>Check connection string: <pre><code># Verify DATABASE_URL in .env\necho $DATABASE_URL\n</code></pre></p> </li> <li> <p>Increase connection pool: <pre><code># In config\nDATABASE_POOL_SIZE = 20  # Increase from 10\nDATABASE_MAX_OVERFLOW = 40  # Increase from 20\n</code></pre></p> </li> <li> <p>Close idle connections: <pre><code># Kill idle connections\npython -m src.cli.close_idle_connections \\\n  --idle-time 300  # &gt;5 minutes\n</code></pre></p> </li> </ol> <p>Prevention: - Monitor connection pool usage - Set connection timeout limits - Use connection pooling (pgBouncer)</p>"},{"location":"user-guide/troubleshooting/#issue-14-database-locks","title":"Issue 14: Database Locks","text":"<p>Symptoms: - Query hangs indefinitely - \"Deadlock detected\" error - Multiple processes waiting</p> <p>Diagnostic:</p> <pre><code># Check for locks\npsql -d fpa_prod -c \"\n  SELECT pid, usename, pg_blocking_pids(pid), query\n  FROM pg_stat_activity\n  WHERE pg_blocking_pids(pid)::text != '{}'\n\"\n\n# View long-running queries\npython -m src.cli.long_running_queries \\\n  --threshold 60  # &gt;60 seconds\n</code></pre> <p>Solutions:</p> <ol> <li> <p>Kill blocking query: <pre><code># Get PID from diagnostic above\npsql -d fpa_prod -c \"SELECT pg_terminate_backend(12345)\"\n</code></pre></p> </li> <li> <p>Reduce transaction scope:</p> </li> <li>Break large transactions into smaller chunks</li> <li> <p>Commit more frequently</p> </li> <li> <p>Use advisory locks: <pre><code># Prevent concurrent consolidations\npython -m src.consolidation.run \\\n  --period \"2026-01-31\" \\\n  --use-advisory-lock\n</code></pre></p> </li> </ol> <p>Prevention: - Keep transactions small and fast - Use advisory locks for long operations - Monitor for deadlocks</p>"},{"location":"user-guide/troubleshooting/#system-wide-issues","title":"System-Wide Issues","text":""},{"location":"user-guide/troubleshooting/#issue-15-out-of-memory","title":"Issue 15: Out of Memory","text":"<p>Symptoms: - <code>MemoryError</code> exception - System becomes unresponsive - OOM killer terminates process</p> <p>Diagnostic:</p> <pre><code># Check memory usage\nfree -h\n\n# Check Python process memory\nps aux | grep python | sort -k4 -r\n\n# Memory profiling\npython -m memory_profiler src/consolidation/consolidator.py\n</code></pre> <p>Solutions:</p> <ol> <li>Increase system memory:</li> <li>Upgrade server RAM</li> <li> <p>Use larger EC2 instance</p> </li> <li> <p>Process in chunks: <pre><code># Process entities one at a time\npython -m src.consolidation.run \\\n  --period \"2026-01-31\" \\\n  --entities \"effecti\" \\\n  --output effecti_consolidated.xlsx\n\npython -m src.consolidation.run \\\n  --period \"2026-01-31\" \\\n  --entities \"mercos\" \\\n  --output mercos_consolidated.xlsx\n\n# Merge results\npython -m src.consolidation.merge \\\n  --files \"effecti_consolidated.xlsx,mercos_consolidated.xlsx\" \\\n  --output final_consolidated.xlsx\n</code></pre></p> </li> <li> <p>Optimize memory usage: <pre><code># Use generators instead of lists\n# Process data in streams\n# Delete large objects after use\n</code></pre></p> </li> <li> <p>Clear cache: <pre><code>python -m src.cli.clear_cache\n</code></pre></p> </li> </ol> <p>Prevention: - Monitor memory usage - Set memory limits in production - Profile memory usage regularly</p>"},{"location":"user-guide/troubleshooting/#getting-help","title":"Getting Help","text":""},{"location":"user-guide/troubleshooting/#support-channels","title":"Support Channels","text":"<ol> <li> <p>Check Logs: <pre><code># System log\ntail -f logs/fpa_system.log\n\n# Component-specific logs\ntail -f logs/data_ingestion.log\ntail -f logs/consolidation.log\ntail -f logs/reporting.log\n</code></pre></p> </li> <li> <p>Run Diagnostics: <pre><code>python -m src.cli.diagnose \\\n  --period \"2026-01-31\" \\\n  --output diagnostic_report.txt\n</code></pre></p> </li> <li> <p>Contact FP&amp;A Team:</p> </li> <li>Email: pschumacher@nuvini.ai</li> <li>Slack: #fpa-support</li> <li> <p>Phone: +55 11 XXXX-XXXX (urgent only)</p> </li> <li> <p>Create GitHub Issue: <pre><code># Include diagnostic report\ngh issue create \\\n  --title \"Consolidation fails for period 2026-01\" \\\n  --body \"$(cat diagnostic_report.txt)\" \\\n  --label bug\n</code></pre></p> </li> </ol>"},{"location":"user-guide/troubleshooting/#escalation-path","title":"Escalation Path","text":"<ol> <li>Level 1: FP&amp;A Analyst (john_analyst@nuvini.ai)</li> <li>Level 2: FP&amp;A Manager (sarah_manager@nuvini.ai)</li> <li>Level 3: CFO (pierre_cfo@nuvini.ai)</li> <li>Level 4: Engineering Team (engineering@nuvini.ai)</li> </ol>"},{"location":"user-guide/troubleshooting/#information-to-provide","title":"Information to Provide","text":"<p>When reporting an issue, include:</p> <ul> <li>Period affected (e.g., \"2026-01-31\")</li> <li>Error message (full stack trace)</li> <li>Steps to reproduce</li> <li>Expected vs. actual behavior</li> <li>Diagnostic report output</li> <li>System logs (last 100 lines)</li> </ul>"},{"location":"user-guide/troubleshooting/#prevention-strategies","title":"Prevention Strategies","text":""},{"location":"user-guide/troubleshooting/#daily-monitoring","title":"Daily Monitoring","text":"<pre><code># Daily health check script\n#!/bin/bash\npython -m src.cli.health_check --full\npython -m src.connectors.health_check --all\npython -m src.cli.db_stats\npython -m src.fx.check_rates --period \"$(date +%Y-%m-01)\"\n</code></pre>"},{"location":"user-guide/troubleshooting/#weekly-maintenance","title":"Weekly Maintenance","text":"<ul> <li>Review error logs</li> <li>Update FX rates</li> <li>Check disk space</li> <li>Backup database</li> <li>Test ERP connections</li> </ul>"},{"location":"user-guide/troubleshooting/#monthly-best-practices","title":"Monthly Best Practices","text":"<ul> <li>Review rejection patterns</li> <li>Update AI model</li> <li>Optimize database indexes</li> <li>Archive old data</li> <li>Test disaster recovery</li> </ul>"},{"location":"user-guide/troubleshooting/#next-steps","title":"Next Steps","text":"<ul> <li>Monthly Close Process - Full workflow</li> <li>ERP Integration Guide - ERP-specific troubleshooting</li> <li>Human Review Guide - Review workflow issues</li> </ul> <p>Last Updated: February 7, 2026 Version: 1.0.0</p>"}]}